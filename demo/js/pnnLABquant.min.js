(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[]}Math.clamp=function(t,a,e){return this.max(a,this.min(e,t))},Math.cbrt||(Math.cbrt=function(t){return this.exp(1/3*this.log(t))});var a=.2126,e=.7152,r=.0722,n=[],i=[];function h(){this.alpha=this.A=this.B=this.L=0}function s(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function l(t){var a,e,r,n=(t.L+16)/116,i=t.A/500+n,h=n-t.B/200;e=-.9689*(i=.95047*(i*i*i>.008856?i*i*i:(i-16/116)/7.787))+1.8758*(n=1*(n*n*n>.008856?n*n*n:(n-16/116)/7.787))+.0415*(h=1.08883*(h*h*h>.008856?h*h*h:(h-16/116)/7.787)),r=.0557*i+-.204*n+1.057*h,a=(a=3.2406*i+-1.5372*n+-.4986*h)>.0031308?1.055*Math.pow(a,1/2.4)-.055:12.92*a,e=e>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r;var s=Math.clamp(t.alpha,0,255);return a=Math.clamp(255*a,0,255),e=Math.clamp(255*e,0,255),s<<24|(r=Math.clamp(255*r,0,255))<<16|e<<8|a}function o(t){return t*(Math.PI/180)}function c(t,a){var e=a.L-t.L,r=(t.L+a.L)/2;return e/(1*(1+.015*M(r-50)/Math.sqrt(20+M(r-50))))}function u(t,a,e,r,n,i){var h=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(a.A*a.A+a.B*a.B))/2,s=.5*(1-Math.sqrt(Math.pow(h,7)/(Math.pow(h,7)+6103515625)));return e.value=(1+s)*t.A,r.value=(1+s)*a.A,n.value=Math.sqrt(e.value*e.value+t.B*t.B),i.value=Math.sqrt(r.value*r.value+a.B*a.B),(i.value-n.value)/(1*(1+.045*((n.value+i.value)/2)))}function p(t,a,e,r,n,i,h,s){var l,c,u,p=o(360),v=o(180),f=n*i;0==t.B&&0==e?l=0:(l=Math.atan2(t.B,e))<0&&(l+=p),0==a.B&&0==r?c=0:(c=Math.atan2(a.B,r))<0&&(c+=p),0==f?u=0:(u=c-l)<-v?u+=p:u>v&&(u-=p);var m=2*Math.sqrt(f)*Math.sin(u/2),M=l+c;n*i==0?s.value=M:Math.abs(l-c)<=v?s.value=M/2:s.value=M<p?(M+p)/2:(M-p)/2,h.value=(n+i)/2;var w=1-.17*Math.cos(s.value-o(30))+.24*Math.cos(2*s.value)+.32*Math.cos(3*s.value+o(6))-.2*Math.cos(4*s.value-o(63));return m/(1*(1+.015*h.value*w))}function v(t,a,e,r){var n=o(30)*Math.exp(-Math.pow((a-o(275))/o(25),2)),i=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625));return-Math.sin(2*n)*i*e*r}function f(t,a){c(t,a);var e={},r={},n={},i={},h=u(t,a,e,r,n,i),s={},l={},o=p(t,a,e.value,r.value,n.value,i.value,s,l);v(s.value,l.value,h,o)}function m(t,a,e,r,n,i){return n?(240&t)<<8|(240&a)<<4|240&e|r>>4:i>=0?(128&t)<<8|(248&a)<<7|(248&e)<<2|r>>3:(248&a)<<8|(252&e)<<3|r>>3}function M(t){return t*t}function w(t,a,e,r){var n=t<<24|r<<16|e<<8|a,s=i[n];return s||(s=function(t,a,e,r){var n,i,s,l=a/255,o=e/255,c=r/255;i=(.2126*(l=l>.04045?Math.pow((l+.055)/1.055,2.4):l/12.92)+.7152*(o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92)+.0722*(c=c>.04045?Math.pow((c+.055)/1.055,2.4):c/12.92))/1,s=(.0193*l+.1192*o+.9505*c)/1.08883,n=(n=(.4124*l+.3576*o+.1805*c)/.95047)>.008856?Math.cbrt(n):7.787*n+16/116,i=i>.008856?Math.cbrt(i):7.787*i+16/116,s=s>.008856?Math.cbrt(s):7.787*s+16/116;var u=new h;return u.alpha=t,u.L=116*i-16,u.A=500*(n-i),u.B=200*(i-s),u}(t,a,e,r),i[n]=s),s}function A(t,a){var e=0,r=1e100,n=t[a],i=n.cnt,s=new h;s.alpha=n.ac,s.L=n.Lc,s.A=n.Ac,s.B=n.Bc;for(var l=n.fw;0!=l;l=t[l].fw){var o=t[l].cnt,f=i*o/(i+o);if(!(f>=r)){var m=new h;m.alpha=t[l].ac,m.L=t[l].Lc,m.A=t[l].Ac,m.B=t[l].Bc;var w=m.alpha-s.alpha,A=f*M(w)*w/3;if(!(A>=r))if(!((A+=f*M(c(s,m)))>=r)){var B={},x={},L={},d={},y=u(s,m,B,x,L,d);if(!((A+=f*M(y))>=r)){var _={},b={},g=p(s,m,B.value,x.value,L.value,d.value,_,b);(A+=f*M(g))>=r||(A+=f*v(_.value,b.value,y,g))>=r||(r=A,e=l)}}}}n.err=r,n.nn=e}function B(t,n,i){for(var h=0,s=255&i,l=i>>>8&255,o=i>>>16&255,c=i>>>24&255,u=1e100,p=w(c,s,l,o),v=0;v<n;v++){var f=255&t[v],m=t[v]>>>8&255,A=t[v]>>>16&255,B=t[v]>>>24&255,x=M(B-c);if(!(x>u)){if(n>32){if((x+=a*M(f-s))>u)continue;if((x+=e*M(m-l))>u)continue;if((x+=r*M(A-o))>u)continue}else{var L=w(B,f,m,A);if((x+=M(L.L-p.L))>u)continue;if((x+=M(L.A-p.A))>u)continue;if((x+=M(L.B-p.B))>u)continue;u=x}u=x,h=v}}return h}function x(t,a,e){var r=0,i=255&e,h=e>>>8&255,s=e>>>16&255,l=e>>>24&255,o=n[e];if(!o){(o=[])[2]=o[3]=1e100;for(var c=w(l,i,h,s);r<a;r++){var u=255&t[r],p=t[r]>>>8&255,v=t[r]>>>16&255,m=w(t[r]>>>24&255,u,p,v);o[4]=Math.abs(m.alpha-c.alpha)+f(m,c),o[4]<o[2]?(o[1]=o[0],o[3]=o[2],o[0]=r,o[2]=o[4]):o[4]<o[3]&&(o[1]=r,o[3]=o[4])}1e100==o[3]&&(o[2]=0)}return r=0==o[2]||Math.floor(32769*Math.random())%(o[3]+o[2])<=o[3]?o[0]:o[1],n[e]=o,r}t.prototype.pnnquan=function(t,a){for(var e=new Array(65536),r=0;r<t.length;++r){var n=255&t[r],i=t[r]>>>8&255,o=t[r]>>>16&255,c=t[r]>>>24&255,u=m(c,n,i,o,this.hasSemiTransparency,this.m_transparentPixelIndex),p=w(c,n,i,o);null==e[u]&&(e[u]=new s),e[u].ac+=c,e[u].Lc+=p.L,e[u].Ac+=p.A,e[u].Bc+=p.B,e[u].cnt++}var v,f,M,B=0,x=new Uint32Array(65537);for(r=0;r<e.length;++r)if(null!=e[r]){var L=1/e[r].cnt;e[r].ac*=L,e[r].Lc*=L,e[r].Ac*=L,e[r].Bc*=L,e[B++]=e[r]}for(r=0;r<B-1;++r)e[r].fw=r+1,e[r+1].bk=r;for(r=0;r<B;++r){A(e,r);var d=e[r].err;for(f=++x[0];f>1&&!(e[v=x[M=f>>1]].err<=d);f=M)x[f]=v;x[f]=r}var y=B-a;for(r=0;r<y;){for(var _;;){var b=x[1];if((_=e[b]).tm>=_.mtm&&e[_.nn].mtm<=_.tm)break;65535==_.mtm?b=x[1]=x[x[0]--]:(A(e,b),_.tm=r);d=e[b].err;for(f=1;(M=f+f)<=x[0]&&(M<x[0]&&e[x[M]].err>e[x[M+1]].err&&M++,!(d<=e[v=x[M]].err));f=M)x[f]=v;x[f]=b}var g=e[_.nn],q=_.cnt,P=g.cnt;L=1/(q+P);_.ac=L*(q*_.ac+P*g.ac),_.Lc=L*(q*_.Lc+P*g.Lc),_.Ac=L*(q*_.Ac+P*g.Ac),_.Bc=L*(q*_.Bc+P*g.Bc),_.cnt+=g.cnt,_.mtm=++r,e[g.bk].fw=g.fw,e[g.fw].bk=g.bk,g.mtm=65535}delete x;var I=0;for(r=0;;++I){if((p=new h).alpha=Math.round(Math.clamp(e[r].ac,0,255)),p.L=e[r].Lc,p.A=e[r].Ac,p.B=e[r].Bc,this.palette[I]=l(p),this.m_transparentPixelIndex>=0&&this.palette[I]==this.m_transparentColor){var U=this.palette[0];this.palette[0]=this.palette[I],this.palette[I]=U}if(0==(r=e[r].fw))break}void 0!==this.palette.sort&&this.palette.sort()},t.prototype.quantize_image=function(t,a,e,r,n,i){var h=0;if(i){const i=4,x=20;for(var s=(r+2)*i,l=new Uint32Array(256*i),o=new Uint32Array(512),c=0;c<256;++c)l[c]=0,l[c+256]=c,l[c+512]=255,l[c+768]=255,o[c]=-x,o[c+256]=x;for(c=-x;c<=x;++c)o[c+256]=c;var u=!1,p=new Uint32Array(s),v=new Uint32Array(s),f=new Uint32Array(65536);for(c=0;c<n;++c){var M,w,A;u?(M=-1,h+=r-1,w=v,A=p):(M=1,w=p,A=v);var L=i,d=r*i;A[d]=A[d+1]=A[d+2]=A[d+3]=0;for(var y=0;y<r;y++){var _=255&t[h],b=t[h]>>>8&255,g=t[h]>>>16&255,q=t[h]>>>24&255,P=l[(w[L]+4104>>4)+_],I=l[(w[L+1]+4104>>4)+b],U=l[(w[L+2]+4104>>4)+g],k=l[(w[L+3]+4104>>4)+q],C=k<<24|U<<16|I<<8|P,S=m(k,P,I,U,this.hasSemiTransparency,this.m_transparentPixelIndex);0==f[S]&&(f[S]=B(this.palette,a,C)+1),e[h]=f[S]-1;var T=this.palette[e[h]],z=255&T,Q=T>>>8&255,j=T>>>16&255,D=T>>>24&255;D<255&&255==q&&(f[S]=B(this.palette,a,t[h])+1,e[h]=f[S]-1),P=o[P-z+256],I=o[I-Q+256],U=o[U-j+256],k=o[k-D+256];var E=2*P;A[d-i]=P,A[d+i]+=P+=E,A[d]+=P+=E,w[L+i]+=P+=E,E=2*I,A[d+1-i]=I,A[d+1+i]+=I+=E,A[d+1]+=I+=E,w[L+1+i]+=I+=E,E=2*U,A[d+2-i]=U,A[d+2+i]+=U+=E,A[d+2]+=U+=E,w[L+2+i]+=U+=E,E=2*k,A[d+3-i]=k,A[d+3+i]+=k+=E,A[d+3]+=k+=E,w[L+3+i]+=k+=E,L+=i,d-=i,h+=M}c%2==1&&(h+=r+1),u=!u}return!0}if(this.m_transparentPixelIndex>=0||a<64)for(c=0;c<e.length;++c)e[c]=B(this.palette,a,t[c]);else for(c=0;c<e.length;++c)e[c]=x(this.palette,a,t[c]);return!0},t.prototype.quantizeImage=function(){for(var t=this.opts.pixels,h=this.opts.width,s=this.opts.height,l=this.opts.colors,o=this.opts.dithering,c=0;c<t.length;++c){var u=t[c]>>>24&255;u<255&&(this.hasSemiTransparency=!0,0==u&&(this.m_transparentPixelIndex=c,this.m_transparentColor=t[c]))}var p=new Uint32Array(t.length);if((this.hasSemiTransparency||l<=32)&&(a=e=r=1),this.palette=new Uint32Array(l),l>2?this.pnnquan(t,l):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.quantize_image(t,l,p,h,s,o),this.m_transparentPixelIndex>=0){var v=p[this.m_transparentPixelIndex];if(l>2)this.palette[v]=this.m_transparentColor;else if(this.palette[v]!=this.m_transparentColor){var f=this.palette[0];this.palette[0]=this.palette[1],this.palette[1]=f}}return i=[],n=[],function(t,a){for(var e=0;e<a.length;++e)a[e]=t[a[e]];return a}(this.palette,p)},t.prototype.getPalette=function(){return this.palette.buffer},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);