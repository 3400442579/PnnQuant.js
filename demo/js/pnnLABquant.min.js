(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[]}Math.clamp=function(t,a,e){return this.max(a,this.min(e,t))},Math.cbrt||(Math.cbrt=function(t){return this.exp(1/3*this.log(t))});var a=[],e=[];function r(){this.alpha=this.A=this.B=this.L=0}function n(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function i(t){var a,e,r,n=(t.L+16)/116,i=t.A/500+n,h=n-t.B/200;e=-.9689*(i=.95047*(i*i*i>.008856?i*i*i:(i-16/116)/7.787))+1.8758*(n=1*(n*n*n>.008856?n*n*n:(n-16/116)/7.787))+.0415*(h=1.08883*(h*h*h>.008856?h*h*h:(h-16/116)/7.787)),r=.0557*i+-.204*n+1.057*h,a=(a=3.2406*i+-1.5372*n+-.4986*h)>.0031308?1.055*Math.pow(a,1/2.4)-.055:12.92*a,e=e>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r;var s=Math.clamp(t.alpha,0,255);return a=Math.clamp(255*a,0,255),e=Math.clamp(255*e,0,255),s<<24|(r=Math.clamp(255*r,0,255))<<16|e<<8|a}function h(t){return t*(Math.PI/180)}function s(t,a){var e=a.L-t.L,r=(t.L+a.L)/2;return e/(1*(1+.015*v(r-50)/Math.sqrt(20+v(r-50))))}function l(t,a,e,r,n,i){var h=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(a.A*a.A+a.B*a.B))/2,s=.5*(1-Math.sqrt(Math.pow(h,7)/(Math.pow(h,7)+6103515625)));return e.value=(1+s)*t.A,r.value=(1+s)*a.A,n.value=Math.sqrt(e.value*e.value+t.B*t.B),i.value=Math.sqrt(r.value*r.value+a.B*a.B),(i.value-n.value)/(1*(1+.045*((n.value+i.value)/2)))}function o(t,a,e,r,n,i,s,l){var o,c,u,p=h(360),v=h(180),f=n*i;0==t.B&&0==e?o=0:(o=Math.atan2(t.B,e))<0&&(o+=p),0==a.B&&0==r?c=0:(c=Math.atan2(a.B,r))<0&&(c+=p),0==f?u=0:(u=c-o)<-v?u+=p:u>v&&(u-=p);var m=2*Math.sqrt(f)*Math.sin(u/2),M=o+c;n*i==0?l.value=M:Math.abs(o-c)<=v?l.value=M/2:l.value=M<p?(M+p)/2:(M-p)/2,s.value=(n+i)/2;var w=1-.17*Math.cos(l.value-h(30))+.24*Math.cos(2*l.value)+.32*Math.cos(3*l.value+h(6))-.2*Math.cos(4*l.value-h(63));return m/(1*(1+.015*s.value*w))}function c(t,a,e,r){var n=h(30)*Math.exp(-Math.pow((a-h(275))/h(25),2)),i=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625));return-Math.sin(2*n)*i*e*r}function u(t,a){s(t,a);var e={},r={},n={},i={},h=l(t,a,e,r,n,i),u={},p={},v=o(t,a,e.value,r.value,n.value,i.value,u,p);c(u.value,p.value,h,v)}function p(t,a,e,r,n){return n?(240&t)<<8|(240&a)<<4|240&e|r>>4:(248&a)<<8|(252&e)<<3|r>>3}function v(t){return t*t}function f(t,a,n,i){var h=t<<24|i<<16|n<<8|a,s=e[h];return s||(s=function(t,a,e,n){var i,h,s,l=a/255,o=e/255,c=n/255;h=(.2126*(l=l>.04045?Math.pow((l+.055)/1.055,2.4):l/12.92)+.7152*(o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92)+.0722*(c=c>.04045?Math.pow((c+.055)/1.055,2.4):c/12.92))/1,s=(.0193*l+.1192*o+.9505*c)/1.08883,i=(i=(.4124*l+.3576*o+.1805*c)/.95047)>.008856?Math.cbrt(i):7.787*i+16/116,h=h>.008856?Math.cbrt(h):7.787*h+16/116,s=s>.008856?Math.cbrt(s):7.787*s+16/116;var u=new r;return u.alpha=t,u.L=116*h-16,u.A=500*(i-h),u.B=200*(h-s),u}(t,a,n,i),e[h]=s),s}function m(t,a){var e=0,n=1e100,i=t[a],h=i.cnt,u=new r;u.alpha=i.ac,u.L=i.Lc,u.A=i.Ac,u.B=i.Bc;for(var p=i.fw;0!=p;p=t[p].fw){var f=t[p].cnt,m=h*f/(h+f);if(!(m>=n)){var M=new r;M.alpha=t[p].ac,M.L=t[p].Lc,M.A=t[p].Ac,M.B=t[p].Bc;var w=M.alpha-u.alpha,A=m*v(w)*w/3;if(!(A>=n))if(!((A+=m*v(s(u,M)))>=n)){var B={},L={},x={},y={},d=l(u,M,B,L,x,y);if(!((A+=m*v(d))>=n)){var b={},g={},q=o(u,M,B.value,L.value,x.value,y.value,b,g);(A+=m*v(q))>=n||(A+=m*c(b.value,g.value,d,q))>=n||(n=A,e=p)}}}}i.err=n,i.nn=e}function M(t,a,e){for(var r=0,n=255&e,i=e>>>8&255,h=e>>>16&255,s=e>>>24&255,l=1e100,o=f(s,n,i,h),c=0;c<a;c++){var u=255&t[c],p=t[c]>>>8&255,m=t[c]>>>16&255,M=t[c]>>>24&255,w=v(M-s);if(!(w>l)){if(a>32){if((w+=v(u-n))>l)continue;if((w+=v(p-i))>l)continue;if((w+=v(m-h))>l)continue}else{var A=f(M,u,p,m);if((w+=v(A.L-o.L))>l)continue;if((w+=v(A.A-o.A))>l)continue;if((w+=v(A.B-o.B))>l)continue;l=w}l=w,r=c}}return r}function w(t,e,r){var n=0,i=255&r,h=r>>>8&255,s=r>>>16&255,l=r>>>24&255,o=a[r];if(!o){(o=[])[2]=o[3]=1e100;for(var c=f(l,i,h,s);n<e;n++){var p=255&t[n],v=t[n]>>>8&255,m=t[n]>>>16&255,M=f(t[n]>>>24&255,p,v,m);o[4]=Math.abs(M.alpha-c.alpha)+u(M,c),o[4]<o[2]?(o[1]=o[0],o[3]=o[2],o[0]=n,o[2]=o[4]):o[4]<o[3]&&(o[1]=n,o[3]=o[4])}1e100==o[3]&&(o[2]=0)}return n=0==o[2]||Math.floor(32769*Math.random())%(o[3]+o[2])<=o[3]?o[0]:o[1],a[r]=o,n}function A(t,a,e,r,n,i,h,s){var l=[];return s?(l[0]=n[(i[h]+4104>>4)+a],l[1]=n[(i[h+1]+4104>>4)+e],l[2]=n[(i[h+2]+4104>>4)+r],l[3]=n[(i[h+3]+4104>>4)+t],l):(l[0]=n[(i[h]+8208>>5)+a],l[1]=n[(i[h+1]+16416>>6)+e],l[2]=n[(i[h+2]+8208>>5)+r],l[3]=t,l)}t.prototype.pnnquan=function(t,a,e){for(var h=new Array(65536),s=0;s<t.length;++s){var l=255&t[s],o=t[s]>>>8&255,c=t[s]>>>16&255,u=t[s]>>>24&255,v=p(u,l,o,c,this.hasSemiTransparency),M=f(u,l,o,c);null==h[v]&&(h[v]=new n),h[v].ac+=u,h[v].Lc+=M.L,h[v].Ac+=M.A,h[v].Bc+=M.B,h[v].cnt++}var w,A,B,L=0,x=new Uint32Array(65537);for(s=0;s<h.length;++s)if(null!=h[s]){var y=1/h[s].cnt;h[s].ac*=y,h[s].Lc*=y,h[s].Ac*=y,h[s].Bc*=y,e&&(h[s].cnt=Math.sqrt(h[s].cnt)),h[L++]=h[s]}for(s=0;s<L-1;++s)h[s].fw=s+1,h[s+1].bk=s;for(s=0;s<L;++s){m(h,s);var d=h[s].err;for(A=++x[0];A>1&&!(h[w=x[B=A>>1]].err<=d);A=B)x[A]=w;x[A]=s}var b=L-a;for(s=0;s<b;){for(var g;;){var q=x[1];if((g=h[q]).tm>=g.mtm&&h[g.nn].mtm<=g.tm)break;65535==g.mtm?q=x[1]=x[x[0]--]:(m(h,q),g.tm=s);d=h[q].err;for(A=1;(B=A+A)<=x[0]&&(B<x[0]&&h[x[B]].err>h[x[B+1]].err&&B++,!(d<=h[w=x[B]].err));A=B)x[A]=w;x[A]=q}var _=h[g.nn],P=g.cnt,I=_.cnt;y=1/(P+I);g.ac=y*(P*g.ac+I*_.ac),g.Lc=y*(P*g.Lc+I*_.Lc),g.Ac=y*(P*g.Ac+I*_.Ac),g.Bc=y*(P*g.Bc+I*_.Bc),g.cnt+=_.cnt,g.mtm=++s,h[_.bk].fw=_.fw,h[_.fw].bk=_.bk,_.mtm=65535}delete x;var U=0;for(s=0;;++U){if((M=new r).alpha=Math.round(Math.clamp(h[s].ac,0,255)),M.L=h[s].Lc,M.A=h[s].Ac,M.B=h[s].Bc,this.palette[U]=i(M),this.m_transparentPixelIndex>=0&&this.palette[U]==this.m_transparentColor){var k=this.palette[0];this.palette[0]=this.palette[U],this.palette[U]=k}if(0==(s=h[s].fw))break}void 0!==this.palette.sort&&this.palette.sort()},t.prototype.quantize_image=function(t,a,e,r,n,i){var h=0;if(i){const i=4,w=20;for(var s=(r+2)*i,l=new Uint32Array(256*i),o=new Uint32Array(512),c=0;c<256;++c)l[c]=0,l[c+256]=c,l[c+512]=255,l[c+768]=255,o[c]=-w,o[c+256]=w;for(c=-w;c<=w;++c)o[c+256]=c;var u=!1,v=new Uint32Array(s),f=new Uint32Array(s),m=new Uint32Array(65536);for(c=0;c<n;++c){var B,L,x;u?(B=-1,h+=r-1,L=f,x=v):(B=1,L=v,x=f);var y=i,d=r*i;x[d]=x[d+1]=x[d+2]=x[d+3]=0;for(var b=0;b<r;b++){var g=255&t[h],q=t[h]>>>8&255,_=t[h]>>>16&255,P=t[h]>>>24&255,I=A(P,g,q,_,l,L,y,this.hasSemiTransparency),U=I[0],k=I[1],C=I[2],S=I[3],T=S<<24|C<<16|k<<8|U,z=p(S,U,k,C,this.hasSemiTransparency);0==m[z]&&(m[z]=M(this.palette,a,T)+1),e[h]=m[z]-1;var Q=this.palette[e[h]],j=255&Q,D=Q>>>8&255,E=Q>>>16&255,F=Q>>>24&255;F<255&&255==P&&(m[z]=M(this.palette,a,t[h])+1,e[h]=m[z]-1),U=o[U-j+256],k=o[k-D+256],C=o[C-E+256],S=o[S-F+256];var G=2*U;x[d-i]=U,x[d+i]+=U+=G,x[d]+=U+=G,L[y+i]+=U+=G,G=2*k,x[d+1-i]=k,x[d+1+i]+=k+=G,x[d+1]+=k+=G,L[y+1+i]+=k+=G,G=2*C,x[d+2-i]=C,x[d+2+i]+=C+=G,x[d+2]+=C+=G,L[y+2+i]+=C+=G,G=2*S,x[d+3-i]=S,x[d+3+i]+=S+=G,x[d+3]+=S+=G,L[y+3+i]+=S+=G,y+=i,d-=i,h+=B}c%2==1&&(h+=r+1),u=!u}return!0}if(this.m_transparentPixelIndex>=0||a<64)for(c=0;c<e.length;++c)e[c]=M(this.palette,a,t[c]);else for(c=0;c<e.length;++c)e[c]=w(this.palette,a,t[c]);return!0},t.prototype.quantizeImage=function(){for(var t=this.opts.pixels,r=this.opts.width,n=this.opts.height,i=this.opts.colors,h=this.opts.dithering,s=0;s<t.length;++s){var l=t[s]>>>24&255;l<255&&(this.hasSemiTransparency=!0,0==l&&(this.m_transparentPixelIndex=s,this.m_transparentColor=t[s]))}var o=new Uint32Array(t.length);this.palette=new Uint32Array(i);var c=i>255;if(i>2?this.pnnquan(t,i,c):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.quantize_image(t,i,o,r,n,h),this.m_transparentPixelIndex>=0){var u=o[this.m_transparentPixelIndex];if(i>2)this.palette[u]=this.m_transparentColor;else if(this.palette[u]!=this.m_transparentColor){var p=this.palette[0];this.palette[0]=this.palette[1],this.palette[1]=p}}return e=[],a=[],function(t,a){for(var e=0;e<a.length;++e)a[e]=t[a[e]];return a}(this.palette,o)},t.prototype.getPalette=function(){return this.palette.buffer},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);