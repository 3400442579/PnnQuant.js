(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[]}Math.clamp||(Math.clamp=function(t,a,e){return this.max(a,this.min(e,t))}),Math.cbrt||(Math.cbrt=function(t){return this.exp(1/3*this.log(t))});var a=1,e=[],r=[];function n(){this.alpha=this.A=this.B=this.L=0}function i(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function h(t){var a,e,r,n=(t.L+16)/116,i=t.A/500+n,h=n-t.B/200;e=-.9689*(i=.95047*(i*i*i>.008856?i*i*i:(i-16/116)/7.787))+1.8758*(n=1*(n*n*n>.008856?n*n*n:(n-16/116)/7.787))+.0415*(h=1.08883*(h*h*h>.008856?h*h*h:(h-16/116)/7.787)),r=.0557*i+-.204*n+1.057*h,a=(a=3.2406*i+-1.5372*n+-.4986*h)>.0031308?1.055*Math.pow(a,1/2.4)-.055:12.92*a,e=e>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r;var s=Math.clamp(t.alpha,0,255);return a=Math.clamp(255*a,0,255),e=Math.clamp(255*e,0,255),s<<24|(r=Math.clamp(255*r,0,255))<<16|e<<8|a}function s(t){return t*(Math.PI/180)}function l(t,a){var e=a.L-t.L,r=(t.L+a.L)/2;return e/(1*(1+.015*f(r-50)/Math.sqrt(20+f(r-50))))}function o(t,a,e,r,n,i){var h=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(a.A*a.A+a.B*a.B))/2,s=.5*(1-Math.sqrt(Math.pow(h,7)/(Math.pow(h,7)+6103515625)));return e.value=(1+s)*t.A,r.value=(1+s)*a.A,n.value=Math.sqrt(e.value*e.value+t.B*t.B),i.value=Math.sqrt(r.value*r.value+a.B*a.B),(i.value-n.value)/(1*(1+.045*((n.value+i.value)/2)))}function u(t,a,e,r,n,i,h,l){var o,u,c,p=s(360),v=s(180),f=n*i;0==t.B&&0==e?o=0:(o=Math.atan2(t.B,e))<0&&(o+=p),0==a.B&&0==r?u=0:(u=Math.atan2(a.B,r))<0&&(u+=p),0==f?c=0:(c=u-o)<-v?c+=p:c>v&&(c-=p);var m=2*Math.sqrt(f)*Math.sin(c/2),M=o+u;n*i==0?l.value=M:Math.abs(o-u)<=v?l.value=M/2:l.value=M<p?(M+p)/2:(M-p)/2,h.value=(n+i)/2;var w=1-.17*Math.cos(l.value-s(30))+.24*Math.cos(2*l.value)+.32*Math.cos(3*l.value+s(6))-.2*Math.cos(4*l.value-s(63));return m/(1*(1+.015*h.value*w))}function c(t,a,e,r){var n=s(30)*Math.exp(-Math.pow((a-s(275))/s(25),2)),i=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625));return-Math.sin(2*n)*i*e*r}function p(t,a){l(t,a);var e={},r={},n={},i={},h=o(t,a,e,r,n,i),s={},p={},v=u(t,a,e.value,r.value,n.value,i.value,s,p);c(s.value,p.value,h,v)}function v(t,a,e,r,n){return n?(240&t)<<8|(240&a)<<4|240&e|r>>4:(248&a)<<8|(252&e)<<3|r>>3}function f(t){return t*t}function m(t,a,e,i){var h=t<<24|i<<16|e<<8|a,s=r[h];return s||(s=function(t,a,e,r){var i,h,s,l=a/255,o=e/255,u=r/255;h=(.2126*(l=l>.04045?Math.pow((l+.055)/1.055,2.4):l/12.92)+.7152*(o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92)+.0722*(u=u>.04045?Math.pow((u+.055)/1.055,2.4):u/12.92))/1,s=(.0193*l+.1192*o+.9505*u)/1.08883,i=(i=(.4124*l+.3576*o+.1805*u)/.95047)>.008856?Math.cbrt(i):7.787*i+16/116,h=h>.008856?Math.cbrt(h):7.787*h+16/116,s=s>.008856?Math.cbrt(s):7.787*s+16/116;var c=new n;return c.alpha=t,c.L=116*h-16,c.A=500*(i-h),c.B=200*(h-s),c}(t,a,e,i),r[h]=s),s}function M(t,e,r){var i=0,h=1e100,s=t[e],p=s.cnt,v=new n;v.alpha=s.ac,v.L=s.Lc,v.A=s.Ac,v.B=s.Bc;for(var m=s.fw;0!=m;m=t[m].fw){var M=t[m].cnt,w=p*M/(p+M);if(!(w>=h)){var A=new n;A.alpha=t[m].ac,A.L=t[m].Lc,A.A=t[m].Ac,A.B=t[m].Bc;var B=A.alpha-v.alpha,L=w*f(B)*B/3;if(!(L>=h||(L+=(1-a)*w*f(A.L-v.L))>=h||(L+=(1-a)*w*f(A.A-v.A))>=h||(L+=(1-a)*w*f(A.B-v.B))>=h)){var g=l(v,A);if(!((L+=a*w*f(g))>=h)){var y={},x={},d={},b={},_=o(v,A,y,x,d,b);if(!((L+=a*w*f(_))>=h)){var q={},I={},P=u(v,A,y.value,x.value,d.value,b.value,q,I);(L+=a*w*f(P))>=h||(L+=a*w*c(q.value,I.value,_,P))>=h||(h=L,i=m)}}}}}s.err=h,s.nn=i}function w(t,a,e){for(var r=0,n=e>>>24&255,i=1e100,h=m(n,255&e,e>>>8&255,e>>>16&255),s=0;s<a;s++){var p=255&t[s],v=t[s]>>>8&255,M=t[s]>>>16&255,w=t[s]>>>24&255,A=f(w-n);if(!(A>i)){var B=m(w,p,v,M);if(a>32){if((A+=f(B.L-h.L))>i)continue;if((A+=f(B.A-h.A))>i)continue;A+=f(B.B-h.B)}else{if((A+=f(l(h,B)))>i)continue;var L={},g={},y={},x={},d=o(h,B,L,g,y,x);if((A+=f(d))>i)continue;var b={},_={},q=u(h,B,L.value,g.value,y.value,x.value,b,_);if((A+=f(q))>i)continue;A+=c(b.value,_.value,d,q)}A>i||(i=A,r=s)}}return r}function A(t,a,r){var n=0,i=255&r,h=r>>>8&255,s=r>>>16&255,l=r>>>24&255,o=e[r];if(!o){(o=[])[2]=o[3]=1e100;for(var u=m(l,i,h,s);n<a;n++){var c=255&t[n],v=t[n]>>>8&255,f=t[n]>>>16&255,M=m(t[n]>>>24&255,c,v,f);o[4]=Math.abs(M.alpha-u.alpha)+p(M,u),o[4]<o[2]?(o[1]=o[0],o[3]=o[2],o[0]=n,o[2]=o[4]):o[4]<o[3]&&(o[1]=n,o[3]=o[4])}1e100==o[3]&&(o[2]=0)}return n=0==o[2]||Math.floor(32769*Math.random())%(o[3]+o[2])<=o[3]?o[0]:o[1],e[r]=o,n}function B(t,a,e,r,n,i,h,s){var l=[];return s?(l[0]=n[(i[h]+4104>>4)+a],l[1]=n[(i[h+1]+4104>>4)+e],l[2]=n[(i[h+2]+4104>>4)+r],l[3]=n[(i[h+3]+4104>>4)+t],l):(l[0]=n[(i[h]+8208>>5)+a],l[1]=n[(i[h+1]+4104>>4)+e],l[2]=n[(i[h+2]+8208>>5)+r],l[3]=t,l)}t.prototype.pnnquan=function(t,e,s){for(var l=new Array(65536),o=0;o<t.length;++o){var u=255&t[o],c=t[o]>>>8&255,p=t[o]>>>16&255,f=t[o]>>>24&255,w=v(f,u,c,p,this.hasSemiTransparency),A=m(f,u,c,p);null==l[w]&&(l[w]=new i),l[w].ac+=f,l[w].Lc+=A.L,l[w].Ac+=A.A,l[w].Bc+=A.B,l[w].cnt++}var B,L,g,y=0,x=new Uint32Array(65537);for(o=0;o<l.length;++o)if(null!=l[o]){var d=1/l[o].cnt;l[o].ac*=d,l[o].Lc*=d,l[o].Ac*=d,l[o].Bc*=d,s&&(l[o].cnt=Math.pow(l[o].cnt,.6)),l[y++]=l[o]}for(o=0;o<y-1;++o)l[o].fw=o+1,l[o+1].bk=o;a=0;for(o=0;o<y;++o){M(l,o);var b=l[o].err;for(L=++x[0];L>1&&!(l[B=x[g=L>>1]].err<=b);L=g)x[L]=B;x[L]=o}a=e<64?Math.min(1,Math.pow(e,2.05)/y):Math.min(1,Math.pow(e,1.05)/Object.keys(r).length);var _=y-e;for(o=0;o<_;){for(var q;;){var I=x[1];if((q=l[I]).tm>=q.mtm&&l[q.nn].mtm<=q.tm)break;65535==q.mtm?I=x[1]=x[x[0]--]:(M(l,I),q.tm=o);b=l[I].err;for(L=1;(g=L+L)<=x[0]&&(g<x[0]&&l[x[g]].err>l[x[g+1]].err&&g++,!(b<=l[B=x[g]].err));L=g)x[L]=B;x[L]=I}var P=l[q.nn],k=q.cnt,U=P.cnt;d=1/(k+U);q.ac=d*(k*q.ac+U*P.ac),q.Lc=d*(k*q.Lc+U*P.Lc),q.Ac=d*(k*q.Ac+U*P.Ac),q.Bc=d*(k*q.Bc+U*P.Bc),q.cnt+=P.cnt,q.mtm=++o,l[P.bk].fw=P.fw,l[P.fw].bk=P.bk,P.mtm=65535}delete x;var T=0;for(o=0;;++T){if((A=new n).alpha=Math.round(Math.clamp(l[o].ac,0,255)),A.L=l[o].Lc,A.A=l[o].Ac,A.B=l[o].Bc,this.palette[T]=h(A),this.m_transparentPixelIndex>=0&&this.palette[T]==this.m_transparentColor){var C=this.palette[0];this.palette[0]=this.palette[T],this.palette[T]=C}if(0==(o=l[o].fw))break}void 0!==this.palette.sort&&this.palette.sort()},t.prototype.quantize_image=function(t,a,e,r,n,i){var h=0;if(i){const i=4,A=20;for(var s=(r+2)*i,l=new Uint32Array(256*i),o=new Uint32Array(512),u=0;u<256;++u)l[u]=0,l[u+256]=u,l[u+512]=255,l[u+768]=255,o[u]=-A,o[u+256]=A;for(u=-A;u<=A;++u)o[u+256]=u;var c=1,p=new Uint32Array(s),v=new Uint32Array(s);for(u=0;u<n;++u){c<0&&(h+=r-1);var f=i,m=r*i;v[m]=v[m+1]=v[m+2]=v[m+3]=0;for(var M=0;M<r;M++){var L=255&t[h],g=t[h]>>>8&255,y=t[h]>>>16&255,x=B(t[h]>>>24&255,L,g,y,l,p,f,this.hasSemiTransparency),d=x[0],b=x[1],_=x[2],q=x[3],I=q<<24|_<<16|b<<8|d;e[h]=w(this.palette,a,I);var P=this.palette[e[h]],k=P>>>8&255,U=P>>>16&255,T=P>>>24&255;d=o[d-(255&P)+256],b=o[b-k+256],_=o[_-U+256],q=o[q-T+256];var C=2*d;v[m-i]=d,v[m+i]+=d+=C,v[m]+=d+=C,p[f+i]+=d+=C,C=2*b,v[m+1-i]=b,v[m+1+i]+=b+=C,v[m+1]+=b+=C,p[f+1+i]+=b+=C,C=2*_,v[m+2-i]=_,v[m+2+i]+=_+=C,v[m+2]+=_+=C,p[f+2+i]+=_+=C,C=2*q,v[m+3-i]=q,v[m+3+i]+=q+=C,v[m+3]+=q+=C,p[f+3+i]+=q+=C,f+=i,m-=i,h+=c}u%2==1&&(h+=r+1),c*=-1;var S=p;p=v,v=S}return!0}if(this.m_transparentPixelIndex>=0||a<64)for(u=0;u<e.length;++u)e[u]=w(this.palette,a,t[u]);else for(u=0;u<e.length;++u)e[u]=A(this.palette,a,t[u]);return!0},t.prototype.quantizeImage=function(){for(var t=this.opts.pixels,a=this.opts.width,n=this.opts.height,i=this.opts.colors,h=this.opts.dithering,s=0;s<t.length;++s){var l=t[s]>>>24&255;l<255&&(this.hasSemiTransparency=!0,0==l&&(this.m_transparentPixelIndex=s,this.m_transparentColor=t[s]))}var o=new Uint32Array(t.length);this.palette=new Uint32Array(i);if(i>2?this.pnnquan(t,i,!0):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.quantize_image(t,i,o,a,n,h),this.m_transparentPixelIndex>=0){var u=o[this.m_transparentPixelIndex];if(i>2)this.palette[u]=this.m_transparentColor;else if(this.palette[u]!=this.m_transparentColor){var c=this.palette[0];this.palette[0]=this.palette[1],this.palette[1]=c}}return r=[],e=[],function(t,a){for(var e=0;e<a.length;++e)a[e]=t[a[e]];return a}(this.palette,o)},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.hasSemiTransparency?"image/png":"image/gif"},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);