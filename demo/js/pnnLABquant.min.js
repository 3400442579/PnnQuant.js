!function(){function t(t){this.opts=t,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=16777215,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,e,a){return this.max(e,this.min(a,t))});var w,Q=15,A=!(Math.randomInt=function(t){return Math.floor(Math.random()*t)}),y=!1,d=.299,R=.587,j=.114,x=.3333,G=1,g=new Map,H=new Map,B=new Map,J=95.047,K=100,V=108.883,W=.008856,X=903.3;function Y(){this.alpha=255,this.A=this.B=this.L=0}var Z=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function $(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function o(t){return W<t?Math.fround(Math.cbrt(t)):Math.fround((X*t+16)/116)}function M(t){return Math.fround(t*(Math.PI/180))}function L(t,e){var a=e.L-t.L,t=(t.L+e.L)/2,e=1+.015*et(t-50)/Math.sqrt(20+et(t-50));return Math.fround(a/e)}function I(t,e,a,n,r,i){var h=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(e.A*e.A+e.B*e.B))/2,h=.5*(1-Math.sqrt(Math.pow(h,7)/(Math.pow(h,7)+6103515625))),h=(a.value=(1+h)*t.A,n.value=(1+h)*e.A,r.value=Math.sqrt(a.value*a.value+t.B*t.B),i.value=Math.sqrt(n.value*n.value+e.B*e.B),i.value-r.value);return Math.fround(h/(1+.045*((r.value+i.value)/2)))}function _(t,e,a,n,r,i,h,s){var o,l,p,u=M(360),c=M(180),f=r*i,t=(0==t.B&&0==a?o=0:(o=Math.atan2(t.B,a))<0&&(o+=u),0==e.B&&0==n?l=0:(l=Math.atan2(e.B,n))<0&&(l+=u),0==f?p=0:(p=l-o)<-c?p+=u:c<p&&(p-=u),2*Math.sqrt(f)*Math.sin(p/2)),a=o+l,e=(r*i==0?s.value=a:Math.abs(o-l)<=c?s.value=a/2:s.value=a<u?(a+u)/2:(a-u)/2,h.value=(r+i)/2,1-.17*Math.cos(s.value-M(30))+.24*Math.cos(2*s.value)+.32*Math.cos(3*s.value+M(6))-.2*Math.cos(4*s.value-M(63))),n=1+.015*h.value*e;return Math.fround(t/n)}function P(t,e,a,n){e=M(30)*Math.exp(-Math.pow((e-M(275))/M(25),2)),t=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625)),e=-Math.sin(2*e)*t;return Math.fround(e*a*n)}function tt(t,e,a,n,r,i){return r?(240&t)<<8|(240&e)<<4|240&a|n>>4:i?(128&t)<<8|(248&e)<<7|(248&a)<<2|n>>3:(248&e)<<8|(252&a)<<3|n>>3}function et(t){return t*t}function at(t,e,a,n){var r,i,h=t<<24|n<<16|a<<8|e,s=H.get(h);return null==s&&(t=t,a=a,n=n,a/=255,n/=255,r=o(100*(.4124*(e=(e=(e=e)/255)<.04045?e/12.92:Math.pow((.055+e)/1.055,2.4))+.3576*(a=a<.04045?a/12.92:Math.pow((.055+a)/1.055,2.4))+.1805*(n=n<.04045?n/12.92:Math.pow((.055+n)/1.055,2.4)))/J),i=o(100*(.2126*e+.7152*a+.0722*n)/K),e=o(100*(.0193*e+.1192*a+.9505*n)/V),(a=new Y).alpha=t,a.L=Math.max(0,116*i-16),a.A=500*(r-i),a.B=200*(i-e),s=a,H.set(h,s)),s}function nt(t,e,a,n){var r=0,i=1e100,e=t[e],h=e.cnt,s=new Y;s.alpha=e.ac,s.L=e.Lc,s.A=e.Ac,s.B=e.Bc;for(var o=e.fw;0!=o;o=t[o].fw){var l=t[o].cnt,l=h*l/(h+l);if(!(i<=l)){var p=new Y;p.alpha=t[o].ac,p.L=t[o].Lc,p.A=t[o].Ac,p.B=t[o].Bc;var u,c,f,M,m,v=l*(y?et(p.alpha-s.alpha)/Math.exp(1.5):0);if(!(i<=v)){if(n){if(i<=(v+=(1-G)*l*Math.abs(p.L-s.L)))continue;v+=(1-G)*l*Math.sqrt(et(p.A-s.A)+et(p.B-s.B))}else{if(i<=(v+=(1-G)*l*et(p.L-s.L)))continue;if(i<=(v+=(1-G)*l*et(p.A-s.A)))continue;v+=(1-G)*l*et(p.B-s.B)}i<=v||(M=L(s,p),i<=(v+=G*l*et(M)))||(f=I(s,p,M={},m={},u={},c={}),i<=(v+=G*l*et(f)))||(m=_(s,p,M.value,m.value,u.value,c.value,p={},M={}),i<=(v+=G*l*et(m)))||i<=(v+=G*l*P(p.value,M.value,f,m))||(i=v,r=o)}}}e.err=Math.fround(i),e.nn=r}function b(t,e){var a=0,n=e>>>24&255,r=(n<=Q&&(n=(e=w)>>>24&255),B.get(e));if(null!=r)return r;2<t.length&&A&&Q<n&&(a=1);for(var i=255&e,h=e>>>8&255,s=e>>>16&255,o=1e100,l=at(n,i,h,s),p=a;p<t.length;++p){var u=255&t[p],c=t[p]>>>8&255,f=t[p]>>>16&255,M=t[p]>>>24&255,m=y?et(M-n)/Math.exp(1.5):0;if(!(o<m)){var v=at(M,u,c,f);if(t.length<=4)m=et(u-i)+et(c-h)+et(f-s),y&&(m+=et(M-n));else if(y){if(o<(m+=et(v.L-l.L)))continue;if(o<(m+=et(v.A-l.A)))continue;m+=et(v.B-l.B)}else if(32<t.length){if(o<(m+=Math.abs(v.L-l.L)))continue;m+=Math.sqrt(et(v.A-l.A)+et(v.B-l.B))}else{if(o<(m+=et(L(l,v))))continue;var u={},c={},f={},M={},d=I(l,v,u,c,f,M);if(o<(m+=et(d)))continue;var x={},g={},v=_(l,v,u.value,c.value,f.value,M.value,x,g);if(o<(m+=et(v)))continue;m+=P(x.value,g.value,d,v)}o<m||(o=m,a=p)}}return B.set(e,a),a}function C(t,e,a){var n=e>>>24&255;if(n<=Q)return b(t,e);var r=255&e,i=e>>>8&255,h=e>>>16&255,s=g.get(e);if(null==s){(s=new Array(4))[2]=s[3]=65535;var o=0;-88<TELL_BLUE_NOISE[4095&a]&&(o=1);for(var l=0;l<t.length;++l){var p=255&t[l],u=t[l]>>>8&255,c=t[l]>>>16&255,f=t[l]>>>24&255,M=(at(f,p,u,c),d*(1-G)*et(p-r));if(!(M>=s[3])&&!((M+=R*(1-G)*et(u-i))>=s[3]||(M+=j*(1-G)*et(c-h))>=s[3])){y&&(M+=x*(1-G)*et(f-n),o=1);for(var m=o;m<Z.length&&!((M+=G*et(Z[m][0]*(p-r)))>=s[3])&&!((M+=G*et(Z[m][1]*(u-i)))>=s[3])&&!((M+=G*et(Z[m][2]*(c-h)))>=s[3]);++m);M<s[2]?(s[1]=s[0],s[3]=s[2],s[0]=l,s[2]=0|M):M<s[3]&&(s[1]=l,s[3]=0|M)}}65535==s[3]&&(s[1]=s[0]),g.set(e,s)}var v=t.length;return R<Z[0][1]&&-88<TELL_BLUE_NOISE[4095&a]||(a=1,s[(a=0==s[2]||Math.randomInt(32767)%(s[3]+s[2])<=s[3]?0:a)+2]>=v)||A&&0==s[a]?b(t,e):s[a]}t.prototype.pnnquan=function(t,e){for(var a=1,n=new Array(65536),E=new Float32Array(t.length),r=0;r<t.length;++r){var i=255&t[r],h=t[r]>>>8&255,s=t[r]>>>16&255,o=t[r]>>>24&255,l=(o<=Q&&(i=255&this.m_transparentColor,h=this.m_transparentColor>>>8&255,s=this.m_transparentColor>>>16&255,o=this.m_transparentColor>>>24&255),tt(o,i,h,s,this.hasSemiTransparency,0<=this.m_transparentPixelIndex)),p=at(o,i,h,s);null==n[l]&&(n[l]=new $),(L=n[l]).ac+=o,L.Lc+=p.L,L.Ac+=p.A,L.Bc+=p.B,L.cnt+=1,Q<o&&e<32&&(E[r]=.1+.9*p.L/100)}this.opts.saliencies=E;for(var u=0,r=0;r<n.length;++r)null!=n[r]&&(T=1/n[r].cnt,n[r].ac*=T,n[r].Lc*=T,n[r].Ac*=T,n[r].Bc*=T,n[u++]=n[r]);var c=et(e)/u,f=((0<=this.m_transparentPixelIndex||this.hasSemiTransparency)&&e<32&&(a=-1),this.opts.weight=Math.min(.9,+e/u));if((f<.001||.0015<f&&f<.0022)&&(a=2),f<.04&&R<1&&R>=Z[0][1]&&(w=Math.exp(1.75)*f,R-=w,j+=w,64<=e)&&(a=0),16<e&&e<64&&Math.abs(e/8e3-f)<.001&&(a=2),H.size<=e){this.palette=new Uint32Array(H.size);var M,m=0;for(M of H.keys())this.palette[m]=M,1<m&&0==(M>>>24&255)&&(this.palette[m]=this.palette[0],this.palette[0]=M,this.palette[m]>>>24&!1)&&(this.palette[m]|=0xff00000000),++m}else{F=e;for(var F,O=0<(g=a)?1<g?function(t){return Math.fround(Math.pow(t,.75))}:F<64?function(t){return 0|Math.sqrt(t)}:function(t){return Math.fround(Math.sqrt(t))}:function(t){return t},v=0;v<u-1;++v)n[v].fw=v+1,n[v+1].bk=v,n[v].cnt=O(n[v].cnt);n[v].cnt=O(n[v].cnt);for(var d,x,g,w,D=.0275<c,A=(G=this.hasSemiTransparency?.5:0!=a&&e<64?.018<c&&c<.022?Math.min(1,c+f*Math.exp(3.13)):.1<c?Math.min(1,1-f):.04<c?Math.min(1,f*Math.exp(1.56)):.025<c&&(f<.002||.0022<f)?Math.min(1,c+f*Math.exp(3.66)):Math.min(1,c+f*Math.exp(1.718)):256<e?Math.min(1,1-1/c):Math.min(1,1-.7*f),!this.hasSemiTransparency&&a<0&&(G=Math.min(1,f*Math.exp(3.13))),new Uint32Array(n.length+1)),r=0;r<u;++r){nt(n,r,0,D);for(var y=n[r].err,B=++A[0];1<B&&!(n[d=A[x=B>>1]].err<=y);B=x)A[B]=d;A[B]=r}0<a&&e<64&&.035<c&&c<.1&&(w=(0<(g=.04<c?1:-1)?.002:.0025)<f&&f<.003?1.872:1.632,G=Math.min(1,c+g*f*Math.exp(w)));for(var L,N=u-e,r=0;r<N;){for(;;){var I=A[1];if((L=n[I]).tm>=L.mtm&&n[L.nn].mtm<=L.tm)break;65535==L.mtm?I=A[1]=A[A[0]--]:(nt(n,I,0,D&&c<1),L.tm=r);y=n[I].err;for(B=1;(x=B+B)<=A[0]&&(x<A[0]&&n[A[x]].err>n[A[x+1]].err&&++x,!(y<=n[d=A[x]].err));B=x)A[B]=d;A[B]=I}var _=n[L.nn],P=L.cnt,q=_.cnt,T=1/(P+q);L.ac=T*(P*L.ac+q*_.ac),L.Lc=T*(P*L.Lc+q*_.Lc),L.Ac=T*(P*L.Ac+q*_.Ac),L.Bc=T*(P*L.Bc+q*_.Bc),L.cnt+=q,L.mtm=++r,n[_.bk].fw=_.fw,n[_.fw].bk=_.bk,_.mtm=65535}N<0&&(this.palette=new Uint32Array(u));for(var b,C,S,U,k,z,m=0,r=0;;++m)if((p=new Y).alpha=this.hasSemiTransparency||0<=this.m_transparentPixelIndex?0|Math.clamp(Math.round(n[r].ac),0,255):255,p.L=n[r].Lc,p.A=n[r].Ac,p.B=n[r].Bc,this.palette[m]=(U=z=C=S=z=C=k=U=S=C=void 0,C=(U=((b=p).L+16)/116)-b.B/200,S=(W<(k=(S=b.A/500+U)*S*S)?k:(116*S-16)/X)*J,U=(X*W<b.L?U*U*U:b.L/X)*K,k=(W<(k=C*C*C)?k:(116*C-16)/X)*V,C=(-.9689*S+1.8758*U+.0415*k)/100,z=(.0557*S+-.204*U+1.057*k)/100,S=.0031308<(S=(3.2406*S+-1.5372*U+-.4986*k)/100)?1.055*Math.pow(S,1/2.4)-.055:12.92*S,C=.0031308<C?1.055*Math.pow(C,1/2.4)-.055:12.92*C,z=.0031308<z?1.055*Math.pow(z,1/2.4)-.055:12.92*z,U=Math.clamp(Math.round(b.alpha),0,255),S=Math.clamp(Math.round(255*S),0,255),C=Math.clamp(Math.round(255*C),0,255),U<<24|Math.clamp(Math.round(255*z),0,255)<<16|C<<8|S),0==(r=n[r].fw))break}},t.prototype.quantize_image=function(t,e,a,n,r){var i=new(256<e?Uint16Array:Uint8Array)(t.length),h=0;if(r){for(var s=256,r=4*(a+2),o=new Int32Array(1024),l=new Int32Array(512),p=0;p<s;++p)o[p]=0,o[p+s]=p,o[p+512]=255,o[p+768]=255,l[p]=-16,l[p+s]=16;for(p=-16;p<=16;++p)l[p+s]=p,16<e&&p%4==3&&(l[p+s]=0);for(var u=this.hasSemiTransparency||e<64,c=1,f=new Int32Array(r),M=new Int32Array(r),m=new Int32Array(65536),p=0;p<n;++p){c<0&&(h+=a-1);for(var v=4,d=4*a,x=M[d]=M[d+1]=M[d+2]=M[d+3]=0;x<a;++x){var g=255&t[h],w=t[h]>>>24&255,A=(B=w,g=g,_=t[h]>>>8&255,T=t[h]>>>16&255,I=o,L=f,y=v,A=u,P=void 0,P=new Int32Array(4),A?(P[0]=I[(L[y]+4104>>4)+g],P[1]=I[(L[y+1]+4104>>4)+_],P[2]=I[(L[y+2]+4104>>4)+T],P[3]=I[(L[y+3]+4104>>4)+B]):(P[0]=I[(L[y]+8208>>5)+g],P[1]=I[(L[y+1]+4104>>4)+_],P[2]=I[(L[y+2]+8208>>5)+T],P[3]=B),P),y=(g=A[3])<<24|(_=A[2])<<16|(I=A[1])<<8|(L=A[0]),B=(u?(0==m[T=tt(g,L,I,_,this.hasSemiTransparency,0<=this.m_transparentPixelIndex)]&&(m[T]=0==w?1:b(this.palette,y)+1),i[h]=m[T]-1):i[h]=0==w?0:C(this.palette,y,p+x),this.palette[i[h]]),L=l[L-(255&B)+s],I=l[I-(B>>>8&255)+s],_=l[_-(B>>>16&255)+s],g=l[g-(B>>>24&255)+s],P=2*L;M[d-4]=L,M[d+4]+=L+=P,M[d]+=L+=P,f[v+4]+=L+P,P=2*I,M[d+1-4]=I,M[d+1+4]+=I+=P,M[d+1]+=I+=P,f[v+1+4]+=I+P,P=2*_,M[d+2-4]=_,M[d+2+4]+=_+=P,M[d+2]+=_+=P,f[v+2+4]+=_+P,P=2*g,M[d+3-4]=g,M[d+3+4]+=g+=P,M[d+3]+=g+=P,f[v+3+4]+=g+P,v+=4,d-=4,h+=c}p%2==1&&(h+=a+1),c*=-1;var q=f,f=M,M=q}}else for(var B,_,T,I,L,y,A,P,p=0;p<i.length;++p)i[p]=this.getDitherFn()(this.palette,t[p],p);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){for(var t,e=this.opts.pixels,a=this.opts.width,n=this.opts.height,r=this.opts.colors,i=this.opts.dithering,h=(this.opts.alphaThreshold&&(Q=this.opts.alphaThreshold),H.clear(),g.clear(),B.clear(),A=!1,0),s=0;s<e.length;++s)(l=e[s]>>>24&255)<224&&(0==l?(this.m_transparentPixelIndex=s,A=!0,2<r?this.m_transparentColor=e[s]:e[s]=this.m_transparentColor):Q<l&&++h);if(this.hasSemiTransparency=y=0<h,r<=32?d=R=j=x=1:(d=Z[0][0],R=Z[0][1],j=Z[0][2]),w=this.m_transparentColor,this.palette=new Uint32Array(r),2<r)this.pnnquan(e,r);else if(0<=this.m_transparentPixelIndex?(this.palette[0]=this.m_transparentColor,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.opts.dithering&&!A){for(var o=new Float32Array(e.length),s=0;s<e.length;++s){var l,p=255&e[s],u=e[s]>>>8&255,c=e[s]>>>16&255,p=at(l=e[s]>>>24&255,p,u,c);o[s]=.1+.9*p.L/100}this.opts.saliencies=o}if(this.opts.dithering||(t=et(r)/H.size,this.opts.weightB=.023<t?1:Math.fround(37.013*t+.906)),y&&(this.opts.weight*=-1),0<=this.m_transparentPixelIndex&&2<this.palette.length&&(t=b(this.palette,e[this.m_transparentPixelIndex],this.m_transparentPixelIndex),this.palette[t]=this.m_transparentColor),this.opts.paletteOnly)return this.opts.ditherFn=this.getDitherFn(),this.opts.getColorIndex=this.getColorIndex,this.opts.palette=this.palette,this.palette;this.quantize_image(e,r,a,n,i);for(var f=this.palette,M=this.qPixels,m=new Uint32Array(M.length),v=0;v<M.length;++v)m[v]=f[M[v]];return m},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return 256<this.opts.colors||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return-1<this.m_transparentPixelIndex?0:-1},t.prototype.getDitherFn=function(){return C},t.prototype.getColorIndex=function(t,e,a,n){return tt(t,e,a,n,this.hasSemiTransparency,0<=this.m_transparentPixelIndex)},t.prototype.getResult=function(){var n=this;return new Promise(function(t,e){var a=n.quantizeImage();n.opts.paletteOnly?t({pal8:a,indexedPixels:n.getIndexedPixels(),transparent:n.getTransparentIndex(),type:n.getImgType()}):t({img8:a,pal8:n.getPalette(),indexedPixels:n.getIndexedPixels(),transparent:n.getTransparentIndex(),type:n.getImgType()})})},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);