(function(){function t(t){this.opts=t,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=16777215,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,a,e){return this.max(a,this.min(e,t))}),Math.randomInt=function(t){return Math.floor(Math.random()*t)};var a,e=15,n=!1,r=!1,i=.299,h=.587,s=.114,o=.3333,l=1,p=new Map,u=new Map,c=new Map,f=95.047,v=100,M=108.883,m=.008856,x=903.3;function d(){this.alpha=255,this.A=this.B=this.L=0}var g=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function w(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function A(t){return t>m?Math.fround(Math.cbrt(t)):Math.fround((x*t+16)/116)}function y(t){var a=(t.L+16)/116,e=t.A/500+a,n=a-t.B/200,r=e*e*e,i=r>m?r:(116*e-16)/x,h=t.L>x*m?a*a*a:t.L/x,s=i*f,o=h*v,l=((r=n*n*n)>m?r:(116*n-16)/x)*M,p=(3.2406*s+-1.5372*o+-.4986*l)/100,u=(-.9689*s+1.8758*o+.0415*l)/100,c=(.0557*s+-.204*o+1.057*l)/100;p=p>.0031308?1.055*Math.pow(p,1/2.4)-.055:12.92*p,u=u>.0031308?1.055*Math.pow(u,1/2.4)-.055:12.92*u,c=c>.0031308?1.055*Math.pow(c,1/2.4)-.055:12.92*c;var d=Math.clamp(Math.round(t.alpha),0,255);return p=Math.clamp(Math.round(255*p),0,255),u=Math.clamp(Math.round(255*u),0,255),d<<24|(c=Math.clamp(Math.round(255*c),0,255))<<16|u<<8|p}function B(t){return Math.fround(t*(Math.PI/180))}function L(t,a){var e=a.L-t.L,n=(t.L+a.L)/2,r=1+.015*T(n-50)/Math.sqrt(20+T(n-50));return Math.fround(e/(1*r))}function I(t,a,e,n,r,i){var h=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(a.A*a.A+a.B*a.B))/2,s=.5*(1-Math.sqrt(Math.pow(h,7)/(Math.pow(h,7)+6103515625)));e.value=(1+s)*t.A,n.value=(1+s)*a.A,r.value=Math.sqrt(e.value*e.value+t.B*t.B),i.value=Math.sqrt(n.value*n.value+a.B*a.B);var o=i.value-r.value,l=1+.045*((r.value+i.value)/2);return Math.fround(o/(1*l))}function P(t,a,e,n,r,i,h,s){var o,l,p,u=B(360),c=B(180),f=r*i;0==t.B&&0==e?o=0:(o=Math.atan2(t.B,e))<0&&(o+=u),0==a.B&&0==n?l=0:(l=Math.atan2(a.B,n))<0&&(l+=u),0==f?p=0:(p=l-o)<-c?p+=u:p>c&&(p-=u);var v=2*Math.sqrt(f)*Math.sin(p/2),M=o+l;r*i==0?s.value=M:Math.abs(o-l)<=c?s.value=M/2:s.value=M<u?(M+u)/2:(M-u)/2,h.value=(r+i)/2;var m=1-.17*Math.cos(s.value-B(30))+.24*Math.cos(2*s.value)+.32*Math.cos(3*s.value+B(6))-.2*Math.cos(4*s.value-B(63)),x=1+.015*h.value*m;return Math.fround(v/(1*x))}function _(t,a,e,n){var r=B(30)*Math.exp(-Math.pow((a-B(275))/B(25),2)),i=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625)),h=-Math.sin(2*r)*i;return Math.fround(h*e*n)}function q(t,a,e,n,r,i){return r?(240&t)<<8|(240&a)<<4|240&e|n>>4:i?(128&t)<<8|(248&a)<<7|(248&e)<<2|n>>3:(248&a)<<8|(252&e)<<3|n>>3}function T(t){return t*t}function b(t,a,e,n){var r,i,h,s,o,l,p,c,m=t<<24|n<<16|e<<8|a,x=u.get(m);return null==x&&(r=t,h=e/255,s=n/255,o=A(100*(.4124*(i=(i=a/255)<.04045?i/12.92:Math.pow((i+.055)/1.055,2.4))+.3576*(h=h<.04045?h/12.92:Math.pow((h+.055)/1.055,2.4))+.1805*(s=s<.04045?s/12.92:Math.pow((s+.055)/1.055,2.4)))/f),l=A(100*(.2126*i+.7152*h+.0722*s)/v),p=A(100*(.0193*i+.1192*h+.9505*s)/M),(c=new d).alpha=r,c.L=Math.max(0,116*l-16),c.A=500*(o-l),c.B=200*(l-p),x=c,u.set(m,x)),x}function C(t,a,e,n){var i=0,h=1e100,s=t[a],o=s.cnt,p=new d;p.alpha=s.ac,p.L=s.Lc,p.A=s.Ac,p.B=s.Bc;for(var u=s.fw;0!=u;u=t[u].fw){var c=t[u].cnt,f=o*c/(o+c);if(!(f>=h)){var v=new d;v.alpha=t[u].ac,v.L=t[u].Lc,v.A=t[u].Ac,v.B=t[u].Bc;var M=f*(r?T(v.alpha-p.alpha)/Math.exp(1.5):0);if(!(M>=h)){if(n){if((M+=(1-l)*f*Math.abs(v.L-p.L))>=h)continue;M+=(1-l)*f*Math.sqrt(T(v.A-p.A)+T(v.B-p.B))}else{if((M+=(1-l)*f*T(v.L-p.L))>=h)continue;if((M+=(1-l)*f*T(v.A-p.A))>=h)continue;M+=(1-l)*f*T(v.B-p.B)}if(!(M>=h)){var m=L(p,v);if(!((M+=l*f*T(m))>=h)){var x={},g={},w={},A={},y=I(p,v,x,g,w,A);if(!((M+=l*f*T(y))>=h)){var B={},q={},b=P(p,v,x.value,g.value,w.value,A.value,B,q);(M+=l*f*T(b))>=h||(M+=l*f*_(B.value,q.value,y,b))>=h||(h=M,i=u)}}}}}}s.err=Math.fround(h),s.nn=i}function S(t,i,h){var s=0,o=i>>>24&255;o<=e&&(o=(i=a)>>>24&255);var l=c.get(i);if(null!=l)return l;t.length>2&&n&&o>e&&(s=1);for(var p=255&i,u=i>>>8&255,f=i>>>16&255,v=1e100,M=b(o,p,u,f),m=s;m<t.length;++m){var x=255&t[m],d=t[m]>>>8&255,g=t[m]>>>16&255,w=t[m]>>>24&255,A=r?T(w-o)/Math.exp(1.5):0;if(!(A>v)){var y=b(w,x,d,g);if(t.length<=4)A=T(x-p)+T(d-u)+T(g-f),r&&(A+=T(w-o));else if(r){if((A+=T(y.L-M.L))>v)continue;if((A+=T(y.A-M.A))>v)continue;A+=T(y.B-M.B)}else if(t.length>32){if((A+=Math.abs(y.L-M.L))>v)continue;A+=Math.sqrt(T(y.A-M.A)+T(y.B-M.B))}else{if((A+=T(L(M,y)))>v)continue;var B={},q={},C={},S={},U=I(M,y,B,q,C,S);if((A+=T(U))>v)continue;var k={},z={},E=P(M,y,B.value,q.value,C.value,S.value,k,z);if((A+=T(E))>v)continue;A+=_(k.value,z.value,U,E)}A>v||(v=A,s=m)}}return c.set(i,s),s}function U(t,a,u){var c=a>>>24&255;if(c<=e)return S(t,a);var f=255&a,v=a>>>8&255,M=a>>>16&255,m=p.get(a);if(null==m){(m=new Array(4))[2]=m[3]=65535;var x=0;TELL_BLUE_NOISE[4095&u]>-88&&(x=1);for(var d=0;d<t.length;++d){var w=255&t[d],A=t[d]>>>8&255,y=t[d]>>>16&255,B=t[d]>>>24&255,L=(b(B,w,A,y),i*(1-l)*T(w-f));if(!(L>=m[3])&&!((L+=h*(1-l)*T(A-v))>=m[3]||(L+=s*(1-l)*T(y-M))>=m[3])){r&&(L+=o*(1-l)*T(B-c),x=1);for(var I=x;I<g.length&&!((L+=l*T(g[I][0]*(w-f)))>=m[3])&&!((L+=l*T(g[I][1]*(A-v)))>=m[3])&&!((L+=l*T(g[I][2]*(y-M)))>=m[3]);++I);L<m[2]?(m[1]=m[0],m[3]=m[2],m[0]=d,m[2]=0|L):L<m[3]&&(m[1]=d,m[3]=0|L)}}65535==m[3]&&(m[1]=m[0]),p.set(a,m)}var P=t.length;if(t.length>32&&(P<<=1,f>240&&v>240&&M>240&&(P>>=1)),h<g[0][1]&&TELL_BLUE_NOISE[4095&u]>-88)return S(t,a);var _=1;return(0==m[2]||Math.randomInt(32767)%(m[3]+m[2])<=m[3])&&(_=0),m[_+2]>=P||n&&0==m[_]?S(t,a):m[_]}function k(t,a,e,n,r,i,h,s){var o=new Int32Array(4);return s?(o[0]=r[(i[h]+4104>>4)+a],o[1]=r[(i[h+1]+4104>>4)+e],o[2]=r[(i[h+2]+4104>>4)+n],o[3]=r[(i[h+3]+4104>>4)+t],o):(o[0]=r[(i[h]+8208>>5)+a],o[1]=r[(i[h+1]+4104>>4)+e],o[2]=r[(i[h+2]+8208>>5)+n],o[3]=t,o)}t.prototype.pnnquan=function(t,a){for(var n=1,r=new Array(65536),i=new Float32Array(t.length),o=0;o<t.length;++o){var p=255&t[o],c=t[o]>>>8&255,f=t[o]>>>16&255,v=t[o]>>>24&255;v<=e&&(p=255&this.m_transparentColor,c=this.m_transparentColor>>>8&255,f=this.m_transparentColor>>>16&255,v=this.m_transparentColor>>>24&255);var M=q(v,p,c,f,this.hasSemiTransparency,this.m_transparentPixelIndex>=0),m=b(v,p,c,f);null==r[M]&&(r[M]=new w),(j=r[M]).ac+=v,j.Lc+=m.L,j.Ac+=m.A,j.Bc+=m.B,j.cnt+=1,v>e&&a<32&&(i[o]=.1+.9*m.L/100)}this.opts.saliencies=i;var x=0;for(o=0;o<r.length;++o)if(null!=r[o]){var A=1/r[o].cnt;r[o].ac*=A,r[o].Lc*=A,r[o].Ac*=A,r[o].Bc*=A,r[x++]=r[o]}var B=T(a)/x;(this.m_transparentPixelIndex>=0||this.hasSemiTransparency)&&a<32&&(n=-1);var L=this.opts.weight=Math.min(.9,1*a/x);if((L<.001||L>.0015&&L<.0022)&&(n=2),L<.04&&h<1&&h>=g[0][1]){var I=Math.exp(1.75)*L;h-=I,s+=I,a>=64&&(n=0)}if(a>16&&a<64){var P=a/8e3;Math.abs(P-L)<.001&&(n=2)}if(u.size<=a){this.palette=new Uint32Array(u.size);var _=0;for(var S of u.keys())this.palette[_]=S,_>1&&0==(S>>>24&255)&&(this.palette[_]=this.palette[0],this.palette[0]=S,this.palette[_]>>>24&!1&&(this.palette[_]|=0xff00000000)),++_}else{for(var U=function(t,a){return a>0?a>1?function(t){return Math.fround(Math.pow(t,.75))}:t<64?function(t){return 0|Math.sqrt(t)}:function(t){return Math.fround(Math.sqrt(t))}:function(t){return t}}(a,n),k=0;k<x-1;++k)r[k].fw=k+1,r[k+1].bk=k,r[k].cnt=U(r[k].cnt);r[k].cnt=U(r[k].cnt);var z,E,F,O=B>.0275;l=this.hasSemiTransparency?.5:0!=n&&a<64?B>.018&&B<.022?Math.min(1,B+L*Math.exp(3.13)):B>.1?Math.min(1,1-L):B>.04?Math.min(1,L*Math.exp(1.56)):B>.033?Math.min(1,B+L*Math.exp(3.66)):Math.min(1,B+L*Math.exp(1.718)):a>256?Math.min(1,1-1/B):Math.min(1,1-.7*L),!this.hasSemiTransparency&&n<0&&(l=Math.min(1,L*Math.exp(3.13)));var D=new Uint32Array(r.length+1);for(o=0;o<x;++o){C(r,o,0,O);var N=r[o].err;for(E=++D[0];E>1&&!(r[z=D[F=E>>1]].err<=N);E=F)D[E]=z;D[E]=o}if(n>0&&a<64&&B>.035&&B<.1){var Q=B>.04?1:-1;I=L>(Q>0?.002:.0025)&&L<.003?1.872:1.632;l=Math.min(1,B+Q*L*Math.exp(I))}var R=x-a;for(o=0;o<R;){for(var j;;){var G=D[1];if((j=r[G]).tm>=j.mtm&&r[j.nn].mtm<=j.tm)break;65535==j.mtm?G=D[1]=D[D[0]--]:(C(r,G,0,O&&B<1),j.tm=o);N=r[G].err;for(E=1;(F=E+E)<=D[0]&&(F<D[0]&&r[D[F]].err>r[D[F+1]].err&&++F,!(N<=r[z=D[F]].err));E=F)D[E]=z;D[E]=G}var H=r[j.nn],J=j.cnt,K=H.cnt;A=1/(J+K);j.ac=A*(J*j.ac+K*H.ac),j.Lc=A*(J*j.Lc+K*H.Lc),j.Ac=A*(J*j.Ac+K*H.Ac),j.Bc=A*(J*j.Bc+K*H.Bc),j.cnt+=K,j.mtm=++o,r[H.bk].fw=H.fw,r[H.fw].bk=H.bk,H.mtm=65535}R<0&&(this.palette=new Uint32Array(x));for(_=0,o=0;;++_){if((m=new d).alpha=this.hasSemiTransparency||this.m_transparentPixelIndex>=0?0|Math.clamp(Math.round(r[o].ac),0,255):255,m.L=r[o].Lc,m.A=r[o].Ac,m.B=r[o].Bc,this.palette[_]=y(m),0==(o=r[o].fw))break}}},t.prototype.quantize_image=function(t,a,e,n,r){var i=a>256?new Uint16Array(t.length):new Uint8Array(t.length),h=0;if(r){const r=4,N=256,Q=16;for(var s=(e+2)*r,o=new Int32Array(r*N),l=new Int32Array(2*N),p=0;p<N;++p)o[p]=0,o[p+N]=p,o[p+2*N]=255,o[p+3*N]=255,l[p]=-Q,l[p+N]=Q;for(p=-Q;p<=Q;++p)l[p+N]=p,a>16&&p%4==3&&(l[p+N]=0);var u=this.hasSemiTransparency||a<64,c=1,f=new Int32Array(s),v=new Int32Array(s),M=new Int32Array(65536);for(p=0;p<n;++p){c<0&&(h+=e-1);var m=r,x=e*r;v[x]=v[x+1]=v[x+2]=v[x+3]=0;for(var d=0;d<e;++d){var g=255&t[h],w=t[h]>>>8&255,A=t[h]>>>16&255,y=t[h]>>>24&255,B=k(y,g,w,A,o,f,m,u),L=B[0],I=B[1],P=B[2],_=B[3],T=_<<24|P<<16|I<<8|L;if(u){var b=q(_,L,I,P,this.hasSemiTransparency,this.m_transparentPixelIndex>=0);0==M[b]&&(M[b]=0==y?1:S(this.palette,T)+1),i[h]=M[b]-1}else i[h]=0==y?0:U(this.palette,T,p+d);var C=this.palette[i[h]],z=C>>>8&255,E=C>>>16&255,F=C>>>24&255;L=l[L-(255&C)+N],I=l[I-z+N],P=l[P-E+N],_=l[_-F+N];var O=2*L;v[x-r]=L,v[x+r]+=L+=O,v[x]+=L+=O,f[m+r]+=L+O,O=2*I,v[x+1-r]=I,v[x+1+r]+=I+=O,v[x+1]+=I+=O,f[m+1+r]+=I+O,O=2*P,v[x+2-r]=P,v[x+2+r]+=P+=O,v[x+2]+=P+=O,f[m+2+r]+=P+O,O=2*_,v[x+3-r]=_,v[x+3+r]+=_+=O,v[x+3]+=_+=O,f[m+3+r]+=_+O,m+=r,x-=r,h+=c}p%2==1&&(h+=e+1),c*=-1;var D=f;f=v,v=D}return this.qPixels=i,this.qPixels}for(p=0;p<i.length;++p)i[p]=this.getDitherFn()(this.palette,t[p],p);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){var t=this.opts.pixels,l=this.opts.width,f=this.opts.height,v=this.opts.colors,M=this.opts.dithering;this.opts.alphaThreshold&&(e=this.opts.alphaThreshold),u.clear(),p.clear(),c.clear(),n=!1;for(var m=0,x=0;x<t.length;++x){var d=t[x]>>>24&255;d<224&&(0==d?(this.m_transparentPixelIndex=x,n=!0,v>2?this.m_transparentColor=t[x]:t[x]=this.m_transparentColor):d>e&&++m)}if(this.hasSemiTransparency=r=m>0,v<=32?i=h=s=o=1:(i=g[0][0],h=g[0][1],s=g[0][2]),a=this.m_transparentColor,this.palette=new Uint32Array(v),v>2?this.pnnquan(t,v):this.m_transparentPixelIndex>=0?(this.palette[0]=this.m_transparentColor,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),!this.opts.dithering){var w=T(v)/u.size;this.opts.weightB=w>.023?1:Math.fround(37.013*w+.906)}if(r&&(this.opts.weight*=-1),this.m_transparentPixelIndex>=0&&this.palette.length>2){var A=S(this.palette,t[this.m_transparentPixelIndex],this.m_transparentPixelIndex);this.palette[A]=this.m_transparentColor}return this.opts.paletteOnly?(this.opts.ditherFn=this.getDitherFn(),this.opts.getColorIndex=this.getColorIndex,this.opts.palette=this.palette,this.palette):(this.quantize_image(t,v,l,f,M),function(t,a){for(var e=new Uint32Array(a.length),n=0;n<a.length;++n)e[n]=t[a[n]];return e}(this.palette,this.qPixels))},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex>-1?0:-1},t.prototype.getDitherFn=function(){return U},t.prototype.getColorIndex=function(t,a,e,n){return q(t,a,e,n,this.hasSemiTransparency,this.m_transparentPixelIndex>=0)},t.prototype.getResult=function(){var t=this;return new Promise(function(a,e){var n=t.quantizeImage();t.opts.paletteOnly?a({pal8:n,indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()}):a({img8:n,pal8:t.getPalette(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()})})},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);
