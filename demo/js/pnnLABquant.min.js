(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,e,a){return this.max(e,this.min(a,t))}),Math.cbrt||(Math.cbrt=function(t){return this.exp(1/3*this.log(t))});var e=0,a=.2126,r=.7152,n=.0722,i=1,s={},h={},l={};function p(){this.alpha=this.A=this.B=this.L=0}function o(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function c(t){var e,a,r,n=(t.L+16)/116,i=t.A/500+n,s=n-t.B/200;a=-.9689*(i=.95047*(i*i*i>.008856?i*i*i:(i-16/116)/7.787))+1.8758*(n=1*(n*n*n>.008856?n*n*n:(n-16/116)/7.787))+.0415*(s=1.08883*(s*s*s>.008856?s*s*s:(s-16/116)/7.787)),r=.0557*i+-.204*n+1.057*s,e=(e=3.2406*i+-1.5372*n+-.4986*s)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:12.92*a,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r;var h=Math.clamp(Math.round(t.alpha),0,255);return e=Math.clamp(Math.round(255*e),0,255),a=Math.clamp(Math.round(255*a),0,255),h<<24|(r=Math.clamp(Math.round(255*r),0,255))<<16|a<<8|e}function u(t){return t*(Math.PI/180)}function v(t,e){var a=e.L-t.L,r=(t.L+e.L)/2;return a/(1*(1+.015*y(r-50)/Math.sqrt(20+y(r-50))))}function f(t,e,a,r,n,i){var s=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(e.A*e.A+e.B*e.B))/2,h=.5*(1-Math.sqrt(Math.pow(s,7)/(Math.pow(s,7)+6103515625)));return a.value=(1+h)*t.A,r.value=(1+h)*e.A,n.value=Math.sqrt(a.value*a.value+t.B*t.B),i.value=Math.sqrt(r.value*r.value+e.B*e.B),(i.value-n.value)/(1*(1+.045*((n.value+i.value)/2)))}function m(t,e,a,r,n,i,s,h){var l,p,o,c=u(360),v=u(180),f=n*i;0==t.B&&0==a?l=0:(l=Math.atan2(t.B,a))<0&&(l+=c),0==e.B&&0==r?p=0:(p=Math.atan2(e.B,r))<0&&(p+=c),0==f?o=0:(o=p-l)<-v?o+=c:o>v&&(o-=c);var m=2*Math.sqrt(f)*Math.sin(o/2),M=l+p;n*i==0?h.value=M:Math.abs(l-p)<=v?h.value=M/2:h.value=M<c?(M+c)/2:(M-c)/2,s.value=(n+i)/2;var x=1-.17*Math.cos(h.value-u(30))+.24*Math.cos(2*h.value)+.32*Math.cos(3*h.value+u(6))-.2*Math.cos(4*h.value-u(63));return m/(1*(1+.015*s.value*x))}function M(t,e,a,r){var n=u(30)*Math.exp(-Math.pow((e-u(275))/u(25),2)),i=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625));return-Math.sin(2*n)*i*a*r}function x(t,e,a,r,n,i){return n?(240&t)<<8|(240&e)<<4|240&a|r>>4:i?(128&t)<<8|(248&e)<<7|(248&a)<<2|r>>3:(248&e)<<8|(252&a)<<3|r>>3}function y(t){return t*t}function d(t,e,a,r){var n=t<<24|r<<16|a<<8|e,i=h[n];return i||(i=function(t,e,a,r){var n,i,s,h=e/255,l=a/255,o=r/255;i=(.2126*(h=h>.04045?Math.pow((h+.055)/1.055,2.4):h/12.92)+.7152*(l=l>.04045?Math.pow((l+.055)/1.055,2.4):l/12.92)+.0722*(o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92))/1,s=(.0193*h+.1192*l+.9505*o)/1.08883,n=(n=(.4124*h+.3576*l+.1805*o)/.95047)>.008856?Math.cbrt(n):7.787*n+16/116,i=i>.008856?Math.cbrt(i):7.787*i+16/116,s=s>.008856?Math.cbrt(s):7.787*s+16/116;var c=new p;return c.alpha=t,c.L=116*i-16,c.A=500*(n-i),c.B=200*(i-s),c}(t,e,a,r),h[n]=i),i}function g(t,e,a){var r=0,n=1e100,s=t[e],h=s.cnt,l=new p;l.alpha=s.ac,l.L=s.Lc,l.A=s.Ac,l.B=s.Bc;for(var o=s.fw;0!=o;o=t[o].fw){var c=t[o].cnt,u=h*c/(h+c);if(!(u>=n)){var x=new p;x.alpha=t[o].ac,x.L=t[o].Lc,x.A=t[o].Ac,x.B=t[o].Bc;var d=u*y(x.alpha-l.alpha)/Math.exp(1.5);if(!(d>=n||(d+=(1-i)*u*y(x.L-l.L))>=n||(d+=(1-i)*u*y(x.A-l.A))>=n||(d+=(1-i)*u*y(x.B-l.B))>=n)){var g=v(l,x);if(!((d+=i*u*y(g))>=n)){var w={},A={},B={},I={},P=f(l,x,w,A,B,I);if(!((d+=i*u*y(P))>=n)){var q={},T={},L=m(l,x,w.value,A.value,B.value,I.value,q,T);(d+=i*u*y(L))>=n||(d+=i*u*M(q.value,T.value,P,L))>=n||(n=d,r=o)}}}}}s.err=n,s.nn=r}function w(t,i,s){var h=l[s];if(null!=h)return h;var p=0,o=255&s,c=s>>>8&255,u=s>>>16&255,x=s>>>24&255;if(x<=e)return p;for(var g=1e100,w=d(x,o,c,u),A=0;A<i;++A){var B=255&t[A],I=t[A]>>>8&255,P=t[A]>>>16&255,q=t[A]>>>24&255,T=this.hasSemiTransparency?y(q-x):0;if(!(T>g)){if(i>32||i<=4||this.hasSemiTransparency){if((T+=a*y(B-o))>g)continue;if((T+=r*y(I-c))>g)continue;if(T+=n*y(P-u),n<1){if(T>g)continue;T+=y((L=d(q,B,I,P)).B-w.B)/2}}else{var L;if((T+=y(v(w,L=d(q,B,I,P))))>g)continue;var _={},b={},S={},k={},U=f(w,L,_,b,S,k);if((T+=y(U))>g)continue;var C={},O={},z=m(w,L,_.value,b.value,S.value,k.value,C,O);if((T+=y(z))>g)continue;T+=M(C.value,O.value,U,z)}T>g||(g=T,p=A)}}return l[s]=p,p}function A(t,e,i){var h,l=0,p=255&i,o=i>>>8&255,c=i>>>16&255,u=i>>>24&255,v=s[i];if(null==v){for((v=new Array(5))[2]=v[3]=65535;l<e;++l){var f=255&t[l],m=t[l]>>>8&255,M=t[l]>>>16&255,x=t[l]>>>24&255,d=a*y(f-p)+r*y(m-o)+n*y(M-c);n>=1&&(d+=y(x-u)),v[4]=d>65535?65535:d,v[4]<v[2]?(v[1]=v[0],v[3]=v[2],v[0]=l,v[2]=v[4]):v[4]<v[3]&&(v[1]=l,v[3]=v[4])}65535==v[3]&&(v[2]=0)}return l=0==v[2]||(h=32767,(Math.floor(Math.random()*h)+1)%(v[3]+v[2])<=v[3])?v[0]:v[1],s[i]=v,l}function B(t,e,a,r,n,i,s,h){var l=new Int32Array(4);return h?(l[0]=n[(i[s]+4104>>4)+e],l[1]=n[(i[s+1]+4104>>4)+a],l[2]=n[(i[s+2]+4104>>4)+r],l[3]=n[(i[s+3]+4104>>4)+t],l):(l[0]=n[(i[s]+8208>>5)+e],l[1]=n[(i[s+1]+4104>>4)+a],l[2]=n[(i[s+2]+8208>>5)+r],l[3]=t,l)}t.prototype.pnnquan=function(t,e,a){for(var r=new Array(65536),n=0;n<t.length;++n){var s=255&t[n],l=t[n]>>>8&255,u=t[n]>>>16&255,v=t[n]>>>24&255,f=x(v,s,l,u,this.hasSemiTransparency,this.m_transparentPixelIndex>=0),m=d(v,s,l,u);null==r[f]&&(r[f]=new o),(b=r[f]).ac+=v,b.Lc+=m.L,b.Ac+=m.A,b.Bc+=m.B,b.cnt+=1}var M=0;for(n=0;n<r.length;++n)if(null!=r[n]){var w=1/r[n].cnt;r[n].ac*=w,r[n].Lc*=w,r[n].Ac*=w,r[n].Bc*=w,r[M++]=r[n]}var A=y(e)/M;(this.m_transparentPixelIndex>=0||this.hasSemiTransparency)&&e<32?a=-1:(A<.018||A>.5)&&e<64&&(a=0);for(var B,I,P,q=0;q<M-1;++q)r[q].fw=q+1,r[q+1].bk=q,a>0&&(r[q].cnt=Math.sqrt(r[q].cnt),e<64&&(r[q].cnt|=0));a>0&&(r[q].cnt=Math.sqrt(r[q].cnt),e<64&&(r[q].cnt|=0)),i=0!=a&&e<64?A>.018&&A<.022?Math.min(1,A+e*Math.exp(4.732)/Object.keys(h).length):Math.min(1,A+e*Math.exp(3.845)/Object.keys(h).length):Math.min(1,A+e*Math.exp(4.732)/Object.keys(h).length),a<0&&(i+=.5,i=Math.min(1,i));var T=new Uint32Array(r.length+1);for(n=0;n<M;++n){g(r,n);var L=r[n].err;for(I=++T[0];I>1&&!(r[B=T[P=I>>1]].err<=L);I=P)T[I]=B;T[I]=n}var _=M-e;for(n=0;n<_;){for(var b;;){var S=T[1];if((b=r[S]).tm>=b.mtm&&r[b.nn].mtm<=b.tm)break;65535==b.mtm?S=T[1]=T[T[0]--]:(g(r,S),b.tm=n);L=r[S].err;for(I=1;(P=I+I)<=T[0]&&(P<T[0]&&r[T[P]].err>r[T[P+1]].err&&++P,!(L<=r[B=T[P]].err));I=P)T[I]=B;T[I]=S}var k=r[b.nn],U=b.cnt,C=k.cnt;w=1/(U+C);b.ac=w*(U*b.ac+C*k.ac),b.Lc=w*(U*b.Lc+C*k.Lc),b.Ac=w*(U*b.Ac+C*k.Ac),b.Bc=w*(U*b.Bc+C*k.Bc),b.cnt+=k.cnt,b.mtm=++n,r[k.bk].fw=k.fw,r[k.fw].bk=k.bk,k.mtm=65535}var O=0;for(n=0;;++O){if((m=new p).alpha=this.hasSemiTransparency||this.m_transparentPixelIndex>=0?0|Math.clamp(Math.round(r[n].ac),0,255):255,m.L=r[n].Lc,m.A=r[n].Ac,m.B=r[n].Bc,this.palette[O]=c(m),this.m_transparentPixelIndex>=0&&0==m.alpha){var z=this.palette[0];this.palette[0]=this.palette[O],this.palette[O]=z}if(0==(n=r[n].fw))break}if(O<e-1){var j=this.palette;this.palette=new Uint32Array(O+2),this.palette[0]=-16777216;for(q=1;q<=O+1;++q)this.palette[q]=j[q-1]}},t.prototype.quantize_image=function(t,e,a,r,n){var i=e>256?new Uint16Array(t.length):new Uint8Array(t.length),s=0;if(n){const n=4,Q=256,R=16;for(var h=(a+2)*n,l=new Int32Array(n*Q),p=new Int32Array(2*Q),o=0;o<Q;++o)l[o]=0,l[o+Q]=o,l[o+2*Q]=255,l[o+3*Q]=255,p[o]=-R,p[o+Q]=R;for(o=-R;o<=R;++o)p[o+Q]=o,e>16&&o%4==3&&(p[o+Q]=0);var c=this.hasSemiTransparency||e<64,u=1,v=new Int32Array(h),f=new Int32Array(h),m=new Int32Array(65536);for(o=0;o<r;++o){u<0&&(s+=a-1);var M=n,y=a*n;f[y]=f[y+1]=f[y+2]=f[y+3]=0;for(var d=0;d<a;++d){var g=255&t[s],I=t[s]>>>8&255,P=t[s]>>>16&255,q=t[s]>>>24&255,T=B(q,g,I,P,l,v,M,c),L=T[0],_=T[1],b=T[2],S=T[3],k=S<<24|b<<16|_<<8|L;if(c){var U=x(S,L,_,b,this.hasSemiTransparency,this.m_transparentPixelIndex>=0);0==m[U]&&(m[U]=0==q?1:w(this.palette,e,k)+1),i[s]=m[U]-1}else i[s]=0==q?0:A(this.palette,e,k);var C=this.palette[i[s]],O=C>>>8&255,z=C>>>16&255,j=C>>>24&255;L=p[L-(255&C)+Q],_=p[_-O+Q],b=p[b-z+Q],S=p[S-j+Q];var D=2*L;f[y-n]=L,f[y+n]+=L+=D,f[y]+=L+=D,v[M+n]+=L+D,D=2*_,f[y+1-n]=_,f[y+1+n]+=_+=D,f[y+1]+=_+=D,v[M+1+n]+=_+D,D=2*b,f[y+2-n]=b,f[y+2+n]+=b+=D,f[y+2]+=b+=D,v[M+2+n]+=b+D,D=2*S,f[y+3-n]=S,f[y+3+n]+=S+=D,f[y+3]+=S+=D,v[M+3+n]+=S+D,M+=n,y-=n,s+=u}o%2==1&&(s+=a+1),u*=-1;var F=v;v=f,f=F}return this.qPixels=i,this.qPixels}if(this.m_transparentPixelIndex>=0||e<64)for(o=0;o<i.length;++o)i[o]=w(this.palette,e,t[o]);else for(o=0;o<i.length;++o)i[o]=A(this.palette,e,t[o]);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){var t=this.opts.pixels,i=this.opts.width,p=this.opts.height,o=this.opts.colors,c=this.opts.dithering;this.opts.alphaThreshold&&(e=this.opts.alphaThreshold),h={},s={},l={};for(var u=0;u<t.length;++u){var v=t[u]>>>24&255;v<255&&(0==v?(this.m_transparentPixelIndex=u,this.m_transparentColor=t[u]=6710835|v<<24):this.hasSemiTransparency=!0)}if(this.hasSemiTransparency?a=r=n=1:(i<512||p<512)&&(a=.299,r=.587,n=.114),this.palette=new Uint32Array(o),o>2?this.pnnquan(t,o,1):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.m_transparentPixelIndex>=0){this.hasSemiTransparency&&(this.opts.divisor=1.5);var f=this.qPixels[this.m_transparentPixelIndex];if(o>2)this.palette[f]=this.m_transparentColor;else if(this.palette[f]!=this.m_transparentColor){var m=this.palette[0];this.palette[0]=this.palette[1],this.palette[1]=m}}return this.hasSemiTransparency&&this.opts.colors<=32||!this.opts.paletteOnly?(this.quantize_image(t,o,i,p,c),function(t,e){for(var a=new Uint32Array(e.length),r=0;r<e.length;++r)a[r]=t[e[r]];return a}(this.palette,this.qPixels)):this.palette},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex>-1?0:-1},t.prototype.getDitherFn=function(){return this.hasSemiTransparency||this.opts.colors<64?w:A},t.prototype.getColorIndex=function(t,e,a,r){return x(t,e,a,r,this.hasSemiTransparency,this.m_transparentPixelIndex>=0)},t.prototype.getResult=function(){var t=this;return new Promise(function(e,a){var r=t.quantizeImage();t.hasSemiTransparency&&t.opts.colors<=32||!t.opts.paletteOnly?e({img8:r,pal8:t.getPalette(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()}):e({pal8:r,indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()})})},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);