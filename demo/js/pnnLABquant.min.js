(function(){function t(t){this.opts=t||{},this.alphaThreshold=0,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,e,a){return this.max(e,this.min(a,t))}),Math.cbrt||(Math.cbrt=function(t){return this.exp(1/3*this.log(t))});var e=.2126,a=.7152,r=.0722,n=1,i={},h={},s={};function l(){this.alpha=this.A=this.B=this.L=0}function p(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function o(t){var e,a,r,n=(t.L+16)/116,i=t.A/500+n,h=n-t.B/200;a=-.9689*(i=.95047*(i*i*i>.008856?i*i*i:(i-16/116)/7.787))+1.8758*(n=1*(n*n*n>.008856?n*n*n:(n-16/116)/7.787))+.0415*(h=1.08883*(h*h*h>.008856?h*h*h:(h-16/116)/7.787)),r=.0557*i+-.204*n+1.057*h,e=(e=3.2406*i+-1.5372*n+-.4986*h)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:12.92*a,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r;var s=Math.clamp(Math.round(t.alpha),0,255);return e=Math.clamp(Math.round(255*e),0,255),a=Math.clamp(Math.round(255*a),0,255),s<<24|(r=Math.clamp(Math.round(255*r),0,255))<<16|a<<8|e}function c(t){return t*(Math.PI/180)}function u(t,e){var a=e.L-t.L,r=(t.L+e.L)/2;return a/(1*(1+.015*x(r-50)/Math.sqrt(20+x(r-50))))}function v(t,e,a,r,n,i){var h=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(e.A*e.A+e.B*e.B))/2,s=.5*(1-Math.sqrt(Math.pow(h,7)/(Math.pow(h,7)+6103515625)));return a.value=(1+s)*t.A,r.value=(1+s)*e.A,n.value=Math.sqrt(a.value*a.value+t.B*t.B),i.value=Math.sqrt(r.value*r.value+e.B*e.B),(i.value-n.value)/(1*(1+.045*((n.value+i.value)/2)))}function f(t,e,a,r,n,i,h,s){var l,p,o,u=c(360),v=c(180),f=n*i;0==t.B&&0==a?l=0:(l=Math.atan2(t.B,a))<0&&(l+=u),0==e.B&&0==r?p=0:(p=Math.atan2(e.B,r))<0&&(p+=u),0==f?o=0:(o=p-l)<-v?o+=u:o>v&&(o-=u);var m=2*Math.sqrt(f)*Math.sin(o/2),M=l+p;n*i==0?s.value=M:Math.abs(l-p)<=v?s.value=M/2:s.value=M<u?(M+u)/2:(M-u)/2,h.value=(n+i)/2;var x=1-.17*Math.cos(s.value-c(30))+.24*Math.cos(2*s.value)+.32*Math.cos(3*s.value+c(6))-.2*Math.cos(4*s.value-c(63));return m/(1*(1+.015*h.value*x))}function m(t,e,a,r){var n=c(30)*Math.exp(-Math.pow((e-c(275))/c(25),2)),i=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625));return-Math.sin(2*n)*i*a*r}function M(t,e,a,r,n,i){return n?(240&t)<<8|(240&e)<<4|240&a|r>>4:i?(128&t)<<8|(248&e)<<7|(248&a)<<2|r>>3:(248&e)<<8|(252&a)<<3|r>>3}function x(t){return t*t}function y(t,e,a,r){var n=t<<24|r<<16|a<<8|e,i=h[n];return i||(i=function(t,e,a,r){var n,i,h,s=e/255,p=a/255,o=r/255;i=(.2126*(s=s>.04045?Math.pow((s+.055)/1.055,2.4):s/12.92)+.7152*(p=p>.04045?Math.pow((p+.055)/1.055,2.4):p/12.92)+.0722*(o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92))/1,h=(.0193*s+.1192*p+.9505*o)/1.08883,n=(n=(.4124*s+.3576*p+.1805*o)/.95047)>.008856?Math.cbrt(n):7.787*n+16/116,i=i>.008856?Math.cbrt(i):7.787*i+16/116,h=h>.008856?Math.cbrt(h):7.787*h+16/116;var c=new l;return c.alpha=t,c.L=116*i-16,c.A=500*(n-i),c.B=200*(i-h),c}(t,e,a,r),h[n]=i),i}function d(t,e,a){var r=0,i=1e100,h=t[e],s=h.cnt,p=new l;p.alpha=h.ac,p.L=h.Lc,p.A=h.Ac,p.B=h.Bc;for(var o=h.fw;0!=o;o=t[o].fw){var c=t[o].cnt,M=s*c/(s+c);if(!(M>=i)){var y=new l;y.alpha=t[o].ac,y.L=t[o].Lc,y.A=t[o].Ac,y.B=t[o].Bc;var d=M*x(y.alpha-p.alpha)/Math.exp(1.5);if(!(d>=i||(d+=(1-n)*M*x(y.L-p.L))>=i||(d+=(1-n)*M*x(y.A-p.A))>=i||(d+=(1-n)*M*x(y.B-p.B))>=i)){var g=u(p,y);if(!((d+=n*M*x(g))>=i)){var w={},A={},B={},I={},P=v(p,y,w,A,B,I);if(!((d+=n*M*x(P))>=i)){var q={},T={},L=f(p,y,w.value,A.value,B.value,I.value,q,T);(d+=n*M*x(L))>=i||(d+=n*M*m(q.value,T.value,P,L))>=i||(i=d,r=o)}}}}}h.err=i,h.nn=r}function g(t,n,i){var h=s[i];if(null!=h)return h;var l=0,p=255&i,o=i>>>8&255,c=i>>>16&255,M=i>>>24&255;if(M<=this.alphaThreshold)return l;for(var d=1e100,g=y(M,p,o,c),w=0;w<n;++w){var A=255&t[w],B=t[w]>>>8&255,I=t[w]>>>16&255,P=t[w]>>>24&255,q=this.hasSemiTransparency?x(P-M)/Math.exp(1.5):0;if(!(q>d)){if(n>32||n<=4||this.hasSemiTransparency){if((q+=e*x(A-p))>d)continue;if((q+=a*x(B-o))>d)continue;if(q+=r*x(I-c),r<1){if(q>d)continue;q+=x((T=y(P,A,B,I)).B-g.B)/2}}else{var T;if((q+=x(u(g,T=y(P,A,B,I))))>d)continue;var L={},_={},b={},S={},k=v(g,T,L,_,b,S);if((q+=x(k))>d)continue;var C={},U={},z=f(g,T,L.value,_.value,b.value,S.value,C,U);if((q+=x(z))>d)continue;q+=m(C.value,U.value,k,z)}q>d||(d=q,l=w)}}return s[i]=l,l}function w(t,n,h){var s,l=0,p=255&h,o=h>>>8&255,c=h>>>16&255,u=h>>>24&255,v=i[h];if(null==v){for((v=new Array(5))[2]=v[3]=65535;l<n;++l){var f=255&t[l],m=t[l]>>>8&255,M=t[l]>>>16&255,y=t[l]>>>24&255,d=e*x(f-p)+a*x(m-o)+r*x(M-c);r>=1&&(d+=x(y-u)),v[4]=d>65535?65535:d,v[4]<v[2]?(v[1]=v[0],v[3]=v[2],v[0]=l,v[2]=v[4]):v[4]<v[3]&&(v[1]=l,v[3]=v[4])}65535==v[3]&&(v[2]=0)}return l=0==v[2]||(s=32767,(Math.floor(Math.random()*s)+1)%(v[3]+v[2])<=v[3])?v[0]:v[1],i[h]=v,l}function A(t,e,a,r,n,i,h,s){var l=new Int32Array(4);return s?(l[0]=n[(i[h]+4104>>4)+e],l[1]=n[(i[h+1]+4104>>4)+a],l[2]=n[(i[h+2]+4104>>4)+r],l[3]=n[(i[h+3]+4104>>4)+t],l):(l[0]=n[(i[h]+8208>>5)+e],l[1]=n[(i[h+1]+4104>>4)+a],l[2]=n[(i[h+2]+8208>>5)+r],l[3]=t,l)}t.prototype.pnnquan=function(t,e,a){for(var r=new Array(65536),i=0;i<t.length;++i){var s=255&t[i],c=t[i]>>>8&255,u=t[i]>>>16&255,v=t[i]>>>24&255,f=M(v,s,c,u,this.hasSemiTransparency,this.m_transparentPixelIndex>=0),m=y(v,s,c,u);null==r[f]&&(r[f]=new p),(b=r[f]).ac+=v,b.Lc+=m.L,b.Ac+=m.A,b.Bc+=m.B,b.cnt+=1}var g=0;for(i=0;i<r.length;++i)if(null!=r[i]){var w=1/r[i].cnt;r[i].ac*=w,r[i].Lc*=w,r[i].Ac*=w,r[i].Bc*=w,r[g++]=r[i]}var A=x(e)/g;(this.m_transparentPixelIndex>=0||this.hasSemiTransparency)&&e<32?a=-1:(A<.018||A>.5)&&e<64&&(a=0);for(var B,I,P,q=0;q<g-1;++q)r[q].fw=q+1,r[q+1].bk=q,a>0&&(r[q].cnt=Math.sqrt(r[q].cnt),e<64&&(r[q].cnt|=0));a>0&&(r[q].cnt=Math.sqrt(r[q].cnt),e<64&&(r[q].cnt|=0)),n=0!=a&&e<64?A>.018&&A<.022?Math.min(1,A+e*Math.exp(4.732)/Object.keys(h).length):Math.min(1,A+e*Math.exp(3.845)/Object.keys(h).length):Math.min(1,A+e*Math.exp(4.732)/Object.keys(h).length),a<0&&(n+=.5,n=Math.min(1,n));var T=new Uint32Array(r.length+1);for(i=0;i<g;++i){d(r,i);var L=r[i].err;for(I=++T[0];I>1&&!(r[B=T[P=I>>1]].err<=L);I=P)T[I]=B;T[I]=i}var _=g-e;for(i=0;i<_;){for(var b;;){var S=T[1];if((b=r[S]).tm>=b.mtm&&r[b.nn].mtm<=b.tm)break;65535==b.mtm?S=T[1]=T[T[0]--]:(d(r,S),b.tm=i);L=r[S].err;for(I=1;(P=I+I)<=T[0]&&(P<T[0]&&r[T[P]].err>r[T[P+1]].err&&++P,!(L<=r[B=T[P]].err));I=P)T[I]=B;T[I]=S}var k=r[b.nn],C=b.cnt,U=k.cnt;w=1/(C+U);b.ac=w*(C*b.ac+U*k.ac),b.Lc=w*(C*b.Lc+U*k.Lc),b.Ac=w*(C*b.Ac+U*k.Ac),b.Bc=w*(C*b.Bc+U*k.Bc),b.cnt+=k.cnt,b.mtm=++i,r[k.bk].fw=k.fw,r[k.fw].bk=k.bk,k.mtm=65535}var z=0;for(i=0;;++z){if((m=new l).alpha=this.hasSemiTransparency||this.m_transparentPixelIndex>=0?0|Math.clamp(Math.round(r[i].ac),0,255):255,m.L=r[i].Lc,m.A=r[i].Ac,m.B=r[i].Bc,this.palette[z]=o(m),this.m_transparentPixelIndex>=0&&this.palette[z]==this.m_transparentColor){var O=this.palette[0];this.palette[0]=this.palette[z],this.palette[z]=O}if(0==(i=r[i].fw))break}if(z<e-1){var j=this.palette;this.palette=new Uint32Array(z+2),this.palette[0]=-16777216;for(q=1;q<=z+1;++q)this.palette[q]=j[q-1]}},t.prototype.quantize_image=function(t,e,a,r,n){var i=e>256?new Uint16Array(t.length):new Uint8Array(t.length),h=0;if(n){const n=4,Q=256,R=16;for(var s=(a+2)*n,l=new Int32Array(n*Q),p=new Int32Array(2*Q),o=0;o<Q;++o)l[o]=0,l[o+Q]=o,l[o+2*Q]=255,l[o+3*Q]=255,p[o]=-R,p[o+Q]=R;for(o=-R;o<=R;++o)p[o+Q]=o,e>16&&o%4==3&&(p[o+Q]=0);var c=this.hasSemiTransparency||e<64,u=1,v=new Int32Array(s),f=new Int32Array(s),m=new Int32Array(65536);for(o=0;o<r;++o){u<0&&(h+=a-1);var x=n,y=a*n;f[y]=f[y+1]=f[y+2]=f[y+3]=0;for(var d=0;d<a;++d){var B=255&t[h],I=t[h]>>>8&255,P=t[h]>>>16&255,q=t[h]>>>24&255,T=A(q,B,I,P,l,v,x,c),L=T[0],_=T[1],b=T[2],S=T[3],k=S<<24|b<<16|_<<8|L;if(c){var C=M(S,L,_,b,this.hasSemiTransparency,this.m_transparentPixelIndex>=0);0==m[C]&&(m[C]=0==q?1:g(this.palette,e,k)+1),i[h]=m[C]-1}else i[h]=0==q?0:w(this.palette,e,k);var U=this.palette[i[h]],z=U>>>8&255,O=U>>>16&255,j=U>>>24&255;L=p[L-(255&U)+Q],_=p[_-z+Q],b=p[b-O+Q],S=p[S-j+Q];var D=2*L;f[y-n]=L,f[y+n]+=L+=D,f[y]+=L+=D,v[x+n]+=L+D,D=2*_,f[y+1-n]=_,f[y+1+n]+=_+=D,f[y+1]+=_+=D,v[x+1+n]+=_+D,D=2*b,f[y+2-n]=b,f[y+2+n]+=b+=D,f[y+2]+=b+=D,v[x+2+n]+=b+D,D=2*S,f[y+3-n]=S,f[y+3+n]+=S+=D,f[y+3]+=S+=D,v[x+3+n]+=S+D,x+=n,y-=n,h+=u}o%2==1&&(h+=a+1),u*=-1;var F=v;v=f,f=F}return this.qPixels=i,this.qPixels}if(this.m_transparentPixelIndex>=0||e<64)for(o=0;o<i.length;++o)i[o]=g(this.palette,e,t[o]);else for(o=0;o<i.length;++o)i[o]=w(this.palette,e,t[o]);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){var t=this.opts.pixels,n=this.opts.width,l=this.opts.height,p=this.opts.colors,o=this.opts.dithering;this.opts.alphaThreshold&&(this.alphaThreshold=this.opts.alphaThreshold),h=[],i=[],s=[];for(var c=0;c<t.length;++c){var u=t[c]>>>24&255;u<255&&(0==u?(this.m_transparentPixelIndex=c,this.m_transparentColor=t[c]):this.hasSemiTransparency=!0)}if(this.hasSemiTransparency?e=a=r=1:(n<512||l<512)&&(e=.299,a=.587,r=.114),this.palette=new Uint32Array(p),p>2?this.pnnquan(t,p,1):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.m_transparentPixelIndex>=0){var v=this.qPixels[this.m_transparentPixelIndex];if(p>2)this.palette[v]=this.m_transparentColor;else if(this.palette[v]!=this.m_transparentColor){var f=this.palette[0];this.palette[0]=this.palette[1],this.palette[1]=f}}return this.opts.paletteOnly?this.palette:(this.quantize_image(t,p,n,l,o),function(t,e){for(var a=new Uint32Array(e.length),r=0;r<e.length;++r)a[r]=t[e[r]];return a}(this.palette,this.qPixels))},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex>-1?0:-1},t.prototype.getDitherFn=function(){return this.hasSemiTransparency||this.opts.colors<64?g:w},t.prototype.getColorIndex=function(t,e,a,r){return M(t,e,a,r,this.hasSemiTransparency,this.m_transparentPixelIndex>=0)},t.prototype.getResult=function(){var t=this;return new Promise(function(e,a){t.opts.paletteOnly?e({pal8:t.quantizeImage(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()}):e({img8:t.quantizeImage(),pal8:t.getPalette(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()})})},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);