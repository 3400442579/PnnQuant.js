(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,a,e){return this.max(a,this.min(e,t))}),Math.cbrt||(Math.cbrt=function(t){return this.exp(1/3*this.log(t))});var a=.299,e=.587,r=.114,n=1,i=[],h=[],s=[];function l(){this.alpha=this.A=this.B=this.L=0}function o(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function c(t){var a,e,r,n=(t.L+16)/116,i=t.A/500+n,h=n-t.B/200;e=-.9689*(i=.95047*(i*i*i>.008856?i*i*i:(i-16/116)/7.787))+1.8758*(n=1*(n*n*n>.008856?n*n*n:(n-16/116)/7.787))+.0415*(h=1.08883*(h*h*h>.008856?h*h*h:(h-16/116)/7.787)),r=.0557*i+-.204*n+1.057*h,a=(a=3.2406*i+-1.5372*n+-.4986*h)>.0031308?1.055*Math.pow(a,1/2.4)-.055:12.92*a,e=e>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r;var s=Math.clamp(t.alpha,0,255);return a=Math.clamp(255*a,0,255),e=Math.clamp(255*e,0,255),s<<24|(r=Math.clamp(255*r,0,255))<<16|e<<8|a}function p(t){return t*(Math.PI/180)}function u(t,a){var e=a.L-t.L,r=(t.L+a.L)/2;return e/(1*(1+.015*w(r-50)/Math.sqrt(20+w(r-50))))}function v(t,a,e,r,n,i){var h=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(a.A*a.A+a.B*a.B))/2,s=.5*(1-Math.sqrt(Math.pow(h,7)/(Math.pow(h,7)+6103515625)));return e.value=(1+s)*t.A,r.value=(1+s)*a.A,n.value=Math.sqrt(e.value*e.value+t.B*t.B),i.value=Math.sqrt(r.value*r.value+a.B*a.B),(i.value-n.value)/(1*(1+.045*((n.value+i.value)/2)))}function f(t,a,e,r,n,i,h,s){var l,o,c,u=p(360),v=p(180),f=n*i;0==t.B&&0==e?l=0:(l=Math.atan2(t.B,e))<0&&(l+=u),0==a.B&&0==r?o=0:(o=Math.atan2(a.B,r))<0&&(o+=u),0==f?c=0:(c=o-l)<-v?c+=u:c>v&&(c-=u);var m=2*Math.sqrt(f)*Math.sin(c/2),M=l+o;n*i==0?s.value=M:Math.abs(l-o)<=v?s.value=M/2:s.value=M<u?(M+u)/2:(M-u)/2,h.value=(n+i)/2;var w=1-.17*Math.cos(s.value-p(30))+.24*Math.cos(2*s.value)+.32*Math.cos(3*s.value+p(6))-.2*Math.cos(4*s.value-p(63));return m/(1*(1+.015*h.value*w))}function m(t,a,e,r){var n=p(30)*Math.exp(-Math.pow((a-p(275))/p(25),2)),i=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625));return-Math.sin(2*n)*i*e*r}function M(t,a,e,r,n){return n?(240&t)<<8|(240&a)<<4|240&e|r>>4:(248&a)<<8|(252&e)<<3|r>>3}function w(t){return t*t}function A(t,a,e,r){var n=t<<24|r<<16|e<<8|a,i=h[n];return i||(i=function(t,a,e,r){var n,i,h,s=a/255,o=e/255,c=r/255;i=(.2126*(s=s>.04045?Math.pow((s+.055)/1.055,2.4):s/12.92)+.7152*(o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92)+.0722*(c=c>.04045?Math.pow((c+.055)/1.055,2.4):c/12.92))/1,h=(.0193*s+.1192*o+.9505*c)/1.08883,n=(n=(.4124*s+.3576*o+.1805*c)/.95047)>.008856?Math.cbrt(n):7.787*n+16/116,i=i>.008856?Math.cbrt(i):7.787*i+16/116,h=h>.008856?Math.cbrt(h):7.787*h+16/116;var p=new l;return p.alpha=t,p.L=116*i-16,p.A=500*(n-i),p.B=200*(i-h),p}(t,a,e,r),h[n]=i),i}function x(t,a,e){var r=0,i=1e100,h=t[a],s=h.cnt,o=new l;o.alpha=h.ac,o.L=h.Lc,o.A=h.Ac,o.B=h.Bc;for(var c=h.fw;0!=c;c=t[c].fw){var p=t[c].cnt,M=s*p/(s+p);if(!(M>=i)){var A=new l;A.alpha=t[c].ac,A.L=t[c].Lc,A.A=t[c].Ac,A.B=t[c].Bc;var x=M*w(A.alpha-o.alpha)/Math.exp(1.7);if(!(x>=i||(x+=(1-n)*M*w(A.L-o.L))>=i||(x+=(1-n)*M*w(A.A-o.A))>=i||(x+=(1-n)*M*w(A.B-o.B))>=i)){var B=u(o,A);if(!((x+=n*M*w(B))>=i)){var q={},y={},g={},L={},P=v(o,A,q,y,g,L);if(!((x+=n*M*w(P))>=i)){var b={},d={},_=f(o,A,q.value,y.value,g.value,L.value,b,d);(x+=n*M*w(_))>=i||(x+=n*M*m(b.value,d.value,P,_))>=i||(i=x,r=c)}}}}}h.err=i,h.nn=r}function B(t,n,i){var h=s[i];if(null!=h)return h;for(var l=0,o=255&i,c=i>>>8&255,p=i>>>16&255,M=i>>>24&255,x=1e100,B=A(M,o,c,p),q=0;q<n;++q){var y=255&t[q],g=t[q]>>>8&255,L=t[q]>>>16&255,P=t[q]>>>24&255,b=w(P-M);if(!(b>x)){var d=A(P,y,g,L);if(n>32||this.hasSemiTransparency){if((b+=a*w(y-o))>x)continue;if((b+=e*w(g-c))>x)continue;if(b+=r*w(L-p),r<1){if(b>x)continue;b+=w(d.B-B.B)/2}}else{if((b+=w(u(B,d)))>x)continue;var _={},I={},k={},T={},U=v(B,d,_,I,k,T);if((b+=w(U))>x)continue;var S={},C={},z=f(B,d,_.value,I.value,k.value,T.value,S,C);if((b+=w(z))>x)continue;b+=m(S.value,C.value,U,z)}b>x||(x=b,l=q)}}return s[i]=l,l}function q(t,a,e){var r=0,n=255&e,h=e>>>8&255,s=e>>>16&255,l=e>>>24&255,o=i[e];if(null==o){(o=[])[2]=o[3]=1e100;for(var c=A(l,n,h,s);r<a;++r){var p=255&t[r],u=t[r]>>>8&255,v=t[r]>>>16&255,f=A(t[r]>>>24&255,p,u,v);o[4]=Math.abs(f.alpha-c.alpha)+Math.abs(f.L-c.L)+Math.abs(f.A-c.A)+Math.abs(f.B-c.B),o[4]<o[2]?(o[1]=o[0],o[3]=o[2],o[0]=r,o[2]=o[4]):o[4]<o[3]&&(o[1]=r,o[3]=o[4])}1e100==o[3]&&(o[2]=0)}return r=0==o[2]||Math.floor(32769*Math.random())%(o[3]+o[2])<=o[3]?o[0]:o[1],i[e]=o,r}function y(t,a,e,r,n,i,h,s){var l=[];return s?(l[0]=n[(i[h]+4104>>4)+a],l[1]=n[(i[h+1]+4104>>4)+e],l[2]=n[(i[h+2]+4104>>4)+r],l[3]=n[(i[h+3]+4104>>4)+t],l):(l[0]=n[(i[h]+8208>>5)+a],l[1]=n[(i[h+1]+4104>>4)+e],l[2]=n[(i[h+2]+8208>>5)+r],l[3]=t,l)}t.prototype.pnnquan=function(t,a,e){for(var r=new Array(65536),i=0;i<t.length;++i){var s=255&t[i],p=t[i]>>>8&255,u=t[i]>>>16&255,v=t[i]>>>24&255,f=M(v,s,p,u,this.hasSemiTransparency),m=A(v,s,p,u);null==r[f]&&(r[f]=new o),(I=r[f]).ac+=v,I.Lc+=m.L,I.Ac+=m.A,I.Bc+=m.B,I.cnt++}var B=0;for(i=0;i<r.length;++i)if(null!=r[i]){var q=1/r[i].cnt;r[i].ac*=q,r[i].Lc*=q,r[i].Ac*=q,r[i].Bc*=q,r[B++]=r[i]}var y,g,L,P=w(a)/B;a<16?e=-1:(P<.022||P>.5)&&a<64&&(e=0),e>0&&(r[0].cnt=0|Math.sqrt(r[0].cnt));for(i=0;i<B-1;++i)r[i].fw=i+1,r[i+1].bk=i,e>0&&(r[i+1].cnt=0|Math.sqrt(r[i+1].cnt));n=0!=e&&a<64?Math.min(1,P+a*Math.exp(3.845)/Object.keys(h).length):e>0?Math.min(1,Math.pow(a,1.05)/Object.keys(h).length):Math.min(1,Math.pow(a,2.31)/B),e<0&&(n+=.5);var b=new Uint32Array(r.length+1);for(i=0;i<B;++i){x(r,i);var d=r[i].err;for(g=++b[0];g>1&&!(r[y=b[L=g>>1]].err<=d);g=L)b[g]=y;b[g]=i}var _=B-a;for(i=0;i<_;){for(var I;;){var k=b[1];if((I=r[k]).tm>=I.mtm&&r[I.nn].mtm<=I.tm)break;65535==I.mtm?k=b[1]=b[b[0]--]:(x(r,k),I.tm=i);d=r[k].err;for(g=1;(L=g+g)<=b[0]&&(L<b[0]&&r[b[L]].err>r[b[L+1]].err&&++L,!(d<=r[y=b[L]].err));g=L)b[g]=y;b[g]=k}var T=r[I.nn],U=I.cnt,S=T.cnt;q=1/(U+S);I.ac=q*(U*I.ac+S*T.ac),I.Lc=q*(U*I.Lc+S*T.Lc),I.Ac=q*(U*I.Ac+S*T.Ac),I.Bc=q*(U*I.Bc+S*T.Bc),I.cnt+=T.cnt,I.mtm=++i,r[T.bk].fw=T.fw,r[T.fw].bk=T.bk,T.mtm=65535}delete b;var C=0;for(i=0;;++C){if((m=new l).alpha=0|Math.clamp(r[i].ac,0,255),m.L=r[i].Lc,m.A=r[i].Ac,m.B=r[i].Bc,this.palette[C]=c(m),this.m_transparentPixelIndex>=0&&this.palette[C]==this.m_transparentColor){var z=this.palette[0];this.palette[0]=this.palette[C],this.palette[C]=z}if(0==(i=r[i].fw))break}void 0!==this.palette.sort&&this.palette.sort()},t.prototype.quantize_image=function(t,a,e,r,n){this.qPixels=new Uint8ClampedArray(t.length);var i=0;if(n){const n=4,z=256,j=16;for(var h=(e+2)*n,s=new Uint32Array(n*z),l=new Uint32Array(2*z),o=0;o<z;++o)s[o]=0,s[o+z]=o,s[o+2*z]=255,s[o+3*z]=255,l[o]=-j,l[o+z]=j;for(o=-j;o<=j;++o)l[o+z]=o;var c=this.hasSemiTransparency||a<64,p=1,u=new Uint32Array(h),v=new Uint32Array(h);for(o=0;o<r;++o){p<0&&(i+=e-1);var f=n,m=e*n;v[m]=v[m+1]=v[m+2]=v[m+3]=0;for(var M=0;M<e;++M){var w=255&t[i],A=t[i]>>>8&255,x=t[i]>>>16&255,g=y(t[i]>>>24&255,w,A,x,s,u,f,c),L=g[0],P=g[1],b=g[2],d=g[3],_=d<<24|b<<16|P<<8|L;this.qPixels[i]=c?B(this.palette,a,_):q(this.palette,a,_);var I=this.palette[this.qPixels[i]],k=I>>>8&255,T=I>>>16&255,U=I>>>24&255;L=l[L-(255&I)+z],P=l[P-k+z],b=l[b-T+z],d=l[d-U+z];var S=2*L;v[m-n]=L,v[m+n]+=L+=S,v[m]+=L+=S,u[f+n]+=L+=S,S=2*P,v[m+1-n]=P,v[m+1+n]+=P+=S,v[m+1]+=P+=S,u[f+1+n]+=P+=S,S=2*b,v[m+2-n]=b,v[m+2+n]+=b+=S,v[m+2]+=b+=S,u[f+2+n]+=b+=S,S=2*d,v[m+3-n]=d,v[m+3+n]+=d+=S,v[m+3]+=d+=S,u[f+3+n]+=d+=S,f+=n,m-=n,i+=p}o%2==1&&(i+=e+1),p*=-1;var C=u;u=v,v=C}return this.qPixels}if(this.m_transparentPixelIndex>=0||a<64)for(o=0;o<this.qPixels.length;++o)this.qPixels[o]=B(this.palette,a,t[o]);else for(o=0;o<this.qPixels.length;++o)this.qPixels[o]=q(this.palette,a,t[o]);return this.qPixels},t.prototype.quantizeImage=function(){for(var t=this.opts.pixels,n=this.opts.width,l=this.opts.height,o=this.opts.colors,c=this.opts.dithering,p=0;p<t.length;++p){var u=t[p]>>>24&255;u<255&&(this.hasSemiTransparency=!0,0==u&&(this.m_transparentPixelIndex=p,this.m_transparentColor=t[p]))}if(this.hasSemiTransparency&&(a=e=r=1),this.palette=new Uint32Array(o),o>2?this.pnnquan(t,o,1):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.quantize_image(t,o,n,l,c),this.m_transparentPixelIndex>=0){var v=qPixels[this.m_transparentPixelIndex];if(o>2)this.palette[v]=this.m_transparentColor;else if(this.palette[v]!=this.m_transparentColor){var f=this.palette[0];this.palette[0]=this.palette[1],this.palette[1]=f}}return h=[],i=[],s=[],function(t,a){for(var e=new Uint32Array(a.length),r=0;r<a.length;++r)e[r]=t[a[r]];return e}(this.palette,this.qPixels)},t.prototype.getPalette=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.hasSemiTransparency?"image/png":"image/gif"},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);