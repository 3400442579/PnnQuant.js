(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,e,a){return this.max(e,this.min(a,t))}),Math.cbrt||(Math.cbrt=function(t){return this.exp(1/3*this.log(t))});var e=0,a=!1,r=.2126,n=.7152,i=.0722,s=1,h={},l={},p={};function o(){this.alpha=this.A=this.B=this.L=0}function c(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function u(t){var e,a,r,n=(t.L+16)/116,i=t.A/500+n,s=n-t.B/200;a=-.9689*(i=.95047*(i*i*i>.008856?i*i*i:(i-16/116)/7.787))+1.8758*(n=1*(n*n*n>.008856?n*n*n:(n-16/116)/7.787))+.0415*(s=1.08883*(s*s*s>.008856?s*s*s:(s-16/116)/7.787)),r=.0557*i+-.204*n+1.057*s,e=(e=3.2406*i+-1.5372*n+-.4986*s)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:12.92*a,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r;var h=Math.clamp(Math.round(t.alpha),0,255);return e=Math.clamp(Math.round(255*e),0,255),a=Math.clamp(Math.round(255*a),0,255),h<<24|(r=Math.clamp(Math.round(255*r),0,255))<<16|a<<8|e}function v(t){return t*(Math.PI/180)}function f(t,e){var a=e.L-t.L,r=(t.L+e.L)/2;return a/(1*(1+.015*d(r-50)/Math.sqrt(20+d(r-50))))}function m(t,e,a,r,n,i){var s=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(e.A*e.A+e.B*e.B))/2,h=.5*(1-Math.sqrt(Math.pow(s,7)/(Math.pow(s,7)+6103515625)));return a.value=(1+h)*t.A,r.value=(1+h)*e.A,n.value=Math.sqrt(a.value*a.value+t.B*t.B),i.value=Math.sqrt(r.value*r.value+e.B*e.B),(i.value-n.value)/(1*(1+.045*((n.value+i.value)/2)))}function x(t,e,a,r,n,i,s,h){var l,p,o,c=v(360),u=v(180),f=n*i;0==t.B&&0==a?l=0:(l=Math.atan2(t.B,a))<0&&(l+=c),0==e.B&&0==r?p=0:(p=Math.atan2(e.B,r))<0&&(p+=c),0==f?o=0:(o=p-l)<-u?o+=c:o>u&&(o-=c);var m=2*Math.sqrt(f)*Math.sin(o/2),x=l+p;n*i==0?h.value=x:Math.abs(l-p)<=u?h.value=x/2:h.value=x<c?(x+c)/2:(x-c)/2,s.value=(n+i)/2;var M=1-.17*Math.cos(h.value-v(30))+.24*Math.cos(2*h.value)+.32*Math.cos(3*h.value+v(6))-.2*Math.cos(4*h.value-v(63));return m/(1*(1+.015*s.value*M))}function M(t,e,a,r){var n=v(30)*Math.exp(-Math.pow((e-v(275))/v(25),2)),i=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625));return-Math.sin(2*n)*i*a*r}function y(t,e,a,r,n,i){return n?(240&t)<<8|(240&e)<<4|240&a|r>>4:i?(128&t)<<8|(248&e)<<7|(248&a)<<2|r>>3:(248&e)<<8|(252&a)<<3|r>>3}function d(t){return t*t}function g(t,e,a,r){var n=t<<24|r<<16|a<<8|e,i=l[n];return i||(i=function(t,e,a,r){var n,i,s,h=e/255,l=a/255,p=r/255;i=(.2126*(h=h>.04045?Math.pow((h+.055)/1.055,2.4):h/12.92)+.7152*(l=l>.04045?Math.pow((l+.055)/1.055,2.4):l/12.92)+.0722*(p=p>.04045?Math.pow((p+.055)/1.055,2.4):p/12.92))/1,s=(.0193*h+.1192*l+.9505*p)/1.08883,n=(n=(.4124*h+.3576*l+.1805*p)/.95047)>.008856?Math.cbrt(n):7.787*n+16/116,i=i>.008856?Math.cbrt(i):7.787*i+16/116,s=s>.008856?Math.cbrt(s):7.787*s+16/116;var c=new o;return c.alpha=t,c.L=116*i-16,c.A=500*(n-i),c.B=200*(i-s),c}(t,e,a,r),l[n]=i),i}function w(t,e,a){var r=0,n=1e100,i=t[e],h=i.cnt,l=new o;l.alpha=i.ac,l.L=i.Lc,l.A=i.Ac,l.B=i.Bc;for(var p=i.fw;0!=p;p=t[p].fw){var c=t[p].cnt,u=h*c/(h+c);if(!(u>=n)){var v=new o;v.alpha=t[p].ac,v.L=t[p].Lc,v.A=t[p].Ac,v.B=t[p].Bc;var y=u*d(v.alpha-l.alpha)/Math.exp(1.5);if(!(y>=n||(y+=(1-s)*u*d(v.L-l.L))>=n||(y+=(1-s)*u*d(v.A-l.A))>=n||(y+=(1-s)*u*d(v.B-l.B))>=n)){var g=f(l,v);if(!((y+=s*u*d(g))>=n)){var w={},A={},B={},I={},P=m(l,v,w,A,B,I);if(!((y+=s*u*d(P))>=n)){var q={},L={},_=x(l,v,w.value,A.value,B.value,I.value,q,L);(y+=s*u*d(_))>=n||(y+=s*u*M(q.value,L.value,P,_))>=n||(n=y,r=p)}}}}}i.err=n,i.nn=r}function A(t,s,h){var l=p[h];if(null!=l)return l;var o=0,c=255&h,u=h>>>8&255,v=h>>>16&255,y=h>>>24&255;if(y<=e)return o;for(var w=1e100,A=g(y,c,u,v),B=0;B<s;++B){var I=255&t[B],P=t[B]>>>8&255,q=t[B]>>>16&255,L=t[B]>>>24&255,_=a?d(L-y):0;if(!(_>w)){if(s>32||s<=4||a){if((_+=r*d(I-c))>w)continue;if((_+=n*d(P-u))>w)continue;if(_+=i*d(q-v),i<1){if(_>w)continue;_+=d((T=g(L,I,P,q)).B-A.B)/2}}else{var T;if((_+=d(f(A,T=g(L,I,P,q))))>w)continue;var b={},S={},k={},C={},U=m(A,T,b,S,k,C);if((_+=d(U))>w)continue;var O={},z={},j=x(A,T,b.value,S.value,k.value,C.value,O,z);if((_+=d(j))>w)continue;_+=M(O.value,z.value,U,j)}_>w||(w=_,o=B)}}return p[h]=o,o}function B(t,e,a){var s,l=0,p=255&a,o=a>>>8&255,c=a>>>16&255,u=a>>>24&255,v=h[a];if(null==v){for((v=new Array(5))[2]=v[3]=65535;l<e;++l){var f=255&t[l],m=t[l]>>>8&255,x=t[l]>>>16&255,M=t[l]>>>24&255,y=r*d(f-p)+n*d(m-o)+i*d(x-c);i>=1&&(y+=d(M-u)),v[4]=y>65535?65535:y,v[4]<v[2]?(v[1]=v[0],v[3]=v[2],v[0]=l,v[2]=v[4]):v[4]<v[3]&&(v[1]=l,v[3]=v[4])}65535==v[3]&&(v[2]=0)}return l=0==v[2]||(s=32767,(Math.floor(Math.random()*s)+1)%(v[3]+v[2])<=v[3])?v[0]:v[1],h[a]=v,l}function I(t,e,a,r,n,i,s,h){var l=new Int32Array(4);return h?(l[0]=n[(i[s]+4104>>4)+e],l[1]=n[(i[s+1]+4104>>4)+a],l[2]=n[(i[s+2]+4104>>4)+r],l[3]=n[(i[s+3]+4104>>4)+t],l):(l[0]=n[(i[s]+8208>>5)+e],l[1]=n[(i[s+1]+4104>>4)+a],l[2]=n[(i[s+2]+8208>>5)+r],l[3]=t,l)}t.prototype.pnnquan=function(t,e,a){for(var r=new Array(65536),n=0;n<t.length;++n){var i=255&t[n],h=t[n]>>>8&255,p=t[n]>>>16&255,v=t[n]>>>24&255,f=y(v,i,h,p,this.hasSemiTransparency,this.m_transparentPixelIndex>=0),m=g(v,i,h,p);null==r[f]&&(r[f]=new c),(b=r[f]).ac+=v,b.Lc+=m.L,b.Ac+=m.A,b.Bc+=m.B,b.cnt+=1}var x=0;for(n=0;n<r.length;++n)if(null!=r[n]){var M=1/r[n].cnt;r[n].ac*=M,r[n].Lc*=M,r[n].Ac*=M,r[n].Bc*=M,r[x++]=r[n]}var A=d(e)/x;(this.m_transparentPixelIndex>=0||this.hasSemiTransparency)&&e<32?a=-1:(A<.018||A>.5)&&e<64&&(a=0);for(var B,I,P,q=0;q<x-1;++q)r[q].fw=q+1,r[q+1].bk=q,a>0&&(r[q].cnt=Math.sqrt(r[q].cnt),e<64&&(r[q].cnt|=0));a>0&&(r[q].cnt=Math.sqrt(r[q].cnt),e<64&&(r[q].cnt|=0)),s=0!=a&&e<64?A>.018&&A<.022?Math.min(1,A+e*Math.exp(4.732)/Object.keys(l).length):Math.min(1,A+e*Math.exp(3.845)/Object.keys(l).length):Math.min(1,A+e*Math.exp(4.732)/Object.keys(l).length),a<0&&(s+=.5,s=Math.min(1,s));var L=new Uint32Array(r.length+1);for(n=0;n<x;++n){w(r,n);var _=r[n].err;for(I=++L[0];I>1&&!(r[B=L[P=I>>1]].err<=_);I=P)L[I]=B;L[I]=n}var T=x-e;for(n=0;n<T;){for(var b;;){var S=L[1];if((b=r[S]).tm>=b.mtm&&r[b.nn].mtm<=b.tm)break;65535==b.mtm?S=L[1]=L[L[0]--]:(w(r,S),b.tm=n);_=r[S].err;for(I=1;(P=I+I)<=L[0]&&(P<L[0]&&r[L[P]].err>r[L[P+1]].err&&++P,!(_<=r[B=L[P]].err));I=P)L[I]=B;L[I]=S}var k=r[b.nn],C=b.cnt,U=k.cnt;M=1/(C+U);b.ac=M*(C*b.ac+U*k.ac),b.Lc=M*(C*b.Lc+U*k.Lc),b.Ac=M*(C*b.Ac+U*k.Ac),b.Bc=M*(C*b.Bc+U*k.Bc),b.cnt+=k.cnt,b.mtm=++n,r[k.bk].fw=k.fw,r[k.fw].bk=k.bk,k.mtm=65535}var O=0;for(n=0;;++O){if((m=new o).alpha=this.hasSemiTransparency||this.m_transparentPixelIndex>=0?0|Math.clamp(Math.round(r[n].ac),0,255):255,m.L=r[n].Lc,m.A=r[n].Ac,m.B=r[n].Bc,this.palette[O]=u(m),this.m_transparentPixelIndex>=0&&0==m.alpha){var z=this.palette[0];this.palette[0]=this.m_transparentColor,this.palette[O]=z}if(0==(n=r[n].fw))break}if(O<e-1){var j=this.palette;this.palette=new Uint32Array(O+2);q=0;for(this.m_transparentPixelIndex>=0&&(this.palette[q++]=j[q]),this.palette[q++]=-16777216;q<=O+1;++q)this.palette[q]=j[q-1]}},t.prototype.quantize_image=function(t,e,a,r,n){var i=e>256?new Uint16Array(t.length):new Uint8Array(t.length),s=0;if(n){const n=4,Q=256,R=16;for(var h=(a+2)*n,l=new Int32Array(n*Q),p=new Int32Array(2*Q),o=0;o<Q;++o)l[o]=0,l[o+Q]=o,l[o+2*Q]=255,l[o+3*Q]=255,p[o]=-R,p[o+Q]=R;for(o=-R;o<=R;++o)p[o+Q]=o,e>16&&o%4==3&&(p[o+Q]=0);var c=this.hasSemiTransparency||e<64,u=1,v=new Int32Array(h),f=new Int32Array(h),m=new Int32Array(65536);for(o=0;o<r;++o){u<0&&(s+=a-1);var x=n,M=a*n;f[M]=f[M+1]=f[M+2]=f[M+3]=0;for(var d=0;d<a;++d){var g=255&t[s],w=t[s]>>>8&255,P=t[s]>>>16&255,q=t[s]>>>24&255,L=I(q,g,w,P,l,v,x,c),_=L[0],T=L[1],b=L[2],S=L[3],k=S<<24|b<<16|T<<8|_;if(c){var C=y(S,_,T,b,this.hasSemiTransparency,this.m_transparentPixelIndex>=0);0==m[C]&&(m[C]=0==q?1:A(this.palette,e,k)+1),i[s]=m[C]-1}else i[s]=0==q?0:B(this.palette,e,k);var U=this.palette[i[s]],O=U>>>8&255,z=U>>>16&255,j=U>>>24&255;_=p[_-(255&U)+Q],T=p[T-O+Q],b=p[b-z+Q],S=p[S-j+Q];var D=2*_;f[M-n]=_,f[M+n]+=_+=D,f[M]+=_+=D,v[x+n]+=_+D,D=2*T,f[M+1-n]=T,f[M+1+n]+=T+=D,f[M+1]+=T+=D,v[x+1+n]+=T+D,D=2*b,f[M+2-n]=b,f[M+2+n]+=b+=D,f[M+2]+=b+=D,v[x+2+n]+=b+D,D=2*S,f[M+3-n]=S,f[M+3+n]+=S+=D,f[M+3]+=S+=D,v[x+3+n]+=S+D,x+=n,M-=n,s+=u}o%2==1&&(s+=a+1),u*=-1;var F=v;v=f,f=F}return this.qPixels=i,this.qPixels}if(this.m_transparentPixelIndex>=0||e<64)for(o=0;o<i.length;++o)i[o]=A(this.palette,e,t[o]);else for(o=0;o<i.length;++o)i[o]=B(this.palette,e,t[o]);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){var t=this.opts.pixels,s=this.opts.width,o=this.opts.height,c=this.opts.colors,u=this.opts.dithering;this.opts.alphaThreshold&&(e=this.opts.alphaThreshold),l={},h={},p={};for(var v=t.length-1;v>=0;--v){var f=t[v]>>>24&255;f<255&&(0==f?(this.m_transparentColor=t[v],this.m_transparentPixelIndex=v,0==this.m_transparentColor&&(t[v]=this.m_transparentColor=6710835|f<<24)):this.hasSemiTransparency=!0)}if(this.hasSemiTransparency?r=n=i=1:(s<512||o<512)&&(r=.299,n=.587,i=.114),a=this.hasSemiTransparency,this.palette=new Uint32Array(c),c>2?this.pnnquan(t,c,1):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.m_transparentPixelIndex>=0){this.hasSemiTransparency&&(this.opts.divisor=1.5);var m=this.qPixels[this.m_transparentPixelIndex];if(c>2)this.palette[m]=this.m_transparentColor;else if(this.palette[m]!=this.m_transparentColor){var x=this.palette[0];this.palette[0]=this.palette[1],this.palette[1]=x}}return this.opts.paletteOnly?this.palette:(this.quantize_image(t,c,s,o,u),function(t,e){for(var a=new Uint32Array(e.length),r=0;r<e.length;++r)a[r]=t[e[r]];return a}(this.palette,this.qPixels))},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex>-1?0:-1},t.prototype.getDitherFn=function(){return this.hasSemiTransparency||this.opts.colors<64?A:B},t.prototype.getColorIndex=function(t,e,a,r){return y(t,e,a,r,this.hasSemiTransparency,this.m_transparentPixelIndex>=0)},t.prototype.getResult=function(){var t=this;return new Promise(function(e,a){var r=t.quantizeImage();t.opts.paletteOnly?e({pal8:r,indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()}):e({img8:r,pal8:t.getPalette(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()})})},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);