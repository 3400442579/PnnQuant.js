(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[]}function a(){this.alpha=this.A=this.B=this.L=0}function e(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function r(t,e,r,n){var i,h,s,l=e/255,o=r/255,c=n/255;l=l>.04045?Math.pow((l+.055)/1.055,2.4):l/12.92,o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,c=c>.04045?Math.pow((c+.055)/1.055,2.4):c/12.92,i=(.4124*l+.3576*o+.1805*c)/.95047,h=(.2126*l+.7152*o+.0722*c)/1,s=(.0193*l+.1192*o+.9505*c)/1.08883,i=i>.008856?Math.cbrt(i):7.787*i+16/116,h=h>.008856?Math.cbrt(h):7.787*h+16/116,s=s>.008856?Math.cbrt(s):7.787*s+16/116;var u=new a;return u.alpha=t,u.L=116*h-16,u.A=500*(i-h),u.B=200*(h-s),u}function n(t){var a,e,r,n=(t.L+16)/116,i=t.A/500+n,h=n-t.B/200;i=.95047*(i*i*i>.008856?i*i*i:(i-16/116)/7.787),n=1*(n*n*n>.008856?n*n*n:(n-16/116)/7.787),h=1.08883*(h*h*h>.008856?h*h*h:(h-16/116)/7.787),a=3.2406*i+-1.5372*n+h*-.4986,e=i*-.9689+1.8758*n+.0415*h,r=.0557*i+n*-.204+1.057*h,a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:12.92*a,e=e>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r;var s=Math.clamp(t.alpha,0,255);return a=Math.clamp(255*a,0,255),e=Math.clamp(255*e,0,255),r=Math.clamp(255*r,0,255),s<<24|r<<16|e<<8|a}function i(t){return t*(Math.PI/180)}function h(t,a){const e=1;var r=a.L-t.L,n=(t.L+a.L)/2,i=1+.015*v(n-50)/Math.sqrt(20+v(n-50));return r/(e*i)}function s(t,a,e,r,n,i){const h=1,s=6103515625;var l=Math.sqrt(t.A*t.A+t.B*t.B),o=Math.sqrt(a.A*a.A+a.B*a.B),c=(l+o)/2,u=.5*(1-Math.sqrt(Math.pow(c,7)/(Math.pow(c,7)+s)));e.value=(1+u)*t.A,r.value=(1+u)*a.A,n.value=Math.sqrt(e.value*e.value+t.B*t.B),i.value=Math.sqrt(r.value*r.value+a.B*a.B);var v=i.value-n.value,p=(n.value+i.value)/2,f=1+.045*p;return v/(h*f)}function l(t,a,e,r,n,h,s,l){const o=1;var c,u=i(360),v=i(180),p=n*h;0==t.B&&0==e?c=0:(c=Math.atan2(t.B,e),0>c&&(c+=u));var f;0==a.B&&0==r?f=0:(f=Math.atan2(a.B,r),0>f&&(f+=u));var m;0==p?m=0:(m=f-c,-v>m?m+=u:m>v&&(m-=u));var M=2*Math.sqrt(p)*Math.sin(m/2),w=c+f;n*h==0?l.value=w:Math.abs(c-f)<=v?l.value=w/2:u>w?l.value=(w+u)/2:l.value=(w-u)/2,s.value=(n+h)/2;var A=1-.17*Math.cos(l.value-i(30))+.24*Math.cos(2*l.value)+.32*Math.cos(3*l.value+i(6))-.2*Math.cos(4*l.value-i(63)),B=1+.015*s.value*A;return M/(o*B)}function o(t,a,e,r){const n=6103515625;var h=i(30)*Math.exp(-Math.pow((a-i(275))/i(25),2)),s=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+n)),l=-Math.sin(2*h)*s;return l*e*r}function c(t,a){var e=(h(t,a),{}),r={},n={},i={},c=s(t,a,e,r,n,i),u={},v={},p=l(t,a,e.value,r.value,n.value,i.value,u,v);o(u.value,v.value,c,p)}function u(t,a,e,r,n){return n?(240&t)<<8|(240&a)<<4|240&e|r>>4:(248&a)<<8|(252&e)<<3|r>>3}function v(t){return t*t}function p(t,a,e,n){var i=t<<24|n<<16|e<<8|a,h=x[i];return h||(h=r(t,a,e,n),x[i]=h),h}function f(t,e,r){var n=0,i=1e100,c=t[e],u=c.cnt,p=new a;p.alpha=c.ac,p.L=c.Lc,p.A=c.Ac,p.B=c.Bc;for(var f=Math.random()<d,m=c.fw;0!=m;m=t[m].fw){var M=t[m].cnt,w=u*M/(u+M);if(!(w>=i)){var A=new a;A.alpha=t[m].ac,A.L=t[m].Lc,A.A=t[m].Ac,A.B=t[m].Bc;var B=A.alpha-p.alpha,y=w*v(B)*B/3;if(!(y>=i)){if(f){var L=h(p,A);if(y+=w*v(L),y>=i)continue;var g={},x={},b={},q={},_=s(p,A,g,x,b,q);if(y+=w*v(_),y>=i)continue;var I={},P={},T=l(p,A,g.value,x.value,b.value,q.value,I,P);if(y+=w*v(T),y>=i)continue;y+=w*o(I.value,P.value,_,T)}else{if(y+=w*v(A.L-p.L),y>=i)continue;if(y+=w*v(A.A-p.A),y>=i)continue;y+=w*v(A.B-p.B)}y>=i||(i=y,n=m)}}}c.err=i,c.nn=n}function m(t,a,e){for(var r=0,n=255&e,i=e>>>8&255,c=e>>>16&255,u=e>>>24&255,f=1e100,m=p(u,n,i,c),M=0;a>M;M++){var w=255&t[M],A=t[M]>>>8&255,d=t[M]>>>16&255,g=t[M]>>>24&255,x=v(g-u);if(!(x>f)){if(a>32){if(x+=B*v(w-n),x>f)continue;if(x+=y*v(A-i),x>f)continue;x+=L*v(d-c)}else{var b=p(g,w,A,d),q=h(m,b);if(x+=v(q),x>f)continue;var _={},I={},P={},T={},U=s(m,b,_,I,P,T);if(x+=v(U),x>f)continue;var k={},S={},C=l(m,b,_.value,I.value,P.value,T.value,k,S);if(x+=v(C),x>f)continue;x+=o(k.value,S.value,U,C)}x>f||(f=x,r=M)}}return r}function M(t,a,e){var r=0,n=255&e,i=e>>>8&255,h=e>>>16&255,s=e>>>24&255,l=g[e];if(!l){l=[],l[2]=l[3]=1e100;for(var o=p(s,n,i,h);a>r;r++){var u=255&t[r],v=t[r]>>>8&255,f=t[r]>>>16&255,m=t[r]>>>24&255,M=p(m,u,v,f);l[4]=Math.abs(M.alpha-o.alpha)+c(M,o),l[4]<l[2]?(l[1]=l[0],l[3]=l[2],l[0]=r,l[2]=l[4]):l[4]<l[3]&&(l[1]=r,l[3]=l[4])}1e100==l[3]&&(l[2]=0)}return r=0==l[2]||Math.floor(32769*Math.random())%(l[3]+l[2])<=l[3]?l[0]:l[1],g[e]=l,r}function w(t,a,e,r,n,i,h,s){var l=[];return s?(l[0]=n[(i[h]+4104>>4)+a],l[1]=n[(i[h+1]+4104>>4)+e],l[2]=n[(i[h+2]+4104>>4)+r],l[3]=n[(i[h+3]+4104>>4)+t],l):(l[0]=n[(i[h]+8208>>5)+a],l[1]=n[(i[h+1]+4104>>4)+e],l[2]=n[(i[h+2]+8208>>5)+r],l[3]=t,l)}function A(t,a){for(var e=0;e<a.length;++e)a[e]=t[a[e]];return a}Math.clamp=function(t,a,e){return this.max(a,this.min(e,t))},Math.cbrt||(Math.cbrt=function(t){return this.exp(1/3*this.log(t))});var B=.2126,y=.7152,L=.0722,d=1,g=[],x=[];t.prototype.pnnquan=function(t,r,i){for(var h=new Array(65536),s=0;s<t.length;++s){var l=255&t[s],o=t[s]>>>8&255,c=t[s]>>>16&255,v=t[s]>>>24&255,m=u(v,l,o,c,this.hasSemiTransparency),M=p(v,l,o,c);null==h[m]&&(h[m]=new e),h[m].ac+=v,h[m].Lc+=M.L,h[m].Ac+=M.A,h[m].Bc+=M.B,h[m].cnt++}for(var w=0,A=new Uint32Array(65537),s=0;s<h.length;++s)if(null!=h[s]){var B=1/h[s].cnt;h[s].ac*=B,h[s].Lc*=B,h[s].Ac*=B,h[s].Bc*=B,i&&(h[s].cnt=Math.sqrt(h[s].cnt)),h[w++]=h[s]}for(var s=0;w-1>s;++s)h[s].fw=s+1,h[s+1].bk=s;var y,L,g;d=0;for(var s=0;w>s;++s){f(h,s,r);var x=h[s].err;for(L=++A[0];L>1&&(g=L>>1,!(h[y=A[g]].err<=x));L=g)A[L]=y;A[L]=s}d=.003125*r;for(var b=w-r,s=0;b>s;){for(var q;;){var _=A[1];if(q=h[_],q.tm>=q.mtm&&h[q.nn].mtm<=q.tm)break;65535==q.mtm?_=A[1]=A[A[0]--]:(f(h,_,r),q.tm=s);var x=h[_].err;for(L=1;(g=L+L)<=A[0]&&(g<A[0]&&h[A[g]].err>h[A[g+1]].err&&g++,!(x<=h[y=A[g]].err));L=g)A[L]=y;A[L]=_}var I=h[q.nn],P=q.cnt,T=I.cnt,B=1/(P+T);q.ac=B*(P*q.ac+T*I.ac),q.Lc=B*(P*q.Lc+T*I.Lc),q.Ac=B*(P*q.Ac+T*I.Ac),q.Bc=B*(P*q.Bc+T*I.Bc),q.cnt+=I.cnt,q.mtm=++s,h[I.bk].fw=I.fw,h[I.fw].bk=I.bk,I.mtm=65535}delete A;for(var U=0,s=0;;++U){var M=new a;if(M.alpha=Math.round(Math.clamp(h[s].ac,0,255)),M.L=h[s].Lc,M.A=h[s].Ac,M.B=h[s].Bc,this.palette[U]=n(M),this.m_transparentPixelIndex>=0&&this.palette[U]==this.m_transparentColor){var k=this.palette[0];this.palette[0]=this.palette[U],this.palette[U]=k}if(0==(s=h[s].fw))break}"undefined"!=typeof this.palette.sort&&this.palette.sort()},t.prototype.quantize_image=function(t,a,e,r,n,i){var h=0;if(i){const s=4,l=20;for(var o=(r+2)*s,c=new Uint32Array(1024),v=new Uint32Array(512),p=0;256>p;++p)c[p]=0,c[p+256]=p,c[p+512]=255,c[p+768]=255,v[p]=-20,v[p+256]=l;for(var p=-20;l>=p;++p)v[p+256]=p;for(var f=!1,A=new Uint32Array(o),B=new Uint32Array(o),y=new Uint32Array(65536),p=0;n>p;++p){var L,d,g;f?(L=-1,h+=r-1,d=B,g=A):(L=1,d=A,g=B);var x=s,b=r*s;g[b]=g[b+1]=g[b+2]=g[b+3]=0;for(var q=0;r>q;q++){var _=255&t[h],I=t[h]>>>8&255,P=t[h]>>>16&255,T=t[h]>>>24&255,U=w(T,_,I,P,c,d,x,this.hasSemiTransparency),k=U[0],S=U[1],C=U[2],z=U[3],Q=z<<24|C<<16|S<<8|k,j=u(z,k,S,C,this.hasSemiTransparency);0==y[j]&&(y[j]=m(this.palette,a,Q)+1),e[h]=y[j]-1;var D=this.palette[e[h]],E=255&D,F=D>>>8&255,G=D>>>16&255,H=D>>>24&255;255>H&&255==T&&(y[j]=m(this.palette,a,t[h])+1,e[h]=y[j]-1),k=v[k-E+256],S=v[S-F+256],C=v[C-G+256],z=v[z-H+256];var J=2*k;g[b-s]=k,g[b+s]+=k+=J,g[b]+=k+=J,d[x+s]+=k+=J,J=2*S,g[b+1-s]=S,g[b+1+s]+=S+=J,g[b+1]+=S+=J,d[x+1+s]+=S+=J,J=2*C,g[b+2-s]=C,g[b+2+s]+=C+=J,g[b+2]+=C+=J,d[x+2+s]+=C+=J,J=2*z,g[b+3-s]=z,g[b+3+s]+=z+=J,g[b+3]+=z+=J,d[x+3+s]+=z+=J,x+=s,b-=s,h+=L}p%2==1&&(h+=r+1),f=!f}return!0}if(this.m_transparentPixelIndex>=0||64>a)for(var p=0;p<e.length;++p)e[p]=m(this.palette,a,t[p]);else for(var p=0;p<e.length;++p)e[p]=M(this.palette,a,t[p]);return!0},t.prototype.quantizeImage=function(){for(var t=this.opts.pixels,a=this.opts.width,e=this.opts.height,r=this.opts.colors,n=this.opts.dithering,i=0;i<t.length;++i){var h=t[i]>>>24&255;255>h&&(this.hasSemiTransparency=!0,0==h&&(this.m_transparentPixelIndex=i,this.m_transparentColor=t[i]))}var s=new Uint32Array(t.length);this.hasSemiTransparency&&(B=y=L=1),this.palette=new Uint32Array(r);var l=Math.random()<r/64;if(r>2?this.pnnquan(t,r,l):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.quantize_image(t,r,s,a,e,n),this.m_transparentPixelIndex>=0){var o=s[this.m_transparentPixelIndex];if(r>2)this.palette[o]=this.m_transparentColor;else if(this.palette[o]!=this.m_transparentColor){var c=this.palette[0];this.palette[0]=this.palette[1],this.palette[1]=c}}return x=[],g=[],A(this.palette,s)},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.hasSemiTransparency?"image/png":"image/gif"},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);