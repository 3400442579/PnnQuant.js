(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,e,a){return this.max(e,this.min(a,t))}),Math.cbrt||(Math.cbrt=function(t){return this.exp(1/3*this.log(t))});var e=0,a=.2126,n=.7152,r=.0722,i=1,s={},h={},l={};function p(){this.alpha=this.A=this.B=this.L=0}function o(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function c(t){var e,a,n,r=(t.L+16)/116,i=t.A/500+r,s=r-t.B/200;a=-.9689*(i=.95047*(i*i*i>.008856?i*i*i:(i-16/116)/7.787))+1.8758*(r=1*(r*r*r>.008856?r*r*r:(r-16/116)/7.787))+.0415*(s=1.08883*(s*s*s>.008856?s*s*s:(s-16/116)/7.787)),n=.0557*i+-.204*r+1.057*s,e=(e=3.2406*i+-1.5372*r+-.4986*s)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:12.92*a,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n;var h=Math.clamp(Math.round(t.alpha),0,255);return e=Math.clamp(Math.round(255*e),0,255),a=Math.clamp(Math.round(255*a),0,255),h<<24|(n=Math.clamp(Math.round(255*n),0,255))<<16|a<<8|e}function u(t){return t*(Math.PI/180)}function v(t,e){var a=e.L-t.L,n=(t.L+e.L)/2;return a/(1*(1+.015*y(n-50)/Math.sqrt(20+y(n-50))))}function f(t,e,a,n,r,i){var s=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(e.A*e.A+e.B*e.B))/2,h=.5*(1-Math.sqrt(Math.pow(s,7)/(Math.pow(s,7)+6103515625)));return a.value=(1+h)*t.A,n.value=(1+h)*e.A,r.value=Math.sqrt(a.value*a.value+t.B*t.B),i.value=Math.sqrt(n.value*n.value+e.B*e.B),(i.value-r.value)/(1*(1+.045*((r.value+i.value)/2)))}function m(t,e,a,n,r,i,s,h){var l,p,o,c=u(360),v=u(180),f=r*i;0==t.B&&0==a?l=0:(l=Math.atan2(t.B,a))<0&&(l+=c),0==e.B&&0==n?p=0:(p=Math.atan2(e.B,n))<0&&(p+=c),0==f?o=0:(o=p-l)<-v?o+=c:o>v&&(o-=c);var m=2*Math.sqrt(f)*Math.sin(o/2),M=l+p;r*i==0?h.value=M:Math.abs(l-p)<=v?h.value=M/2:h.value=M<c?(M+c)/2:(M-c)/2,s.value=(r+i)/2;var x=1-.17*Math.cos(h.value-u(30))+.24*Math.cos(2*h.value)+.32*Math.cos(3*h.value+u(6))-.2*Math.cos(4*h.value-u(63));return m/(1*(1+.015*s.value*x))}function M(t,e,a,n){var r=u(30)*Math.exp(-Math.pow((e-u(275))/u(25),2)),i=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625));return-Math.sin(2*r)*i*a*n}function x(t,e,a,n,r,i){return r?(240&t)<<8|(240&e)<<4|240&a|n>>4:i?(128&t)<<8|(248&e)<<7|(248&a)<<2|n>>3:(248&e)<<8|(252&a)<<3|n>>3}function y(t){return t*t}function d(t,e,a,n){var r=t<<24|n<<16|a<<8|e,i=h[r];return i||(i=function(t,e,a,n){var r,i,s,h=e/255,l=a/255,o=n/255;i=(.2126*(h=h>.04045?Math.pow((h+.055)/1.055,2.4):h/12.92)+.7152*(l=l>.04045?Math.pow((l+.055)/1.055,2.4):l/12.92)+.0722*(o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92))/1,s=(.0193*h+.1192*l+.9505*o)/1.08883,r=(r=(.4124*h+.3576*l+.1805*o)/.95047)>.008856?Math.cbrt(r):7.787*r+16/116,i=i>.008856?Math.cbrt(i):7.787*i+16/116,s=s>.008856?Math.cbrt(s):7.787*s+16/116;var c=new p;return c.alpha=t,c.L=116*i-16,c.A=500*(r-i),c.B=200*(i-s),c}(t,e,a,n),h[r]=i),i}function g(t,e,a){var n=0,r=1e100,s=t[e],h=s.cnt,l=new p;l.alpha=s.ac,l.L=s.Lc,l.A=s.Ac,l.B=s.Bc;for(var o=s.fw;0!=o;o=t[o].fw){var c=t[o].cnt,u=h*c/(h+c);if(!(u>=r)){var x=new p;x.alpha=t[o].ac,x.L=t[o].Lc,x.A=t[o].Ac,x.B=t[o].Bc;var d=u*y(x.alpha-l.alpha)/Math.exp(1.5);if(!(d>=r||(d+=(1-i)*u*y(x.L-l.L))>=r||(d+=(1-i)*u*y(x.A-l.A))>=r||(d+=(1-i)*u*y(x.B-l.B))>=r)){var g=v(l,x);if(!((d+=i*u*y(g))>=r)){var w={},A={},B={},I={},P=f(l,x,w,A,B,I);if(!((d+=i*u*y(P))>=r)){var q={},L={},T=m(l,x,w.value,A.value,B.value,I.value,q,L);(d+=i*u*y(T))>=r||(d+=i*u*M(q.value,L.value,P,T))>=r||(r=d,n=o)}}}}}s.err=r,s.nn=n}function w(t,i,s){var h=l[s];if(null!=h)return h;var p=0,o=255&s,c=s>>>8&255,u=s>>>16&255,x=s>>>24&255;if(x<=e)return p;for(var g=1e100,w=d(x,o,c,u),A=0;A<i;++A){var B=255&t[A],I=t[A]>>>8&255,P=t[A]>>>16&255,q=t[A]>>>24&255,L=this.hasSemiTransparency?y(q-x):0;if(!(L>g)){if(i>32||i<=4||this.hasSemiTransparency){if((L+=a*y(B-o))>g)continue;if((L+=n*y(I-c))>g)continue;if(L+=r*y(P-u),r<1){if(L>g)continue;L+=y((T=d(q,B,I,P)).B-w.B)/2}}else{var T;if((L+=y(v(w,T=d(q,B,I,P))))>g)continue;var _={},b={},S={},k={},U=f(w,T,_,b,S,k);if((L+=y(U))>g)continue;var z={},C={},O=m(w,T,_.value,b.value,S.value,k.value,z,C);if((L+=y(O))>g)continue;L+=M(z.value,C.value,U,O)}L>g||(g=L,p=A)}}return l[s]=p,p}function A(t,e,i){var h,l=0,p=255&i,o=i>>>8&255,c=i>>>16&255,u=i>>>24&255,v=s[i];if(null==v){for((v=new Array(5))[2]=v[3]=65535;l<e;++l){var f=255&t[l],m=t[l]>>>8&255,M=t[l]>>>16&255,x=t[l]>>>24&255,d=a*y(f-p)+n*y(m-o)+r*y(M-c);r>=1&&(d+=y(x-u)),v[4]=d>65535?65535:d,v[4]<v[2]?(v[1]=v[0],v[3]=v[2],v[0]=l,v[2]=v[4]):v[4]<v[3]&&(v[1]=l,v[3]=v[4])}65535==v[3]&&(v[2]=0)}return l=0==v[2]||(h=32767,(Math.floor(Math.random()*h)+1)%(v[3]+v[2])<=v[3])?v[0]:v[1],s[i]=v,l}function B(t,e,a,n,r,i,s,h){var l=new Int32Array(4);return h?(l[0]=r[(i[s]+4104>>4)+e],l[1]=r[(i[s+1]+4104>>4)+a],l[2]=r[(i[s+2]+4104>>4)+n],l[3]=r[(i[s+3]+4104>>4)+t],l):(l[0]=r[(i[s]+8208>>5)+e],l[1]=r[(i[s+1]+4104>>4)+a],l[2]=r[(i[s+2]+8208>>5)+n],l[3]=t,l)}t.prototype.pnnquan=function(t,e,a){for(var n=new Array(65536),r=0;r<t.length;++r){var s=255&t[r],l=t[r]>>>8&255,u=t[r]>>>16&255,v=t[r]>>>24&255,f=x(v,s,l,u,this.hasSemiTransparency,this.m_transparentPixelIndex>=0),m=d(v,s,l,u);null==n[f]&&(n[f]=new o),(b=n[f]).ac+=v,b.Lc+=m.L,b.Ac+=m.A,b.Bc+=m.B,b.cnt+=1}var M=0;for(r=0;r<n.length;++r)if(null!=n[r]){var w=1/n[r].cnt;n[r].ac*=w,n[r].Lc*=w,n[r].Ac*=w,n[r].Bc*=w,n[M++]=n[r]}var A=y(e)/M;(this.m_transparentPixelIndex>=0||this.hasSemiTransparency)&&e<32?a=-1:(A<.018||A>.5)&&e<64&&(a=0);for(var B,I,P,q=0;q<M-1;++q)n[q].fw=q+1,n[q+1].bk=q,a>0&&(n[q].cnt=Math.sqrt(n[q].cnt),e<64&&(n[q].cnt|=0));a>0&&(n[q].cnt=Math.sqrt(n[q].cnt),e<64&&(n[q].cnt|=0)),i=0!=a&&e<64?A>.018&&A<.022?Math.min(1,A+e*Math.exp(4.732)/Object.keys(h).length):Math.min(1,A+e*Math.exp(3.845)/Object.keys(h).length):Math.min(1,A+e*Math.exp(4.732)/Object.keys(h).length),a<0&&(i+=.5,i=Math.min(1,i));var L=new Uint32Array(n.length+1);for(r=0;r<M;++r){g(n,r);var T=n[r].err;for(I=++L[0];I>1&&!(n[B=L[P=I>>1]].err<=T);I=P)L[I]=B;L[I]=r}var _=M-e;for(r=0;r<_;){for(var b;;){var S=L[1];if((b=n[S]).tm>=b.mtm&&n[b.nn].mtm<=b.tm)break;65535==b.mtm?S=L[1]=L[L[0]--]:(g(n,S),b.tm=r);T=n[S].err;for(I=1;(P=I+I)<=L[0]&&(P<L[0]&&n[L[P]].err>n[L[P+1]].err&&++P,!(T<=n[B=L[P]].err));I=P)L[I]=B;L[I]=S}var k=n[b.nn],U=b.cnt,z=k.cnt;w=1/(U+z);b.ac=w*(U*b.ac+z*k.ac),b.Lc=w*(U*b.Lc+z*k.Lc),b.Ac=w*(U*b.Ac+z*k.Ac),b.Bc=w*(U*b.Bc+z*k.Bc),b.cnt+=k.cnt,b.mtm=++r,n[k.bk].fw=k.fw,n[k.fw].bk=k.bk,k.mtm=65535}var C=0;for(r=0;;++C){if((m=new p).alpha=this.hasSemiTransparency||this.m_transparentPixelIndex>=0?0|Math.clamp(Math.round(n[r].ac),0,255):255,m.L=n[r].Lc,m.A=n[r].Ac,m.B=n[r].Bc,this.palette[C]=c(m),this.m_transparentPixelIndex>=0&&0==v){var O=this.palette[0];this.palette[0]=this.palette[C],this.palette[C]=O}if(0==(r=n[r].fw))break}if(C<e-1){var j=this.palette;this.palette=new Uint32Array(C+2),this.palette[0]=-16777216;for(q=1;q<=C+1;++q)this.palette[q]=j[q-1]}},t.prototype.quantize_image=function(t,e,a,n,r){var i=e>256?new Uint16Array(t.length):new Uint8Array(t.length),s=0;if(r){const r=4,Q=256,R=16;for(var h=(a+2)*r,l=new Int32Array(r*Q),p=new Int32Array(2*Q),o=0;o<Q;++o)l[o]=0,l[o+Q]=o,l[o+2*Q]=255,l[o+3*Q]=255,p[o]=-R,p[o+Q]=R;for(o=-R;o<=R;++o)p[o+Q]=o,e>16&&o%4==3&&(p[o+Q]=0);var c=this.hasSemiTransparency||e<64,u=1,v=new Int32Array(h),f=new Int32Array(h),m=new Int32Array(65536);for(o=0;o<n;++o){u<0&&(s+=a-1);var M=r,y=a*r;f[y]=f[y+1]=f[y+2]=f[y+3]=0;for(var d=0;d<a;++d){var g=255&t[s],I=t[s]>>>8&255,P=t[s]>>>16&255,q=t[s]>>>24&255,L=B(q,g,I,P,l,v,M,c),T=L[0],_=L[1],b=L[2],S=L[3],k=S<<24|b<<16|_<<8|T;if(c){var U=x(S,T,_,b,this.hasSemiTransparency,this.m_transparentPixelIndex>=0);0==m[U]&&(m[U]=0==q?1:w(this.palette,e,k)+1),i[s]=m[U]-1}else i[s]=0==q?0:A(this.palette,e,k);var z=this.palette[i[s]],C=z>>>8&255,O=z>>>16&255,j=z>>>24&255;T=p[T-(255&z)+Q],_=p[_-C+Q],b=p[b-O+Q],S=p[S-j+Q];var D=2*T;f[y-r]=T,f[y+r]+=T+=D,f[y]+=T+=D,v[M+r]+=T+D,D=2*_,f[y+1-r]=_,f[y+1+r]+=_+=D,f[y+1]+=_+=D,v[M+1+r]+=_+D,D=2*b,f[y+2-r]=b,f[y+2+r]+=b+=D,f[y+2]+=b+=D,v[M+2+r]+=b+D,D=2*S,f[y+3-r]=S,f[y+3+r]+=S+=D,f[y+3]+=S+=D,v[M+3+r]+=S+D,M+=r,y-=r,s+=u}o%2==1&&(s+=a+1),u*=-1;var F=v;v=f,f=F}return this.qPixels=i,this.qPixels}if(this.m_transparentPixelIndex>=0||e<64)for(o=0;o<i.length;++o)i[o]=w(this.palette,e,t[o]);else for(o=0;o<i.length;++o)i[o]=A(this.palette,e,t[o]);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){var t=this.opts.pixels,i=this.opts.width,p=this.opts.height,o=this.opts.colors,c=this.opts.dithering;this.opts.alphaThreshold&&(e=this.opts.alphaThreshold),h={},s={},l={};for(var u=0;u<t.length;++u){var v=t[u]>>>24&255;v<255&&(0==v?(this.m_transparentPixelIndex=u,this.m_transparentColor=t[u]):this.hasSemiTransparency=!0)}if(this.hasSemiTransparency?a=n=r=1:(i<512||p<512)&&(a=.299,n=.587,r=.114),this.palette=new Uint32Array(o),o>2?this.pnnquan(t,o,1):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.m_transparentPixelIndex>=0){this.hasSemiTransparency&&(this.opts.divisor=1.5);var f=this.qPixels[this.m_transparentPixelIndex];if(o>2)this.palette[f]=this.m_transparentColor;else if(this.palette[f]!=this.m_transparentColor){var m=this.palette[0];this.palette[0]=this.palette[1],this.palette[1]=m}}return this.opts.paletteOnly?this.palette:(this.quantize_image(t,o,i,p,c),function(t,e){for(var a=new Uint32Array(e.length),n=0;n<e.length;++n)a[n]=t[e[n]];return a}(this.palette,this.qPixels))},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex>-1?0:-1},t.prototype.getDitherFn=function(){return this.hasSemiTransparency||this.opts.colors<64?w:A},t.prototype.getColorIndex=function(t,e,a,n){return x(t,e,a,n,this.hasSemiTransparency,this.m_transparentPixelIndex>=0)},t.prototype.getResult=function(){var t=this;return new Promise(function(e,a){t.opts.paletteOnly?e({pal8:t.quantizeImage(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()}):e({img8:t.quantizeImage(),pal8:t.getPalette(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()})})},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);