(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[]}Math.clamp=function(t,a,e){return this.max(a,this.min(e,t))},Math.cbrt||(Math.cbrt=function(t){return this.exp(1/3*this.log(t))});var a=.2126,e=.7152,r=.0722,n=320,i=[],h=[];function s(){this.alpha=this.A=this.B=this.L=0}function l(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function o(t){var a,e,r,n=(t.L+16)/116,i=t.A/500+n,h=n-t.B/200;e=-.9689*(i=.95047*(i*i*i>.008856?i*i*i:(i-16/116)/7.787))+1.8758*(n=1*(n*n*n>.008856?n*n*n:(n-16/116)/7.787))+.0415*(h=1.08883*(h*h*h>.008856?h*h*h:(h-16/116)/7.787)),r=.0557*i+-.204*n+1.057*h,a=(a=3.2406*i+-1.5372*n+-.4986*h)>.0031308?1.055*Math.pow(a,1/2.4)-.055:12.92*a,e=e>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r;var s=Math.clamp(t.alpha,0,255);return a=Math.clamp(255*a,0,255),e=Math.clamp(255*e,0,255),s<<24|(r=Math.clamp(255*r,0,255))<<16|e<<8|a}function u(t){return t*(Math.PI/180)}function c(t,a){var e=a.L-t.L,r=(t.L+a.L)/2;return e/(1*(1+.015*w(r-50)/Math.sqrt(20+w(r-50))))}function p(t,a,e,r,n,i){var h=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(a.A*a.A+a.B*a.B))/2,s=.5*(1-Math.sqrt(Math.pow(h,7)/(Math.pow(h,7)+6103515625)));return e.value=(1+s)*t.A,r.value=(1+s)*a.A,n.value=Math.sqrt(e.value*e.value+t.B*t.B),i.value=Math.sqrt(r.value*r.value+a.B*a.B),(i.value-n.value)/(1*(1+.045*((n.value+i.value)/2)))}function v(t,a,e,r,n,i,h,s){var l,o,c,p=u(360),v=u(180),f=n*i;0==t.B&&0==e?l=0:(l=Math.atan2(t.B,e))<0&&(l+=p),0==a.B&&0==r?o=0:(o=Math.atan2(a.B,r))<0&&(o+=p),0==f?c=0:(c=o-l)<-v?c+=p:c>v&&(c-=p);var m=2*Math.sqrt(f)*Math.sin(c/2),M=l+o;n*i==0?s.value=M:Math.abs(l-o)<=v?s.value=M/2:s.value=M<p?(M+p)/2:(M-p)/2,h.value=(n+i)/2;var w=1-.17*Math.cos(s.value-u(30))+.24*Math.cos(2*s.value)+.32*Math.cos(3*s.value+u(6))-.2*Math.cos(4*s.value-u(63));return m/(1*(1+.015*h.value*w))}function f(t,a,e,r){var n=u(30)*Math.exp(-Math.pow((a-u(275))/u(25),2)),i=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625));return-Math.sin(2*n)*i*e*r}function m(t,a){c(t,a);var e={},r={},n={},i={},h=p(t,a,e,r,n,i),s={},l={},o=v(t,a,e.value,r.value,n.value,i.value,s,l);f(s.value,l.value,h,o)}function M(t,a,e,r,n){return n?(240&t)<<8|(240&a)<<4|240&e|r>>4:(248&a)<<8|(252&e)<<3|r>>3}function w(t){return t*t}function A(t,a,e,r){var n=t<<24|r<<16|e<<8|a,i=h[n];return i||(i=function(t,a,e,r){var n,i,h,l=a/255,o=e/255,u=r/255;i=(.2126*(l=l>.04045?Math.pow((l+.055)/1.055,2.4):l/12.92)+.7152*(o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92)+.0722*(u=u>.04045?Math.pow((u+.055)/1.055,2.4):u/12.92))/1,h=(.0193*l+.1192*o+.9505*u)/1.08883,n=(n=(.4124*l+.3576*o+.1805*u)/.95047)>.008856?Math.cbrt(n):7.787*n+16/116,i=i>.008856?Math.cbrt(i):7.787*i+16/116,h=h>.008856?Math.cbrt(h):7.787*h+16/116;var c=new s;return c.alpha=t,c.L=116*i-16,c.A=500*(n-i),c.B=200*(i-h),c}(t,a,e,r),h[n]=i),i}function B(t,a,e){var r=0,i=1e100,h=t[a],l=h.cnt,o=new s;o.alpha=h.ac,o.L=h.Lc,o.A=h.Ac,o.B=h.Bc;for(var u=Math.random()<e/n,m=h.fw;0!=m;m=t[m].fw){var M=t[m].cnt,A=l*M/(l+M);if(!(A>=i)){var B=new s;B.alpha=t[m].ac,B.L=t[m].Lc,B.A=t[m].Ac,B.B=t[m].Bc;var y=B.alpha-o.alpha,L=A*w(y)*y/3;if(!(L>=i)){if(u){if((L+=A*w(c(o,B)))>=i)continue;var d={},g={},x={},b={},q=p(o,B,d,g,x,b);if((L+=A*w(q))>=i)continue;var _={},I={},P=v(o,B,d.value,g.value,x.value,b.value,_,I);if((L+=A*w(P))>=i)continue;L+=A*f(_.value,I.value,q,P)}else{if((L+=A*w(B.L-o.L))>=i)continue;if((L+=A*w(B.A-o.A))>=i)continue;L+=A*w(B.B-o.B)}L>=i||(i=L,r=m)}}}h.err=i,h.nn=r}function y(t,n,i){for(var h=0,s=255&i,l=i>>>8&255,o=i>>>16&255,u=i>>>24&255,m=1e100,M=A(u,s,l,o),B=0;B<n;B++){var y=255&t[B],L=t[B]>>>8&255,d=t[B]>>>16&255,g=t[B]>>>24&255,x=w(g-u);if(!(x>m)){if(n>32){if((x+=a*w(y-s))>m)continue;if((x+=e*w(L-l))>m)continue;x+=r*w(d-o)}else{var b=A(g,y,L,d);if((x+=w(c(M,b)))>m)continue;var q={},_={},I={},P={},T=p(M,b,q,_,I,P);if((x+=w(T))>m)continue;var U={},k={},S=v(M,b,q.value,_.value,I.value,P.value,U,k);if((x+=w(S))>m)continue;x+=f(U.value,k.value,T,S)}x>m||(m=x,h=B)}}return h}function L(t,a,e){var r=0,n=255&e,h=e>>>8&255,s=e>>>16&255,l=e>>>24&255,o=i[e];if(!o){(o=[])[2]=o[3]=1e100;for(var u=A(l,n,h,s);r<a;r++){var c=255&t[r],p=t[r]>>>8&255,v=t[r]>>>16&255,f=A(t[r]>>>24&255,c,p,v);o[4]=Math.abs(f.alpha-u.alpha)+m(f,u),o[4]<o[2]?(o[1]=o[0],o[3]=o[2],o[0]=r,o[2]=o[4]):o[4]<o[3]&&(o[1]=r,o[3]=o[4])}1e100==o[3]&&(o[2]=0)}return r=0==o[2]||Math.floor(32769*Math.random())%(o[3]+o[2])<=o[3]?o[0]:o[1],i[e]=o,r}function d(t,a,e,r,n,i,h,s){var l=[];return s?(l[0]=n[(i[h]+4104>>4)+a],l[1]=n[(i[h+1]+4104>>4)+e],l[2]=n[(i[h+2]+4104>>4)+r],l[3]=n[(i[h+3]+4104>>4)+t],l):(l[0]=n[(i[h]+8208>>5)+a],l[1]=n[(i[h+1]+4104>>4)+e],l[2]=n[(i[h+2]+8208>>5)+r],l[3]=t,l)}t.prototype.pnnquan=function(t,a,e){for(var r=new Array(65536),i=0;i<t.length;++i){var h=255&t[i],u=t[i]>>>8&255,c=t[i]>>>16&255,p=t[i]>>>24&255,v=M(p,h,u,c,this.hasSemiTransparency),f=A(p,h,u,c);null==r[v]&&(r[v]=new l),r[v].ac+=p,r[v].Lc+=f.L,r[v].Ac+=f.A,r[v].Bc+=f.B,r[v].cnt++}var m,w,y,L=0,d=new Uint32Array(65537);for(i=0;i<r.length;++i)if(null!=r[i]){var g=1/r[i].cnt;r[i].ac*=g,r[i].Lc*=g,r[i].Ac*=g,r[i].Bc*=g,e&&(r[i].cnt=Math.sqrt(r[i].cnt)),r[L++]=r[i]}for(i=0;i<L-1;++i)r[i].fw=i+1,r[i+1].bk=i;n=e?512:256;for(i=0;i<L;++i){B(r,i,a);var x=r[i].err;for(w=++d[0];w>1&&!(r[m=d[y=w>>1]].err<=x);w=y)d[w]=m;d[w]=i}var b=L-a;for(i=0;i<b;){for(var q;;){var _=d[1];if((q=r[_]).tm>=q.mtm&&r[q.nn].mtm<=q.tm)break;65535==q.mtm?_=d[1]=d[d[0]--]:(B(r,_,a),q.tm=i);x=r[_].err;for(w=1;(y=w+w)<=d[0]&&(y<d[0]&&r[d[y]].err>r[d[y+1]].err&&y++,!(x<=r[m=d[y]].err));w=y)d[w]=m;d[w]=_}var I=r[q.nn],P=q.cnt,T=I.cnt;g=1/(P+T);q.ac=g*(P*q.ac+T*I.ac),q.Lc=g*(P*q.Lc+T*I.Lc),q.Ac=g*(P*q.Ac+T*I.Ac),q.Bc=g*(P*q.Bc+T*I.Bc),q.cnt+=I.cnt,q.mtm=++i,r[I.bk].fw=I.fw,r[I.fw].bk=I.bk,I.mtm=65535}delete d;var U=0;for(i=0;;++U){if((f=new s).alpha=Math.round(Math.clamp(r[i].ac,0,255)),f.L=r[i].Lc,f.A=r[i].Ac,f.B=r[i].Bc,this.palette[U]=o(f),this.m_transparentPixelIndex>=0&&this.palette[U]==this.m_transparentColor){var k=this.palette[0];this.palette[0]=this.palette[U],this.palette[U]=k}if(0==(i=r[i].fw))break}void 0!==this.palette.sort&&this.palette.sort()},t.prototype.quantize_image=function(t,a,e,r,n,i){var h=0;if(i){const i=4,L=20;for(var s=(r+2)*i,l=new Uint32Array(256*i),o=new Uint32Array(512),u=0;u<256;++u)l[u]=0,l[u+256]=u,l[u+512]=255,l[u+768]=255,o[u]=-L,o[u+256]=L;for(u=-L;u<=L;++u)o[u+256]=u;var c=!1,p=new Uint32Array(s),v=new Uint32Array(s),f=new Uint32Array(65536);for(u=0;u<n;++u){var m,w,A;c?(m=-1,h+=r-1,w=v,A=p):(m=1,w=p,A=v);var B=i,g=r*i;A[g]=A[g+1]=A[g+2]=A[g+3]=0;for(var x=0;x<r;x++){var b=255&t[h],q=t[h]>>>8&255,_=t[h]>>>16&255,I=t[h]>>>24&255,P=d(I,b,q,_,l,w,B,this.hasSemiTransparency),T=P[0],U=P[1],k=P[2],S=P[3],C=S<<24|k<<16|U<<8|T,z=M(S,T,U,k,this.hasSemiTransparency);0==f[z]&&(f[z]=y(this.palette,a,C)+1),e[h]=f[z]-1;var Q=this.palette[e[h]],j=255&Q,D=Q>>>8&255,E=Q>>>16&255,F=Q>>>24&255;F<255&&255==I&&(f[z]=y(this.palette,a,t[h])+1,e[h]=f[z]-1),T=o[T-j+256],U=o[U-D+256],k=o[k-E+256],S=o[S-F+256];var G=2*T;A[g-i]=T,A[g+i]+=T+=G,A[g]+=T+=G,w[B+i]+=T+=G,G=2*U,A[g+1-i]=U,A[g+1+i]+=U+=G,A[g+1]+=U+=G,w[B+1+i]+=U+=G,G=2*k,A[g+2-i]=k,A[g+2+i]+=k+=G,A[g+2]+=k+=G,w[B+2+i]+=k+=G,G=2*S,A[g+3-i]=S,A[g+3+i]+=S+=G,A[g+3]+=S+=G,w[B+3+i]+=S+=G,B+=i,g-=i,h+=m}u%2==1&&(h+=r+1),c=!c}return!0}if(this.m_transparentPixelIndex>=0||a<64)for(u=0;u<e.length;++u)e[u]=y(this.palette,a,t[u]);else for(u=0;u<e.length;++u)e[u]=L(this.palette,a,t[u]);return!0},t.prototype.quantizeImage=function(){for(var t=this.opts.pixels,n=this.opts.width,s=this.opts.height,l=this.opts.colors,o=this.opts.dithering,u=0;u<t.length;++u){var c=t[u]>>>24&255;c<255&&(this.hasSemiTransparency=!0,0==c&&(this.m_transparentPixelIndex=u,this.m_transparentColor=t[u]))}var p=new Uint32Array(t.length);(this.hasSemiTransparency||l<=32)&&(a=e=r=1),this.palette=new Uint32Array(l);var v=Math.random()<l/64;if(l>2?this.pnnquan(t,l,v):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.quantize_image(t,l,p,n,s,o),this.m_transparentPixelIndex>=0){var f=p[this.m_transparentPixelIndex];if(l>2)this.palette[f]=this.m_transparentColor;else if(this.palette[f]!=this.m_transparentColor){var m=this.palette[0];this.palette[0]=this.palette[1],this.palette[1]=m}}return h=[],i=[],function(t,a){for(var e=0;e<a.length;++e)a[e]=t[a[e]];return a}(this.palette,p)},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.hasSemiTransparency?"image/png":"image/gif"},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);