(function(){function t(t){this.opts=t,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=16777215,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,e,a){return this.max(e,this.min(a,t))}),Math.randomInt=function(t){return Math.floor(Math.random()*t)};var e,a=15,n=!1,r=!1,i=.299,h=.587,s=.114,o=.3333,l=1,p=new Map,u=new Map,c=new Map,f=95.047,v=100,m=108.883,M=.008856,x=903.3;function g(){this.alpha=255,this.A=this.B=this.L=0}var d=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function w(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function A(t){return t>M?Math.fround(Math.cbrt(t)):Math.fround((x*t+16)/116)}function y(t){var e=(t.L+16)/116,a=t.A/500+e,n=e-t.B/200,r=a*a*a,i=r>M?r:(116*a-16)/x,h=t.L>x*M?e*e*e:t.L/x,s=i*f,o=h*v,l=((r=n*n*n)>M?r:(116*n-16)/x)*m,p=(3.2406*s+-1.5372*o+-.4986*l)/100,u=(-.9689*s+1.8758*o+.0415*l)/100,c=(.0557*s+-.204*o+1.057*l)/100;p=p>.0031308?1.055*Math.pow(p,1/2.4)-.055:12.92*p,u=u>.0031308?1.055*Math.pow(u,1/2.4)-.055:12.92*u,c=c>.0031308?1.055*Math.pow(c,1/2.4)-.055:12.92*c;var g=Math.clamp(Math.round(t.alpha),0,255);return p=Math.clamp(Math.round(255*p),0,255),u=Math.clamp(Math.round(255*u),0,255),g<<24|(c=Math.clamp(Math.round(255*c),0,255))<<16|u<<8|p}function B(t){return Math.fround(t*(Math.PI/180))}function L(t,e){var a=e.L-t.L,n=(t.L+e.L)/2,r=1+.015*T(n-50)/Math.sqrt(20+T(n-50));return Math.fround(a/(1*r))}function I(t,e,a,n,r,i){var h=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(e.A*e.A+e.B*e.B))/2,s=.5*(1-Math.sqrt(Math.pow(h,7)/(Math.pow(h,7)+6103515625)));a.value=(1+s)*t.A,n.value=(1+s)*e.A,r.value=Math.sqrt(a.value*a.value+t.B*t.B),i.value=Math.sqrt(n.value*n.value+e.B*e.B);var o=i.value-r.value,l=1+.045*((r.value+i.value)/2);return Math.fround(o/(1*l))}function _(t,e,a,n,r,i,h,s){var o,l,p,u=B(360),c=B(180),f=r*i;0==t.B&&0==a?o=0:(o=Math.atan2(t.B,a))<0&&(o+=u),0==e.B&&0==n?l=0:(l=Math.atan2(e.B,n))<0&&(l+=u),0==f?p=0:(p=l-o)<-c?p+=u:p>c&&(p-=u);var v=2*Math.sqrt(f)*Math.sin(p/2),m=o+l;r*i==0?s.value=m:Math.abs(o-l)<=c?s.value=m/2:s.value=m<u?(m+u)/2:(m-u)/2,h.value=(r+i)/2;var M=1-.17*Math.cos(s.value-B(30))+.24*Math.cos(2*s.value)+.32*Math.cos(3*s.value+B(6))-.2*Math.cos(4*s.value-B(63)),x=1+.015*h.value*M;return Math.fround(v/(1*x))}function P(t,e,a,n){var r=B(30)*Math.exp(-Math.pow((e-B(275))/B(25),2)),i=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625)),h=-Math.sin(2*r)*i;return Math.fround(h*a*n)}function q(t,e,a,n,r,i){return r?(240&t)<<8|(240&e)<<4|240&a|n>>4:i?(128&t)<<8|(248&e)<<7|(248&a)<<2|n>>3:(248&e)<<8|(252&a)<<3|n>>3}function T(t){return t*t}function C(t,e,a,n){var r,i,h,s,o,l,p,c,M=t<<24|n<<16|a<<8|e,x=u.get(M);return null==x&&(r=t,h=a/255,s=n/255,o=A(100*(.4124*(i=(i=e/255)<.04045?i/12.92:Math.pow((i+.055)/1.055,2.4))+.3576*(h=h<.04045?h/12.92:Math.pow((h+.055)/1.055,2.4))+.1805*(s=s<.04045?s/12.92:Math.pow((s+.055)/1.055,2.4)))/f),l=A(100*(.2126*i+.7152*h+.0722*s)/v),p=A(100*(.0193*i+.1192*h+.9505*s)/m),(c=new g).alpha=r,c.L=Math.max(0,116*l-16),c.A=500*(o-l),c.B=200*(l-p),x=c,u.set(M,x)),x}function S(t,e,a,n){var i=0,h=1e100,s=t[e],o=s.cnt,p=new g;p.alpha=s.ac,p.L=s.Lc,p.A=s.Ac,p.B=s.Bc;for(var u=s.fw;0!=u;u=t[u].fw){var c=t[u].cnt,f=o*c/(o+c);if(!(f>=h)){var v=new g;v.alpha=t[u].ac,v.L=t[u].Lc,v.A=t[u].Ac,v.B=t[u].Bc;var m=f*(r?T(v.alpha-p.alpha)/Math.exp(1.5):0);if(!(m>=h)){if(n){if((m+=(1-l)*f*Math.abs(v.L-p.L))>=h)continue;m+=(1-l)*f*Math.sqrt(T(v.A-p.A)+T(v.B-p.B))}else{if((m+=(1-l)*f*T(v.L-p.L))>=h)continue;if((m+=(1-l)*f*T(v.A-p.A))>=h)continue;m+=(1-l)*f*T(v.B-p.B)}if(!(m>=h)){var M=L(p,v);if(!((m+=l*f*T(M))>=h)){var x={},d={},w={},A={},y=I(p,v,x,d,w,A);if(!((m+=l*f*T(y))>=h)){var B={},q={},C=_(p,v,x.value,d.value,w.value,A.value,B,q);(m+=l*f*T(C))>=h||(m+=l*f*P(B.value,q.value,y,C))>=h||(h=m,i=u)}}}}}}s.err=Math.fround(h),s.nn=i}function b(t,i,h){var s=0,o=i>>>24&255;o<=a&&(o=(i=e)>>>24&255);var l=c.get(i);if(null!=l)return l;t.length>2&&n&&o>a&&(s=1);for(var p=255&i,u=i>>>8&255,f=i>>>16&255,v=1e100,m=C(o,p,u,f),M=s;M<t.length;++M){var x=255&t[M],g=t[M]>>>8&255,d=t[M]>>>16&255,w=t[M]>>>24&255,A=r?T(w-o)/Math.exp(1.5):0;if(!(A>v)){var y=C(w,x,g,d);if(t.length<=4)A=T(x-p)+T(g-u)+T(d-f),r&&(A+=T(w-o));else if(r){if((A+=T(y.L-m.L))>v)continue;if((A+=T(y.A-m.A))>v)continue;A+=T(y.B-m.B)}else if(t.length>32){if((A+=Math.abs(y.L-m.L))>v)continue;A+=Math.sqrt(T(y.A-m.A)+T(y.B-m.B))}else{if((A+=T(L(m,y)))>v)continue;var B={},q={},S={},b={},U=I(m,y,B,q,S,b);if((A+=T(U))>v)continue;var k={},z={},E=_(m,y,B.value,q.value,S.value,b.value,k,z);if((A+=T(E))>v)continue;A+=P(k.value,z.value,U,E)}A>v||(v=A,s=M)}}return c.set(i,s),s}function U(t,e,u){var c=e>>>24&255;if(c<=a)return b(t,e);var f=255&e,v=e>>>8&255,m=e>>>16&255,M=p.get(e);if(null==M){(M=new Array(4))[2]=M[3]=65535;var x=0;TELL_BLUE_NOISE[4095&u]>-88&&(x=1);for(var g=0;g<t.length;++g){var w=255&t[g],A=t[g]>>>8&255,y=t[g]>>>16&255,B=t[g]>>>24&255,L=(C(B,w,A,y),i*(1-l)*T(w-f));if(!(L>=M[3])&&!((L+=h*(1-l)*T(A-v))>=M[3]||(L+=s*(1-l)*T(y-m))>=M[3])){r&&(L+=o*(1-l)*T(B-c),x=1);for(var I=x;I<d.length&&!((L+=l*T(d[I][0]*(w-f)))>=M[3])&&!((L+=l*T(d[I][1]*(A-v)))>=M[3])&&!((L+=l*T(d[I][2]*(y-m)))>=M[3]);++I);L<M[2]?(M[1]=M[0],M[3]=M[2],M[0]=g,M[2]=0|L):L<M[3]&&(M[1]=g,M[3]=0|L)}}65535==M[3]&&(M[1]=M[0]),p.set(e,M)}var _=t.length;if(t.length>32&&(_<<=1,f>240&&v>240&&m>240&&(_>>=1)),h<d[0][1]&&TELL_BLUE_NOISE[4095&u]>-88)return b(t,e);var P=1;return(0==M[2]||Math.randomInt(32767)%(M[3]+M[2])<=M[3])&&(P=0),M[P+2]>=_||n&&0==M[P]?b(t,e):M[P]}function k(t,e,a,n,r,i,h,s){var o=new Int32Array(4);return s?(o[0]=r[(i[h]+4104>>4)+e],o[1]=r[(i[h+1]+4104>>4)+a],o[2]=r[(i[h+2]+4104>>4)+n],o[3]=r[(i[h+3]+4104>>4)+t],o):(o[0]=r[(i[h]+8208>>5)+e],o[1]=r[(i[h+1]+4104>>4)+a],o[2]=r[(i[h+2]+8208>>5)+n],o[3]=t,o)}t.prototype.pnnquan=function(t,e){for(var n=1,r=new Array(65536),i=new Float32Array(t.length),o=0;o<t.length;++o){var p=255&t[o],c=t[o]>>>8&255,f=t[o]>>>16&255,v=t[o]>>>24&255;v<=a&&(p=255&this.m_transparentColor,c=this.m_transparentColor>>>8&255,f=this.m_transparentColor>>>16&255,v=this.m_transparentColor>>>24&255);var m=q(v,p,c,f,this.hasSemiTransparency,this.m_transparentPixelIndex>=0),M=C(v,p,c,f);null==r[m]&&(r[m]=new w),(R=r[m]).ac+=v,R.Lc+=M.L,R.Ac+=M.A,R.Bc+=M.B,R.cnt+=1,v>a&&e<32&&(i[o]=.1+.9*M.L/100)}this.opts.saliencies=i;var x=0;for(o=0;o<r.length;++o)if(null!=r[o]){var A=1/r[o].cnt;r[o].ac*=A,r[o].Lc*=A,r[o].Ac*=A,r[o].Bc*=A,r[x++]=r[o]}var B=T(e)/x;(this.m_transparentPixelIndex>=0||this.hasSemiTransparency)&&e<32&&(n=-1);var L=this.opts.weight=Math.min(.9,1*e/x);if(L>.0015&&L<.002&&(n=2),L<.04&&h<1&&h>=d[0][1]){var I=Math.exp(1.75)*L;h-=I,s+=I,e>=64&&(n=0)}if(u.size<=e){this.palette=new Uint32Array(u.size);var _=0;for(var P of u.keys())this.palette[_]=P,_>1&&0==(P>>>24&255)&&(this.palette[_]=this.palette[0],this.palette[0]=P,this.palette[_]>>>24&!1&&(this.palette[_]|=0xff00000000)),++_}else{for(var b=function(t,e){return e>0?e>1?function(t){return 0|Math.pow(t,.75)}:t<64?function(t){return 0|Math.sqrt(t)}:function(t){return Math.fround(Math.sqrt(t))}:function(t){return t}}(e,n),U=0;U<x-1;++U)r[U].fw=U+1,r[U+1].bk=U,r[U].cnt=b(r[U].cnt);r[U].cnt=b(r[U].cnt);var k,z,E,F=B>.0275;l=this.hasSemiTransparency?.5:0!=n&&e<64?B>.018&&B<.022?Math.min(1,B+L*Math.exp(3.13)):B>.1?Math.min(1,1-L):B>.04?Math.min(1,L*Math.exp(1.56)):B>.03?Math.min(1,B+L*Math.exp(3.66)):Math.min(1,B+L*Math.exp(1.718)):e>256?Math.min(1,1-1/B):Math.min(1,1-.7*L),!this.hasSemiTransparency&&n<0&&(l=Math.min(1,L*Math.exp(3.13)));var O=new Uint32Array(r.length+1);for(o=0;o<x;++o){S(r,o,0,F);var D=r[o].err;for(z=++O[0];z>1&&!(r[k=O[E=z>>1]].err<=D);z=E)O[z]=k;O[z]=o}if(n>0&&e<64&&B>.035&&B<.1){var N=B>.04?1:-1;I=L>.0025&&L<.003?1.872:1.632;l=Math.min(1,B+N*L*Math.exp(I))}var Q=x-e;for(o=0;o<Q;){for(var R;;){var j=O[1];if((R=r[j]).tm>=R.mtm&&r[R.nn].mtm<=R.tm)break;65535==R.mtm?j=O[1]=O[O[0]--]:(S(r,j,0,F&&B<1),R.tm=o);D=r[j].err;for(z=1;(E=z+z)<=O[0]&&(E<O[0]&&r[O[E]].err>r[O[E+1]].err&&++E,!(D<=r[k=O[E]].err));z=E)O[z]=k;O[z]=j}var G=r[R.nn],H=R.cnt,J=G.cnt;A=1/(H+J);R.ac=A*(H*R.ac+J*G.ac),R.Lc=A*(H*R.Lc+J*G.Lc),R.Ac=A*(H*R.Ac+J*G.Ac),R.Bc=A*(H*R.Bc+J*G.Bc),R.cnt+=J,R.mtm=++o,r[G.bk].fw=G.fw,r[G.fw].bk=G.bk,G.mtm=65535}Q<0&&(this.palette=new Uint32Array(x));for(_=0,o=0;;++_){if((M=new g).alpha=this.hasSemiTransparency||this.m_transparentPixelIndex>=0?0|Math.clamp(Math.round(r[o].ac),0,255):255,M.L=r[o].Lc,M.A=r[o].Ac,M.B=r[o].Bc,this.palette[_]=y(M),0==(o=r[o].fw))break}}},t.prototype.quantize_image=function(t,e,a,n,r){var i=e>256?new Uint16Array(t.length):new Uint8Array(t.length),h=0;if(r){const r=4,N=256,Q=16;for(var s=(a+2)*r,o=new Int32Array(r*N),l=new Int32Array(2*N),p=0;p<N;++p)o[p]=0,o[p+N]=p,o[p+2*N]=255,o[p+3*N]=255,l[p]=-Q,l[p+N]=Q;for(p=-Q;p<=Q;++p)l[p+N]=p,e>16&&p%4==3&&(l[p+N]=0);var u=this.hasSemiTransparency||e<64,c=1,f=new Int32Array(s),v=new Int32Array(s),m=new Int32Array(65536);for(p=0;p<n;++p){c<0&&(h+=a-1);var M=r,x=a*r;v[x]=v[x+1]=v[x+2]=v[x+3]=0;for(var g=0;g<a;++g){var d=255&t[h],w=t[h]>>>8&255,A=t[h]>>>16&255,y=t[h]>>>24&255,B=k(y,d,w,A,o,f,M,u),L=B[0],I=B[1],_=B[2],P=B[3],T=P<<24|_<<16|I<<8|L;if(u){var C=q(P,L,I,_,this.hasSemiTransparency,this.m_transparentPixelIndex>=0);0==m[C]&&(m[C]=0==y?1:b(this.palette,T)+1),i[h]=m[C]-1}else i[h]=0==y?0:U(this.palette,T,p+g);var S=this.palette[i[h]],z=S>>>8&255,E=S>>>16&255,F=S>>>24&255;L=l[L-(255&S)+N],I=l[I-z+N],_=l[_-E+N],P=l[P-F+N];var O=2*L;v[x-r]=L,v[x+r]+=L+=O,v[x]+=L+=O,f[M+r]+=L+O,O=2*I,v[x+1-r]=I,v[x+1+r]+=I+=O,v[x+1]+=I+=O,f[M+1+r]+=I+O,O=2*_,v[x+2-r]=_,v[x+2+r]+=_+=O,v[x+2]+=_+=O,f[M+2+r]+=_+O,O=2*P,v[x+3-r]=P,v[x+3+r]+=P+=O,v[x+3]+=P+=O,f[M+3+r]+=P+O,M+=r,x-=r,h+=c}p%2==1&&(h+=a+1),c*=-1;var D=f;f=v,v=D}return this.qPixels=i,this.qPixels}for(p=0;p<i.length;++p)i[p]=this.getDitherFn()(this.palette,t[p],p);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){var t=this.opts.pixels,l=this.opts.width,f=this.opts.height,v=this.opts.colors,m=this.opts.dithering;this.opts.alphaThreshold&&(a=this.opts.alphaThreshold),u.clear(),p.clear(),c.clear(),n=!1;for(var M=0,x=0;x<t.length;++x){var g=t[x]>>>24&255;g<224&&(0==g?(this.m_transparentPixelIndex=x,n=!0,v>2?this.m_transparentColor=t[x]:t[x]=this.m_transparentColor):g>a&&++M)}if(this.hasSemiTransparency=r=M>0,v<=32?i=h=s=o=1:(i=d[0][0],h=d[0][1],s=d[0][2]),e=this.m_transparentColor,this.palette=new Uint32Array(v),v>2?this.pnnquan(t,v):this.m_transparentPixelIndex>=0?(this.palette[0]=this.m_transparentColor,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),!this.opts.dithering){var w=T(v)/u.size;this.opts.weight=w>.023?1:Math.fround(37.013*w+.906)}if(r&&(this.opts.weight*=-1),this.m_transparentPixelIndex>=0){var A=b(this.palette,t[this.m_transparentPixelIndex],this.m_transparentPixelIndex);this.palette.length>2?this.palette[A]=this.m_transparentColor:this.palette[A]!=this.m_transparentColor&&(this.palette[0]=this.palette[A],this.palette[A]=this.m_transparentColor,c.clear())}return this.opts.paletteOnly?(this.opts.ditherFn=this.getDitherFn(),this.opts.getColorIndex=this.getColorIndex,this.opts.palette=this.palette,this.palette):(this.quantize_image(t,v,l,f,m),function(t,e){for(var a=new Uint32Array(e.length),n=0;n<e.length;++n)a[n]=t[e[n]];return a}(this.palette,this.qPixels))},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex>-1?0:-1},t.prototype.getDitherFn=function(){return U},t.prototype.getColorIndex=function(t,e,a,n){return q(t,e,a,n,this.hasSemiTransparency,this.m_transparentPixelIndex>=0)},t.prototype.getResult=function(){var t=this;return new Promise(function(e,a){var n=t.quantizeImage();t.opts.paletteOnly?e({pal8:n,indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()}):e({img8:n,pal8:t.getPalette(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()})})},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);