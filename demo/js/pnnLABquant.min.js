(function(){function t(t){this.opts=t||{},this.alphaThreshold=0,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,a,e){return this.max(a,this.min(e,t))}),Math.cbrt||(Math.cbrt=function(t){return this.exp(1/3*this.log(t))});var a=.299,e=.587,n=.114,r=1,i=[],h=[],s=[];function l(){this.alpha=this.A=this.B=this.L=0}function p(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function o(t){var a,e,n,r=(t.L+16)/116,i=t.A/500+r,h=r-t.B/200;e=-.9689*(i=.95047*(i*i*i>.008856?i*i*i:(i-16/116)/7.787))+1.8758*(r=1*(r*r*r>.008856?r*r*r:(r-16/116)/7.787))+.0415*(h=1.08883*(h*h*h>.008856?h*h*h:(h-16/116)/7.787)),n=.0557*i+-.204*r+1.057*h,a=(a=3.2406*i+-1.5372*r+-.4986*h)>.0031308?1.055*Math.pow(a,1/2.4)-.055:12.92*a,e=e>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n;var s=Math.clamp(t.alpha,0,255);return a=Math.clamp(255*a,0,255),e=Math.clamp(255*e,0,255),s<<24|(n=Math.clamp(255*n,0,255))<<16|e<<8|a}function c(t){return t*(Math.PI/180)}function u(t,a){var e=a.L-t.L,n=(t.L+a.L)/2;return e/(1*(1+.015*x(n-50)/Math.sqrt(20+x(n-50))))}function v(t,a,e,n,r,i){var h=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(a.A*a.A+a.B*a.B))/2,s=.5*(1-Math.sqrt(Math.pow(h,7)/(Math.pow(h,7)+6103515625)));return e.value=(1+s)*t.A,n.value=(1+s)*a.A,r.value=Math.sqrt(e.value*e.value+t.B*t.B),i.value=Math.sqrt(n.value*n.value+a.B*a.B),(i.value-r.value)/(1*(1+.045*((r.value+i.value)/2)))}function f(t,a,e,n,r,i,h,s){var l,p,o,u=c(360),v=c(180),f=r*i;0==t.B&&0==e?l=0:(l=Math.atan2(t.B,e))<0&&(l+=u),0==a.B&&0==n?p=0:(p=Math.atan2(a.B,n))<0&&(p+=u),0==f?o=0:(o=p-l)<-v?o+=u:o>v&&(o-=u);var m=2*Math.sqrt(f)*Math.sin(o/2),M=l+p;r*i==0?s.value=M:Math.abs(l-p)<=v?s.value=M/2:s.value=M<u?(M+u)/2:(M-u)/2,h.value=(r+i)/2;var x=1-.17*Math.cos(s.value-c(30))+.24*Math.cos(2*s.value)+.32*Math.cos(3*s.value+c(6))-.2*Math.cos(4*s.value-c(63));return m/(1*(1+.015*h.value*x))}function m(t,a,e,n){var r=c(30)*Math.exp(-Math.pow((a-c(275))/c(25),2)),i=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625));return-Math.sin(2*r)*i*e*n}function M(t,a,e,n,r,i){return r?(240&t)<<8|(240&a)<<4|240&e|n>>4:i?(128&t)<<8|(248&a)<<7|(248&e)<<2|n>>3:(248&a)<<8|(252&e)<<3|n>>3}function x(t){return t*t}function y(t,a,e,n){var r=t<<24|n<<16|e<<8|a,i=h[r];return i||(i=function(t,a,e,n){var r,i,h,s=a/255,p=e/255,o=n/255;i=(.2126*(s=s>.04045?Math.pow((s+.055)/1.055,2.4):s/12.92)+.7152*(p=p>.04045?Math.pow((p+.055)/1.055,2.4):p/12.92)+.0722*(o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92))/1,h=(.0193*s+.1192*p+.9505*o)/1.08883,r=(r=(.4124*s+.3576*p+.1805*o)/.95047)>.008856?Math.cbrt(r):7.787*r+16/116,i=i>.008856?Math.cbrt(i):7.787*i+16/116,h=h>.008856?Math.cbrt(h):7.787*h+16/116;var c=new l;return c.alpha=t,c.L=116*i-16,c.A=500*(r-i),c.B=200*(i-h),c}(t,a,e,n),h[r]=i),i}function g(t,a,e){var n=0,i=1e100,h=t[a],s=h.cnt,p=new l;p.alpha=h.ac,p.L=h.Lc,p.A=h.Ac,p.B=h.Bc;for(var o=h.fw;0!=o;o=t[o].fw){var c=t[o].cnt,M=s*c/(s+c);if(!(M>=i)){var y=new l;y.alpha=t[o].ac,y.L=t[o].Lc,y.A=t[o].Ac,y.B=t[o].Bc;var g=M*x(y.alpha-p.alpha)/Math.exp(1.5);if(!(g>=i||(g+=(1-r)*M*x(y.L-p.L))>=i||(g+=(1-r)*M*x(y.A-p.A))>=i||(g+=(1-r)*M*x(y.B-p.B))>=i)){var d=u(p,y);if(!((g+=r*M*x(d))>=i)){var w={},A={},B={},I={},P=v(p,y,w,A,B,I);if(!((g+=r*M*x(P))>=i)){var q={},L={},b=f(p,y,w.value,A.value,B.value,I.value,q,L);(g+=r*M*x(b))>=i||(g+=r*M*m(q.value,L.value,P,b))>=i||(i=g,n=o)}}}}}h.err=i,h.nn=n}function d(t,r,i){var h=s[i];if(null!=h)return h;var l=0,p=255&i,o=i>>>8&255,c=i>>>16&255,M=i>>>24&255;if(M<=this.alphaThreshold)return l;for(var g=1e100,d=y(M,p,o,c),w=0;w<r;++w){var A=255&t[w],B=t[w]>>>8&255,I=t[w]>>>16&255,P=t[w]>>>24&255,q=x(P-M);if(!(q>g)){var L=y(P,A,B,I);if(r>32||this.hasSemiTransparency){if((q+=a*x(A-p))>g)continue;if((q+=e*x(B-o))>g)continue;if(q+=n*x(I-c),n<1){if(q>g)continue;q+=x(L.B-d.B)/2}}else{if((q+=x(u(d,L)))>g)continue;var b={},T={},_={},k={},S=v(d,L,b,T,_,k);if((q+=x(S))>g)continue;var C={},O={},z=f(d,L,b.value,T.value,_.value,k.value,C,O);if((q+=x(z))>g)continue;q+=m(C.value,O.value,S,z)}q>g||(g=q,l=w)}}return s[i]=l,l}function w(t,a,e){var n=0,r=255&e,h=e>>>8&255,s=e>>>16&255,l=e>>>24&255,p=i[e];if(null==p){(p=[])[2]=p[3]=1e100;for(var o=y(l,r,h,s);n<a;++n){var c=255&t[n],u=t[n]>>>8&255,v=t[n]>>>16&255,f=y(t[n]>>>24&255,c,u,v);p[4]=Math.abs(f.alpha-o.alpha)+Math.abs(f.L-o.L)+Math.abs(f.A-o.A)+Math.abs(f.B-o.B),p[4]<p[2]?(p[1]=p[0],p[3]=p[2],p[0]=n,p[2]=p[4]):p[4]<p[3]&&(p[1]=n,p[3]=p[4])}1e100==p[3]&&(p[2]=0)}return n=0==p[2]||Math.floor(32769*Math.random())%(p[3]+p[2])<=p[3]?p[0]:p[1],i[e]=p,n}function A(t,a,e,n,r,i,h,s){var l=new Int32Array(4);return s?(l[0]=r[(i[h]+4104>>4)+a],l[1]=r[(i[h+1]+4104>>4)+e],l[2]=r[(i[h+2]+4104>>4)+n],l[3]=r[(i[h+3]+4104>>4)+t],l):(l[0]=r[(i[h]+8208>>5)+a],l[1]=r[(i[h+1]+4104>>4)+e],l[2]=r[(i[h+2]+8208>>5)+n],l[3]=t,l)}t.prototype.pnnquan=function(t,a,e){for(var n=new Array(65536),i=0;i<t.length;++i){var s=255&t[i],c=t[i]>>>8&255,u=t[i]>>>16&255,v=t[i]>>>24&255,f=M(v,s,c,u,this.hasSemiTransparency,this.m_transparentPixelIndex>=0),m=y(v,s,c,u);null==n[f]&&(n[f]=new p),(T=n[f]).ac+=v,T.Lc+=m.L,T.Ac+=m.A,T.Bc+=m.B,T.cnt++}var d=0;for(i=0;i<n.length;++i)if(null!=n[i]){var w=1/n[i].cnt;n[i].ac*=w,n[i].Lc*=w,n[i].Ac*=w,n[i].Bc*=w,n[d++]=n[i]}var A,B,I,P=x(a)/d;(this.m_transparentPixelIndex>=0||this.hasSemiTransparency)&&a<32?e=-1:(P<.018||P>.5)&&a<64&&(e=0),e>0&&(n[0].cnt=0|Math.sqrt(n[0].cnt));for(i=0;i<d-1;++i)n[i].fw=i+1,n[i+1].bk=i,e>0&&(n[i+1].cnt=0|Math.sqrt(n[i+1].cnt));r=0!=e&&a<64?P>.018&&P<.022?Math.min(1,P+a*Math.exp(4.732)/Object.keys(h).length):Math.min(1,P+a*Math.exp(3.845)/Object.keys(h).length):e>0?Math.min(1,Math.pow(a,1.05)/Object.keys(h).length):Math.min(1,P+a*Math.exp(4.732)/Object.keys(h).length),e<0&&(r+=.5,r=Math.min(1,r));var q=new Uint32Array(n.length+1);for(i=0;i<d;++i){g(n,i);var L=n[i].err;for(B=++q[0];B>1&&!(n[A=q[I=B>>1]].err<=L);B=I)q[B]=A;q[B]=i}var b=d-a;for(i=0;i<b;){for(var T;;){var _=q[1];if((T=n[_]).tm>=T.mtm&&n[T.nn].mtm<=T.tm)break;65535==T.mtm?_=q[1]=q[q[0]--]:(g(n,_),T.tm=i);L=n[_].err;for(B=1;(I=B+B)<=q[0]&&(I<q[0]&&n[q[I]].err>n[q[I+1]].err&&++I,!(L<=n[A=q[I]].err));B=I)q[B]=A;q[B]=_}var k=n[T.nn],S=T.cnt,C=k.cnt;w=1/(S+C);T.ac=w*(S*T.ac+C*k.ac),T.Lc=w*(S*T.Lc+C*k.Lc),T.Ac=w*(S*T.Ac+C*k.Ac),T.Bc=w*(S*T.Bc+C*k.Bc),T.cnt+=k.cnt,T.mtm=++i,n[k.bk].fw=k.fw,n[k.fw].bk=k.bk,k.mtm=65535}var O=0;for(i=0;;++O){if((m=new l).alpha=0|Math.clamp(Math.round(n[i].ac),0,255),m.L=n[i].Lc,m.A=n[i].Ac,m.B=n[i].Bc,this.palette[O]=o(m),this.m_transparentPixelIndex>=0&&this.palette[O]==this.m_transparentColor){var z=this.palette[0];this.palette[0]=this.palette[O],this.palette[O]=z}if(0==(i=n[i].fw))break}},t.prototype.quantize_image=function(t,a,e,n,r){var i=a>256?new Uint16Array(t.length):new Uint8Array(t.length),h=0;if(r){const r=4,Q=256,R=16;for(var s=(e+2)*r,l=new Int32Array(r*Q),p=new Int32Array(2*Q),o=0;o<Q;++o)l[o]=0,l[o+Q]=o,l[o+2*Q]=255,l[o+3*Q]=255,p[o]=-R,p[o+Q]=R;for(o=-R;o<=R;++o)p[o+Q]=o%4==3?0:o;var c=this.hasSemiTransparency||a<64,u=1,v=new Int32Array(s),f=new Int32Array(s),m=new Int32Array(65536);for(o=0;o<n;++o){u<0&&(h+=e-1);var x=r,y=e*r;f[y]=f[y+1]=f[y+2]=f[y+3]=0;for(var g=0;g<e;++g){var B=255&t[h],I=t[h]>>>8&255,P=t[h]>>>16&255,q=t[h]>>>24&255,L=A(q,B,I,P,l,v,x,c),b=L[0],T=L[1],_=L[2],k=L[3],S=k<<24|_<<16|T<<8|b;if(c){var C=M(k,b,T,_,this.hasSemiTransparency,this.m_transparentPixelIndex>=0);0==m[C]&&(m[C]=0==q?1:d(this.palette,a,S)+1),i[h]=m[C]-1}else i[h]=0==q?0:w(this.palette,a,S);var O=this.palette[i[h]],z=O>>>8&255,U=O>>>16&255,j=O>>>24&255;b=p[b-(255&O)+Q],T=p[T-z+Q],_=p[_-U+Q],k=p[k-j+Q];var D=2*b;f[y-r]=b,f[y+r]+=b+=D,f[y]+=b+=D,v[x+r]+=b+D,D=2*T,f[y+1-r]=T,f[y+1+r]+=T+=D,f[y+1]+=T+=D,v[x+1+r]+=T+D,D=2*_,f[y+2-r]=_,f[y+2+r]+=_+=D,f[y+2]+=_+=D,v[x+2+r]+=_+D,D=2*k,f[y+3-r]=k,f[y+3+r]+=k+=D,f[y+3]+=k+=D,v[x+3+r]+=k+D,x+=r,y-=r,h+=u}o%2==1&&(h+=e+1),u*=-1;var F=v;v=f,f=F}return this.qPixels=i,this.qPixels}if(this.m_transparentPixelIndex>=0||a<64)for(o=0;o<i.length;++o)i[o]=d(this.palette,a,t[o]);else for(o=0;o<i.length;++o)i[o]=w(this.palette,a,t[o]);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){var t=this.opts.pixels,r=this.opts.width,l=this.opts.height,p=this.opts.colors,o=this.opts.dithering;this.opts.alphaThreshold&&(this.alphaThreshold=this.opts.alphaThreshold),h=[],i=[],s=[];for(var c=0;c<t.length;++c){var u=t[c]>>>24&255;u<255&&(0==u?(this.m_transparentPixelIndex=c,this.m_transparentColor=t[c]):this.hasSemiTransparency=!0)}if(this.hasSemiTransparency&&(a=e=n=1),this.palette=new Uint32Array(p),p>2?this.pnnquan(t,p,1):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.m_transparentPixelIndex>=0){var v=this.qPixels[this.m_transparentPixelIndex];if(p>2)this.palette[v]=this.m_transparentColor;else if(this.palette[v]!=this.m_transparentColor){var f=this.palette[0];this.palette[0]=this.palette[1],this.palette[1]=f}}return this.opts.paletteOnly?this.palette:(this.quantize_image(t,p,r,l,o),function(t,a){for(var e=new Uint32Array(a.length),n=0;n<a.length;++n)e[n]=t[a[n]];return e}(this.palette,this.qPixels))},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex>-1?0:-1},t.prototype.getDitherFn=function(){return this.hasSemiTransparency||this.opts.colors<64?d:w},t.prototype.getColorIndex=function(t,a,e,n){return M(t,a,e,n,this.hasSemiTransparency,this.m_transparentPixelIndex>=0)},t.prototype.getResult=function(){var t=this;return new Promise(function(a,e){t.opts.paletteOnly?a({pal8:t.quantizeImage(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()}):a({img8:t.quantizeImage(),pal8:t.getPalette(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()})})},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);