!function(){function t(t){this.opts=t,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=16777215,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,e,r){return this.max(e,this.min(r,t))});var g,A,C,S=15,x=!1,d=!1,E=.299,L=.587,U=.114,k=.3333,v=.5,F=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function O(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=this.err=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0}function z(t,e,r,n,a,i){return a?(240&t)<<8|(240&e)<<4|240&r|n>>4:i?(128&t)<<8|(248&e)<<7|(248&r)<<2|n>>3:(248&e)<<8|(252&r)<<3|n>>3}function y(t){return t*t}function B(t,e){var r=0,n=1e100,a=t[e],i=a.cnt,s=a.ac,h=a.rc,o=a.gc,p=a.bc,l=0;-88<TELL_BLUE_NOISE[4095&e]&&(l=L<F[0][1]?F.length:1);for(var c=a.fw;0!=c;c=t[c].fw){var f=t[c].cnt,m=i*f/(i+f);if(!(n<=m)){var u=0;if(!(d&&(l=1,n<=(u+=.5*m*k*y(t[c].ac-s)))||n<=(u+=.5*m*E*y(t[c].rc-h))||n<=(u+=.5*m*L*y(t[c].gc-o))||n<=(u+=.5*m*U*y(t[c].bc-p)))){for(var g=l;g<F.length&&!(n<=(u+=m*v*y(F[g][0]*(t[c].rc-h))))&&!(n<=(u+=m*v*y(F[g][1]*(t[c].gc-o))))&&!(n<=(u+=m*v*y(F[g][2]*(t[c].bc-p))));++g);n=u,r=c}}}a.err=Math.fround(n),a.nn=r}function D(t,e,r){var n=0,a=e>>>24&255,i=(a<=S&&(a=(e=g)>>>24&255),C.get(e));if(null!=i)return i;2<t.length&&x&&S<a&&(n=1);for(var s=255&e,h=e>>>8&255,o=e>>>16&255,p=E,l=L,c=U,f=(2<t.length&&-88<TELL_BLUE_NOISE[4095&r]&&(p=F[0][0],l=F[0][1],c=F[0][2]),1e100),m=n;m<t.length;m++){var u=k*y((t[m]>>>24&255)-a);f<u||f<(u+=p*y((255&t[m])-s))||f<(u+=l*y((t[m]>>>8&255)-h))||f<(u+=c*y((t[m]>>>16&255)-o))||(f=u,n=m)}return C.set(e,n),n}function e(t,e,r){var n=e>>>24&255;if(n<=S)return D(t,e,r);var a=255&e,i=e>>>8&255,s=e>>>16&255,h=A.get(e);if(!h){(h=new Array(4))[2]=h[3]=65535;var o=E,p=L,l=U;-88<TELL_BLUE_NOISE[4095&r]&&(o=F[0][0],p=F[0][1],l=F[0][2]);for(var c=0;c<t.length;++c){var f=o*y((255&t[c])-a);f>=h[3]||(f+=p*y((t[c]>>>8&255)-i))>=h[3]||(f+=l*y((t[c]>>>16&255)-s))>=h[3]||(d&&(f+=k*y((t[c]>>>24&255)-n)),f<h[2]?(h[1]=h[0],h[3]=h[2],h[0]=c,h[2]=0|f):f<h[3]&&(h[1]=c,h[3]=0|f))}65535==h[3]&&(h[1]=h[0]),A.set(e,h)}var m=t.length<<2,u=(r+1)%2;return.67*h[3]<h[3]-h[2]?u=0:h[0]>h[1]&&(u=r%2),h[u+2]>=m||x&&0==h[u+2]?D(t,e,r):h[u]}t.prototype.pnnquan=function(t,e){A.clear(),C.clear();for(var r=1,n=new Array(65536),a=0;a<t.length;++a){var i=255&t[a],s=t[a]>>>8&255,h=t[a]>>>16&255,o=((q=t[a]>>>24&255)<=S&&(i=255&this.m_transparentColor,s=this.m_transparentColor>>>8&255,h=this.m_transparentColor>>>16&255,q=this.m_transparentColor>>>24&255),z(q,i,s,h,this.hasSemiTransparency,e<64||0<=this.m_transparentPixelIndex));null==n[o]&&(n[o]=new O),(v=n[o]).ac+=q,v.rc+=i,v.gc+=s,v.bc+=h,v.cnt+=1}for(var p=0,a=0;a<n.length;++a)null!=n[a]&&(b=1/n[a].cnt,n[a].ac*=b,n[a].rc*=b,n[a].gc*=b,n[a].bc*=b,n[p++]=n[a]);e<16&&(r=-1);for(var l,c,f=this.opts.weight=Math.min(.9,+e/p),m=(.003<f&&f<.005&&(r=0),f<.03&&L>=F[0][1]&&(E=L=U=k=1,64<=e)&&(r=0),f=e,0<(r=r)?f<64?function(t){return Math.fround(Math.sqrt(t))}:function(t){return 0|Math.sqrt(t)}:r<0?function(t){return 0|Math.cbrt(t)}:function(t){return t}),u=0;u<p-1;++u)n[u].fw=u+1,n[u+1].bk=u,n[u].cnt=m(n[u].cnt);n[u].cnt=m(n[u].cnt);for(var g=new Uint32Array(n.length+1),a=0;a<p;++a){B(n,a);for(var x=n[a].err,d=++g[0];1<d&&!(n[l=g[c=d>>1]].err<=x);d=c)g[d]=l;g[d]=a}for(var v,y=p-e,a=0;a<y;){for(;;){var I=g[1];if((v=n[I]).tm>=v.mtm&&n[v.nn].mtm<=v.tm)break;65535==v.mtm?I=g[1]=g[g[0]--]:(B(n,I),v.tm=a);x=n[I].err;for(d=1;(c=d+d)<=g[0]&&(c<g[0]&&n[g[c]].err>n[g[c+1]].err&&++c,!(x<=n[l=g[c]].err));d=c)g[d]=l;g[d]=I}var _=n[v.nn],w=v.cnt,P=_.cnt,b=Math.fround(1/(w+P));v.ac=b*Math.round(w*v.ac+P*_.ac),v.rc=b*Math.round(w*v.rc+P*_.rc),v.gc=b*Math.round(w*v.gc+P*_.gc),v.bc=b*Math.round(w*v.bc+P*_.bc),v.cnt+=P,v.mtm=++a,n[_.bk].fw=_.fw,n[_.fw].bk=_.bk,_.mtm=65535}this.palette=new Uint32Array(0<y?e:p);for(var M=0,a=0;;++M){var T,q=0|Math.clamp(n[a].ac,0,255),i=0|Math.clamp(n[a].rc,0,255),s=0|Math.clamp(n[a].gc,0,255),h=0|Math.clamp(n[a].bc,0,255);if(this.palette[M]=q<<24|h<<16|s<<8|i,0<=this.m_transparentPixelIndex&&0==q&&(T=this.palette[0],this.palette[0]=this.m_transparentColor,this.palette[M]=T),0==(a=n[a].fw))break}},t.prototype.quantize_image=function(t,e,r,n,a){var i=new(256<e?Uint16Array:Uint8Array)(t.length),s=0;if(a){for(var h=256,a=4*(r+2),o=new Int32Array(1024),p=new Int32Array(512),l=0;l<h;++l)o[l]=0,o[l+h]=l,o[l+512]=255,o[l+768]=255,p[l]=-20,p[l+h]=20;for(l=-20;l<=20;++l)p[l+h]=l;for(var c=this.hasSemiTransparency||e<64,f=1,m=new Int32Array(a),u=new Int32Array(a),g=new Int32Array(65536),l=0;l<n;++l){f<0&&(s+=r-1);for(var x=4,d=4*r,v=u[d]=u[d+1]=u[d+2]=u[d+3]=0;v<r;++v){var y=255&t[s],I=t[s]>>>24&255,_=(P=I,y=y,T=t[s]>>>8&255,C=t[s]>>>16&255,M=o,b=m,w=x,_=c,q=void 0,q=new Int32Array(4),_?(q[0]=M[(b[w]+4104>>4)+y],q[1]=M[(b[w+1]+4104>>4)+T],q[2]=M[(b[w+2]+4104>>4)+C],q[3]=M[(b[w+3]+4104>>4)+P]):(q[0]=M[(b[w]+8208>>5)+y],q[1]=M[(b[w+1]+4104>>4)+T],q[2]=M[(b[w+2]+8208>>5)+C],q[3]=P),q),w=(y=_[3])<<24|(T=_[2])<<16|(M=_[1])<<8|(b=_[0]),P=(c?(0==g[C=z(y,b,M,T,this.hasSemiTransparency,0<=this.m_transparentPixelIndex)]&&(g[C]=0==I?1:D(this.palette,w,l+v)+1),i[s]=g[C]-1):i[s]=0==I?0:D(this.palette,w,l+v),this.palette[i[s]]),b=p[b-(255&P)+h],M=p[M-(P>>>8&255)+h],T=p[T-(P>>>16&255)+h],y=p[y-(P>>>24&255)+h],q=2*b;u[d-4]=b,u[d+4]+=b+=q,u[d]+=b+=q,m[x+4]+=b+q,q=2*M,u[d+1-4]=M,u[d+1+4]+=M+=q,u[d+1]+=M+=q,m[x+1+4]+=M+q,q=2*T,u[d+2-4]=T,u[d+2+4]+=T+=q,u[d+2]+=T+=q,m[x+2+4]+=T+q,q=2*y,u[d+3-4]=y,u[d+3+4]+=y+=q,u[d+3]+=y+=q,m[x+3+4]+=y+q,x+=4,d-=4,s+=f}l%2==1&&(s+=r+1),f*=-1;var A=m,m=u,u=A}}else for(var P,T,C,M,b,w,_,q,l=0;l<i.length;++l)i[l]=this.getDitherFn()(this.palette,t[l],l);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){for(var t,e=this.opts.pixels,r=this.opts.width,n=this.opts.height,a=this.opts.colors,i=this.opts.dithering,s=(this.opts.alphaThreshold&&(S=this.opts.alphaThreshold),A=new Map,C=new Map,x=!1,0),h=0;h<e.length;++h){var o=e[h]>>>24&255;o<224&&(0==o?(this.m_transparentPixelIndex=h,x=!0,2<a?this.m_transparentColor=e[h]:e[h]=this.m_transparentColor):S<o&&++s)}if(this.hasSemiTransparency=d=0<s,a<=32?E=L=U=k=1:(E=F[0][0],L=F[0][1],U=F[0][2]),g=this.m_transparentColor,this.palette=new Uint32Array(a),2<a?this.pnnquan(e,a):0<=this.m_transparentPixelIndex?(this.palette[0]=this.m_transparentColor,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.opts.dithering||(this.opts.weightB=1),d&&(this.opts.weight*=-1),0<=this.m_transparentPixelIndex&&2<this.palette.length&&(t=this.getDitherFn()(this.palette,e[this.m_transparentPixelIndex],this.m_transparentPixelIndex),this.palette[t]=this.m_transparentColor),this.opts.paletteOnly)return this.opts.ditherFn=this.getDitherFn(),this.opts.getColorIndex=this.getColorIndex,this.opts.palette=this.palette,this.palette;this.qPixels=this.quantize_image(e,a,r,n,i);for(var p=this.palette,l=this.qPixels,c=new Uint32Array(l.length),f=0;f<l.length;++f)c[f]=p[l[f]];return c},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return 256<this.opts.colors||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return-1<this.m_transparentPixelIndex?0:-1},t.prototype.getDitherFn=function(){return this.opts.dithering?D:e},t.prototype.getColorIndex=function(t,e,r,n){return z(t,e,r,n,this.hasSemiTransparency,0<=this.m_transparentPixelIndex)},t.prototype.getResult=function(){var n=this;return new Promise(function(t,e){var r=n.quantizeImage();n.opts.paletteOnly?t({pal8:r,indexedPixels:n.getIndexedPixels(),transparent:n.getTransparentIndex(),type:n.getImgType()}):t({img8:r,pal8:n.getPalette(),indexedPixels:n.getIndexedPixels(),transparent:n.getTransparentIndex(),type:n.getImgType()})})},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);