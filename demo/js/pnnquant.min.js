(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[]}Math.clamp||(Math.clamp=function(t,r,e){return this.max(r,this.min(e,t))});var r=[],e=[];function a(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function n(t,r,e,a,n){return n?(240&t)<<8|(240&r)<<4|240&e|a>>4:(248&r)<<8|(252&e)<<3|a>>3}function i(t){return t*t}function s(t,r){for(var e=0,a=1e100,n=t[r],s=n.cnt,h=n.ac,o=n.rc,c=n.gc,p=n.bc,l=n.fw;0!=l;l=t[l].fw){var f=t[l].cnt,m=s*f/(s+f);if(!(m>=a)){var u=m*i(t[l].ac-h);u>=a||(u+=m*i(t[l].rc-o))>=a||(u+=m*i(t[l].gc-c))>=a||(u+=m*i(t[l].bc-p))>=a||(a=u,e=l)}}n.err=a,n.nn=e}function h(t,r,a){var n=e[a];if(null!=n)return n;for(var s=0,h=255&a,o=a>>>8&255,c=a>>>16&255,p=a>>>24&255,l=1e100,f=0;f<r;f++){var m=255&t[f],u=t[f]>>>8&255,v=t[f]>>>16&255,g=i((t[f]>>>24&255)-p);g>l||((g+=i(m-h))>l||(g+=i(u-o))>l||(g+=i(v-c))>l||(l=g,s=f))}return e[a]=s,s}function o(t,e,a){var n=0,i=255&a,s=a>>>8&255,h=a>>>16&255,o=a>>>24&255,c=r[a];if(!c){for((c=[])[2]=c[3]=1e100;n<e;n++){var p=255&t[n],l=t[n]>>>8&255,f=t[n]>>>16&255,m=t[n]>>>24&255;c[4]=Math.abs(o-m)+Math.abs(i-p)+Math.abs(s-l)+Math.abs(h-f),c[4]<c[2]?(c[1]=c[0],c[3]=c[2],c[0]=n,c[2]=c[4]):c[4]<c[3]&&(c[1]=n,c[3]=c[4])}1e100==c[3]&&(c[2]=0)}return n=0==c[2]||Math.floor(32769*Math.random())%(c[3]+c[2])<=c[3]?c[0]:c[1],r[a]=c,n}function c(t,r,e,a,n,i,s,h){var o=[];return h?(o[0]=n[(i[s]+4104>>4)+r],o[1]=n[(i[s+1]+4104>>4)+e],o[2]=n[(i[s+2]+4104>>4)+a],o[3]=n[(i[s+3]+4104>>4)+t],o):(o[0]=n[(i[s]+8208>>5)+r],o[1]=n[(i[s+1]+4104>>4)+e],o[2]=n[(i[s+2]+8208>>5)+a],o[3]=t,o)}t.prototype.pnnquan=function(t,r,e){for(var i=new Array(65536),h=0;h<t.length;++h){var o=255&t[h],c=t[h]>>>8&255,p=t[h]>>>16&255,l=n(A=t[h]>>>24&255,o,c,p,this.hasSemiTransparency);null==i[l]&&(i[l]=new a),i[l].ac+=A,i[l].rc+=o,i[l].gc+=c,i[l].bc+=p,i[l].cnt++}var f,m,u,v=0,g=new Uint32Array(65537);for(h=0;h<i.length;++h)if(null!=i[h]){var b=1/i[h].cnt;i[h].ac*=b,i[h].rc*=b,i[h].gc*=b,i[h].bc*=b,e&&(i[h].cnt=Math.sqrt(i[h].cnt)),i[v++]=i[h]}for(h=0;h<v-1;++h)i[h].fw=h+1,i[h+1].bk=h;for(h=0;h<v;++h){s(i,h);var d=i[h].err;for(m=++g[0];m>1&&!(i[f=g[u=m>>1]].err<=d);m=u)g[m]=f;g[m]=h}var y=v-r;for(h=0;h<y;){for(var w;;){var x=g[1];if((w=i[x]).tm>=w.mtm&&i[w.nn].mtm<=w.tm)break;65535==w.mtm?x=g[1]=g[g[0]--]:(s(i,x),w.tm=h);d=i[x].err;for(m=1;(u=m+m)<=g[0]&&(u<g[0]&&i[g[u]].err>i[g[u+1]].err&&u++,!(d<=i[f=g[u]].err));m=u)g[m]=f;g[m]=x}var M=i[w.nn],_=w.cnt,I=M.cnt;b=1/(_+I);w.ac=b*(_*w.ac+I*M.ac),w.rc=b*(_*w.rc+I*M.rc),w.gc=b*(_*w.gc+I*M.gc),w.bc=b*(_*w.bc+I*M.bc),w.cnt+=M.cnt,w.mtm=++h,i[M.bk].fw=M.fw,i[M.fw].bk=M.bk,M.mtm=65535}delete g;var P=0;for(h=0;;++P){var A=Math.round(Math.clamp(i[h].ac,0,255));o=Math.round(Math.clamp(i[h].rc,0,255)),c=Math.round(Math.clamp(i[h].gc,0,255)),p=Math.round(Math.clamp(i[h].bc,0,255));if(this.palette[P]=A<<24|p<<16|c<<8|o,this.m_transparentPixelIndex>=0&&this.palette[P]==this.m_transparentColor){var k=this.palette[0];this.palette[0]=this.palette[P],this.palette[P]=k}if(0==(h=i[h].fw))break}void 0!==this.palette.sort&&this.palette.sort()},t.prototype.quantize_image=function(t,r,e,a,n,i){var s=0;if(i){const i=4,o=20;for(var p=(a+2)*i,l=new Uint32Array(256*i),f=new Uint32Array(512),m=0;m<256;++m)l[m]=0,l[m+256]=m,l[m+512]=255,l[m+768]=255,f[m]=-o,f[m+256]=o;for(m=-o;m<=o;++m)f[m+256]=m;var u=1,v=new Uint32Array(p),g=new Uint32Array(p);for(m=0;m<n;++m){u<0&&(s+=a-1);var b=i,d=a*i;g[d]=g[d+1]=g[d+2]=g[d+3]=0;for(var y=0;y<a;y++){var w=255&t[s],x=t[s]>>>8&255,M=t[s]>>>16&255,_=c(t[s]>>>24&255,w,x,M,l,v,b,this.hasSemiTransparency),I=_[0],P=_[1],A=_[2],k=_[3],U=k<<24|A<<16|P<<8|I;e[s]=h(this.palette,r,U);var q=this.palette[e[s]],T=q>>>8&255,C=q>>>16&255,S=q>>>24&255;I=f[I-(255&q)+256],P=f[P-T+256],A=f[A-C+256],k=f[k-S+256];var z=2*I;g[d-i]=I,g[d+i]+=I+=z,g[d]+=I+=z,v[b+i]+=I+=z,z=2*P,g[d+1-i]=P,g[d+1+i]+=P+=z,g[d+1]+=P+=z,v[b+1+i]+=P+=z,z=2*A,g[d+2-i]=A,g[d+2+i]+=A+=z,g[d+2]+=A+=z,v[b+2+i]+=A+=z,z=2*k,g[d+3-i]=k,g[d+3+i]+=k+=z,g[d+3]+=k+=z,v[b+3+i]+=k+=z,b+=i,d-=i,s+=u}m%2==1&&(s+=a+1),u*=-1;var Q=v;v=g,g=Q}return!0}if(this.m_transparentPixelIndex>=0||r<64)for(m=0;m<e.length;++m)e[m]=h(this.palette,r,t[m]);else for(m=0;m<e.length;++m)e[m]=o(this.palette,r,t[m]);return!0},t.prototype.quantizeImage=function(){for(var t=this.opts.pixels,a=this.opts.width,n=this.opts.height,i=this.opts.colors,s=this.opts.dithering,h=0;h<t.length;++h){var o=t[h]>>>24&255;o<255&&(this.hasSemiTransparency=!0,0==o&&(this.m_transparentPixelIndex=h,this.m_transparentColor=t[h]))}var c=new Uint32Array(t.length);if(this.palette=new Uint32Array(i),i>2?this.pnnquan(t,i,!0):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.quantize_image(t,i,c,a,n,s),this.m_transparentPixelIndex>=0){var p=c[this.m_transparentPixelIndex];if(i>2)this.palette[p]=this.m_transparentColor;else if(palette[p]!=this.m_transparentColor){var l=palette[0];this.palette[0]=palette[1],this.palette[1]=l}}return r=[],e=[],function(t,r){for(var e=0;e<r.length;++e)r[e]=t[r[e]];return r}(this.palette,c)},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.hasSemiTransparency?"image/png":"image/gif"},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);