(function(){function t(t){this.opts=t||{},this.alphaThreshold=0,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,r,e){return this.max(r,this.min(e,t))});var r=.299,e=.587,n=.114,a=[],i=[];function s(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function h(t,r,e,n,a,i){return a?(240&t)<<8|(240&r)<<4|240&e|n>>4:i?(128&t)<<8|(248&r)<<7|(248&e)<<2|n>>3:(248&r)<<8|(252&e)<<3|n>>3}function o(t){return t*t}function l(t,r){for(var e=0,n=1e100,a=t[r],i=a.cnt,s=a.ac,h=a.rc,l=a.gc,p=a.bc,c=a.fw;0!=c;c=t[c].fw){var f=t[c].cnt,m=i*f/(i+f);if(!(m>=n)){var u=m*o(t[c].ac-s);u>=n||(u+=m*o(t[c].rc-h))>=n||(u+=m*o(t[c].gc-l))>=n||(u+=m*o(t[c].bc-p))>=n||(n=u,e=c)}}a.err=n,a.nn=e}function p(t,a,s){var h=i[s];if(null!=h)return h;var l=0,p=255&s,c=s>>>8&255,f=s>>>16&255,m=s>>>24&255;if(m<=this.alphaThreshold)return l;for(var u=1e100,v=0;v<a;v++){var x=255&t[v],g=t[v]>>>8&255,d=t[v]>>>16&255,y=o((t[v]>>>24&255)-m);y>u||((y+=r*o(x-p))>u||(y+=e*o(g-c))>u||(y+=n*o(d-f))>u||(u=y,l=v))}return i[s]=l,l}function c(t,r,e){var n=0,i=255&e,s=e>>>8&255,h=e>>>16&255,o=e>>>24&255,l=a[e];if(!l){for((l=[])[2]=l[3]=1e100;n<r;n++){var p=255&t[n],c=t[n]>>>8&255,f=t[n]>>>16&255,m=t[n]>>>24&255;l[4]=Math.abs(o-m)+Math.abs(i-p)+Math.abs(s-c)+Math.abs(h-f),l[4]<l[2]?(l[1]=l[0],l[3]=l[2],l[0]=n,l[2]=l[4]):l[4]<l[3]&&(l[1]=n,l[3]=l[4])}1e100==l[3]&&(l[2]=0)}return n=0==l[2]||Math.floor(32769*Math.random())%(l[3]+l[2])<=l[3]?l[0]:l[1],a[e]=l,n}function f(t,r,e,n,a,i,s,h){var o=new Int32Array(4);return h?(o[0]=a[(i[s]+4104>>4)+r],o[1]=a[(i[s+1]+4104>>4)+e],o[2]=a[(i[s+2]+4104>>4)+n],o[3]=a[(i[s+3]+4104>>4)+t],o):(o[0]=a[(i[s]+8208>>5)+r],o[1]=a[(i[s+1]+4104>>4)+e],o[2]=a[(i[s+2]+8208>>5)+n],o[3]=t,o)}t.prototype.pnnquan=function(t,r,e){for(var n=new Array(65536),a=0;a<t.length;++a){var i=255&t[a],p=t[a]>>>8&255,c=t[a]>>>16&255,f=h(T=t[a]>>>24&255,i,p,c,this.hasSemiTransparency,r<64||this.m_transparentPixelIndex>=0);null==n[f]&&(n[f]=new s),n[f].ac+=T,n[f].rc+=i,n[f].gc+=p,n[f].bc+=c,n[f].cnt++}var m,u,v,x=0;for(a=0;a<n.length;++a)if(null!=n[a]){var g=1/n[a].cnt;n[a].ac*=g,n[a].rc*=g,n[a].gc*=g,n[a].bc*=g,n[x++]=n[a]}r<16&&(e=-1),o(r)/x<.03&&(e=0),e>0?n[0].cnt=0|Math.sqrt(n[0].cnt):e<0&&(n[0].cnt=0|Math.cbrt(n[0].cnt));for(a=0;a<x-1;++a)n[a].fw=a+1,n[a+1].bk=a,e>0?n[a+1].cnt=0|Math.sqrt(n[a+1].cnt):e<0&&(n[a+1].cnt=0|Math.cbrt(n[a+1].cnt));var d=new Uint32Array(n.length+1);for(a=0;a<x;++a){l(n,a);var y=n[a].err;for(u=++d[0];u>1&&!(n[m=d[v=u>>1]].err<=y);u=v)d[u]=m;d[u]=a}var b=x-r;for(a=0;a<b;){for(var P;;){var w=d[1];if((P=n[w]).tm>=P.mtm&&n[P.nn].mtm<=P.tm)break;65535==P.mtm?w=d[1]=d[d[0]--]:(l(n,w),P.tm=a);y=n[w].err;for(u=1;(v=u+u)<=d[0]&&(v<d[0]&&n[d[v]].err>n[d[v+1]].err&&++v,!(y<=n[m=d[v]].err));u=v)d[u]=m;d[u]=w}var I=n[P.nn],M=P.cnt,_=I.cnt;g=1/(M+_);P.ac=g*(M*P.ac+_*I.ac),P.rc=g*(M*P.rc+_*I.rc),P.gc=g*(M*P.gc+_*I.gc),P.bc=g*(M*P.bc+_*I.bc),P.cnt+=I.cnt,P.mtm=++a,n[I.bk].fw=I.fw,n[I.fw].bk=I.bk,I.mtm=65535}var q=0;for(a=0;;++q){var T=Math.round(Math.clamp(n[a].ac,0,255));i=Math.round(Math.clamp(n[a].rc,0,255)),p=Math.round(Math.clamp(n[a].gc,0,255)),c=Math.round(Math.clamp(n[a].bc,0,255));if(this.palette[q]=T<<24|c<<16|p<<8|i,this.m_transparentPixelIndex>=0&&this.palette[q]==this.m_transparentColor){var A=this.palette[0];this.palette[0]=this.palette[q],this.palette[q]=A}if(0==(a=n[a].fw))break}},t.prototype.quantize_image=function(t,r,e,n,a){var i=r>256?new Uint16Array(t.length):new Uint8Array(t.length),s=0;if(a){const a=4,c=256,E=20;for(var o=(e+2)*a,l=new Int32Array(a*c),m=new Int32Array(2*c),u=0;u<c;++u)l[u]=0,l[u+c]=u,l[u+2*c]=255,l[u+3*c]=255,m[u]=-E,m[u+c]=E;for(u=-E;u<=E;++u)m[u+c]=u%4==3?0:u;var v=this.hasSemiTransparency||r<64,x=1,g=new Int32Array(o),d=new Int32Array(o),y=new Int32Array(65536);for(u=0;u<n;++u){x<0&&(s+=e-1);var b=a,P=e*a;d[P]=d[P+1]=d[P+2]=d[P+3]=0;for(var w=0;w<e;++w){var I=255&t[s],M=t[s]>>>8&255,_=t[s]>>>16&255,q=t[s]>>>24&255,T=f(q,I,M,_,l,g,b,v),A=T[0],S=T[1],k=T[2],C=T[3],U=C<<24|k<<16|S<<8|A;if(v){var z=h(C,A,S,k,this.hasSemiTransparency,this.m_transparentPixelIndex>=0);0==y[z]&&(y[z]=0==q?1:p(this.palette,r,U)+1),i[s]=y[z]-1}else i[s]=0==q?0:p(this.palette,r,U);var D=this.palette[i[s]],F=D>>>8&255,O=D>>>16&255,Q=D>>>24&255;A=m[A-(255&D)+c],S=m[S-F+c],k=m[k-O+c],C=m[C-Q+c];var j=2*A;d[P-a]=A,d[P+a]+=A+=j,d[P]+=A+=j,g[b+a]+=A+j,j=2*S,d[P+1-a]=S,d[P+1+a]+=S+=j,d[P+1]+=S+=j,g[b+1+a]+=S+j,j=2*k,d[P+2-a]=k,d[P+2+a]+=k+=j,d[P+2]+=k+=j,g[b+2+a]+=k+j,j=2*C,d[P+3-a]=C,d[P+3+a]+=C+=j,d[P+3]+=C+=j,g[b+3+a]+=C+j,b+=a,P-=a,s+=x}u%2==1&&(s+=e+1),x*=-1;var B=g;g=d,d=B}return this.qPixels=i,this.qPixels}if(this.m_transparentPixelIndex>=0||r<64)for(u=0;u<i.length;++u)i[u]=p(this.palette,r,t[u]);else for(u=0;u<i.length;++u)i[u]=c(this.palette,r,t[u]);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){var t=this.opts.pixels,s=this.opts.width,h=this.opts.height,o=this.opts.colors,l=this.opts.dithering;this.opts.alphaThreshold&&(this.alphaThreshold=this.opts.alphaThreshold),a=[],i=[];for(var p=0;p<t.length;++p){var c=t[p]>>>24&255;c<255&&(0==c?(this.m_transparentPixelIndex=p,this.m_transparentColor=t[p]):this.hasSemiTransparency=!0)}if(o<=32&&(r=e=n=1),this.palette=new Uint32Array(o),o>2?this.pnnquan(t,o,1):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.m_transparentPixelIndex>=0){var f=this.qPixels[this.m_transparentPixelIndex];if(o>2)this.palette[f]=this.m_transparentColor;else if(palette[f]!=this.m_transparentColor){var m=palette[0];this.palette[0]=palette[1],this.palette[1]=m}}return this.opts.paletteOnly?this.palette:(this.qPixels=this.quantize_image(t,o,s,h,l),function(t,r){for(var e=new Uint32Array(r.length),n=0;n<r.length;++n)e[n]=t[r[n]];return e}(this.palette,this.qPixels))},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex>-1?0:-1},t.prototype.getDitherFn=function(){return this.hasSemiTransparency||this.opts.colors<64?p:c},t.prototype.getColorIndex=function(t,r,e,n){return h(t,r,e,n,this.hasSemiTransparency,this.m_transparentPixelIndex>=0)},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);