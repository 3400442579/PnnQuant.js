(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[]}Math.clamp||(Math.clamp=function(t,r,e){return this.max(r,this.min(e,t))});var r=[];function e(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function a(t,r,e,a,n){return n?(240&t)<<8|(240&r)<<4|240&e|a>>4:(248&r)<<8|(252&e)<<3|a>>3}function n(t){return t*t}function i(t,r){for(var e=0,a=1e100,i=t[r],s=i.cnt,h=i.ac,o=i.rc,c=i.gc,p=i.bc,l=i.fw;0!=l;l=t[l].fw){var f=t[l].cnt,m=s*f/(s+f);if(!(m>=a)){var u=m*n(t[l].ac-h);u>=a||(u+=m*n(t[l].rc-o))>=a||(u+=m*n(t[l].gc-c))>=a||(u+=m*n(t[l].bc-p))>=a||(a=u,e=l)}}i.err=a,i.nn=e}function s(t,r,e){for(var a=0,i=255&e,s=e>>>8&255,h=e>>>16&255,o=e>>>24&255,c=1e100,p=0;p<r;p++){var l=255&t[p],f=t[p]>>>8&255,m=t[p]>>>16&255,u=n((t[p]>>>24&255)-o);u>c||((u+=n(l-i))>c||(u+=n(f-s))>c||(u+=n(m-h))>c||(c=u,a=p))}return a}function h(t,e,a){var n=0,i=255&a,s=a>>>8&255,h=a>>>16&255,o=a>>>24&255,c=r[a];if(!c){for((c=[])[2]=c[3]=1e100;n<e;n++){var p=255&t[n],l=t[n]>>>8&255,f=t[n]>>>16&255,m=t[n]>>>24&255;c[4]=Math.abs(o-m)+Math.abs(i-p)+Math.abs(s-l)+Math.abs(h-f),c[4]<c[2]?(c[1]=c[0],c[3]=c[2],c[0]=n,c[2]=c[4]):c[4]<c[3]&&(c[1]=n,c[3]=c[4])}1e100==c[3]&&(c[2]=0)}return n=0==c[2]||Math.floor(32769*Math.random())%(c[3]+c[2])<=c[3]?c[0]:c[1],r[a]=c,n}function o(t,r,e,a,n,i,s,h){var o=[];return h?(o[0]=n[(i[s]+4104>>4)+r],o[1]=n[(i[s+1]+4104>>4)+e],o[2]=n[(i[s+2]+4104>>4)+a],o[3]=n[(i[s+3]+4104>>4)+t],o):(o[0]=n[(i[s]+8208>>5)+r],o[1]=n[(i[s+1]+4104>>4)+e],o[2]=n[(i[s+2]+8208>>5)+a],o[3]=t,o)}t.prototype.pnnquan=function(t,r,n){for(var s=new Array(65536),h=0;h<t.length;++h){var o=255&t[h],c=t[h]>>>8&255,p=t[h]>>>16&255,l=a(A=t[h]>>>24&255,o,c,p,this.hasSemiTransparency);null==s[l]&&(s[l]=new e),s[l].ac+=A,s[l].rc+=o,s[l].gc+=c,s[l].bc+=p,s[l].cnt++}var f,m,u,v=0,g=new Uint32Array(65537);for(h=0;h<s.length;++h)if(null!=s[h]){var b=1/s[h].cnt;s[h].ac*=b,s[h].rc*=b,s[h].gc*=b,s[h].bc*=b,n&&(s[h].cnt=Math.sqrt(s[h].cnt)),s[v++]=s[h]}for(h=0;h<v-1;++h)s[h].fw=h+1,s[h+1].bk=h;for(h=0;h<v;++h){i(s,h);var d=s[h].err;for(m=++g[0];m>1&&!(s[f=g[u=m>>1]].err<=d);m=u)g[m]=f;g[m]=h}var y=v-r;for(h=0;h<y;){for(var w;;){var x=g[1];if((w=s[x]).tm>=w.mtm&&s[w.nn].mtm<=w.tm)break;65535==w.mtm?x=g[1]=g[g[0]--]:(i(s,x),w.tm=h);d=s[x].err;for(m=1;(u=m+m)<=g[0]&&(u<g[0]&&s[g[u]].err>s[g[u+1]].err&&u++,!(d<=s[f=g[u]].err));m=u)g[m]=f;g[m]=x}var M=s[w.nn],_=w.cnt,I=M.cnt;b=1/(_+I);w.ac=b*(_*w.ac+I*M.ac),w.rc=b*(_*w.rc+I*M.rc),w.gc=b*(_*w.gc+I*M.gc),w.bc=b*(_*w.bc+I*M.bc),w.cnt+=M.cnt,w.mtm=++h,s[M.bk].fw=M.fw,s[M.fw].bk=M.bk,M.mtm=65535}delete g;var P=0;for(h=0;;++P){var A=Math.round(Math.clamp(s[h].ac,0,255));o=Math.round(Math.clamp(s[h].rc,0,255)),c=Math.round(Math.clamp(s[h].gc,0,255)),p=Math.round(Math.clamp(s[h].bc,0,255));if(this.palette[P]=A<<24|p<<16|c<<8|o,this.m_transparentPixelIndex>=0&&this.palette[P]==this.m_transparentColor){var k=this.palette[0];this.palette[0]=this.palette[P],this.palette[P]=k}if(0==(h=s[h].fw))break}void 0!==this.palette.sort&&this.palette.sort()},t.prototype.quantize_image=function(t,r,e,a,n,i){var c=0;if(i){const i=4,h=20;for(var p=(a+2)*i,l=new Uint32Array(256*i),f=new Uint32Array(512),m=0;m<256;++m)l[m]=0,l[m+256]=m,l[m+512]=255,l[m+768]=255,f[m]=-h,f[m+256]=h;for(m=-h;m<=h;++m)f[m+256]=m;var u=!1,v=new Uint32Array(p),g=new Uint32Array(p);for(m=0;m<n;++m){var b,d,y;u?(b=-1,c+=a-1,d=g,y=v):(b=1,d=v,y=g);var w=i,x=a*i;y[x]=y[x+1]=y[x+2]=y[x+3]=0;for(var M=0;M<a;M++){var _=255&t[c],I=t[c]>>>8&255,P=t[c]>>>16&255,A=o(t[c]>>>24&255,_,I,P,l,d,w,this.hasSemiTransparency),k=A[0],U=A[1],q=A[2],T=A[3],C=T<<24|q<<16|U<<8|k;e[c]=s(this.palette,r,C);var S=this.palette[e[c]],z=S>>>8&255,Q=S>>>16&255,j=S>>>24&255;k=f[k-(255&S)+256],U=f[U-z+256],q=f[q-Q+256],T=f[T-j+256];var B=2*k;y[x-i]=k,y[x+i]+=k+=B,y[x]+=k+=B,d[w+i]+=k+=B,B=2*U,y[x+1-i]=U,y[x+1+i]+=U+=B,y[x+1]+=U+=B,d[w+1+i]+=U+=B,B=2*q,y[x+2-i]=q,y[x+2+i]+=q+=B,y[x+2]+=q+=B,d[w+2+i]+=q+=B,B=2*T,y[x+3-i]=T,y[x+3+i]+=T+=B,y[x+3]+=T+=B,d[w+3+i]+=T+=B,w+=i,x-=i,c+=b}m%2==1&&(c+=a+1),u=!u}return!0}if(this.m_transparentPixelIndex>=0||r<64)for(m=0;m<e.length;++m)e[m]=s(this.palette,r,t[m]);else for(m=0;m<e.length;++m)e[m]=h(this.palette,r,t[m]);return!0},t.prototype.quantizeImage=function(){for(var t=this.opts.pixels,e=this.opts.width,a=this.opts.height,n=this.opts.colors,i=this.opts.dithering,s=0;s<t.length;++s){var h=t[s]>>>24&255;h<255&&(this.hasSemiTransparency=!0,0==h&&(this.m_transparentPixelIndex=s,this.m_transparentColor=t[s]))}var o=new Uint32Array(t.length);if(this.palette=new Uint32Array(n),n>2?this.pnnquan(t,n,!0):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.quantize_image(t,n,o,e,a,i),this.m_transparentPixelIndex>=0){var c=o[this.m_transparentPixelIndex];if(n>2)this.palette[c]=this.m_transparentColor;else if(palette[c]!=this.m_transparentColor){var p=palette[0];this.palette[0]=palette[1],this.palette[1]=p}}return r=[],function(t,r){for(var e=0;e<r.length;++e)r[e]=t[r[e]];return r}(this.palette,o)},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.hasSemiTransparency?"image/png":"image/gif"},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);