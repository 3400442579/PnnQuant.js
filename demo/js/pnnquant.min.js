(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[]}Math.clamp=function(t,r,e){return this.max(r,this.min(e,t))};var r=[];function e(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function a(t,r,e,a,n,i){return n?(240&t)<<8|(240&r)<<4|240&e|a>>4:i>=0?(128&t)<<8|(248&r)<<7|(248&e)<<2|a>>3:(248&r)<<8|(252&e)<<3|a>>3}function n(t){return t*t}function i(t,r){for(var e=0,a=1e100,i=t[r],s=i.cnt,h=i.ac,o=i.rc,c=i.gc,p=i.bc,l=i.fw;0!=l;l=t[l].fw){var f,m;f=n(t[l].ac-h)+n(t[l].rc-o)+n(t[l].gc-c)+n(t[l].bc-p),(f*=s*(m=t[l].cnt)/(s+m))>=a||(a=f,e=l)}i.err=a,i.nn=e}function s(t,r,e){for(var a=0,i=255&e,s=e>>>8&255,h=e>>>16&255,o=e>>>24&255,c=1e100,p=0;p<r;p++){var l=255&t[p],f=t[p]>>>8&255,m=t[p]>>>16&255,u=n((t[p]>>>24&255)-o);u>c||((u+=n(l-i))>c||(u+=n(f-s))>c||(u+=n(m-h))>c||(c=u,a=p))}return a}function h(t,e,a){var n=0,i=255&a,s=a>>>8&255,h=a>>>16&255,o=a>>>24&255,c=r[a];if(!c){for((c=[])[2]=c[3]=1e100;n<e;n++){var p=255&t[n],l=t[n]>>>8&255,f=t[n]>>>16&255,m=t[n]>>>24&255;c[4]=Math.abs(o-m)+Math.abs(i-p)+Math.abs(s-l)+Math.abs(h-f),c[4]<c[2]?(c[1]=c[0],c[3]=c[2],c[0]=n,c[2]=c[4]):c[4]<c[3]&&(c[1]=n,c[3]=c[4])}1e100==c[3]&&(c[2]=0)}return n=0==c[2]||Math.floor(32769*Math.random())%(c[3]+c[2])<=c[3]?c[0]:c[1],r[a]=c,n}t.prototype.pnnquan=function(t,r,n){for(var s=new Array(65536),h=0;h<t.length;++h){var o=255&t[h],c=t[h]>>>8&255,p=t[h]>>>16&255,l=a(A=t[h]>>>24&255,o,c,p,this.hasSemiTransparency,this.m_transparentPixelIndex);null==s[l]&&(s[l]=new e),s[l].ac+=A,s[l].rc+=o,s[l].gc+=c,s[l].bc+=p,s[l].cnt++}var f,m,u,v=0,d=new Uint32Array(65537);for(h=0;h<s.length;++h)if(null!=s[h]){var g=1/s[h].cnt;s[h].ac*=g,s[h].rc*=g,s[h].gc*=g,s[h].bc*=g,n&&(s[h].cnt=Math.sqrt(s[h].cnt)),s[v++]=s[h]}for(h=0;h<v-1;++h)s[h].fw=h+1,s[h+1].bk=h;for(h=0;h<v;++h){i(s,h);var x=s[h].err;for(m=++d[0];m>1&&!(s[f=d[u=m>>1]].err<=x);m=u)d[m]=f;d[m]=h}var b=v-r;for(h=0;h<b;){for(var w;;){var y=d[1];if((w=s[y]).tm>=w.mtm&&s[w.nn].mtm<=w.tm)break;65535==w.mtm?y=d[1]=d[d[0]--]:(i(s,y),w.tm=h);x=s[y].err;for(m=1;(u=m+m)<=d[0]&&(u<d[0]&&s[d[u]].err>s[d[u+1]].err&&u++,!(x<=s[f=d[u]].err));m=u)d[m]=f;d[m]=y}var M=s[w.nn],_=w.cnt,P=M.cnt;g=1/(_+P);w.ac=g*(_*w.ac+P*M.ac),w.rc=g*(_*w.rc+P*M.rc),w.gc=g*(_*w.gc+P*M.gc),w.bc=g*(_*w.bc+P*M.bc),w.cnt+=M.cnt,w.mtm=++h,s[M.bk].fw=M.fw,s[M.fw].bk=M.bk,M.mtm=65535}delete d;var I=0;for(h=0;;++I){var A=Math.round(Math.clamp(s[h].ac,0,255));o=Math.round(Math.clamp(s[h].rc,0,255)),c=Math.round(Math.clamp(s[h].gc,0,255)),p=Math.round(Math.clamp(s[h].bc,0,255));if(this.palette[I]=A<<24|p<<16|c<<8|o,this.m_transparentPixelIndex>=0&&this.palette[I]==this.m_transparentColor){var U=this.palette[0];this.palette[0]=this.palette[I],this.palette[I]=U}if(0==(h=s[h].fw))break}void 0!==this.palette.sort&&this.palette.sort()},t.prototype.quantize_image=function(t,r,e,n,i,o){var c=0;if(o){const h=4,o=20;for(var p=(n+2)*h,l=new Uint32Array(256*h),f=new Uint32Array(512),m=0;m<256;++m)l[m]=0,l[m+256]=m,l[m+512]=255,l[m+768]=255,f[m]=-o,f[m+256]=o;for(m=-o;m<=o;++m)f[m+256]=m;var u=!1,v=new Uint32Array(p),d=new Uint32Array(p),g=new Uint32Array(65536);for(m=0;m<i;++m){var x,b,w;u?(x=-1,c+=n-1,b=d,w=v):(x=1,b=v,w=d);var y=h,M=n*h;w[M]=w[M+1]=w[M+2]=w[M+3]=0;for(var _=0;_<n;_++){var P=255&t[c],I=t[c]>>>8&255,A=t[c]>>>16&255,U=t[c]>>>24&255,k=l[(b[y]+4104>>4)+P],q=l[(b[y+1]+4104>>4)+I],C=l[(b[y+2]+4104>>4)+A],S=l[(b[y+3]+4104>>4)+U],T=S<<24|C<<16|q<<8|k,z=a(S,k,q,C,this.hasSemiTransparency,this.m_transparentPixelIndex);0==g[z]&&(g[z]=s(this.palette,r,T)+1),e[c]=g[z]-1;var Q=this.palette[e[c]],j=Q>>>8&255,B=Q>>>16&255,D=Q>>>24&255;k=f[k-(255&Q)+256],q=f[q-j+256],C=f[C-B+256],S=f[S-D+256];var E=2*k;w[M-h]=k,w[M+h]+=k+=E,w[M]+=k+=E,b[y+h]+=k+=E,E=2*q,w[M+1-h]=q,w[M+1+h]+=q+=E,w[M+1]+=q+=E,b[y+1+h]+=q+=E,E=2*C,w[M+2-h]=C,w[M+2+h]+=C+=E,w[M+2]+=C+=E,b[y+2+h]+=C+=E,E=2*S,w[M+3-h]=S,w[M+3+h]+=S+=E,w[M+3]+=S+=E,b[y+3+h]+=S+=E,y+=h,M-=h,c+=x}m%2==1&&(c+=n+1),u=!u}return!0}if(this.m_transparentPixelIndex>=0||r<64)for(m=0;m<e.length;++m)e[m]=s(this.palette,r,t[m]);else for(m=0;m<e.length;++m)e[m]=h(this.palette,r,t[m]);return!0},t.prototype.quantizeImage=function(){for(var t=this.opts.pixels,e=this.opts.width,a=this.opts.height,n=this.opts.colors,i=this.opts.dithering,s=0;s<t.length;++s){var h=t[s]>>>24&255;h<255&&(this.hasSemiTransparency=!0,0==h&&(this.m_transparentPixelIndex=s,this.m_transparentColor=t[s]))}var o=new Uint32Array(t.length);this.palette=new Uint32Array(n);var c=n>255;if(n>2?this.pnnquan(t,n,c):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.quantize_image(t,n,o,e,a,i),this.m_transparentPixelIndex>=0){var p=o[this.m_transparentPixelIndex];if(n>2)this.palette[p]=this.m_transparentColor;else if(palette[p]!=this.m_transparentColor){var l=palette[0];this.palette[0]=palette[1],this.palette[1]=l}}return r=[],function(t,r){for(var e=0;e<r.length;++e)r[e]=t[r[e]];return r}(this.palette,o)},t.prototype.getPalette=function(){return this.palette.buffer},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);