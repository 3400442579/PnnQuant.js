(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[]}Math.clamp||(Math.clamp=function(t,r,e){return this.max(r,this.min(e,t))});var r=[],e=[];function a(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function n(t,r,e,a,n){return n?(240&t)<<8|(240&r)<<4|240&e|a>>4:(248&r)<<8|(252&e)<<3|a>>3}function i(t){return t*t}function s(t,r){for(var e=0,a=1e100,n=t[r],s=n.cnt,h=n.ac,c=n.rc,o=n.gc,p=n.bc,l=n.fw;0!=l;l=t[l].fw){var f=t[l].cnt,m=s*f/(s+f);if(!(m>=a)){var u=m*i(t[l].ac-h);u>=a||(u+=m*i(t[l].rc-c))>=a||(u+=m*i(t[l].gc-o))>=a||(u+=m*i(t[l].bc-p))>=a||(a=u,e=l)}}n.err=a,n.nn=e}function h(t,r,a){var n=e[a];if(null!=n)return n;for(var s=0,h=255&a,c=a>>>8&255,o=a>>>16&255,p=a>>>24&255,l=1e100,f=0;f<r;f++){var m=255&t[f],u=t[f]>>>8&255,v=t[f]>>>16&255,g=i((t[f]>>>24&255)-p);g>l||((g+=i(m-h))>l||(g+=i(u-c))>l||(g+=i(v-o))>l||(l=g,s=f))}return e[a]=s,s}function c(t,e,a){var n=0,i=255&a,s=a>>>8&255,h=a>>>16&255,c=a>>>24&255,o=r[a];if(!o){for((o=[])[2]=o[3]=1e100;n<e;n++){var p=255&t[n],l=t[n]>>>8&255,f=t[n]>>>16&255,m=t[n]>>>24&255;o[4]=Math.abs(c-m)+Math.abs(i-p)+Math.abs(s-l)+Math.abs(h-f),o[4]<o[2]?(o[1]=o[0],o[3]=o[2],o[0]=n,o[2]=o[4]):o[4]<o[3]&&(o[1]=n,o[3]=o[4])}1e100==o[3]&&(o[2]=0)}return n=0==o[2]||Math.floor(32769*Math.random())%(o[3]+o[2])<=o[3]?o[0]:o[1],r[a]=o,n}function o(t,r,e,a,n,i,s,h){var c=[];return h?(c[0]=n[(i[s]+4104>>4)+r],c[1]=n[(i[s+1]+4104>>4)+e],c[2]=n[(i[s+2]+4104>>4)+a],c[3]=n[(i[s+3]+4104>>4)+t],c):(c[0]=n[(i[s]+8208>>5)+r],c[1]=n[(i[s+1]+4104>>4)+e],c[2]=n[(i[s+2]+8208>>5)+a],c[3]=t,c)}t.prototype.pnnquan=function(t,r,e){for(var h=new Array(65536),c=0;c<t.length;++c){var o=255&t[c],p=t[c]>>>8&255,l=t[c]>>>16&255,f=n(k=t[c]>>>24&255,o,p,l,this.hasSemiTransparency);null==h[f]&&(h[f]=new a),h[f].ac+=k,h[f].rc+=o,h[f].gc+=p,h[f].bc+=l,h[f].cnt++}var m,u,v,g=0;for(c=0;c<h.length;++c)if(null!=h[c]){var b=1/h[c].cnt;h[c].ac*=b,h[c].rc*=b,h[c].gc*=b,h[c].bc*=b,h[g++]=h[c]}r<16&&(e=-1),i(r)/g<.022&&(e=0),e>0?h[0].cnt=0|Math.sqrt(h[0].cnt):e<0&&(h[0].cnt=0|Math.cbrt(h[0].cnt));for(c=0;c<g-1;++c)h[c].fw=c+1,h[c+1].bk=c,e>0?h[c+1].cnt=0|Math.sqrt(h[c+1].cnt):e<0&&(h[c+1].cnt=0|Math.cbrt(h[c+1].cnt));var d=new Uint32Array(65537);for(c=0;c<g;++c){s(h,c);var y=h[c].err;for(u=++d[0];u>1&&!(h[m=d[v=u>>1]].err<=y);u=v)d[u]=m;d[u]=c}var M=g-r;for(c=0;c<M;){for(var w;;){var x=d[1];if((w=h[x]).tm>=w.mtm&&h[w.nn].mtm<=w.tm)break;65535==w.mtm?x=d[1]=d[d[0]--]:(s(h,x),w.tm=c);y=h[x].err;for(u=1;(v=u+u)<=d[0]&&(v<d[0]&&h[d[v]].err>h[d[v+1]].err&&++v,!(y<=h[m=d[v]].err));u=v)d[u]=m;d[u]=x}var _=h[w.nn],I=w.cnt,P=_.cnt;b=1/(I+P);w.ac=b*(I*w.ac+P*_.ac),w.rc=b*(I*w.rc+P*_.rc),w.gc=b*(I*w.gc+P*_.gc),w.bc=b*(I*w.bc+P*_.bc),w.cnt+=_.cnt,w.mtm=++c,h[_.bk].fw=_.fw,h[_.fw].bk=_.bk,_.mtm=65535}delete d;var A=0;for(c=0;;++A){var k=Math.round(Math.clamp(h[c].ac,0,255));o=Math.round(Math.clamp(h[c].rc,0,255)),p=Math.round(Math.clamp(h[c].gc,0,255)),l=Math.round(Math.clamp(h[c].bc,0,255));if(this.palette[A]=k<<24|l<<16|p<<8|o,this.m_transparentPixelIndex>=0&&this.palette[A]==this.m_transparentColor){var q=this.palette[0];this.palette[0]=this.palette[A],this.palette[A]=q}if(0==(c=h[c].fw))break}void 0!==this.palette.sort&&this.palette.sort()},t.prototype.quantize_image=function(t,r,e,a,n){var i=new Uint32Array(t.length),s=0;if(n){const n=4,c=256,B=20;for(var p=(e+2)*n,l=new Uint32Array(n*c),f=new Uint32Array(2*c),m=0;m<c;++m)l[m]=0,l[m+c]=m,l[m+2*c]=255,l[m+3*c]=255,f[m]=-B,f[m+c]=B;for(m=-B;m<=B;++m)f[m+c]=m;var u=this.hasSemiTransparency||r<64,v=1,g=new Uint32Array(p),b=new Uint32Array(p);for(m=0;m<a;++m){v<0&&(s+=e-1);var d=n,y=e*n;b[y]=b[y+1]=b[y+2]=b[y+3]=0;for(var M=0;M<e;++M){var w=255&t[s],x=t[s]>>>8&255,_=t[s]>>>16&255,I=o(t[s]>>>24&255,w,x,_,l,g,d,u),P=I[0],A=I[1],k=I[2],q=I[3],U=q<<24|k<<16|A<<8|P;i[s]=h(this.palette,r,U);var T=this.palette[i[s]],C=T>>>8&255,S=T>>>16&255,z=T>>>24&255;P=f[P-(255&T)+c],A=f[A-C+c],k=f[k-S+c],q=f[q-z+c];var Q=2*P;b[y-n]=P,b[y+n]+=P+=Q,b[y]+=P+=Q,g[d+n]+=P+=Q,Q=2*A,b[y+1-n]=A,b[y+1+n]+=A+=Q,b[y+1]+=A+=Q,g[d+1+n]+=A+=Q,Q=2*k,b[y+2-n]=k,b[y+2+n]+=k+=Q,b[y+2]+=k+=Q,g[d+2+n]+=k+=Q,Q=2*q,b[y+3-n]=q,b[y+3+n]+=q+=Q,b[y+3]+=q+=Q,g[d+3+n]+=q+=Q,d+=n,y-=n,s+=v}m%2==1&&(s+=e+1),v*=-1;var j=g;g=b,b=j}return i}if(this.m_transparentPixelIndex>=0||r<64)for(m=0;m<i.length;++m)i[m]=h(this.palette,r,t[m]);else for(m=0;m<i.length;++m)i[m]=c(this.palette,r,t[m]);return i},t.prototype.quantizeImage=function(){for(var t=this.opts.pixels,a=this.opts.width,n=this.opts.height,i=this.opts.colors,s=this.opts.dithering,h=0;h<t.length;++h){var c=t[h]>>>24&255;c<255&&(this.hasSemiTransparency=!0,0==c&&(this.m_transparentPixelIndex=h,this.m_transparentColor=t[h]))}this.palette=new Uint32Array(i),i>2?this.pnnquan(t,i,1):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295);var o=this.quantize_image(t,i,a,n,s);if(this.m_transparentPixelIndex>=0){var p=o[this.m_transparentPixelIndex];if(i>2)this.palette[p]=this.m_transparentColor;else if(palette[p]!=this.m_transparentColor){var l=palette[0];this.palette[0]=palette[1],this.palette[1]=l}}return r=[],e=[],function(t,r){for(var e=0;e<r.length;++e)r[e]=t[r[e]];return r}(this.palette,o)},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.hasSemiTransparency?"image/png":"image/gif"},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);