(function(){function t(t){this.opts=t,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=16777215,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,e,r){return this.max(e,this.min(r,t))});var e,r=15,n=!1,a=!1,i=.299,s=.587,h=.114,o=.3333,p=.5,l=new Map,c=new Map,f=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function u(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=this.err=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0}function m(t,e,r,n,a,i){return a?(240&t)<<8|(240&e)<<4|240&r|n>>4:i?(128&t)<<8|(248&e)<<7|(248&r)<<2|n>>3:(248&e)<<8|(252&r)<<3|n>>3}function g(t){return t*t}function v(t,e){var r=0,n=1e100,l=t[e],c=l.cnt,u=l.ac,m=l.rc,v=l.gc,x=l.bc,d=0;TELL_BLUE_NOISE[4095&e]>-88&&(d=s<f[0][1]?f.length:1);for(var y=l.fw;0!=y;y=t[y].fw){var I=t[y].cnt,_=c*I/(c+I);if(!(_>=n)){var w=0;if(!(a&&(d=1,(w+=_*(1-p)*o*g(t[y].ac-u))>=n)||(w+=_*(1-p)*i*g(t[y].rc-m))>=n||(w+=_*(1-p)*s*g(t[y].gc-v))>=n||(w+=_*(1-p)*h*g(t[y].bc-x))>=n)){for(var P=d;P<f.length&&!((w+=_*p*g(f[P][0]*(t[y].rc-m)))>=n)&&!((w+=_*p*g(f[P][1]*(t[y].gc-v)))>=n)&&!((w+=_*p*g(f[P][2]*(t[y].bc-x)))>=n);++P);n=w,r=y}}}l.err=Math.fround(n),l.nn=r}function x(t,a,p){var l=0,u=a>>>24&255;u<=r&&(u=(a=e)>>>24&255);var m=c.get(a);if(null!=m)return m;t.length>2&&n&&u>r&&(l=1);var v=255&a,x=a>>>8&255,d=a>>>16&255,y=i,I=s,_=h;t.length>2&&TELL_BLUE_NOISE[4095&p]>-88&&(y=f[0][0],I=f[0][1],_=f[0][2]);for(var w=1e100,P=l;P<t.length;P++){var b=255&t[P],M=t[P]>>>8&255,T=t[P]>>>16&255,q=t[P]>>>24&255,C=o*g(q-u);C>w||((C+=y*g(b-v))>w||(C+=I*g(M-x))>w||(C+=_*g(T-d))>w||(w=C,l=P))}return c.set(a,l),l}function d(t,e,p){var c=e>>>24&255;if(c<=r)return x(t,e,p);var u=255&e,m=e>>>8&255,v=e>>>16&255,d=l.get(e);if(!d){(d=new Array(4))[2]=d[3]=65535;var y=i,I=s,_=h;TELL_BLUE_NOISE[4095&p]>-88&&(y=f[0][0],I=f[0][1],_=f[0][2]);for(var w=0;w<t.length;++w){var P=255&t[w],b=t[w]>>>8&255,M=t[w]>>>16&255,T=t[w]>>>24&255,q=y*g(P-u);q>=d[3]||((q+=I*g(b-m))>=d[3]||(q+=_*g(M-v))>=d[3]||(a&&(q+=o*g(T-c)),q<d[2]?(d[1]=d[0],d[3]=d[2],d[0]=w,d[2]=q):q<d[3]&&(d[1]=w,d[3]=q)))}65535==d[3]&&(d[1]=d[0]),l.set(e,d)}var C=t.length<<2,A=(p+1)%2;return.67*d[3]<d[3]-d[2]?A=0:d[0]>d[1]&&(A=p%2),d[A+2]>=C||n&&0==d[A]?x(t,e,p):d[A]}function y(t,e,r,n,a,i,s,h){var o=new Int32Array(4);return h?(o[0]=a[(i[s]+4104>>4)+e],o[1]=a[(i[s+1]+4104>>4)+r],o[2]=a[(i[s+2]+4104>>4)+n],o[3]=a[(i[s+3]+4104>>4)+t],o):(o[0]=a[(i[s]+8208>>5)+e],o[1]=a[(i[s+1]+4104>>4)+r],o[2]=a[(i[s+2]+8208>>5)+n],o[3]=t,o)}t.prototype.pnnquan=function(t,e){l.clear(),c.clear();for(var n=1,a=new Array(65536),p=0;p<t.length;++p){var g=255&t[p],x=t[p]>>>8&255,d=t[p]>>>16&255;(z=t[p]>>>24&255)<=r&&(g=255&this.m_transparentColor,x=this.m_transparentColor>>>8&255,d=this.m_transparentColor>>>16&255,z=this.m_transparentColor>>>24&255);var y=m(z,g,x,d,this.hasSemiTransparency,e<64||this.m_transparentPixelIndex>=0);null==a[y]&&(a[y]=new u),(E=a[y]).ac+=z,E.rc+=g,E.gc+=x,E.bc+=d,E.cnt+=1}var I=0;for(p=0;p<a.length;++p)if(null!=a[p]){var _=1/a[p].cnt;a[p].ac*=_,a[p].rc*=_,a[p].gc*=_,a[p].bc*=_,a[I++]=a[p]}e<16&&(n=-1);var w=this.opts.weight=Math.min(.9,1*e/I);w>.003&&w<.005&&(n=0),w<.03&&s>=f[0][1]&&(i=s=h=o=1,e>=64&&(n=0));for(var P,b,M,T=function(t,e){return e>0?t<64?function(t){return Math.fround(Math.sqrt(t))}:function(t){return 0|Math.sqrt(t)}:e<0?function(t){return 0|Math.cbrt(t)}:function(t){return t}}(e,n),q=0;q<I-1;++q)a[q].fw=q+1,a[q+1].bk=q,a[q].cnt=T(a[q].cnt);a[q].cnt=T(a[q].cnt);var C=new Uint32Array(a.length+1);for(p=0;p<I;++p){v(a,p);var A=a[p].err;for(b=++C[0];b>1&&!(a[P=C[M=b>>1]].err<=A);b=M)C[b]=P;C[b]=p}var S=I-e;for(p=0;p<S;){for(var E;;){var L=C[1];if((E=a[L]).tm>=E.mtm&&a[E.nn].mtm<=E.tm)break;65535==E.mtm?L=C[1]=C[C[0]--]:(v(a,L),E.tm=p);A=a[L].err;for(b=1;(M=b+b)<=C[0]&&(M<C[0]&&a[C[M]].err>a[C[M+1]].err&&++M,!(A<=a[P=C[M]].err));b=M)C[b]=P;C[b]=L}var U=a[E.nn],k=E.cnt,F=U.cnt;_=Math.fround(1/(k+F));E.ac=_*Math.round(k*E.ac+F*U.ac),E.rc=_*Math.round(k*E.rc+F*U.rc),E.gc=_*Math.round(k*E.gc+F*U.gc),E.bc=_*Math.round(k*E.bc+F*U.bc),E.cnt+=F,E.mtm=++p,a[U.bk].fw=U.fw,a[U.fw].bk=U.bk,U.mtm=65535}S<0&&(this.palette=new Uint32Array(I));var O=0;for(p=0;;++O){var z=0|Math.clamp(a[p].ac,0,255);g=0|Math.clamp(a[p].rc,0,255),x=0|Math.clamp(a[p].gc,0,255),d=0|Math.clamp(a[p].bc,0,255);if(this.palette[O]=z<<24|d<<16|x<<8|g,this.m_transparentPixelIndex>=0&&0==z){var D=this.palette[0];this.palette[0]=this.m_transparentColor,this.palette[O]=D}if(0==(p=a[p].fw))break}},t.prototype.quantize_image=function(t,e,r,n,a){var i=e>256?new Uint16Array(t.length):new Uint8Array(t.length),s=0;if(a){const a=4,B=256,N=20;for(var h=(r+2)*a,o=new Int32Array(a*B),p=new Int32Array(2*B),l=0;l<B;++l)o[l]=0,o[l+B]=l,o[l+2*B]=255,o[l+3*B]=255,p[l]=-N,p[l+B]=N;for(l=-N;l<=N;++l)p[l+B]=l;var c=this.hasSemiTransparency||e<64,f=1,u=new Int32Array(h),g=new Int32Array(h),v=new Int32Array(65536);for(l=0;l<n;++l){f<0&&(s+=r-1);var d=a,I=r*a;g[I]=g[I+1]=g[I+2]=g[I+3]=0;for(var _=0;_<r;++_){var w=255&t[s],P=t[s]>>>8&255,b=t[s]>>>16&255,M=t[s]>>>24&255,T=y(M,w,P,b,o,u,d,c),q=T[0],C=T[1],A=T[2],S=T[3],E=S<<24|A<<16|C<<8|q;if(c){var L=m(S,q,C,A,this.hasSemiTransparency,this.m_transparentPixelIndex>=0);0==v[L]&&(v[L]=0==M?1:x(this.palette,E,l+_)+1),i[s]=v[L]-1}else i[s]=0==M?0:x(this.palette,E,l+_);var U=this.palette[i[s]],k=U>>>8&255,F=U>>>16&255,O=U>>>24&255;q=p[q-(255&U)+B],C=p[C-k+B],A=p[A-F+B],S=p[S-O+B];var z=2*q;g[I-a]=q,g[I+a]+=q+=z,g[I]+=q+=z,u[d+a]+=q+z,z=2*C,g[I+1-a]=C,g[I+1+a]+=C+=z,g[I+1]+=C+=z,u[d+1+a]+=C+z,z=2*A,g[I+2-a]=A,g[I+2+a]+=A+=z,g[I+2]+=A+=z,u[d+2+a]+=A+z,z=2*S,g[I+3-a]=S,g[I+3+a]+=S+=z,g[I+3]+=S+=z,u[d+3+a]+=S+z,d+=a,I-=a,s+=f}l%2==1&&(s+=r+1),f*=-1;var D=u;u=g,g=D}return this.qPixels=i,this.qPixels}for(l=0;l<i.length;++l)i[l]=this.getDitherFn()(this.palette,t[l],l);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){var t=this.opts.pixels,p=this.opts.width,u=this.opts.height,m=this.opts.colors,g=this.opts.dithering;this.opts.alphaThreshold&&(r=this.opts.alphaThreshold),l.clear(),c.clear(),n=!1;for(var v=0,x=0;x<t.length;++x){var d=t[x]>>>24&255;d<224&&(0==d?(this.m_transparentPixelIndex=x,n=!0,m>2?this.m_transparentColor=t[x]:t[x]=this.m_transparentColor):d>r&&++v)}if(this.hasSemiTransparency=a=v>0,m<=32?i=s=h=o=1:(i=f[0][0],s=f[0][1],h=f[0][2]),e=this.m_transparentColor,this.palette=new Uint32Array(m),m>2?this.pnnquan(t,m):this.m_transparentPixelIndex>=0?(this.palette[0]=this.m_transparentColor,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),a&&(this.opts.weight*=-1),this.m_transparentPixelIndex>=0){var y=this.getDitherFn()(this.palette,t[this.m_transparentPixelIndex],this.m_transparentPixelIndex);this.palette.length>2?this.palette[y]=this.m_transparentColor:this.palette[y]!=this.m_transparentColor&&(this.palette[0]=this.palette[y],this.palette[y]=this.m_transparentColor,c.clear())}return this.opts.paletteOnly?(this.opts.ditherFn=this.getDitherFn(),this.opts.getColorIndex=this.getColorIndex,this.opts.palette=this.palette,this.palette):(this.qPixels=this.quantize_image(t,m,p,u,g),function(t,e){for(var r=new Uint32Array(e.length),n=0;n<e.length;++n)r[n]=t[e[n]];return r}(this.palette,this.qPixels))},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex>-1?0:-1},t.prototype.getDitherFn=function(){return this.opts.dithering?x:d},t.prototype.getColorIndex=function(t,e,r,n){return m(t,e,r,n,this.hasSemiTransparency,this.m_transparentPixelIndex>=0)},t.prototype.getResult=function(){var t=this;return new Promise(function(e,r){var n=t.quantizeImage();t.opts.paletteOnly?e({pal8:n,indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()}):e({img8:n,pal8:t.getPalette(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()})})},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);