(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[]}Math.clamp=function(t,r,e){return this.max(r,this.min(e,t))};var r=[];function e(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function a(t,r,e,a,n){return n?(240&t)<<8|(240&r)<<4|240&e|a>>4:(248&r)<<8|(252&e)<<3|a>>3}function n(t){return t*t}function i(t,r){for(var e=0,a=1e100,i=t[r],s=i.cnt,h=i.ac,o=i.rc,c=i.gc,p=i.bc,l=i.fw;0!=l;l=t[l].fw){var f,m;f=n(t[l].ac-h)+n(t[l].rc-o)+n(t[l].gc-c)+n(t[l].bc-p),(f*=s*(m=t[l].cnt)/(s+m))>=a||(a=f,e=l)}i.err=a,i.nn=e}function s(t,r,e){for(var a=0,i=255&e,s=e>>>8&255,h=e>>>16&255,o=e>>>24&255,c=1e100,p=0;p<r;p++){var l=255&t[p],f=t[p]>>>8&255,m=t[p]>>>16&255,u=n((t[p]>>>24&255)-o);u>c||((u+=n(l-i))>c||(u+=n(f-s))>c||(u+=n(m-h))>c||(c=u,a=p))}return a}function h(t,e,a){var n=0,i=255&a,s=a>>>8&255,h=a>>>16&255,o=a>>>24&255,c=r[a];if(!c){for((c=[])[2]=c[3]=1e100;n<e;n++){var p=255&t[n],l=t[n]>>>8&255,f=t[n]>>>16&255,m=t[n]>>>24&255;c[4]=Math.abs(o-m)+Math.abs(i-p)+Math.abs(s-l)+Math.abs(h-f),c[4]<c[2]?(c[1]=c[0],c[3]=c[2],c[0]=n,c[2]=c[4]):c[4]<c[3]&&(c[1]=n,c[3]=c[4])}1e100==c[3]&&(c[2]=0)}return n=0==c[2]||Math.floor(32769*Math.random())%(c[3]+c[2])<=c[3]?c[0]:c[1],r[a]=c,n}function o(t,r,e,a,n,i,s,h){var o=[];return h?(o[0]=n[(i[s]+4104>>4)+r],o[1]=n[(i[s+1]+4104>>4)+e],o[2]=n[(i[s+2]+4104>>4)+a],o[3]=n[(i[s+3]+4104>>4)+t],o):(o[0]=n[(i[s]+8208>>5)+r],o[1]=n[(i[s+1]+4104>>4)+e],o[2]=n[(i[s+2]+8208>>5)+a],o[3]=t,o)}t.prototype.pnnquan=function(t,r,n){for(var s=new Array(65536),h=0;h<t.length;++h){var o=255&t[h],c=t[h]>>>8&255,p=t[h]>>>16&255,l=a(P=t[h]>>>24&255,o,c,p,this.hasSemiTransparency);null==s[l]&&(s[l]=new e),s[l].ac+=P,s[l].rc+=o,s[l].gc+=c,s[l].bc+=p,s[l].cnt++}var f,m,u,v=0,g=new Uint32Array(65537);for(h=0;h<s.length;++h)if(null!=s[h]){var y=1/s[h].cnt;s[h].ac*=y,s[h].rc*=y,s[h].gc*=y,s[h].bc*=y,n&&(s[h].cnt=Math.sqrt(s[h].cnt)),s[v++]=s[h]}for(h=0;h<v-1;++h)s[h].fw=h+1,s[h+1].bk=h;for(h=0;h<v;++h){i(s,h);var b=s[h].err;for(m=++g[0];m>1&&!(s[f=g[u=m>>1]].err<=b);m=u)g[m]=f;g[m]=h}var d=v-r;for(h=0;h<d;){for(var w;;){var x=g[1];if((w=s[x]).tm>=w.mtm&&s[w.nn].mtm<=w.tm)break;65535==w.mtm?x=g[1]=g[g[0]--]:(i(s,x),w.tm=h);b=s[x].err;for(m=1;(u=m+m)<=g[0]&&(u<g[0]&&s[g[u]].err>s[g[u+1]].err&&u++,!(b<=s[f=g[u]].err));m=u)g[m]=f;g[m]=x}var M=s[w.nn],_=w.cnt,A=M.cnt;y=1/(_+A);w.ac=y*(_*w.ac+A*M.ac),w.rc=y*(_*w.rc+A*M.rc),w.gc=y*(_*w.gc+A*M.gc),w.bc=y*(_*w.bc+A*M.bc),w.cnt+=M.cnt,w.mtm=++h,s[M.bk].fw=M.fw,s[M.fw].bk=M.bk,M.mtm=65535}delete g;var I=0;for(h=0;;++I){var P=Math.round(Math.clamp(s[h].ac,0,255));o=Math.round(Math.clamp(s[h].rc,0,255)),c=Math.round(Math.clamp(s[h].gc,0,255)),p=Math.round(Math.clamp(s[h].bc,0,255));if(this.palette[I]=P<<24|p<<16|c<<8|o,this.m_transparentPixelIndex>=0&&this.palette[I]==this.m_transparentColor){var U=this.palette[0];this.palette[0]=this.palette[I],this.palette[I]=U}if(0==(h=s[h].fw))break}void 0!==this.palette.sort&&this.palette.sort()},t.prototype.quantize_image=function(t,r,e,n,i,c){var p=0;if(c){const h=4,c=20;for(var l=(n+2)*h,f=new Uint32Array(256*h),m=new Uint32Array(512),u=0;u<256;++u)f[u]=0,f[u+256]=u,f[u+512]=255,f[u+768]=255,m[u]=-c,m[u+256]=c;for(u=-c;u<=c;++u)m[u+256]=u;var v=!1,g=new Uint32Array(l),y=new Uint32Array(l),b=new Uint32Array(65536);for(u=0;u<i;++u){var d,w,x;v?(d=-1,p+=n-1,w=y,x=g):(d=1,w=g,x=y);var M=h,_=n*h;x[_]=x[_+1]=x[_+2]=x[_+3]=0;for(var A=0;A<n;A++){var I=255&t[p],P=t[p]>>>8&255,U=t[p]>>>16&255,k=o(t[p]>>>24&255,I,P,U,f,w,M,this.hasSemiTransparency),T=k[0],q=k[1],S=k[2],C=k[3],z=C<<24|S<<16|q<<8|T,Q=a(C,T,q,S,this.hasSemiTransparency);0==b[Q]&&(b[Q]=s(this.palette,r,z)+1),e[p]=b[Q]-1;var j=this.palette[e[p]],B=j>>>8&255,D=j>>>16&255,E=j>>>24&255;T=m[T-(255&j)+256],q=m[q-B+256],S=m[S-D+256],C=m[C-E+256];var F=2*T;x[_-h]=T,x[_+h]+=T+=F,x[_]+=T+=F,w[M+h]+=T+=F,F=2*q,x[_+1-h]=q,x[_+1+h]+=q+=F,x[_+1]+=q+=F,w[M+1+h]+=q+=F,F=2*S,x[_+2-h]=S,x[_+2+h]+=S+=F,x[_+2]+=S+=F,w[M+2+h]+=S+=F,F=2*C,x[_+3-h]=C,x[_+3+h]+=C+=F,x[_+3]+=C+=F,w[M+3+h]+=C+=F,M+=h,_-=h,p+=d}u%2==1&&(p+=n+1),v=!v}return!0}if(this.m_transparentPixelIndex>=0||r<64)for(u=0;u<e.length;++u)e[u]=s(this.palette,r,t[u]);else for(u=0;u<e.length;++u)e[u]=h(this.palette,r,t[u]);return!0},t.prototype.quantizeImage=function(){for(var t=this.opts.pixels,e=this.opts.width,a=this.opts.height,n=this.opts.colors,i=this.opts.dithering,s=0;s<t.length;++s){var h=t[s]>>>24&255;h<255&&(this.hasSemiTransparency=!0,0==h&&(this.m_transparentPixelIndex=s,this.m_transparentColor=t[s]))}var o=new Uint32Array(t.length);this.palette=new Uint32Array(n);var c=n>255;if(n>2?this.pnnquan(t,n,c):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.quantize_image(t,n,o,e,a,i),this.m_transparentPixelIndex>=0){var p=o[this.m_transparentPixelIndex];if(n>2)this.palette[p]=this.m_transparentColor;else if(palette[p]!=this.m_transparentColor){var l=palette[0];this.palette[0]=palette[1],this.palette[1]=l}}return r=[],function(t,r){for(var e=0;e<r.length;++e)r[e]=t[r[e]];return r}(this.palette,o)},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.hasSemiTransparency?"image/png":"image/gif"},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);