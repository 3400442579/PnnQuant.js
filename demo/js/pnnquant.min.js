(function(){function t(t){this.opts=t,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=16777215,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,e,r){return this.max(e,this.min(r,t))});var e,r=15,n=!1,a=!1,i=.299,s=.587,h=.114,o=.3333,p=.5,l=new Map,c=new Map,f=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function u(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=this.err=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0}function m(t,e,r,n,a,i){return a?(240&t)<<8|(240&e)<<4|240&r|n>>4:i?(128&t)<<8|(248&e)<<7|(248&r)<<2|n>>3:(248&e)<<8|(252&r)<<3|n>>3}function g(t){return t*t}function v(t,e){var r=0,n=1e100,l=t[e],c=l.cnt,u=l.ac,m=l.rc,v=l.gc,x=l.bc,d=0;TELL_BLUE_NOISE[4095&e]>-88&&(d=s<f[0][1]?f.length:1);for(var y=l.fw;0!=y;y=t[y].fw){var I=t[y].cnt,w=c*I/(c+I);if(!(w>=n)){var P=0;if(!(a&&(d=1,(P+=w*(1-p)*o*g(t[y].ac-u))>=n)||(P+=w*(1-p)*i*g(t[y].rc-m))>=n||(P+=w*(1-p)*s*g(t[y].gc-v))>=n||(P+=w*(1-p)*h*g(t[y].bc-x))>=n)){for(var _=d;_<f.length&&!((P+=w*p*g(f[_][0]*(t[y].rc-m)))>=n)&&!((P+=w*p*g(f[_][1]*(t[y].gc-v)))>=n)&&!((P+=w*p*g(f[_][2]*(t[y].bc-x)))>=n);++_);n=P,r=y}}}l.err=Math.fround(n),l.nn=r}function x(t,a,p){var l=0,f=a>>>24&255;f<=r&&(f=(a=e)>>>24&255);var u=c.get(a);if(null!=u)return u;t.length>2&&n&&f>r&&(l=1);var m=255&a,v=a>>>8&255,x=a>>>16&255,d=i,y=s,I=h,w=o;t.length<3&&(d=y=I=w=1);for(var P=1e100,_=l;_<t.length;_++){var b=255&t[_],M=t[_]>>>8&255,q=t[_]>>>16&255,C=w*g((t[_]>>>24&255)-f);C>P||((C+=d*g(b-m))>P||(C+=y*g(M-v))>P||(C+=I*g(q-x))>P||(P=C,l=_))}return c.set(a,l),l}function d(t,e,p){var c=e>>>24&255;if(c<=r)return x(t,e);var f=255&e,u=e>>>8&255,m=e>>>16&255,v=l.get(e);if(!v){(v=new Array(4))[2]=v[3]=65535;var d=i,y=s,I=h,w=o;t.length<3&&(d=y=I=w=1);for(var P=0;P<t.length;++P){var _=255&t[P],b=t[P]>>>8&255,M=t[P]>>>16&255,q=t[P]>>>24&255,C=d*g(_-f);C>=v[3]||((C+=y*g(b-u))>=v[3]||(C+=I*g(M-m))>=v[3]||(a&&(C+=w*g(q-c)),C<v[2]?(v[1]=v[0],v[3]=v[2],v[0]=P,v[2]=C):C<v[3]&&(v[1]=P,v[3]=C)))}65535==v[3]&&(v[1]=v[0]),l.set(e,v)}var T=t.length<<2,A=(p+1)%2;return.67*v[3]<v[3]-v[2]?A=0:v[0]>v[1]&&(A=p%2),v[A+2]>=T||n&&0==v[A]?x(t,e):v[A]}function y(t,e,r,n,a,i,s,h){var o=new Int32Array(4);return h?(o[0]=a[(i[s]+4104>>4)+e],o[1]=a[(i[s+1]+4104>>4)+r],o[2]=a[(i[s+2]+4104>>4)+n],o[3]=a[(i[s+3]+4104>>4)+t],o):(o[0]=a[(i[s]+8208>>5)+e],o[1]=a[(i[s+1]+4104>>4)+r],o[2]=a[(i[s+2]+8208>>5)+n],o[3]=t,o)}t.prototype.pnnquan=function(t,e){for(var n=1,a=new Array(65536),p=0;p<t.length;++p){var l=255&t[p],c=t[p]>>>8&255,g=t[p]>>>16&255;(z=t[p]>>>24&255)<=r&&(l=255&this.m_transparentColor,c=this.m_transparentColor>>>8&255,g=this.m_transparentColor>>>16&255,z=this.m_transparentColor>>>24&255);var x=m(z,l,c,g,this.hasSemiTransparency,e<64||this.m_transparentPixelIndex>=0);null==a[x]&&(a[x]=new u),(T=a[x]).ac+=z,T.rc+=l,T.gc+=c,T.bc+=g,T.cnt+=1}var d=0;for(p=0;p<a.length;++p)if(null!=a[p]){var y=1/a[p].cnt;a[p].ac*=y,a[p].rc*=y,a[p].gc*=y,a[p].bc*=y,a[d++]=a[p]}e<16&&(n=-1),(this.opts.weight=Math.min(.9,1*e/d))<.03&&s<1&&s>=f[0][1]&&(i=s=h=o=1,e>=64&&(n=0));for(var I,w,P,_=function(t,e){return e>0?t<64?function(t){return Math.fround(Math.sqrt(t))}:function(t){return 0|Math.sqrt(t)}:e<0?function(t){return 0|Math.cbrt(t)}:function(t){return t}}(e,n),b=0;b<d-1;++b)a[b].fw=b+1,a[b+1].bk=b,a[b].cnt=_(a[b].cnt);a[b].cnt=_(a[b].cnt);var M=new Uint32Array(a.length+1);for(p=0;p<d;++p){v(a,p);var q=a[p].err;for(w=++M[0];w>1&&!(a[I=M[P=w>>1]].err<=q);w=P)M[w]=I;M[w]=p}var C=d-e;for(p=0;p<C;){for(var T;;){var A=M[1];if((T=a[A]).tm>=T.mtm&&a[T.nn].mtm<=T.tm)break;65535==T.mtm?A=M[1]=M[M[0]--]:(v(a,A),T.tm=p);q=a[A].err;for(w=1;(P=w+w)<=M[0]&&(P<M[0]&&a[M[P]].err>a[M[P+1]].err&&++P,!(q<=a[I=M[P]].err));w=P)M[w]=I;M[w]=A}var S=a[T.nn],k=T.cnt,U=S.cnt;y=Math.fround(1/(k+U));T.ac=y*Math.round(k*T.ac+U*S.ac),T.rc=y*Math.round(k*T.rc+U*S.rc),T.gc=y*Math.round(k*T.gc+U*S.gc),T.bc=y*Math.round(k*T.bc+U*S.bc),T.cnt+=U,T.mtm=++p,a[S.bk].fw=S.fw,a[S.fw].bk=S.bk,S.mtm=65535}C<0&&(this.palette=new Uint32Array(d));var F=0;for(p=0;;++F){var z=0|Math.clamp(a[p].ac,0,255);l=0|Math.clamp(a[p].rc,0,255),c=0|Math.clamp(a[p].gc,0,255),g=0|Math.clamp(a[p].bc,0,255);if(this.palette[F]=z<<24|g<<16|c<<8|l,this.m_transparentPixelIndex>=0&&0==z){var D=this.palette[0];this.palette[0]=this.m_transparentColor,this.palette[F]=D}if(0==(p=a[p].fw))break}},t.prototype.quantize_image=function(t,e,r,n,a){var i=e>256?new Uint16Array(t.length):new Uint8Array(t.length),s=0;if(a){const a=4,B=256,N=20;for(var h=(r+2)*a,o=new Int32Array(a*B),p=new Int32Array(2*B),l=0;l<B;++l)o[l]=0,o[l+B]=l,o[l+2*B]=255,o[l+3*B]=255,p[l]=-N,p[l+B]=N;for(l=-N;l<=N;++l)p[l+B]=l;var c=this.hasSemiTransparency||e<64,f=1,u=new Int32Array(h),g=new Int32Array(h),v=new Int32Array(65536);for(l=0;l<n;++l){f<0&&(s+=r-1);var d=a,I=r*a;g[I]=g[I+1]=g[I+2]=g[I+3]=0;for(var w=0;w<r;++w){var P=255&t[s],_=t[s]>>>8&255,b=t[s]>>>16&255,M=t[s]>>>24&255,q=y(M,P,_,b,o,u,d,c),C=q[0],T=q[1],A=q[2],S=q[3],k=S<<24|A<<16|T<<8|C;if(c){var U=m(S,C,T,A,this.hasSemiTransparency,this.m_transparentPixelIndex>=0);0==v[U]&&(v[U]=0==M?1:x(this.palette,k)+1),i[s]=v[U]-1}else i[s]=0==M?0:x(this.palette,k);var F=this.palette[i[s]],z=F>>>8&255,D=F>>>16&255,E=F>>>24&255;C=p[C-(255&F)+B],T=p[T-z+B],A=p[A-D+B],S=p[S-E+B];var L=2*C;g[I-a]=C,g[I+a]+=C+=L,g[I]+=C+=L,u[d+a]+=C+L,L=2*T,g[I+1-a]=T,g[I+1+a]+=T+=L,g[I+1]+=T+=L,u[d+1+a]+=T+L,L=2*A,g[I+2-a]=A,g[I+2+a]+=A+=L,g[I+2]+=A+=L,u[d+2+a]+=A+L,L=2*S,g[I+3-a]=S,g[I+3+a]+=S+=L,g[I+3]+=S+=L,u[d+3+a]+=S+L,d+=a,I-=a,s+=f}l%2==1&&(s+=r+1),f*=-1;var O=u;u=g,g=O}return this.qPixels=i,this.qPixels}for(l=0;l<i.length;++l)i[l]=this.getDitherFn()(this.palette,t[l],l);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){var t=this.opts.pixels,p=this.opts.width,u=this.opts.height,m=this.opts.colors,g=this.opts.dithering;this.opts.alphaThreshold&&(r=this.opts.alphaThreshold),l.clear(),c.clear(),n=!1;for(var v=0,x=0;x<t.length;++x){var d=t[x]>>>24&255;d<224&&(0==d?(this.m_transparentPixelIndex=x,n=!0,m>2?this.m_transparentColor=t[x]:t[x]=this.m_transparentColor):d>r&&++v)}if(this.hasSemiTransparency=a=v>0,m<=32?i=s=h=o=1:(i=f[0][0],s=f[0][1],h=f[0][2]),e=this.m_transparentColor,this.palette=new Uint32Array(m),m>2?this.pnnquan(t,m):this.m_transparentPixelIndex>=0?(this.palette[0]=this.m_transparentColor,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),a&&(this.opts.weight*=-1),this.m_transparentPixelIndex>=0){var y=this.getDitherFn()(this.palette,t[this.m_transparentPixelIndex],this.m_transparentPixelIndex);this.palette.length>2?this.palette[y]=this.m_transparentColor:this.palette[y]!=this.m_transparentColor&&(this.palette[0]=this.palette[y],this.palette[y]=this.m_transparentColor,c.clear())}return this.opts.paletteOnly?(this.opts.ditherFn=this.getDitherFn(),this.opts.getColorIndex=this.getColorIndex,this.opts.palette=this.palette,this.palette):(this.qPixels=this.quantize_image(t,m,p,u,g),function(t,e){for(var r=new Uint32Array(e.length),n=0;n<e.length;++n)r[n]=t[e[n]];return r}(this.palette,this.qPixels))},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex>-1?0:-1},t.prototype.getDitherFn=function(){return this.opts.dithering?x:d},t.prototype.getColorIndex=function(t,e,r,n){return m(t,e,r,n,this.hasSemiTransparency,this.m_transparentPixelIndex>=0)},t.prototype.getResult=function(){var t=this;return new Promise(function(e,r){var n=t.quantizeImage();t.opts.paletteOnly?e({pal8:n,indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()}):e({img8:n,pal8:t.getPalette(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()})})},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);