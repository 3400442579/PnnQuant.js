(function(){function t(t){this.opts=t||{},this.alphaThreshold=0,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,r,e){return this.max(r,this.min(e,t))});var r=[],e=[];function a(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function n(t,r,e,a,n,i){return n?(240&t)<<8|(240&r)<<4|240&e|a>>4:i?(128&t)<<8|(248&r)<<7|(248&e)<<2|a>>3:(248&r)<<8|(252&e)<<3|a>>3}function i(t){return t*t}function s(t,r){for(var e=0,a=1e100,n=t[r],s=n.cnt,h=n.ac,l=n.rc,o=n.gc,p=n.bc,c=n.fw;0!=c;c=t[c].fw){var f=t[c].cnt,m=s*f/(s+f);if(!(m>=a)){var u=m*i(t[c].ac-h);u>=a||(u+=m*i(t[c].rc-l))>=a||(u+=m*i(t[c].gc-o))>=a||(u+=m*i(t[c].bc-p))>=a||(a=u,e=c)}}n.err=a,n.nn=e}function h(t,r,a){var n=e[a];if(null!=n)return n;var s=0,h=255&a,l=a>>>8&255,o=a>>>16&255,p=a>>>24&255;if(p<=this.alphaThreshold)return s;for(var c=1e100,f=0;f<r;f++){var m=255&t[f],u=t[f]>>>8&255,v=t[f]>>>16&255,x=i((t[f]>>>24&255)-p);x>c||((x+=i(m-h))>c||(x+=i(u-l))>c||(x+=i(v-o))>c||(c=x,s=f))}return e[a]=s,s}function l(t,e,a){var n=0,i=255&a,s=a>>>8&255,h=a>>>16&255,l=a>>>24&255,o=r[a];if(!o){for((o=[])[2]=o[3]=1e100;n<e;n++){var p=255&t[n],c=t[n]>>>8&255,f=t[n]>>>16&255,m=t[n]>>>24&255;o[4]=Math.abs(l-m)+Math.abs(i-p)+Math.abs(s-c)+Math.abs(h-f),o[4]<o[2]?(o[1]=o[0],o[3]=o[2],o[0]=n,o[2]=o[4]):o[4]<o[3]&&(o[1]=n,o[3]=o[4])}1e100==o[3]&&(o[2]=0)}return n=0==o[2]||Math.floor(32769*Math.random())%(o[3]+o[2])<=o[3]?o[0]:o[1],r[a]=o,n}function o(t,r,e,a,n,i,s,h){var l=[];return h?(l[0]=n[(i[s]+4104>>4)+r],l[1]=n[(i[s+1]+4104>>4)+e],l[2]=n[(i[s+2]+4104>>4)+a],l[3]=n[(i[s+3]+4104>>4)+t],l):(l[0]=n[(i[s]+8208>>5)+r],l[1]=n[(i[s+1]+4104>>4)+e],l[2]=n[(i[s+2]+8208>>5)+a],l[3]=t,l)}t.prototype.pnnquan=function(t,r,e){for(var h=new Array(65536),l=0;l<t.length;++l){var o=255&t[l],p=t[l]>>>8&255,c=t[l]>>>16&255,f=n(T=t[l]>>>24&255,o,p,c,this.hasSemiTransparency,r<64||this.m_transparentPixelIndex>=0);null==h[f]&&(h[f]=new a),h[f].ac+=T,h[f].rc+=o,h[f].gc+=p,h[f].bc+=c,h[f].cnt++}var m,u,v,x=0;for(l=0;l<h.length;++l)if(null!=h[l]){var g=1/h[l].cnt;h[l].ac*=g,h[l].rc*=g,h[l].gc*=g,h[l].bc*=g,h[x++]=h[l]}r<16&&(e=-1),i(r)/x<.03&&(e=0),e>0?h[0].cnt=0|Math.sqrt(h[0].cnt):e<0&&(h[0].cnt=0|Math.cbrt(h[0].cnt));for(l=0;l<x-1;++l)h[l].fw=l+1,h[l+1].bk=l,e>0?h[l+1].cnt=0|Math.sqrt(h[l+1].cnt):e<0&&(h[l+1].cnt=0|Math.cbrt(h[l+1].cnt));var d=new Uint32Array(h.length+1);for(l=0;l<x;++l){s(h,l);var y=h[l].err;for(u=++d[0];u>1&&!(h[m=d[v=u>>1]].err<=y);u=v)d[u]=m;d[u]=l}var b=x-r;for(l=0;l<b;){for(var P;;){var w=d[1];if((P=h[w]).tm>=P.mtm&&h[P.nn].mtm<=P.tm)break;65535==P.mtm?w=d[1]=d[d[0]--]:(s(h,w),P.tm=l);y=h[w].err;for(u=1;(v=u+u)<=d[0]&&(v<d[0]&&h[d[v]].err>h[d[v+1]].err&&++v,!(y<=h[m=d[v]].err));u=v)d[u]=m;d[u]=w}var M=h[P.nn],_=P.cnt,q=M.cnt;g=1/(_+q);P.ac=g*(_*P.ac+q*M.ac),P.rc=g*(_*P.rc+q*M.rc),P.gc=g*(_*P.gc+q*M.gc),P.bc=g*(_*P.bc+q*M.bc),P.cnt+=M.cnt,P.mtm=++l,h[M.bk].fw=M.fw,h[M.fw].bk=M.bk,M.mtm=65535}var I=0;for(l=0;;++I){var T=Math.round(Math.clamp(h[l].ac,0,255));o=Math.round(Math.clamp(h[l].rc,0,255)),p=Math.round(Math.clamp(h[l].gc,0,255)),c=Math.round(Math.clamp(h[l].bc,0,255));if(this.palette[I]=T<<24|c<<16|p<<8|o,this.m_transparentPixelIndex>=0&&this.palette[I]==this.m_transparentColor){var A=this.palette[0];this.palette[0]=this.palette[I],this.palette[I]=A}if(0==(l=h[l].fw))break}void 0!==this.palette.sort&&this.palette.sort()},t.prototype.quantize_image=function(t,r,e,a,i){var s=r>256?new Uint16Array(t.length):new Uint8Array(t.length),p=0;if(i){const i=4,l=256,G=20;for(var c=(e+2)*i,f=new Uint32Array(i*l),m=new Uint32Array(2*l),u=0;u<l;++u)f[u]=0,f[u+l]=u,f[u+2*l]=255,f[u+3*l]=255,m[u]=-G,m[u+l]=G;for(u=-G;u<=G;++u)m[u+l]=u;var v=this.hasSemiTransparency||r<64,x=1,g=new Uint32Array(c),d=new Uint32Array(c),y=new Uint32Array(65536);for(u=0;u<a;++u){x<0&&(p+=e-1);var b=i,P=e*i;d[P]=d[P+1]=d[P+2]=d[P+3]=0;for(var w=0;w<e;++w){var M=255&t[p],_=t[p]>>>8&255,q=t[p]>>>16&255,I=t[p]>>>24&255,T=o(I,M,_,q,f,g,b,v),A=T[0],U=T[1],k=T[2],S=T[3],C=S<<24|k<<16|U<<8|A;if(v){var z=n(S,A,U,k,this.hasSemiTransparency,this.m_transparentPixelIndex>=0);0==y[z]&&(y[z]=0==I?1:h(this.palette,r,C)+1),s[p]=y[z]-1}else s[p]=0==I?0:h(this.palette,r,C);var Q=this.palette[s[p]],j=Q>>>8&255,B=Q>>>16&255,D=Q>>>24&255;A=m[A-(255&Q)+l],U=m[U-j+l],k=m[k-B+l],S=m[S-D+l];var E=2*A;d[P-i]=A,d[P+i]+=A+=E,d[P]+=A+=E,g[b+i]+=A+E,E=2*U,d[P+1-i]=U,d[P+1+i]+=U+=E,d[P+1]+=U+=E,g[b+1+i]+=U+E,E=2*k,d[P+2-i]=k,d[P+2+i]+=k+=E,d[P+2]+=k+=E,g[b+2+i]+=k+E,E=2*S,d[P+3-i]=S,d[P+3+i]+=S+=E,d[P+3]+=S+=E,g[b+3+i]+=S+E,b+=i,P-=i,p+=x}u%2==1&&(p+=e+1),x*=-1;var F=g;g=d,d=F}return this.qPixels=s,this.qPixels}if(this.m_transparentPixelIndex>=0||r<64)for(u=0;u<s.length;++u)s[u]=h(this.palette,r,t[u]);else for(u=0;u<s.length;++u)s[u]=l(this.palette,r,t[u]);return this.qPixels=s,this.qPixels},t.prototype.quantizeImage=function(){var t=this.opts.pixels,a=this.opts.width,n=this.opts.height,i=this.opts.colors,s=this.opts.dithering;this.opts.alphaThreshold&&(this.alphaThreshold=this.opts.alphaThreshold);for(var h=0;h<t.length;++h){var l=t[h]>>>24&255;l<255&&(0==l?(this.m_transparentPixelIndex=h,this.m_transparentColor=t[h]):this.hasSemiTransparency=!0)}if(this.palette=new Uint32Array(i),i>2?this.pnnquan(t,i,1):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.qPixels=this.quantize_image(t,i,a,n,s),this.m_transparentPixelIndex>=0){var o=this.qPixels[this.m_transparentPixelIndex];if(i>2)this.palette[o]=this.m_transparentColor;else if(palette[o]!=this.m_transparentColor){var p=palette[0];this.palette[0]=palette[1],this.palette[1]=p}}return r=[],e=[],function(t,r){for(var e=new Uint32Array(r.length),a=0;a<r.length;++a)e[a]=t[r[a]];return e}(this.palette,this.qPixels)},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex>-1?0:-1},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);