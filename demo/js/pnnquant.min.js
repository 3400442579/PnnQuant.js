(function(){function t(t){this.opts=t||{},this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[],this.qPixels=[]}var e;Math.clamp||(Math.clamp=function(t,e,r){return this.max(e,this.min(r,t))}),Math.fround||(Math.fround=(e=new Float32Array(1),function(t){return e[0]=+t,e[0]}));var r=0,n=.2126,a=.7152,i=.0722,s={},h={};function o(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=this.err=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0}function p(t,e,r,n,a,i){return a?(240&t)<<8|(240&e)<<4|240&r|n>>4:i?(128&t)<<8|(248&e)<<7|(248&r)<<2|n>>3:(248&e)<<8|(252&r)<<3|n>>3}function l(t){return t*t}function c(t,e){for(var r=0,s=1e100,h=t[e],o=h.cnt,p=h.ac,c=h.rc,f=h.gc,u=h.bc,m=h.fw;0!=m;m=t[m].fw){var g=t[m].cnt,x=o*g/(o+g);if(!(x>=s)){var d=x*l(t[m].ac-p);d>=s||(d+=x*n*l(t[m].rc-c))>=s||(d+=x*a*l(t[m].gc-f))>=s||(d+=x*i*l(t[m].bc-u))>=s||(s=d,r=m)}}h.err=Math.fround(s),h.nn=r}function f(t,e,s){var o=h[s];if(null!=o)return o;var p=0,c=255&s,f=s>>>8&255,u=s>>>16&255,m=s>>>24&255;if(m<=r)return p;for(var g=1e100,x=0;x<e;x++){var d=255&t[x],v=t[x]>>>8&255,y=t[x]>>>16&255,I=t[x]>>>24&255,M=n*l(d-c);M>g||((M+=a*l(v-f))>g||(M+=i*l(y-u))>g||(M+=l(I-m))>g||(g=M,p=x))}return h[s]=p,p}function u(t,e,r){var n=0,a=255&r,i=r>>>8&255,h=r>>>16&255,o=r>>>24&255,p=s[r];if(!p){for((p=new Array(5))[2]=p[3]=1e100;n<e;++n){var l=255&t[n],c=t[n]>>>8&255,f=t[n]>>>16&255,u=t[n]>>>24&255;p[4]=Math.abs(a-l)+Math.abs(i-c)+Math.abs(h-f)+Math.abs(o-u),p[4]<p[2]?(p[1]=p[0],p[3]=p[2],p[0]=n,p[2]=p[4]):p[4]<p[3]&&(p[1]=n,p[3]=p[4])}1e100==p[3]&&(p[2]=0)}return n=0==p[2]||Math.floor(32767*Math.random())%(p[3]+p[2])<=p[3]?p[0]:p[1],s[r]=p,n}function m(t,e,r,n,a,i,s,h){var o=new Int32Array(4);return h?(o[0]=a[(i[s]+4104>>4)+e],o[1]=a[(i[s+1]+4104>>4)+r],o[2]=a[(i[s+2]+4104>>4)+n],o[3]=a[(i[s+3]+4104>>4)+t],o):(o[0]=a[(i[s]+8208>>5)+e],o[1]=a[(i[s+1]+4104>>4)+r],o[2]=a[(i[s+2]+8208>>5)+n],o[3]=t,o)}t.prototype.pnnquan=function(t,e,r){for(var n=new Array(65536),a=0;a<t.length;++a){var i=255&t[a],s=t[a]>>>8&255,h=t[a]>>>16&255,f=p(A=t[a]>>>24&255,i,s,h,this.hasSemiTransparency,e<64||this.m_transparentPixelIndex>=0);null==n[f]&&(n[f]=new o),n[f].ac+=A,n[f].rc+=i,n[f].gc+=s,n[f].bc+=h,n[f].cnt+=1}var u=0;for(a=0;a<n.length;++a)if(null!=n[a]){var m=1/n[a].cnt;n[a].ac*=m,n[a].rc*=m,n[a].gc*=m,n[a].bc*=m,n[u++]=n[a]}e<16&&(r=-1),l(e)/u<.03&&(r=0);for(var g,x,d,v=0;v<u-1;++v)n[v].fw=v+1,n[v+1].bk=v,r>0?n[v].cnt=e<64?Math.fround(Math.sqrt(n[v].cnt)):0|Math.sqrt(n[v].cnt):r<0&&(n[v].cnt=0|Math.cbrt(n[v].cnt));r>0?n[v].cnt=e<64?Math.fround(Math.sqrt(n[v].cnt)):0|Math.sqrt(n[v].cnt):r<0&&(n[v].cnt=0|Math.cbrt(n[v].cnt));var y=new Uint32Array(n.length+1);for(a=0;a<u;++a){c(n,a);var I=n[a].err;for(x=++y[0];x>1&&!(n[g=y[d=x>>1]].err<=I);x=d)y[x]=g;y[x]=a}var M=u-e;for(a=0;a<M;){for(var P;;){var w=y[1];if((P=n[w]).tm>=P.mtm&&n[P.nn].mtm<=P.tm)break;65535==P.mtm?w=y[1]=y[y[0]--]:(c(n,w),P.tm=a);I=n[w].err;for(x=1;(d=x+x)<=y[0]&&(d<y[0]&&n[y[d]].err>n[y[d+1]].err&&++d,!(I<=n[g=y[d]].err));x=d)y[x]=g;y[x]=w}var b=n[P.nn],_=P.cnt,q=b.cnt;m=Math.fround(1/(_+q));P.ac=m*Math.round(_*P.ac+q*b.ac),P.rc=m*Math.round(_*P.rc+q*b.rc),P.gc=m*Math.round(_*P.gc+q*b.gc),P.bc=m*Math.round(_*P.bc+q*b.bc),P.cnt+=b.cnt,P.mtm=++a,n[b.bk].fw=b.fw,n[b.fw].bk=b.bk,b.mtm=65535}var T=0;for(a=0;;++T){var A=0|Math.clamp(n[a].ac,0,255);i=0|Math.clamp(n[a].rc,0,255),s=0|Math.clamp(n[a].gc,0,255),h=0|Math.clamp(n[a].bc,0,255);if(this.palette[T]=A<<24|h<<16|s<<8|i,this.m_transparentPixelIndex>=0&&0==A){var S=this.palette[0];this.palette[0]=this.m_transparentColor,this.palette[T]=S}if(0==(a=n[a].fw))break}if(T<e-1){var C=this.palette;this.palette=new Uint32Array(T+1);for(v=0;v<T+1;++v)this.palette[v]=C[v]}},t.prototype.quantize_image=function(t,e,r,n,a){var i=e>256?new Uint16Array(t.length):new Uint8Array(t.length),s=0;if(a){const a=4,u=256,B=20;for(var h=(r+2)*a,o=new Int32Array(a*u),l=new Int32Array(2*u),c=0;c<u;++c)o[c]=0,o[c+u]=c,o[c+2*u]=255,o[c+3*u]=255,l[c]=-B,l[c+u]=B;for(c=-B;c<=B;++c)l[c+u]=c;var g=this.hasSemiTransparency||e<64,x=1,d=new Int32Array(h),v=new Int32Array(h),y=new Int32Array(65536);for(c=0;c<n;++c){x<0&&(s+=r-1);var I=a,M=r*a;v[M]=v[M+1]=v[M+2]=v[M+3]=0;for(var P=0;P<r;++P){var w=255&t[s],b=t[s]>>>8&255,_=t[s]>>>16&255,q=t[s]>>>24&255,T=m(q,w,b,_,o,d,I,g),A=T[0],S=T[1],C=T[2],k=T[3],U=k<<24|C<<16|S<<8|A;if(g){var z=p(k,A,S,C,this.hasSemiTransparency,this.m_transparentPixelIndex>=0);0==y[z]&&(y[z]=0==q?1:f(this.palette,e,U)+1),i[s]=y[z]-1}else i[s]=0==q?0:f(this.palette,e,U);var F=this.palette[i[s]],D=F>>>8&255,O=F>>>16&255,Q=F>>>24&255;A=l[A-(255&F)+u],S=l[S-D+u],C=l[C-O+u],k=l[k-Q+u];var R=2*A;v[M-a]=A,v[M+a]+=A+=R,v[M]+=A+=R,d[I+a]+=A+R,R=2*S,v[M+1-a]=S,v[M+1+a]+=S+=R,v[M+1]+=S+=R,d[I+1+a]+=S+R,R=2*C,v[M+2-a]=C,v[M+2+a]+=C+=R,v[M+2]+=C+=R,d[I+2+a]+=C+R,R=2*k,v[M+3-a]=k,v[M+3+a]+=k+=R,v[M+3]+=k+=R,d[I+3+a]+=k+R,I+=a,M-=a,s+=x}c%2==1&&(s+=r+1),x*=-1;var j=d;d=v,v=j}return this.qPixels=i,this.qPixels}if(this.m_transparentPixelIndex>=0||e<64)for(c=0;c<i.length;++c)i[c]=f(this.palette,e,t[c]);else for(c=0;c<i.length;++c)i[c]=u(this.palette,e,t[c]);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){var t=this.opts.pixels,e=this.opts.width,o=this.opts.height,p=this.opts.colors,l=this.opts.dithering;this.opts.alphaThreshold&&(r=this.opts.alphaThreshold),s={},h={};for(var c=0;c<t.length;++c){var f=t[c]>>>24&255;f<255&&(0==f?(this.m_transparentColor=t[c],this.m_transparentPixelIndex=c,0==this.m_transparentColor&&(t[c]=this.m_transparentColor=6710835|f<<24)):this.hasSemiTransparency=!0)}if(this.hasSemiTransparency||p<=32?n=a=i=1:(e<512||o<512)&&(n=.299,a=.587,i=.114),this.palette=new Uint32Array(p),p>2?this.pnnquan(t,p,1):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.m_transparentPixelIndex>=0){this.hasSemiTransparency&&(this.opts.divisor=1.25);var u=this.getDitherFn()(this.palette,t.length,t[this.m_transparentPixelIndex]);if(p>2)this.palette[u]=this.m_transparentColor;else if(this.palette[u]!=this.m_transparentColor){var m=this.palette[0];this.palette[0]=this.palette[1],this.palette[1]=m}}return this.opts.paletteOnly?this.palette:(this.qPixels=this.quantize_image(t,p,e,o,l),function(t,e){for(var r=new Uint32Array(e.length),n=0;n<e.length;++n)r[n]=t[e[n]];return r}(this.palette,this.qPixels))},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex>-1?0:-1},t.prototype.getDitherFn=function(){return this.opts.dithering?f:u},t.prototype.getColorIndex=function(t,e,r,n){return p(t,e,r,n,this.hasSemiTransparency,this.m_transparentPixelIndex>=0)},t.prototype.getResult=function(){var t=this;return new Promise(function(e,r){var n=t.quantizeImage();t.opts.paletteOnly?e({pal8:n,indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()}):e({img8:n,pal8:t.getPalette(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()})})},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);