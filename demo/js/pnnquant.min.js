(function(){function t(t){this.opts=t||{},this.alphaThreshold=0,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,r,e){return this.max(r,this.min(e,t))});var r=[],e=[];function a(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function n(t,r,e,a,n){return n?(240&t)<<8|(240&r)<<4|240&e|a>>4:(248&r)<<8|(252&e)<<3|a>>3}function i(t){return t*t}function s(t,r){for(var e=0,a=1e100,n=t[r],s=n.cnt,h=n.ac,o=n.rc,l=n.gc,p=n.bc,c=n.fw;0!=c;c=t[c].fw){var f=t[c].cnt,m=s*f/(s+f);if(!(m>=a)){var u=m*i(t[c].ac-h);u>=a||(u+=m*i(t[c].rc-o))>=a||(u+=m*i(t[c].gc-l))>=a||(u+=m*i(t[c].bc-p))>=a||(a=u,e=c)}}n.err=a,n.nn=e}function h(t,r,a){var n=e[a];if(null!=n)return n;var s=0,h=255&a,o=a>>>8&255,l=a>>>16&255,p=a>>>24&255;if(p<=this.alphaThreshold)return s;for(var c=1e100,f=0;f<r;f++){var m=255&t[f],u=t[f]>>>8&255,v=t[f]>>>16&255,g=i((t[f]>>>24&255)-p);g>c||((g+=i(m-h))>c||(g+=i(u-o))>c||(g+=i(v-l))>c||(c=g,s=f))}return e[a]=s,s}function o(t,e,a){var n=0,i=255&a,s=a>>>8&255,h=a>>>16&255,o=a>>>24&255,l=r[a];if(!l){for((l=[])[2]=l[3]=1e100;n<e;n++){var p=255&t[n],c=t[n]>>>8&255,f=t[n]>>>16&255,m=t[n]>>>24&255;l[4]=Math.abs(o-m)+Math.abs(i-p)+Math.abs(s-c)+Math.abs(h-f),l[4]<l[2]?(l[1]=l[0],l[3]=l[2],l[0]=n,l[2]=l[4]):l[4]<l[3]&&(l[1]=n,l[3]=l[4])}1e100==l[3]&&(l[2]=0)}return n=0==l[2]||Math.floor(32769*Math.random())%(l[3]+l[2])<=l[3]?l[0]:l[1],r[a]=l,n}function l(t,r,e,a,n,i,s,h){var o=[];return h?(o[0]=n[(i[s]+4104>>4)+r],o[1]=n[(i[s+1]+4104>>4)+e],o[2]=n[(i[s+2]+4104>>4)+a],o[3]=n[(i[s+3]+4104>>4)+t],o):(o[0]=n[(i[s]+8208>>5)+r],o[1]=n[(i[s+1]+4104>>4)+e],o[2]=n[(i[s+2]+8208>>5)+a],o[3]=t,o)}t.prototype.pnnquan=function(t,r,e){for(var h=new Array(65536),o=0;o<t.length;++o){var l=255&t[o],p=t[o]>>>8&255,c=t[o]>>>16&255;if((U=t[o]>>>24&255)<=this.alphaThreshold){var f=255&this.m_transparentColor,m=this.m_transparentColor>>>8&255,u=this.m_transparentColor>>>16&255;null==h[v=n(this.m_transparentColor>>>24&255,f,m,u,this.hasSemiTransparency)]&&(h[v]=new a),h[v].cnt++}else{var v;null==h[v=n(U,l,p,c,this.hasSemiTransparency)]&&(h[v]=new a),h[v].ac+=U,h[v].rc+=l,h[v].gc+=p,h[v].bc+=c,h[v].cnt++}}var g,x,d,y=0;for(o=0;o<h.length;++o)if(null!=h[o]){var b=1/h[o].cnt;h[o].ac*=b,h[o].rc*=b,h[o].gc*=b,h[o].bc*=b,h[y++]=h[o]}r<16&&(e=-1),i(r)/y<.022&&(e=0),e>0?h[0].cnt=0|Math.sqrt(h[0].cnt):e<0&&(h[0].cnt=0|Math.cbrt(h[0].cnt));for(o=0;o<y-1;++o)h[o].fw=o+1,h[o+1].bk=o,e>0?h[o+1].cnt=0|Math.sqrt(h[o+1].cnt):e<0&&(h[o+1].cnt=0|Math.cbrt(h[o+1].cnt));var w=new Uint32Array(65537);for(o=0;o<y;++o){s(h,o);var M=h[o].err;for(x=++w[0];x>1&&!(h[g=w[d=x>>1]].err<=M);x=d)w[x]=g;w[x]=o}var P=y-r;for(o=0;o<P;){for(var _;;){var q=w[1];if((_=h[q]).tm>=_.mtm&&h[_.nn].mtm<=_.tm)break;65535==_.mtm?q=w[1]=w[w[0]--]:(s(h,q),_.tm=o);M=h[q].err;for(x=1;(d=x+x)<=w[0]&&(d<w[0]&&h[w[d]].err>h[w[d+1]].err&&++d,!(M<=h[g=w[d]].err));x=d)w[x]=g;w[x]=q}var T=h[_.nn],I=_.cnt,A=T.cnt;b=1/(I+A);_.ac=b*(I*_.ac+A*T.ac),_.rc=b*(I*_.rc+A*T.rc),_.gc=b*(I*_.gc+A*T.gc),_.bc=b*(I*_.bc+A*T.bc),_.cnt+=T.cnt,_.mtm=++o,h[T.bk].fw=T.fw,h[T.fw].bk=T.bk,T.mtm=65535}var C=0;for(o=0;;++C){var U=Math.round(Math.clamp(h[o].ac,0,255));l=Math.round(Math.clamp(h[o].rc,0,255)),p=Math.round(Math.clamp(h[o].gc,0,255)),c=Math.round(Math.clamp(h[o].bc,0,255));if(this.palette[C]=U<<24|c<<16|p<<8|l,this.m_transparentPixelIndex>=0&&this.palette[C]==this.m_transparentColor){var k=this.palette[0];this.palette[0]=this.palette[C],this.palette[C]=k}if(0==(o=h[o].fw))break}void 0!==this.palette.sort&&this.palette.sort()},t.prototype.quantize_image=function(t,r,e,a,n){var i=r>256?new Uint16Array(t.length):new Uint8Array(t.length),s=0;if(n){const n=4,o=256,B=20;for(var p=(e+2)*n,c=new Uint32Array(n*o),f=new Uint32Array(2*o),m=0;m<o;++m)c[m]=0,c[m+o]=m,c[m+2*o]=255,c[m+3*o]=255,f[m]=-B,f[m+o]=B;for(m=-B;m<=B;++m)f[m+o]=m;var u=this.hasSemiTransparency||r<64,v=1,g=new Uint32Array(p),x=new Uint32Array(p);for(m=0;m<a;++m){v<0&&(s+=e-1);var d=n,y=e*n;x[y]=x[y+1]=x[y+2]=x[y+3]=0;for(var b=0;b<e;++b){var w=255&t[s],M=t[s]>>>8&255,P=t[s]>>>16&255,_=l(t[s]>>>24&255,w,M,P,c,g,d,u),q=_[0],T=_[1],I=_[2],A=_[3],C=A<<24|I<<16|T<<8|q;i[s]=h(this.palette,r,C);var U=this.palette[i[s]],k=U>>>8&255,S=U>>>16&255,z=U>>>24&255;q=f[q-(255&U)+o],T=f[T-k+o],I=f[I-S+o],A=f[A-z+o];var Q=2*q;x[y-n]=q,x[y+n]+=q+=Q,x[y]+=q+=Q,g[d+n]+=q+=Q,Q=2*T,x[y+1-n]=T,x[y+1+n]+=T+=Q,x[y+1]+=T+=Q,g[d+1+n]+=T+=Q,Q=2*I,x[y+2-n]=I,x[y+2+n]+=I+=Q,x[y+2]+=I+=Q,g[d+2+n]+=I+=Q,Q=2*A,x[y+3-n]=A,x[y+3+n]+=A+=Q,x[y+3]+=A+=Q,g[d+3+n]+=A+=Q,d+=n,y-=n,s+=v}m%2==1&&(s+=e+1),v*=-1;var j=g;g=x,x=j}return this.qPixels=i,this.qPixels}if(this.m_transparentPixelIndex>=0||r<64)for(m=0;m<i.length;++m)i[m]=h(this.palette,r,t[m]);else for(m=0;m<i.length;++m)i[m]=o(this.palette,r,t[m]);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){var t=this.opts.pixels,a=this.opts.width,n=this.opts.height,i=this.opts.colors,s=this.opts.dithering;this.opts.alphaThreshold&&(this.alphaThreshold=this.opts.alphaThreshold);for(var h=0;h<t.length;++h){var o=t[h]>>>24&255;o<255&&(0==o?(this.m_transparentPixelIndex=h,this.m_transparentColor=t[h]):this.hasSemiTransparency=!0)}if(this.palette=new Uint32Array(i),i>2?this.pnnquan(t,i,1):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.qPixels=this.quantize_image(t,i,a,n,s),this.m_transparentPixelIndex>=0){var l=this.qPixels[this.m_transparentPixelIndex];if(i>2)this.palette[l]=this.m_transparentColor;else if(palette[l]!=this.m_transparentColor){var p=palette[0];this.palette[0]=palette[1],this.palette[1]=p}}return r=[],e=[],function(t,r){for(var e=new Uint32Array(r.length),a=0;a<r.length;++a)e[a]=t[r[a]];return e}(this.palette,this.qPixels)},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex>-1?0:-1},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);