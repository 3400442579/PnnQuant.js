(function(){function t(t){this.opts=t||{},this.alphaThreshold=0,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=0,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,e,r){return this.max(e,this.min(r,t))});var e=.2126,r=.7152,n=.0722,a={},i={};function s(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function h(t,e,r,n,a,i){return a?(240&t)<<8|(240&e)<<4|240&r|n>>4:i?(128&t)<<8|(248&e)<<7|(248&r)<<2|n>>3:(248&e)<<8|(252&r)<<3|n>>3}function p(t){return t*t}function l(t,a){for(var i=0,s=1e100,h=t[a],l=h.cnt,o=h.ac,c=h.rc,f=h.gc,m=h.bc,u=h.fw;0!=u;u=t[u].fw){var g=e*p(t[u].rc-c)+r*p(t[u].gc-f)+n*p(t[u].bc-m);this.hasSemiTransparency&&(g+=p(t[u].ac-o));var x=t[u].cnt;(g*=l*x/(l+x))>=s||(s=g,i=u)}h.err=s,h.nn=i}function o(t,a,s){var h=i[s];if(null!=h)return h;var l=0,o=255&s,c=s>>>8&255,f=s>>>16&255,m=s>>>24&255;if(m<=this.alphaThreshold)return l;for(var u=1e100,g=0;g<a;g++){var x=255&t[g],v=t[g]>>>8&255,y=t[g]>>>16&255,d=p((t[g]>>>24&255)-m);d>u||((d+=e*p(x-o))>u||(d+=r*p(v-c))>u||(d+=n*p(y-f))>u||(u=d,l=g))}return i[s]=l,l}function c(t,e,r){var n=0,i=255&r,s=r>>>8&255,h=r>>>16&255,p=r>>>24&255,l=a[r];if(!l){for((l=new Array(5))[2]=l[3]=1e100;n<e;++n){var o=255&t[n],c=t[n]>>>8&255,f=t[n]>>>16&255,m=t[n]>>>24&255;l[4]=Math.abs(p-m)+Math.abs(i-o)+Math.abs(s-c)+Math.abs(h-f),l[4]<l[2]?(l[1]=l[0],l[3]=l[2],l[0]=n,l[2]=l[4]):l[4]<l[3]&&(l[1]=n,l[3]=l[4])}1e100==l[3]&&(l[2]=0)}return n=0==l[2]||Math.floor(32767*Math.random())%(l[3]+l[2])<=l[3]?l[0]:l[1],a[r]=l,n}function f(t,e,r,n,a,i,s,h){var p=new Int32Array(4);return h?(p[0]=a[(i[s]+4104>>4)+e],p[1]=a[(i[s+1]+4104>>4)+r],p[2]=a[(i[s+2]+4104>>4)+n],p[3]=a[(i[s+3]+4104>>4)+t],p):(p[0]=a[(i[s]+8208>>5)+e],p[1]=a[(i[s+1]+4104>>4)+r],p[2]=a[(i[s+2]+8208>>5)+n],p[3]=t,p)}t.prototype.pnnquan=function(t,e,r){for(var n=new Array(65536),a=0;a<t.length;++a){var i=255&t[a],o=t[a]>>>8&255,c=t[a]>>>16&255,f=h(A=t[a]>>>24&255,i,o,c,this.hasSemiTransparency,e<64||this.m_transparentPixelIndex>=0);null==n[f]&&(n[f]=new s),n[f].ac+=A,n[f].rc+=i,n[f].gc+=o,n[f].bc+=c,n[f].cnt++}var m=0;for(a=0;a<n.length;++a)if(null!=n[a]){var u=1/n[a].cnt;n[a].ac*=u,n[a].rc*=u,n[a].gc*=u,n[a].bc*=u,n[m++]=n[a]}e<16&&(r=-1),p(e)/m<.03&&(r=0);for(var g,x,v,y=0;y<m-1;++y)n[y].fw=y+1,n[y+1].bk=y,r>0?n[y].cnt=0|Math.sqrt(n[y].cnt):r<0&&(n[y].cnt=0|Math.cbrt(n[y].cnt));r>0?n[y].cnt=0|Math.sqrt(n[y].cnt):r<0&&(n[y].cnt=0|Math.cbrt(n[y].cnt));var d=new Uint32Array(n.length+1);for(a=0;a<m;++a){l(n,a);var I=n[a].err;for(x=++d[0];x>1&&!(n[g=d[v=x>>1]].err<=I);x=v)d[x]=g;d[x]=a}var P=m-e;for(a=0;a<P;){for(var w;;){var b=d[1];if((w=n[b]).tm>=w.mtm&&n[w.nn].mtm<=w.tm)break;65535==w.mtm?b=d[1]=d[d[0]--]:(l(n,b),w.tm=a);I=n[b].err;for(x=1;(v=x+x)<=d[0]&&(v<d[0]&&n[d[v]].err>n[d[v+1]].err&&++v,!(I<=n[g=d[v]].err));x=v)d[x]=g;d[x]=b}var T=n[w.nn],q=w.cnt,_=T.cnt;u=1/(q+_);w.ac=u*(q*w.ac+_*T.ac),w.rc=u*(q*w.rc+_*T.rc),w.gc=u*(q*w.gc+_*T.gc),w.bc=u*(q*w.bc+_*T.bc),w.cnt+=T.cnt,w.mtm=++a,n[T.bk].fw=T.fw,n[T.fw].bk=T.bk,T.mtm=65535}var M=0;for(a=0;;++M){var A=0|Math.clamp(n[a].ac,0,255);i=0|Math.clamp(n[a].rc,0,255),o=0|Math.clamp(n[a].gc,0,255),c=0|Math.clamp(n[a].bc,0,255);if(this.palette[M]=A<<24|c<<16|o<<8|i,this.m_transparentPixelIndex>=0&&this.palette[M]==this.m_transparentColor){var S=this.palette[0];this.palette[0]=this.palette[M],this.palette[M]=S}if(0==(a=n[a].fw))break}if(M<e-1){var k=this.palette;this.palette=new Uint32Array(M+1);for(y=0;y<M+1;++y)this.palette[y]=k[y]}},t.prototype.quantize_image=function(t,e,r,n,a){var i=e>256?new Uint16Array(t.length):new Uint8Array(t.length),s=0;if(a){const a=4,c=256,B=20;for(var p=(r+2)*a,l=new Int32Array(a*c),m=new Int32Array(2*c),u=0;u<c;++u)l[u]=0,l[u+c]=u,l[u+2*c]=255,l[u+3*c]=255,m[u]=-B,m[u+c]=B;for(u=-B;u<=B;++u)m[u+c]=u;var g=this.hasSemiTransparency||e<64,x=1,v=new Int32Array(p),y=new Int32Array(p),d=new Int32Array(65536);for(u=0;u<n;++u){x<0&&(s+=r-1);var I=a,P=r*a;y[P]=y[P+1]=y[P+2]=y[P+3]=0;for(var w=0;w<r;++w){var b=255&t[s],T=t[s]>>>8&255,q=t[s]>>>16&255,_=t[s]>>>24&255,M=f(_,b,T,q,l,v,I,g),A=M[0],S=M[1],k=M[2],C=M[3],U=C<<24|k<<16|S<<8|A;if(g){var z=h(C,A,S,k,this.hasSemiTransparency,this.m_transparentPixelIndex>=0);0==d[z]&&(d[z]=0==_?1:o(this.palette,e,U)+1),i[s]=d[z]-1}else i[s]=0==_?0:o(this.palette,e,U);var O=this.palette[i[s]],D=O>>>8&255,F=O>>>16&255,Q=O>>>24&255;A=m[A-(255&O)+c],S=m[S-D+c],k=m[k-F+c],C=m[C-Q+c];var R=2*A;y[P-a]=A,y[P+a]+=A+=R,y[P]+=A+=R,v[I+a]+=A+R,R=2*S,y[P+1-a]=S,y[P+1+a]+=S+=R,y[P+1]+=S+=R,v[I+1+a]+=S+R,R=2*k,y[P+2-a]=k,y[P+2+a]+=k+=R,y[P+2]+=k+=R,v[I+2+a]+=k+R,R=2*C,y[P+3-a]=C,y[P+3+a]+=C+=R,y[P+3]+=C+=R,v[I+3+a]+=C+R,I+=a,P-=a,s+=x}u%2==1&&(s+=r+1),x*=-1;var j=v;v=y,y=j}return this.qPixels=i,this.qPixels}if(this.m_transparentPixelIndex>=0||e<64)for(u=0;u<i.length;++u)i[u]=o(this.palette,e,t[u]);else for(u=0;u<i.length;++u)i[u]=c(this.palette,e,t[u]);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){var t=this.opts.pixels,s=this.opts.width,h=this.opts.height,p=this.opts.colors,l=this.opts.dithering;this.opts.alphaThreshold&&(this.alphaThreshold=this.opts.alphaThreshold),a=[],i=[];for(var o=0;o<t.length;++o){var c=t[o]>>>24&255;c<255&&(0==c?(this.m_transparentPixelIndex=o,this.m_transparentColor=t[o]):this.hasSemiTransparency=!0)}if(p<=32?e=r=n=1:(s<512||h<512)&&(e=.299,r=.587,n=.114),this.palette=new Uint32Array(p),p>2?this.pnnquan(t,p,1):this.m_transparentPixelIndex>=0?(this.palette[0]=0,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.m_transparentPixelIndex>=0){var f=this.qPixels[this.m_transparentPixelIndex];if(p>2)this.palette[f]=this.m_transparentColor;else if(palette[f]!=this.m_transparentColor){var m=palette[0];this.palette[0]=palette[1],this.palette[1]=m}}return this.opts.paletteOnly?this.palette:(this.qPixels=this.quantize_image(t,p,s,h,l),function(t,e){for(var r=new Uint32Array(e.length),n=0;n<e.length;++n)r[n]=t[e[n]];return r}(this.palette,this.qPixels))},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return this.opts.colors>256||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return this.m_transparentPixelIndex>-1?0:-1},t.prototype.getDitherFn=function(){return this.opts.dithering?o:c},t.prototype.getColorIndex=function(t,e,r,n){return h(t,e,r,n,this.hasSemiTransparency,this.m_transparentPixelIndex>=0)},t.prototype.getResult=function(){var t=this;return new Promise(function(e,r){t.opts.paletteOnly?e({pal8:t.quantizeImage(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()}):e({img8:t.quantizeImage(),pal8:t.getPalette(),indexedPixels:t.getIndexedPixels(),transparent:t.getTransparentIndex(),type:t.getImgType()})})},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);