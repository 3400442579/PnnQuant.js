!function(){function t(t){this.opts=t,this.qPixels=[]}function o(t){t/=255;return t<.04045?t/12.92:Math.pow((.055+t)/1.055,2.4)}function q(t,e,i,h,s,n){function a(t,e,i){return.2126*o(t)+.7152*o(e)+.0722*o(i)}t=a(t,e,i);return 100*(a(h,s,n)-t)}function A(t,e,i,h,s,n){function a(t,e,i){return-.09991*t-.33609*e+.436*i}t=a(t,e,i);return a(h,s,n)-t}function I(t){var e=255&t,i=t>>>8&255,h=t>>>16&255,t=t>>>24&255;this.yDiff=0,this.p=[e,i,h,t]}var _,C,O,n,S,T,k,F,G,R,j,z,H,J,K,Q=[],V=[],W=9,a=343;function b(t,e){for(var i=t+e*O,h=S[i],s=new I(h),n=H?V.length-1:0,a=W-1,o=0;o<Q.length;++o){var p=Q[o];if(n<0||n>=V.length)break;for(var r=0;r<p.p.length;++r)s.p[r]+=p.p[r]*V[n],s.p[r]>a&&(a=s.p[r]);n+=H?-1:1}for(var l,f,g,u,w,M=0|Math.clamp(s.p[0],0,255),d=0|Math.clamp(s.p[1],0,255),c=0|Math.clamp(s.p[2],0,255),x=0|Math.clamp(s.p[3],0,255),b=255&h,B=h>>>8&255,v=h>>>16&255,y=x<<24|c<<16|d<<8|M,m=(null==k||H?F<=32&&240<x?(w=C(x,M,d,c),0==j[w]&&(j[w]=_(T,y,i)+1),R[i]=j[w]-1,N=Math.max(2,F-J),null!=k&&(Math.abs(q(b,B,v,M,d,c))>N||Math.abs(A(b,B,v,M,d,c))>2*N)&&(l=1/3,y=new BlueNoise({weightB:1/k[i]}).diffuse(h,T[R[i]],l,t,e),R[i]=_(T,y,i))):R[i]=_(T,y,i):(l=1/3,N=Math.max(2,F-J),F<=4&&.2<k[i]&&k[i]<.25?y=new BlueNoise({weightB:2*G/k[i]}).diffuse(h,T[R[i]],l,t,e):(F<=4||q(b,B,v,M,d,c)<2*N)&&(P=A(b,B,v,f=255&(y=new BlueNoise({weightB:.5*G/k[i]}).diffuse(h,T[R[i]],l,t,e)),g=y>>>8&255,u=y>>>16&255),F<=4&&Math.abs(P)>8*N&&(m=.65<k[i]?h:x<<24|c<<16|d<<8|M,P=A(b,B,v,f=255&(y=new BlueNoise({weightB:G*k[i]}).diffuse(m,T[R[i]],l,t,e)),g=y>>>8&255,u=y>>>16&255)),f=255&(y=Math.abs(P)>J*N?new BlueNoise({weightB:P<0?G/k[i]:G*k[i]}).diffuse(h,T[R[i]],l,t,e):y),g=y>>>8&255,u=y>>>16&255),h=q(b,B,v,f=255&y,g=y>>>8&255,u=y>>>16&255),P=A(b,B,v,f,g,u),F<3||6<J?8<F&&(Math.abs(h)>G*N||Math.abs(P)>2*N)&&(D=0<h||0<P?.4*G*k[i]:.2*G*k[i],m=x<<24|c<<16|d<<8|M,f=255&(y=new BlueNoise({weightB:D}).diffuse(m,T[R[i]],l,t,e)),g=y>>>8&255,u=y>>>16&255):8<F&&(Math.abs(h)>G*N||Math.abs(P)>N)&&(f=255&(y=G<.3&&(F<=32||k[i]<G)?(D=0<h||0<P?.4*G*k[i]:.4*G/k[i],new BlueNoise({weightB:D}).diffuse(y,T[R[i]],l,t,e)):x<<24|c<<16|d<<8|M),g=y>>>8&255,u=y>>>16&255),w=C(x,f,g,u),0==j[w]&&(j[w]=_(T,y,i)+1),R[i]=j[w]-1),Q.length>=W?Q.shift():0<Q.length&&X(Q.length),255&(y=T[R[i]])),N=y>>>8&255,h=y>>>16&255,P=y>>>24&255,D=(s.p[0]=M-m,s.p[1]=d-N,s.p[2]=c-h,s.p[3]=x-P,2<T.length),E=TELL_BLUE_NOISE[4095&i]>K,L=(s.yDiff=H?Math.abs(q(b,B,v,M,d,c)):1,!E&&TELL_BLUE_NOISE[4095&(4096*s.yDiff|0)]>K),U=D?s.p.length-1:0,r=0;r<U;++r)Math.abs(s.p[r])>=z&&(E?s.p[r]=Math.fround(Math.tanh(s.p[r]/a*20))*(z-1):L?s.p[r]=Math.fround(s.p[r]/a*s.yDiff)*(z-1):s.p[r]/=Math.fround(1+Math.sqrt(z)));Q.push(s),H&&Q.sort(function(t,e){return Math.sign(t.yDiff-e.yDiff)})}function B(t,e,i,h,s,n){var a=Math.abs(i+h),o=Math.abs(s+n),p=Math.sign(i),r=Math.sign(h),l=Math.sign(s),f=Math.sign(n);if(1==o)for(var g=0;g<a;++g)b(t,e),t+=p,e+=r;else if(1==a)for(g=0;g<o;++g)b(t,e),t+=l,e+=f;else{var u=i/2|0,w=h/2|0,M=s/2|0,d=n/2|0,c=Math.abs(u+w),x=Math.abs(M+d);3*o<2*a?(c%2!=0&&2<a&&(u+=p,w+=r),B(t,e,u,w,s,n),B(t+u,e+w,i-u,h-w,s,n)):(x%2!=0&&2<o&&(M+=l,d+=f),B(t,e,M,d,u,w),B(t+M,e+d,i,h,s-M,n-d),B(t+(i-p)+(M-l),e+(h-r)+(d-f),-M,-d,-(i-u),-(h-w)))}}function X(t){var e=Math.fround(Math.pow(a+1,1/(t-1))),i=1,h=0;V=new Array(t);for(var s=0;s<t;++s)Q.push(new I(0)),h+=V[t-s-1]=i,i/=e;for(i=0,s=0;s<t;++s)V[s]=Math.fround(V[s]/h),i+=V[s];V[0]+=Math.fround(1-i)}t.prototype.dither=function(){Q=[];var t=this.opts.weight<0,e=(this.opts.weight=Math.abs(this.opts.weight),J=this.opts.weight<.0025?12:this.opts.weight<.004?8:6,H=128<=this.opts.palette.length&&(t?this.opts.weight<.18:.052<=this.opts.weight),W=this.opts.weight<.01?.0025<this.opts.weight?25:16:9,t?1:Math.exp(this.opts.weight)-.25),i=!t&&.002<this.opts.weight?-.25:1,i=(z=t||9<W?Math.pow(Math.sqrt(W)+e*i,2):W,16<this.opts.palette.length?3200:1500);if((5e3<this.opts.palette.length/this.opts.weight&&(.045<this.opts.weight||.01<this.opts.weight&&this.opts.palette.length<64)||this.opts.weight<.03&&this.opts.palette.length/this.opts.weight<i&&16<=this.opts.palette.length&&this.opts.palette.length<128)&&(z=Math.pow(5+e,2)),K=9<W?-112:-64,V=[],j=new Uint32Array(65536),_=this.opts.ditherFn,C=this.opts.getColorIndex,O=this.opts.width,n=this.opts.height,S=this.opts.pixels,T=this.opts.palette,k=t?null:this.opts.saliencies,F=T.length,G=4<F?.6-.00625*F:1,4<F?(i=.005-625e-7*F,G=Math.fround(this.opts.weight>i?Math.max(.25,G-F*this.opts.weight):Math.min(1.5,G+F*this.opts.weight)),F<16&&(G*=.75)):G*=.95,(64<F||4<F&&.02<this.opts.weight)&&(G*=.4),R=new(256<F?Uint16Array:Uint8Array)(S.length),H||X(W),n<=O?B(0,0,O,0,0,n):B(0,0,0,n,O,0),this.opts.indexedPixels=this.qPixels=R,this.opts.dithering){for(var h=new Uint32Array(R.length),s=0;s<R.length;++s)h[s]=T[R[s]];return h}return R},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var i=this;return new Promise(function(t,e){i.opts.dithering?t({img8:i.dither(),indexedPixels:i.getIndexedPixels()}):t({indexedPixels:i.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);
