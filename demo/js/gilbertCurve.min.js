!function(){function t(t){this.opts=t,this.qPixels=[]}function p(t){t/=255;return t<.04045?t/12.92:Math.pow((.055+t)/1.055,2.4)}function E(t,e,h,i,s,n){function o(t,e,h){return.2126*p(t)+.7152*p(e)+.0722*p(h)}t=o(t,e,h),e=o(i,s,n);return 100*Math.abs(e-t)}function L(t){var e=255&t,h=t>>>8&255,i=t>>>16&255,t=t>>>24&255;this.yDiff=0,this.p=[e,h,i,t]}var U,q,A,n,I,_,B,N,C,O,S,T,k,F,G=[],R=[],j=9,o=343;function v(t,e){for(var h=t+e*A,i=I[h],s=new L(i),n=T?R.length-1:0,o=j-1,p=0;p<G.length;++p){var a=G[p];if(n<0||n>=R.length)break;for(var r=0;r<a.p.length;++r)s.p[r]+=a.p[r]*R[n],s.p[r]>o&&(o=s.p[r]);n+=T?-1:1}var l=0|Math.clamp(s.p[0],0,255),f=0|Math.clamp(s.p[1],0,255),g=0|Math.clamp(s.p[2],0,255),u=0|Math.clamp(s.p[3],0,255),M=255&i,d=i>>>8&255,w=i>>>16&255,c=u<<24|g<<16|f<<8|l;function x(t,e,h){return-.09991*t-.33609*e+.436*h}N<=32&&240<u?(b=q(u,l,f,g),0==O[b]&&(O[b]=U(_,c,h)+1),C[h]=O[b]-1,b=Math.max(1,N-k),null!=B&&(E(M,d,w,l,f,g)>b||(y=x(y=M,v=d,w),v=x(l,f,g),Math.abs(v-y)>2*b))&&(c=new BlueNoise({weight:1/B[h]}).diffuse(i,_[C[h]],1/3,t,e),C[h]=U(_,c,h))):C[h]=U(_,c,h),G.length>=j?G.shift():0<G.length&&z(G.length);for(var v=(c=_[C[h]])>>>8&255,y=c>>>16&255,b=c>>>24&255,i=(s.p[0]=l-(255&c),s.p[1]=f-v,s.p[2]=g-y,s.p[3]=u-b,2<_.length),m=TELL_BLUE_NOISE[4095&h]>F,P=(s.yDiff=T?E(M,d,w,l,f,g):1,!m&&TELL_BLUE_NOISE[4095&(4096*s.yDiff|0)]>F),D=i?s.p.length-1:0,r=0;r<D;++r)Math.abs(s.p[r])>=S&&(m?s.p[r]=Math.fround(Math.tanh(s.p[r]/o*20))*(S-1):P?s.p[r]=Math.fround(s.p[r]/o*s.yDiff)*(S-1):s.p[r]/=Math.fround(1+Math.sqrt(S)));G.push(s),T&&G.sort(function(t,e){return Math.sign(t.yDiff-e.yDiff)})}function y(t,e,h,i,s,n){var o=Math.abs(h+i),p=Math.abs(s+n),a=Math.sign(h),r=Math.sign(i),l=Math.sign(s),f=Math.sign(n);if(1==p)for(var g=0;g<o;++g)v(t,e),t+=a,e+=r;else if(1==o)for(g=0;g<p;++g)v(t,e),t+=l,e+=f;else{var u=h/2|0,M=i/2|0,d=s/2|0,w=n/2|0,c=Math.abs(u+M),x=Math.abs(d+w);3*p<2*o?(c%2!=0&&2<o&&(u+=a,M+=r),y(t,e,u,M,s,n),y(t+u,e+M,h-u,i-M,s,n)):(x%2!=0&&2<p&&(d+=l,w+=f),y(t,e,d,w,u,M),y(t+d,e+w,h,i,s-d,n-w),y(t+(h-a)+(d-l),e+(i-r)+(w-f),-d,-w,-(h-u),-(i-M)))}}function z(t){var e=Math.fround(Math.pow(o+1,1/(t-1))),h=1,i=0;R=new Array(t);for(var s=0;s<t;++s)G.push(new L(0)),i+=R[t-s-1]=h,h/=e;for(h=0,s=0;s<t;++s)R[s]=Math.fround(R[s]/i),h+=R[s];R[0]+=Math.fround(1-h)}t.prototype.dither=function(){G=[];var t=this.opts.weight<0,e=(this.opts.weight=Math.abs(this.opts.weight),k=this.opts.weight<.0025?12:6,T=128<=this.opts.palette.length&&(t?this.opts.weight<.18:.052<=this.opts.weight),j=this.opts.weight<.01?.0025<this.opts.weight?25:16:9,t?1:Math.exp(this.opts.weight)-.25),h=.002<this.opts.weight?-.25:1,t=(S=t||9<j?Math.pow(Math.sqrt(j)+e*h,2):j,16<this.opts.palette.length?3200:1500);if((5e3<this.opts.palette.length/this.opts.weight&&(.045<this.opts.weight||.01<this.opts.weight&&this.opts.palette.length<=64)||this.opts.weight<.03&&this.opts.palette.length/this.opts.weight<t&&16<=this.opts.palette.length&&this.opts.palette.length<128)&&(S=Math.pow(5+e,2)),F=9<j?-112:-64,R=[],O=new Uint32Array(65536),U=this.opts.ditherFn,q=this.opts.getColorIndex,A=this.opts.width,n=this.opts.height,I=this.opts.pixels,_=this.opts.palette,B=this.opts.saliencies,N=_.length,C=new(256<N?Uint16Array:Uint8Array)(I.length),T||z(j),n<=A?y(0,0,A,0,0,n):y(0,0,0,n,A,0),this.opts.indexedPixels=this.qPixels=C,this.opts.dithering){for(var i=new Uint32Array(C.length),s=0;s<C.length;++s)i[s]=_[C[s]];return i}return C},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var h=this;return new Promise(function(t,e){h.opts.dithering?t({img8:h.dither(),indexedPixels:h.getIndexedPixels()}):t({indexedPixels:h.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);
