(function(){function t(t){this.opts=t,this.qPixels=[]}function e(t){var e=t/255;return e<.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function i(t,i,h,s,n,r){function a(t,i,h){return.2126*e(t)+.7152*e(i)+.0722*e(h)}var o=a(t,i,h),p=a(s,n,r);return 100*Math.abs(p-o)}function h(t){var e=255&t,i=t>>>8&255,h=t>>>16&255,s=t>>>24&255;this.yDiff=0,this.p=[e,i,h,s]}var s,n,r,a,o,p,l,f,g,u,M,d,w,v,c=[],x=[],y=9,b=343;function m(t,e){for(var a=t+e*r,b=o[a],m=new h(b),P=d?x.length-1:0,E=y-1,L=0;L<c.length;++L){var U=c[L];if(P<0||P>=x.length)break;for(var q=0;q<U.p.length;++q)m.p[q]+=U.p[q]*x[P],m.p[q]>E&&(E=m.p[q]);P+=d?-1:1}var A=0|Math.clamp(m.p[0],0,255),I=0|Math.clamp(m.p[1],0,255),_=0|Math.clamp(m.p[2],0,255),B=0|Math.clamp(m.p[3],0,255),N=255&b,C=b>>>8&255,O=b>>>16&255,S=B<<24|_<<16|I<<8|A;if(f<=32&&B>240){var T=n(B,A,I,_);0==u[T]&&(u[T]=s(p,S,a)+1),g[a]=u[T]-1;var k=Math.max(1,f-w);if(null!=l&&(i(N,C,O,A,I,_)>k||function(t,e,i,h,s,n){function r(t,e,i){return-.09991*t-.33609*e+.436*i}var a=r(t,e,i),o=r(h,s,n);return Math.abs(o-a)}(N,C,O,A,I,_)>2*k)){S=new BlueNoise({weight:1/l[a]}).diffuse(b,p[g[a]],1/3,t,e),g[a]=s(p,S,a)}}else g[a]=s(p,S,a);c.length>=y?c.shift():c.length>0&&D(c.length);var F=255&(S=p[g[a]]),G=S>>>8&255,R=S>>>16&255,j=S>>>24&255;m.p[0]=A-F,m.p[1]=I-G,m.p[2]=_-R,m.p[3]=B-j;var z=p.length>2,H=TELL_BLUE_NOISE[4095&a]>v;m.yDiff=d?i(N,C,O,A,I,_):1;var J=!H&&TELL_BLUE_NOISE[4095&(4096*m.yDiff|0)]>v,K=z?m.p.length-1:0;for(q=0;q<K;++q)Math.abs(m.p[q])>=M&&(H?m.p[q]=Math.fround(Math.tanh(m.p[q]/E*20))*(M-1):J?m.p[q]=Math.fround(m.p[q]/E*m.yDiff)*(M-1):m.p[q]/=Math.fround(1+Math.sqrt(M)));c.push(m),d&&c.sort(function(t,e){return Math.sign(t.yDiff-e.yDiff)})}function P(t,e,i,h,s,n){var r=Math.abs(i+h),a=Math.abs(s+n),o=Math.sign(i),p=Math.sign(h),l=Math.sign(s),f=Math.sign(n);if(1!=a)if(1!=r){var g=i/2|0,u=h/2|0,M=s/2|0,d=n/2|0,w=Math.abs(g+u),v=Math.abs(M+d);if(2*r>3*a)return w%2!=0&&r>2&&(g+=o,u+=p),P(t,e,g,u,s,n),void P(t+g,e+u,i-g,h-u,s,n);v%2!=0&&a>2&&(M+=l,d+=f),P(t,e,M,d,g,u),P(t+M,e+d,i,h,s-M,n-d),P(t+(i-o)+(M-l),e+(h-p)+(d-f),-M,-d,-(i-g),-(h-u))}else for(c=0;c<a;++c)m(t,e),t+=l,e+=f;else for(var c=0;c<r;++c)m(t,e),t+=o,e+=p}function D(t){var e=Math.fround(Math.pow(b+1,1/(t-1))),i=1,s=0;x=new Array(t);for(var n=0;n<t;++n)c.push(new h(0)),s+=x[t-n-1]=i,i/=e;i=0;for(n=0;n<t;++n)x[n]=Math.fround(x[n]/s),i+=x[n];x[0]+=Math.fround(1-i)}t.prototype.dither=function(){c=[];var t=this.opts.weight<0;this.opts.weight=Math.abs(this.opts.weight),w=this.opts.weight<.0025?12:6,d=this.opts.palette.length>=128&&(t?this.opts.weight<.18:this.opts.weight>=.04),y=this.opts.weight<.01?this.opts.weight>.0025?25:16:9;var e=t?1:Math.exp(this.opts.weight)-.25,i=this.opts.weight>.002?-.75:1;M=t||y>9?Math.pow(Math.sqrt(y)+e*i,2):y;var h=this.opts.palette.length>16?3200:1500;return this.opts.palette.length/this.opts.weight>5e3&&(this.opts.weight>.045||this.opts.weight>.01&&this.opts.palette.length<=64)?M=Math.pow(5+e,2):this.opts.weight<.03&&this.opts.palette.length/this.opts.weight<h&&this.opts.palette.length>=16&&this.opts.palette.length<128&&(M=Math.pow(5+e,2)),v=y>9?-112:-64,x=[],u=new Uint32Array(65536),s=this.opts.ditherFn,n=this.opts.getColorIndex,r=this.opts.width,a=this.opts.height,o=this.opts.pixels,p=this.opts.palette,l=this.opts.saliencies,f=p.length,g=f>256?new Uint16Array(o.length):new Uint8Array(o.length),d||D(y),r>=a?P(0,0,r,0,0,a):P(0,0,0,a,r,0),this.opts.indexedPixels=this.qPixels=g,this.opts.dithering?function(){for(var t=new Uint32Array(g.length),e=0;e<g.length;++e)t[e]=p[g[e]];return t}():g},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var t=this;return new Promise(function(e,i){t.opts.dithering?e({img8:t.dither(),indexedPixels:t.getIndexedPixels()}):e({indexedPixels:t.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);
