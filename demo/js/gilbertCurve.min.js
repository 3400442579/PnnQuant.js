(function(){function t(t){this.opts=t,this.qPixels=[]}function e(t){var e=255&t,i=t>>>8&255,h=t>>>16&255,s=t>>>24&255;this.p=[e,i,h,s]}var i,h,s,n,p,a,o,r,l,g,f,u,d=[],M=[],w=9;function v(t,n){for(var v=t+n*s,x=p[v],c=new e(x),m=w-1,y=0;y<w;++y)for(var P=d[y],b=0;b<P.p.length;++b)c.p[b]+=P.p[b]*M[y],c.p[b]>m&&(m=c.p[b]);var q=0|Math.clamp(c.p[0],0,255),A=0|Math.clamp(c.p[1],0,255),U=0|Math.clamp(c.p[2],0,255),I=0|Math.clamp(c.p[3],0,255),E=I<<24|U<<16|A<<8|q;if(r<=32&&I>240){var L=h(I,q,A,U);if(0==g[L]&&(g[L]=i(a,E,v)+1),l[v]=g[L]-1,null!=o&&o[v]>.65&&o[v]<.75){E=new BlueNoise({weight:1/o[v]}).diffuse(x,a[l[v]],1/3,t,n),l[v]=i(a,E,v)}}else l[v]=i(a,E,v);d.shift();var B=255&(E=a[l[v]]),C=E>>>8&255,N=E>>>16&255,_=E>>>24&255;c.p[0]=q-B,c.p[1]=A-C,c.p[2]=U-N,c.p[3]=I-_;var F=a.length>2,G=TELL_BLUE_NOISE[4095&v]>u,O=F?c.p.length-1:0;for(b=0;b<O;++b)Math.abs(c.p[b])>=f&&(G?c.p[b]=Math.fround(Math.tanh(c.p[b]/m*20))*(f-1):c.p[b]/=Math.fround(1+Math.sqrt(f)));d.push(c)}function x(t,e,i,h,s,n){var p=Math.abs(i+h),a=Math.abs(s+n),o=Math.sign(i),r=Math.sign(h),l=Math.sign(s),g=Math.sign(n);if(1!=a)if(1!=p){var f=i/2|0,u=h/2|0,d=s/2|0,M=n/2|0,w=Math.abs(f+u),c=Math.abs(d+M);if(2*p>3*a)return w%2!=0&&p>2&&(f+=o,u+=r),x(t,e,f,u,s,n),void x(t+f,e+u,i-f,h-u,s,n);c%2!=0&&a>2&&(d+=l,M+=g),x(t,e,d,M,f,u),x(t+d,e+M,i,h,s-d,n-M),x(t+(i-o)+(d-l),e+(h-r)+(M-g),-d,-M,-(i-f),-(h-u))}else for(m=0;m<a;++m)v(t,e),t+=l,e+=g;else for(var m=0;m<p;++m)v(t,e),t+=o,e+=r}t.prototype.dither=function(){d=[];var t=this.opts.weight<0;this.opts.weight=Math.abs(this.opts.weight),w=this.opts.weight<.01?this.opts.weight>.0025?25:16:9;var v=t?1:Math.exp(this.opts.weight)-.25;f=t||w>9?Math.pow(Math.sqrt(w)+v,2):w,this.opts.palette.length/this.opts.weight>5e3&&(this.opts.weight>.045||this.opts.weight>.01&&this.opts.palette.length<=64)&&(f=Math.pow(5+v,2)),this.opts.palette.length>16&&this.opts.palette.length<256&&(f=Math.max(f,this.opts.palette.length-w)),u=w>9?-112:-64,M=new Array(w),g=new Uint32Array(65536);for(var c=Math.pow(344,1/(w-1)),m=1,y=0,P=0;P<w;++P){d.push(new e(0));var b=Math.fround(1/m);y+=M[w-P-1]=b,m*=c}m=0;for(P=0;P<w;++P)M[P]=Math.fround(M[P]/y),m+=M[P];return M[0]+=Math.fround(1-m),i=this.opts.ditherFn,h=this.opts.getColorIndex,s=this.opts.width,n=this.opts.height,p=this.opts.pixels,a=this.opts.palette,o=this.opts.saliencies,r=a.length,l=r>256?new Uint16Array(p.length):new Uint8Array(p.length),s>=n?x(0,0,s,0,0,n):x(0,0,0,n,s,0),this.opts.indexedPixels=this.qPixels=l,this.opts.dithering?function(){for(var t=new Uint32Array(l.length),e=0;e<l.length;++e)t[e]=a[l[e]];return t}():l},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var t=this;return new Promise(function(e,i){t.opts.dithering?e({img8:t.dither(),indexedPixels:t.getIndexedPixels()}):e({indexedPixels:t.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);
