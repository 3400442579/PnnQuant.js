(function(){function t(t){this.opts=t||{},this.qPixels=[]}function e(t){return t<0?-1:t>0?1:0}function i(t){var e=255&t,i=t>>>8&255,r=t>>>16&255,n=t>>>24&255;this.p=[e,i,r,n]}var r,n,s,o,h,p,a,l;Math.clamp||(Math.clamp=function(t,e,i){return this.max(e,this.min(i,t))});var f,u=[],d=[],c=9;function v(t,e){for(var o=t+e*s,v=h[o],x=new i(v),g=0;g<c;++g)for(var m=u[g],M=0;M<m.p.length;++M)x.p[M]+=m.p[M]*d[g];var w=0|Math.clamp(x.p[0],0,255),y=0|Math.clamp(x.p[1],0,255),P=0|Math.clamp(x.p[2],0,255),b=0|Math.clamp(x.p[3],0,255),A=b<<24|P<<16|y<<8|w;if(a<64){var U=n(b,w,y,P);0==f[U]&&(f[U]=v>>>24&!1?1:r(p,a,A)+1),l[o]=f[U]-1}else l[o]=r(p,a,A);u.shift();var q=255&(A=p[l[o]]),I=A>>>8&255,C=A>>>16&255,F=A>>>24&255;x.p[0]=w-q,x.p[1]=y-I,x.p[2]=P-C,x.p[3]=b-F;for(M=0;M<x.p.length;++M)Math.abs(x.p[M])<c||(x.p[M]/=3);u.push(x)}function x(t,i,r,n,s,o){var h=Math.abs(r+n),p=Math.abs(s+o),a=e(r),l=e(n),f=e(s),u=e(o);if(1!=p)if(1!=h){var d=r/2|0,c=n/2|0,g=s/2|0,m=o/2|0,M=Math.abs(d+c),w=Math.abs(g+m);if(2*h>3*p)return M%2!=0&&h>2&&(d+=a,c+=l),x(t,i,d,c,s,o),void x(t+d,i+c,r-d,n-c,s,o);w%2!=0&&p>2&&(g+=f,m+=u),x(t,i,g,m,d,c),x(t+g,i+m,r,n,s-g,o-m),x(t+(r-a)+(g-f),i+(n-l)+(m-u),-g,-m,-(r-d),-(n-c))}else for(y=0;y<p;++y)v(t,i),t+=f,i+=u;else for(var y=0;y<h;++y)v(t,i),t+=a,i+=l}t.prototype.dither=function(){u=[],d=[],f=new Uint32Array(65536);for(var t=Math.pow(344,1/(c-1)),e=1,v=0,g=0;g<c;++g)u.push(new i(0)),v+=d[c-g-1]=1/e,e*=t;e=0;for(g=0;g<c;++g)e+=d[g]/=v;return d[0]+=1-e,r=this.opts.ditherFn,n=this.opts.getColorIndex,s=this.opts.width,o=this.opts.height,h=this.opts.pixels,p=this.opts.palette,a=this.opts.colors,l=a>256?new Uint16Array(h.length):new Uint8Array(h.length),s>=o?x(0,0,s,0,0,o):x(0,0,0,o,s,0),this.qPixels=l,this.opts.dithering?function(){for(var t=new Uint32Array(l.length),e=0;e<l.length;++e)t[e]=p[l[e]];return t}():l},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var t=this;return new Promise(function(e,i){t.opts.dithering?e({img8:t.dither(),indexedPixels:t.getIndexedPixels()}):e({indexedPixels:t.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);