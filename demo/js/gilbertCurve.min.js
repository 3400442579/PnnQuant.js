!function(){function t(t){this.opts=t,this.qPixels=[]}function a(t){t/=255;return t<.04045?t/12.92:Math.pow((.055+t)/1.055,2.4)}function E(t,e,i,h,s,n){function o(t,e,i){return.2126*a(t)+.7152*a(e)+.0722*a(i)}t=o(t,e,i),e=o(h,s,n);return 100*Math.abs(e-t)}function I(t,e,i,h,s,n){function o(t,e,i){return-.09991*t-.33609*e+.436*i}t=o(t,e,i),e=o(h,s,n);return Math.abs(e-t)}function L(t){var e=255&t,i=t>>>8&255,h=t>>>16&255,t=t>>>24&255;this.yDiff=0,this.p=[e,i,h,t]}Math.tanh||(Math.tanh=function(t){var e=Math.exp(+t),t=Math.exp(-t);return e==1/0?1:t==1/0?-1:(e-t)/(e+t)});var U,q,A,n,B,_,C,O,S,T,k,F,G,R,j,z,H,J=[],K=[],Q=9,o=343;function V(t,e,i,h){var s,n,o=t+e*A,a=_[o],p=255&a,r=a>>>8&255,l=a>>>16&255,f=255&i,u=i>>>8&255,g=i>>>16&255,w=i>>>24&255,M=Math.max(2,S-z),d=(S<=4&&.2<O[o]&&O[o]<.25?i=new BlueNoise({weightB:2*h/O[o]}).diffuse(a,C[k[o]],1/3,t,e):(S<=4||E(p,r,l,f,u,g)<2*M)&&(d=255&(i=new BlueNoise({weightB:.5*h/O[o]}).diffuse(a,C[k[o]],1/3,t,e)),c=i>>>8&255,x=i>>>16&255,S<=4&&I(p,r,l,d,c,x)>8*M&&(n=.65<O[o]?a:w<<24|g<<16|u<<8|f,d=255&(i=new BlueNoise({weightB:h*O[o]}).diffuse(n,C[k[o]],1/3,t,e)),c=i>>>8&255,x=i>>>16&255),d=255&(i=I(p,r,l,d,c,x)>z*M?new BlueNoise({weightB:h/O[o]}).diffuse(a,C[k[o]],1/3,t,e):i),c=i>>>8&255,x=i>>>16&255),255&i),c=i>>>8&255,x=i>>>16&255,a=(S<3||6<z?(s=.0015<B&&B<.0025?h:Math.PI,4<S&&(E(p,r,l,d,c,x)>s*M||I(p,r,l,d,c,x)>z*M)&&(s=O[o]<.4?.4*h*O[o]:.4*h/O[o],n=O[o]<.6?a:w<<24|g<<16|u<<8|f,d=255&(i=new BlueNoise({weightB:s}).diffuse(n,C[k[o]],1/3,t,e)),c=i>>>8&255,x=i>>>16&255)):4<S&&(E(p,r,l,d,c,x)>h*M||I(p,r,l,d,c,x)>M)&&(d=255&(i=h<.3&&(S<=32||O[o]<h)?new BlueNoise({weightB:.4*h*O[o]}).diffuse(i,C[k[o]],1/3,t,e):w<<24|g<<16|u<<8|f),c=i>>>8&255,x=i>>>16&255),Q<16&&4<S&&O[o]<.6&&E(p,r,l,d,c,x)>z-1&&(i=w<<24|g<<16|u<<8|f,d=f,c=u,x=g),1<h&&E(p,r,l,d,c,x)>Q&&(i=w<<24|g<<16|u<<8|f,d=f,c=u,x=g),q(w,d,c,x));return 0==F[a]&&(F[a]=U(C,i,o)+1),F[a]-1}function v(t,e){for(var i=t+e*A,h=_[i],s=new L(h),n=j?K.length-1:0,o=Q-1,a=0;a<J.length;++a){var p=J[a];if(n<0||n>=K.length)break;for(var r=0;r<p.p.length;++r)s.p[r]+=p.p[r]*K[n],s.p[r]>o&&(o=s.p[r]);n+=j?-1:1}for(var l,f=0|Math.clamp(s.p[0],0,255),u=0|Math.clamp(s.p[1],0,255),g=0|Math.clamp(s.p[2],0,255),w=0|Math.clamp(s.p[3],0,255),M=255&h,d=h>>>8&255,c=h>>>16&255,x=w<<24|g<<16|u<<8|f,B=(null!=O&&R&&!j?k[i]=V(t,e,x,T):S<=32&&240<w?(B=q(w,f,u,g),0==F[B]&&(F[B]=U(C,x,i)+1),k[i]=F[B]-1,B=Math.max(2,S-z),null!=O&&(E(M,d,c,f,u,g)>B||I(M,d,c,f,u,g)>2*B)&&(l=1/3,x=new BlueNoise({weightB:1/O[i]}).diffuse(h,C[k[i]],l,t,e),k[i]=U(C,x,i))):k[i]=U(C,x,i),J.length>=Q?J.shift():0<J.length&&W(J.length),255&(x=C[k[i]])),v=x>>>8&255,y=x>>>16&255,m=x>>>24&255,w=(s.p[0]=f-B,s.p[1]=u-v,s.p[2]=g-y,s.p[3]=w-m,2<C.length),b=TELL_BLUE_NOISE[4095&i]>H,N=(s.yDiff=j?E(M,d,c,B,v,y):1,!b&&TELL_BLUE_NOISE[4095&(4096*s.yDiff|0)]>H),P=!1,D=w?s.p.length-1:0,r=0;r<D;++r)Math.abs(s.p[r])>=G&&(j&&null!=O&&(P=!0),b?s.p[r]=Math.fround(Math.tanh(s.p[r]/o*20))*(G-1):N?s.p[r]=Math.fround(s.p[r]/o*s.yDiff)*(G-1):s.p[r]/=Math.fround(1+Math.sqrt(G))),j&&null==O&&Math.abs(s.p[r])>=Q&&(P=!0);P&&(null!=O?k[i]=V(t,e,x,1.25):3<E(M,d,c,f,u,g)&&3<I(M,d,c,f,u,g)&&(l=1/3,x=new BlueNoise({weightB:l}).diffuse(h,C[k[i]],l,t,e),k[i]=U(C,x,i))),J.push(s),j&&J.sort(function(t,e){return e.yDiff<t.yDiff?-1:t.yDiff<e.yDiff?1:0})}function y(t,e,i,h,s,n){var o=Math.abs(i+h),a=Math.abs(s+n),p=Math.sign(i),r=Math.sign(h),l=Math.sign(s),f=Math.sign(n);if(1==a)for(var u=0;u<o;++u)v(t,e),t+=p,e+=r;else if(1==o)for(u=0;u<a;++u)v(t,e),t+=l,e+=f;else{var g=i>>1,w=h>>1,M=s>>1,d=n>>1,c=Math.abs(g+w),x=Math.abs(M+d);3*a<2*o?(c%2!=0&&2<o&&(g+=p,w+=r),y(t,e,g,w,s,n),y(t+g,e+w,i-g,h-w,s,n)):(x%2!=0&&2<a&&(M+=l,d+=f),y(t,e,M,d,g,w),y(t+M,e+d,i,h,s-M,n-d),y(t+(i-p)+(M-l),e+(h-r)+(d-f),-M,-d,-(i-g),-(h-w)))}}function W(t){var e=Math.fround(Math.pow(o+1,1/(t-1))),i=1,h=0;K=new Array(t);for(var s=0;s<t;++s)J.push(new L(0)),h+=K[t-s-1]=i,i/=e;for(i=0,s=0;s<t;++s)K[s]=Math.fround(K[s]/h),i+=K[s];K[0]+=Math.fround(1-i)}t.prototype.dither=function(){J=[];var t=this.opts.weight<0,e=(this.opts.weight=B=Math.abs(this.opts.weight),z=this.opts.weight<.0025?12:this.opts.weight<.004?8:6,j=128<=this.opts.palette.length&&(!t||this.opts.weight<.18),Q=this.opts.weight<.015?.0025<this.opts.weight?25:16:9,t?1:Math.exp(this.opts.weight)-.25),i=!t&&.002<this.opts.weight?-.25:1,i=(G=t||9<Q?Math.pow(Math.sqrt(Q)+e*i,2):Q*(null!=O?2:Math.E),16<this.opts.palette.length?3200:1500);if((5e3<this.opts.palette.length/this.opts.weight&&(.045<this.opts.weight||.01<this.opts.weight&&this.opts.palette.length<64)||this.opts.weight<.03&&this.opts.palette.length/this.opts.weight<i&&16<=this.opts.palette.length&&this.opts.palette.length<128)&&(G=Math.pow(5+e,2)),G|=0,H=9<Q?-112:-64,K=[],F=new Uint32Array(65536),U=this.opts.ditherFn,q=this.opts.getColorIndex,A=this.opts.width,n=this.opts.height,_=this.opts.pixels,C=this.opts.palette,O=t?null:this.opts.saliencies,R=this.opts.dithering,S=C.length,T=4<S?.6-.00625*S:1,4<S?(i=.005-625e-7*S,T=Math.fround(this.opts.weight>i?.25:Math.min(1.5,T+S*this.opts.weight)),32<S&&S<256&&(T+=.1)):T*=.95,(64<S||4<S&&.02<this.opts.weight)&&(T*=.4),k=new(256<S?Uint16Array:Uint8Array)(_.length),j||W(Q),n<=A?y(0,0,A,0,0,n):y(0,0,0,n,A,0),this.opts.indexedPixels=this.qPixels=k,this.opts.dithering){for(var h=new Uint32Array(k.length),s=0;s<k.length;++s)h[s]=C[k[s]];return h}return k},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var i=this;return new Promise(function(t,e){i.opts.dithering||i.opts.colors<=32?t({img8:i.dither(),indexedPixels:i.getIndexedPixels()}):t({indexedPixels:i.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);
