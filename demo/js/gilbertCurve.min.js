(function(){function t(t){this.opts=t||{},this.qPixels=[]}var e,r,i,n,o,h,s,a,p;function u(t){return t<0?-1:t>0?1:0}function f(t){var e=255&t,r=t>>>8&255,i=t>>>16&255,n=t>>>24&255;this.p=[e,r,i,n]}Math.clamp||(Math.clamp=function(t,e,r){return this.max(e,this.min(r,t))}),Math.fround||(Math.fround=(e=new Float32Array(1),function(t){return e[0]=+t,e[0]}));var l=[],d=[],c=9;function v(t,e){for(var o=t+e*n,u=new f(h[o]),v=0;v<c;++v)for(var M=l[v],x=0;x<M.p.length;++x)u.p[x]+=M.p[x]*d[v];var g=0|Math.clamp(u.p[0],0,255),m=0|Math.clamp(u.p[1],0,255),w=0|Math.clamp(u.p[2],0,255),y=0|Math.clamp(u.p[3],0,255),P=y<<24|w<<16|m<<8|g;p[o]=r(s,a,P),l.shift();var b=255&(P=s[p[o]]),A=P>>>8&255,q=P>>>16&255,I=P>>>24&255;if(u.p[0]=g-b,u.p[1]=m-A,u.p[2]=w-q,u.p[3]=y-I,i<3||a>16)for(x=0;x<u.p.length;++x)Math.abs(u.p[x])<c||(u.p[x]=Math.fround(u.p[x]/i));l.push(u)}function M(t,e,r,i,n,o){var h=Math.abs(r+i),s=Math.abs(n+o),a=u(r),p=u(i),f=u(n),l=u(o);if(1!=s)if(1!=h){var d=r/2|0,c=i/2|0,x=n/2|0,g=o/2|0,m=Math.abs(d+c),w=Math.abs(x+g);if(2*h>3*s)return m%2!=0&&h>2&&(d+=a,c+=p),M(t,e,d,c,n,o),void M(t+d,e+c,r-d,i-c,n,o);w%2!=0&&s>2&&(x+=f,g+=l),M(t,e,x,g,d,c),M(t+x,e+g,r,i,n-x,o-g),M(t+(r-a)+(x-f),e+(i-p)+(g-l),-x,-g,-(r-d),-(i-c))}else for(y=0;y<s;++y)v(t,e),t+=f,e+=l;else for(var y=0;y<h;++y)v(t,e),t+=a,e+=p}t.prototype.dither=function(){l=[],d=new Array(c);for(var t=Math.pow(344,1/(c-1)),e=1,u=0,v=0;v<c;++v){l.push(new f(0));var x=Math.fround(1/e);u+=d[c-v-1]=x,e*=t}e=0;for(v=0;v<c;++v)d[v]=Math.fround(d[v]/u),e+=d[v];return d[0]+=Math.fround(1-e),r=this.opts.ditherFn,this.opts.getColorIndex,n=this.opts.width,o=this.opts.height,h=this.opts.pixels,s=this.opts.palette,a=s.length,i=this.opts.divisor?this.opts.divisor:a>32?3:a>2?1.8:1.5,p=a>256?new Uint16Array(h.length):new Uint8Array(h.length),n>=o?M(0,0,n,0,0,o):M(0,0,0,o,n,0),this.qPixels=p,this.opts.dithering?function(){for(var t=new Uint32Array(p.length),e=0;e<p.length;++e)t[e]=s[p[e]];return t}():p},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var t=this;return new Promise(function(e,r){t.opts.dithering?e({img8:t.dither(),indexedPixels:t.getIndexedPixels()}):e({indexedPixels:t.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);