(function(){function t(t){this.opts=t,this.qPixels=[]}function e(t){var e=t/255;return e<.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function i(t){var e=255&t,i=t>>>8&255,h=t>>>16&255,n=t>>>24&255;this.yDiff=0,this.p=[e,i,h,n]}var h,n,s,r,o,a,p,l,f,g,u,d,M,w=[],v=[],c=9,x=343;function y(t,r){for(var x=t+r*s,y=o[x],b=new i(y),P=d?v.length-1:0,A=c-1,D=0;D<w.length;++D){var E=w[D];if(P<0||P>=v.length)break;for(var L=0;L<E.p.length;++L)b.p[L]+=E.p[L]*v[P],b.p[L]>A&&(A=b.p[L]);P+=d?-1:1}var U=0|Math.clamp(b.p[0],0,255),q=0|Math.clamp(b.p[1],0,255),I=0|Math.clamp(b.p[2],0,255),_=0|Math.clamp(b.p[3],0,255),B=_<<24|I<<16|q<<8|U;if(l<=32&&_>240){var N=n(_,U,q,I);if(0==g[N]&&(g[N]=h(a,B,x)+1),f[x]=g[N]-1,null!=p&&p[x]>.65&&p[x]<.75){B=new BlueNoise({weight:1/p[x]}).diffuse(y,a[f[x]],1/3,t,r),f[x]=h(a,B,x)}}else f[x]=h(a,B,x);w.length>=c?w.shift():w.length>0&&m(w.length);var O=255&y,C=y>>>8&255,F=y>>>16&255,S=255&(B=a[f[x]]),T=B>>>8&255,k=B>>>16&255,G=B>>>24&255;b.p[0]=U-S,b.p[1]=q-T,b.p[2]=I-k,b.p[3]=_-G;var R=a.length>2,j=TELL_BLUE_NOISE[4095&x]>M;b.yDiff=d?function(t,i,h,n,s,r){function o(t,i,h){return.2126*e(t)+.7152*e(i)+.0722*e(h)}var a=o(t,i,h),p=o(n,s,r);return 100*Math.abs(p-a)}(O,C,F,U,q,I):1;var z=!j&&TELL_BLUE_NOISE[4095&(4096*b.yDiff|0)]>M,H=R?b.p.length-1:0;for(L=0;L<H;++L)Math.abs(b.p[L])>=u&&(j?b.p[L]=Math.fround(Math.tanh(b.p[L]/A*20))*(u-1):z?b.p[L]=Math.fround(b.p[L]/A*b.yDiff)*(u-1):b.p[L]/=Math.fround(1+Math.sqrt(u)));w.push(b),d&&w.sort(function(t,e){return t.yDiff<e.yDiff?1:-1})}function b(t,e,i,h,n,s){var r=Math.abs(i+h),o=Math.abs(n+s),a=Math.sign(i),p=Math.sign(h),l=Math.sign(n),f=Math.sign(s);if(1!=o)if(1!=r){var g=i/2|0,u=h/2|0,d=n/2|0,M=s/2|0,w=Math.abs(g+u),v=Math.abs(d+M);if(2*r>3*o)return w%2!=0&&r>2&&(g+=a,u+=p),b(t,e,g,u,n,s),void b(t+g,e+u,i-g,h-u,n,s);v%2!=0&&o>2&&(d+=l,M+=f),b(t,e,d,M,g,u),b(t+d,e+M,i,h,n-d,s-M),b(t+(i-a)+(d-l),e+(h-p)+(M-f),-d,-M,-(i-g),-(h-u))}else for(c=0;c<o;++c)y(t,e),t+=l,e+=f;else for(var c=0;c<r;++c)y(t,e),t+=a,e+=p}function m(t){var e=Math.fround(Math.pow(x+1,1/(t-1))),h=1,n=0;v=new Array(t);for(var s=0;s<t;++s)w.push(new i(0)),n+=v[t-s-1]=h,h/=e;h=0;for(s=0;s<t;++s)v[s]=Math.fround(v[s]/n),h+=v[s];v[0]+=Math.fround(1-h)}t.prototype.dither=function(){w=[];var t=this.opts.weight<0;d=!t&&this.opts.palette.length>=128&&navigator.userAgent.indexOf("Firefox")<0,this.opts.weight=Math.abs(this.opts.weight),c=this.opts.weight<.01?this.opts.weight>.0025?25:16:9;var e=t?1:Math.exp(this.opts.weight)-.25;return u=t||c>9?Math.pow(Math.sqrt(c)+e,2):c,this.opts.palette.length/this.opts.weight>5e3&&(this.opts.weight>.045||this.opts.weight>.01&&this.opts.palette.length<=64)?u=Math.pow(5+e,2):this.opts.palette.length/this.opts.weight<3200&&this.opts.palette.length>16&&this.opts.palette.length<128&&(u=Math.pow(5+e,2)),M=c>9?-112:-64,v=[],g=new Uint32Array(65536),h=this.opts.ditherFn,n=this.opts.getColorIndex,s=this.opts.width,r=this.opts.height,o=this.opts.pixels,a=this.opts.palette,p=this.opts.saliencies,l=a.length,f=l>256?new Uint16Array(o.length):new Uint8Array(o.length),m(d?1:c),s>=r?b(0,0,s,0,0,r):b(0,0,0,r,s,0),this.opts.indexedPixels=this.qPixels=f,this.opts.dithering?function(){for(var t=new Uint32Array(f.length),e=0;e<f.length;++e)t[e]=a[f[e]];return t}():f},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var t=this;return new Promise(function(e,i){t.opts.dithering?e({img8:t.dither(),indexedPixels:t.getIndexedPixels()}):e({indexedPixels:t.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);
