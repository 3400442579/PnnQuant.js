(function(){function t(t){this.opts=t||{},this.qPixels=[]}function e(t){return t<0?-1:t>0?1:0}function i(t){var e=255&t,i=t>>>8&255,r=t>>>16&255,n=t>>>24&255;this.p=[e,i,r,n]}var r,n,s,o,h,p,a,l,f;Math.clamp||(Math.clamp=function(t,e,i){return this.max(e,this.min(i,t))});var u,d=[],c=[],v=9;function x(t,e){for(var h=t+e*o,x=p[h],g=new i(x),m=0;m<v;++m)for(var M=d[m],w=0;w<M.p.length;++w)g.p[w]+=M.p[w]*c[m];var y=0|Math.clamp(g.p[0],0,255),P=0|Math.clamp(g.p[1],0,255),b=0|Math.clamp(g.p[2],0,255),A=0|Math.clamp(g.p[3],0,255),U=A<<24|b<<16|P<<8|y;if(l<64){var q=n(A,y,P,b);0==u[q]&&(u[q]=x>>>24&!1?1:r(a,l,U)+1),f[h]=u[q]-1}else f[h]=r(a,l,U);d.shift();var I=255&(U=a[f[h]]),C=U>>>8&255,F=U>>>16&255,G=U>>>24&255;if(g.p[0]=y-I,g.p[1]=P-C,g.p[2]=b-F,g.p[3]=A-G,s<3||l>16)for(w=0;w<g.p.length;++w)Math.abs(g.p[w])<v||(g.p[w]/=s);d.push(g)}function g(t,i,r,n,s,o){var h=Math.abs(r+n),p=Math.abs(s+o),a=e(r),l=e(n),f=e(s),u=e(o);if(1!=p)if(1!=h){var d=r/2|0,c=n/2|0,v=s/2|0,m=o/2|0,M=Math.abs(d+c),w=Math.abs(v+m);if(2*h>3*p)return M%2!=0&&h>2&&(d+=a,c+=l),g(t,i,d,c,s,o),void g(t+d,i+c,r-d,n-c,s,o);w%2!=0&&p>2&&(v+=f,m+=u),g(t,i,v,m,d,c),g(t+v,i+m,r,n,s-v,o-m),g(t+(r-a)+(v-f),i+(n-l)+(m-u),-v,-m,-(r-d),-(n-c))}else for(y=0;y<p;++y)x(t,i),t+=f,i+=u;else for(var y=0;y<h;++y)x(t,i),t+=a,i+=l}t.prototype.dither=function(){d=[],c=[],u=new Uint32Array(65536);for(var t=Math.pow(344,1/(v-1)),e=1,x=0,m=0;m<v;++m)d.push(new i(0)),x+=c[v-m-1]=1/e,e*=t;e=0;for(m=0;m<v;++m)e+=c[m]/=x;return c[0]+=1-e,r=this.opts.ditherFn,n=this.opts.getColorIndex,o=this.opts.width,h=this.opts.height,p=this.opts.pixels,a=this.opts.palette,l=this.opts.colors,s=l>32?3:l>2?1.8:1.5,f=l>256?new Uint16Array(p.length):new Uint8Array(p.length),o>=h?g(0,0,o,0,0,h):g(0,0,0,h,o,0),this.qPixels=f,this.opts.dithering?function(){for(var t=new Uint32Array(f.length),e=0;e<f.length;++e)t[e]=a[f[e]];return t}():f},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var t=this;return new Promise(function(e,i){t.opts.dithering?e({img8:t.dither(),indexedPixels:t.getIndexedPixels()}):e({indexedPixels:t.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);