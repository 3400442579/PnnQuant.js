(function(){function t(t){this.opts=t||{},this.qPixels=[]}var e,r,n,i,a,h,o,s,p,f;function u(t){return t<0?-1:t>0?1:0}function l(t){var e=255&t,r=t>>>8&255,n=t>>>16&255,i=t>>>24&255;this.p=[e,r,n,i]}Math.clamp||(Math.clamp=function(t,e,r){return this.max(e,this.min(r,t))}),Math.fround||(Math.fround=(e=new Float32Array(1),function(t){return e[0]=+t,e[0]}));var d,c=[],M=[],v=9;function x(t,e){for(var h=t+e*a,u=o[h],x=new l(u),g=0;g<v;++g)for(var m=c[g],w=0;w<m.p.length;++w)x.p[w]+=m.p[w]*M[g];var y=0|Math.clamp(x.p[0],0,255),P=0|Math.clamp(x.p[1],0,255),b=0|Math.clamp(x.p[2],0,255),A=0|Math.clamp(x.p[3],0,255),U=A<<24|b<<16|P<<8|y;if(p<64){var q=n(A,y,P,b);0==d[q]&&(d[q]=u>>>24&!1?1:r(s,p,U)+1),f[h]=d[q]-1}else f[h]=r(s,p,U);c.shift();var I=255&(U=s[f[h]]),C=U>>>8&255,F=U>>>16&255,G=U>>>24&255;if(x.p[0]=y-I,x.p[1]=P-C,x.p[2]=b-F,x.p[3]=A-G,i<3||p>16)for(w=0;w<x.p.length;++w)Math.abs(x.p[w])<v||(x.p[w]=Math.fround(x.p[w]/i));c.push(x)}function g(t,e,r,n,i,a){var h=Math.abs(r+n),o=Math.abs(i+a),s=u(r),p=u(n),f=u(i),l=u(a);if(1!=o)if(1!=h){var d=r/2|0,c=n/2|0,M=i/2|0,v=a/2|0,m=Math.abs(d+c),w=Math.abs(M+v);if(2*h>3*o)return m%2!=0&&h>2&&(d+=s,c+=p),g(t,e,d,c,i,a),void g(t+d,e+c,r-d,n-c,i,a);w%2!=0&&o>2&&(M+=f,v+=l),g(t,e,M,v,d,c),g(t+M,e+v,r,n,i-M,a-v),g(t+(r-s)+(M-f),e+(n-p)+(v-l),-M,-v,-(r-d),-(n-c))}else for(y=0;y<o;++y)x(t,e),t+=f,e+=l;else for(var y=0;y<h;++y)x(t,e),t+=s,e+=p}t.prototype.dither=function(){c=[],M=new Array(v),d=new Uint32Array(65536);for(var t=Math.pow(344,1/(v-1)),e=1,u=0,x=0;x<v;++x){c.push(new l(0));var m=Math.fround(1/e);u+=M[v-x-1]=m,e*=t}e=0;for(x=0;x<v;++x)M[x]=Math.fround(M[x]/u),e+=M[x];return M[0]+=Math.fround(1-e),r=this.opts.ditherFn,n=this.opts.getColorIndex,a=this.opts.width,h=this.opts.height,o=this.opts.pixels,s=this.opts.palette,p=s.length,i=p>32?3:p>2?1.8:1.5,f=p>256?new Uint16Array(o.length):new Uint8Array(o.length),a>=h?g(0,0,a,0,0,h):g(0,0,0,h,a,0),this.qPixels=f,this.opts.dithering?function(){for(var t=new Uint32Array(f.length),e=0;e<f.length;++e)t[e]=s[f[e]];return t}():f},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var t=this;return new Promise(function(e,r){t.opts.dithering?e({img8:t.dither(),indexedPixels:t.getIndexedPixels()}):e({indexedPixels:t.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);