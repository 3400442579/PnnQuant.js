(function(){function t(t){this.opts=t,this.qPixels=[]}function e(t){var e=t/255;return e<.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function h(t){var e=255&t,i=t>>>8&255,h=t>>>16&255,s=t>>>24&255;this.yDiff=0,this.p=[e,i,h,s]}var s,n,r,o,a,p,l,f,g,u,d,M,w,v=[],c=[],x=9,y=343;function m(t,e,h){for(i=t.length-1,item=t[i];i>0&&item[e]>t[i-1][e];)t[i]=t[i-1],--i;return t[i]=item,t}function b(t,i){for(var o=t+i*r,y=a[o],b=new h(y),P=M?c.length-1:0,L=x-1,U=0;U<v.length;++U){var q=v[U];if(P<0||P>=c.length)break;for(var A=0;A<q.p.length;++A)b.p[A]+=q.p[A]*c[P],b.p[A]>L&&(L=b.p[A]);P+=M?-1:1}var D=0|Math.clamp(b.p[0],0,255),I=0|Math.clamp(b.p[1],0,255),_=0|Math.clamp(b.p[2],0,255),B=0|Math.clamp(b.p[3],0,255),N=B<<24|_<<16|I<<8|D;if(f<=32&&B>240){var C=n(B,D,I,_);if(0==u[C]&&(u[C]=s(p,N,o)+1),g[o]=u[C]-1,null!=l&&l[o]>.65&&l[o]<.75){N=new BlueNoise({weight:1/l[o]}).diffuse(y,p[g[o]],1/3,t,i),g[o]=s(p,N,o)}}else g[o]=s(p,N,o);v.length>=x?v.shift():v.length>0&&E(v.length);var O=255&y,S=y>>>8&255,T=y>>>16&255,k=255&(N=p[g[o]]),F=N>>>8&255,G=N>>>16&255,R=N>>>24&255;b.p[0]=D-k,b.p[1]=I-F,b.p[2]=_-G,b.p[3]=B-R;var j=p.length>2,z=TELL_BLUE_NOISE[4095&o]>w;b.yDiff=M?function(t,i,h,s,n,r){function o(t,i,h){return.2126*e(t)+.7152*e(i)+.0722*e(h)}var a=o(t,i,h),p=o(s,n,r);return 100*Math.abs(p-a)}(O,S,T,D,I,_):1;var H=!z&&TELL_BLUE_NOISE[4095&(4096*b.yDiff|0)]>w,J=j?b.p.length-1:0;for(A=0;A<J;++A)Math.abs(b.p[A])>=d&&(z?b.p[A]=Math.fround(Math.tanh(b.p[A]/L*20))*(d-1):H?b.p[A]=Math.fround(b.p[A]/L*b.yDiff)*(d-1):b.p[A]/=Math.fround(1+Math.sqrt(d)));v.push(b),M&&m(v,"yDiff")}function P(t,e,i,h,s,n){var r=Math.abs(i+h),o=Math.abs(s+n),a=Math.sign(i),p=Math.sign(h),l=Math.sign(s),f=Math.sign(n);if(1!=o)if(1!=r){var g=i/2|0,u=h/2|0,d=s/2|0,M=n/2|0,w=Math.abs(g+u),v=Math.abs(d+M);if(2*r>3*o)return w%2!=0&&r>2&&(g+=a,u+=p),P(t,e,g,u,s,n),void P(t+g,e+u,i-g,h-u,s,n);v%2!=0&&o>2&&(d+=l,M+=f),P(t,e,d,M,g,u),P(t+d,e+M,i,h,s-d,n-M),P(t+(i-a)+(d-l),e+(h-p)+(M-f),-d,-M,-(i-g),-(h-u))}else for(c=0;c<o;++c)b(t,e),t+=l,e+=f;else for(var c=0;c<r;++c)b(t,e),t+=a,e+=p}function E(t){var e=Math.fround(Math.pow(y+1,1/(t-1))),i=1,s=0;c=new Array(t);for(var n=0;n<t;++n)v.push(new h(0)),s+=c[t-n-1]=i,i/=e;i=0;for(n=0;n<t;++n)c[n]=Math.fround(c[n]/s),i+=c[n];c[0]+=Math.fround(1-i)}t.prototype.dither=function(){v=[];var t=this.opts.weight<0;this.opts.weight=Math.abs(this.opts.weight),M=!t&&this.opts.palette.length>=128&&this.opts.weight>=.04,x=this.opts.weight<.01?this.opts.weight>.0025?25:16:9;var e=t?1:Math.exp(this.opts.weight)-.25;return d=t||x>9?Math.pow(Math.sqrt(x)+e,2):x,this.opts.palette.length/this.opts.weight>5e3&&(this.opts.weight>.045||this.opts.weight>.01&&this.opts.palette.length<=64)?d=Math.pow(5+e,2):this.opts.palette.length/this.opts.weight<3200&&this.opts.palette.length>16&&this.opts.palette.length<128&&(d=Math.pow(5+e,2)),w=x>9?-112:-64,c=[],u=new Uint32Array(65536),s=this.opts.ditherFn,n=this.opts.getColorIndex,r=this.opts.width,o=this.opts.height,a=this.opts.pixels,p=this.opts.palette,l=this.opts.saliencies,f=p.length,g=f>256?new Uint16Array(a.length):new Uint8Array(a.length),M||E(x),r>=o?P(0,0,r,0,0,o):P(0,0,0,o,r,0),this.opts.indexedPixels=this.qPixels=g,this.opts.dithering?function(){for(var t=new Uint32Array(g.length),e=0;e<g.length;++e)t[e]=p[g[e]];return t}():g},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var t=this;return new Promise(function(e,i){t.opts.dithering?e({img8:t.dither(),indexedPixels:t.getIndexedPixels()}):e({indexedPixels:t.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);
