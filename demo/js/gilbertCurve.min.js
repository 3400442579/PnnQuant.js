!function(){function t(t){this.opts=t,this.qPixels=[]}function p(t){t/=255;return t<.04045?t/12.92:Math.pow((.055+t)/1.055,2.4)}function U(t,e,i,h,s,n){function o(t,e,i){return.2126*p(t)+.7152*p(e)+.0722*p(i)}t=o(t,e,i),e=o(h,s,n);return 100*Math.abs(e-t)}function B(t){var e=255&t,i=t>>>8&255,h=t>>>16&255,t=t>>>24&255;this.yDiff=0,this.p=[e,i,h,t]}var D,I,N,n,_,q,A,O,S,T,C,k,F,G,R=[],j=[],z=9,o=343;function v(t,e){for(var i=t+e*N,h=_[i],s=new B(h),n=k?j.length-1:0,o=z-1,p=0;p<R.length;++p){var a=R[p];if(n<0||n>=j.length)break;for(var r=0;r<a.p.length;++r)s.p[r]+=a.p[r]*j[n],s.p[r]>o&&(o=s.p[r]);n+=k?-1:1}var l,f=0|Math.clamp(s.p[0],0,255),g=0|Math.clamp(s.p[1],0,255),u=0|Math.clamp(s.p[2],0,255),w=0|Math.clamp(s.p[3],0,255),M=255&h,d=h>>>8&255,c=h>>>16&255,x=w<<24|u<<16|g<<8|f;function v(t,e,i){return-.09991*t-.33609*e+.436*i}null!=A&&O<3?(l=(m=1)/3,x=(U(M,d,c,f,g,u)>m&&0<TELL_BLUE_NOISE[4095&i]?new BlueNoise({weight:1/A[i]}):new BlueNoise({weight:l*A[i]})).diffuse(h,q[S[i]],l,t,e),S[i]=D(q,x,i)):O<=32&&240<w?(b=I(w,f,g,u),0==T[b]&&(T[b]=D(q,x,i)+1),S[i]=T[b]-1,m=Math.max(2,O-F),null!=A&&(U(M,d,c,f,g,u)>m||(b=v(b=M,y=d,c),y=v(f,g,u),Math.abs(y-b)>2*m))&&(l=1/3,x=new BlueNoise({weight:1/A[i]}).diffuse(h,q[S[i]],l,t,e),S[i]=D(q,x,i))):S[i]=D(q,x,i),R.length>=z?R.shift():0<R.length&&H(R.length);for(var y=(x=q[S[i]])>>>8&255,b=x>>>16&255,m=x>>>24&255,h=(s.p[0]=f-(255&x),s.p[1]=g-y,s.p[2]=u-b,s.p[3]=w-m,2<q.length),E=TELL_BLUE_NOISE[4095&i]>G,L=(s.yDiff=k?U(M,d,c,f,g,u):1,!E&&TELL_BLUE_NOISE[4095&(4096*s.yDiff|0)]>G),P=h?s.p.length-1:0,r=0;r<P;++r)Math.abs(s.p[r])>=C&&(E?s.p[r]=Math.fround(Math.tanh(s.p[r]/o*20))*(C-1):L?s.p[r]=Math.fround(s.p[r]/o*s.yDiff)*(C-1):s.p[r]/=Math.fround(1+Math.sqrt(C)));R.push(s),k&&R.sort(function(t,e){return Math.sign(t.yDiff-e.yDiff)})}function y(t,e,i,h,s,n){var o=Math.abs(i+h),p=Math.abs(s+n),a=Math.sign(i),r=Math.sign(h),l=Math.sign(s),f=Math.sign(n);if(1==p)for(var g=0;g<o;++g)v(t,e),t+=a,e+=r;else if(1==o)for(g=0;g<p;++g)v(t,e),t+=l,e+=f;else{var u=i/2|0,w=h/2|0,M=s/2|0,d=n/2|0,c=Math.abs(u+w),x=Math.abs(M+d);3*p<2*o?(c%2!=0&&2<o&&(u+=a,w+=r),y(t,e,u,w,s,n),y(t+u,e+w,i-u,h-w,s,n)):(x%2!=0&&2<p&&(M+=l,d+=f),y(t,e,M,d,u,w),y(t+M,e+d,i,h,s-M,n-d),y(t+(i-a)+(M-l),e+(h-r)+(d-f),-M,-d,-(i-u),-(h-w)))}}function H(t){var e=Math.fround(Math.pow(o+1,1/(t-1))),i=1,h=0;j=new Array(t);for(var s=0;s<t;++s)R.push(new B(0)),h+=j[t-s-1]=i,i/=e;for(i=0,s=0;s<t;++s)j[s]=Math.fround(j[s]/h),i+=j[s];j[0]+=Math.fround(1-i)}t.prototype.dither=function(){R=[];var t=this.opts.weight<0,e=(this.opts.weight=Math.abs(this.opts.weight),F=this.opts.weight<.0025?12:6,k=128<=this.opts.palette.length&&(t?this.opts.weight<.18:.052<=this.opts.weight),z=this.opts.weight<.01?.0025<this.opts.weight?25:16:9,t?1:Math.exp(this.opts.weight)-.25),i=.002<this.opts.weight?-.25:1,t=(C=t||9<z?Math.pow(Math.sqrt(z)+e*i,2):z,16<this.opts.palette.length?3200:1500);if((5e3<this.opts.palette.length/this.opts.weight&&(.045<this.opts.weight||.01<this.opts.weight&&this.opts.palette.length<=64)||this.opts.weight<.03&&this.opts.palette.length/this.opts.weight<t&&16<=this.opts.palette.length&&this.opts.palette.length<128)&&(C=Math.pow(5+e,2)),G=9<z?-112:-64,j=[],T=new Uint32Array(65536),D=this.opts.ditherFn,I=this.opts.getColorIndex,N=this.opts.width,n=this.opts.height,_=this.opts.pixels,q=this.opts.palette,A=this.opts.saliencies,O=q.length,S=new(256<O?Uint16Array:Uint8Array)(_.length),k||H(z),n<=N?y(0,0,N,0,0,n):y(0,0,0,n,N,0),this.opts.indexedPixels=this.qPixels=S,this.opts.dithering){for(var h=new Uint32Array(S.length),s=0;s<S.length;++s)h[s]=q[S[s]];return h}return S},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var i=this;return new Promise(function(t,e){i.opts.dithering?t({img8:i.dither(),indexedPixels:i.getIndexedPixels()}):t({indexedPixels:i.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);
