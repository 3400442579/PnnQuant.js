(function(){function t(t){this.opts=t,this.qPixels=[]}function e(t){var e=t/255;return e<.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function i(t){var e=255&t,i=t>>>8&255,h=t>>>16&255,s=t>>>24&255;this.yDiff=-1,this.p=[e,i,h,s]}var h,s,n,o,p,a,r,f,l,u,g,d,M,w=[],c=[],v=9;function x(t,o){var x=t+o*n,y=p[x],m=new i(y),D=d?c.length-1:0,P=v-1;w.forEach(function(t){for(var e=0;e<t.p.length;++e)m.p[e]+=t.p[e]*c[D],m.p[e]>P&&(P=m.p[e]);D+=d?-1:1,t.yDiff<0&&(t.yDiff=m.yDiff)});var b=0|Math.clamp(m.p[0],0,255),E=0|Math.clamp(m.p[1],0,255),L=0|Math.clamp(m.p[2],0,255),U=0|Math.clamp(m.p[3],0,255),q=U<<24|L<<16|E<<8|b;if(f<=32&&U>240){var A=s(U,b,E,L);if(0==u[A]&&(u[A]=h(a,q,x)+1),l[x]=u[A]-1,null!=r&&r[x]>.65&&r[x]<.75){q=new BlueNoise({weight:1/r[x]}).diffuse(y,a[l[x]],1/3,t,o),l[x]=h(a,q,x)}}else l[x]=h(a,q,x);w.shift();var I=255&y,_=y>>>8&255,B=y>>>16&255,N=255&(q=a[l[x]]),C=q>>>8&255,O=q>>>16&255,S=q>>>24&255;m.p[0]=b-N,m.p[1]=E-C,m.p[2]=L-O,m.p[3]=U-S;var T=a.length>2,F=TELL_BLUE_NOISE[4095&x]>M;m.yDiff=d?function(t,i,h,s,n,o){function p(t,i,h){return.2126*e(t)+.7152*e(i)+.0722*e(h)}var a=p(t,i,h),r=p(s,n,o);return 100*Math.abs(r-a)}(I,_,B,b,E,L):1;for(var G=!F&&TELL_BLUE_NOISE[4095&(4096*m.yDiff|0)]>M,R=T?m.p.length-1:0,j=0;j<R;++j)Math.abs(m.p[j])>=g&&(F?m.p[j]=Math.fround(Math.tanh(m.p[j]/P*20))*(g-1):G?m.p[j]=Math.fround(m.p[j]/P*m.yDiff)*(g-1):m.p[j]/=Math.fround(1+Math.sqrt(g)));w.push(m),d&&w.sort((t,e)=>e.yDiff-t.yDiff)}function y(t,e,i,h,s,n){var o=Math.abs(i+h),p=Math.abs(s+n),a=Math.sign(i),r=Math.sign(h),f=Math.sign(s),l=Math.sign(n);if(1!=p)if(1!=o){var u=i/2|0,g=h/2|0,d=s/2|0,M=n/2|0,w=Math.abs(u+g),c=Math.abs(d+M);if(2*o>3*p)return w%2!=0&&o>2&&(u+=a,g+=r),y(t,e,u,g,s,n),void y(t+u,e+g,i-u,h-g,s,n);c%2!=0&&p>2&&(d+=f,M+=l),y(t,e,d,M,u,g),y(t+d,e+M,i,h,s-d,n-M),y(t+(i-a)+(d-f),e+(h-r)+(M-l),-d,-M,-(i-u),-(h-g))}else for(v=0;v<p;++v)x(t,e),t+=f,e+=l;else for(var v=0;v<o;++v)x(t,e),t+=a,e+=r}t.prototype.dither=function(){w=[];var t=this.opts.weight<0;d=null!=this.opts.saliencies&&!t&&this.opts.palette.length>=256,this.opts.weight=Math.abs(this.opts.weight),v=this.opts.weight<.01?this.opts.weight>.0025?25:16:9;var e=t?1:Math.exp(this.opts.weight)-.25;g=t||v>9?Math.pow(Math.sqrt(v)+e,2):v,this.opts.palette.length/this.opts.weight>5e3&&(this.opts.weight>.045||this.opts.weight>.01&&this.opts.palette.length<=64)?g=Math.pow(5+e,2):this.opts.palette.length/this.opts.weight<3200&&this.opts.palette.length>16&&this.opts.palette.length<128&&(g=Math.pow(5+e,2)),M=v>9?-112:-64,c=new Array(v),u=new Uint32Array(65536);for(var x=Math.fround(Math.pow(344,1/(v-1))),m=1,D=0,P=0;P<v;++P)w.push(new i(0)),D+=c[v-P-1]=m,m/=x;m=0;for(P=0;P<v;++P)c[P]=Math.fround(c[P]/D),m+=c[P];return c[0]+=Math.fround(1-m),h=this.opts.ditherFn,s=this.opts.getColorIndex,n=this.opts.width,o=this.opts.height,p=this.opts.pixels,a=this.opts.palette,r=this.opts.saliencies,f=a.length,l=f>256?new Uint16Array(p.length):new Uint8Array(p.length),n>=o?y(0,0,n,0,0,o):y(0,0,0,o,n,0),this.opts.indexedPixels=this.qPixels=l,this.opts.dithering?function(){for(var t=new Uint32Array(l.length),e=0;e<l.length;++e)t[e]=a[l[e]];return t}():l},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var t=this;return new Promise(function(e,i){t.opts.dithering?e({img8:t.dither(),indexedPixels:t.getIndexedPixels()}):e({indexedPixels:t.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);
