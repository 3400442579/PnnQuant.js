!function(){function t(t){this.opts=t,this.qPixels=[]}function p(t){t/=255;return t<.04045?t/12.92:Math.pow((.055+t)/1.055,2.4)}function L(t,e,i,h,s,n){function o(t,e,i){return.2126*p(t)+.7152*p(e)+.0722*p(i)}t=o(t,e,i),e=o(h,s,n);return 100*Math.abs(e-t)}function U(t,e,i,h,s,n){function o(t,e,i){return-.09991*t-.33609*e+.436*i}t=o(t,e,i),e=o(h,s,n);return Math.abs(e-t)}function q(t){var e=255&t,i=t>>>8&255,h=t>>>16&255,t=t>>>24&255;this.yDiff=0,this.p=[e,i,h,t]}Math.tanh||(Math.tanh=function(t){var e=Math.exp(+t),t=Math.exp(-t);return e==1/0?1:t==1/0?-1:(e-t)/(e+t)});var A,I,_,n,C,O,S,T,k,F,G,R,j,z,H,J,K=[],Q=[],V=9,o=343;function y(t,e){for(var i=t+e*_,h=C[i],s=new q(h),n=z?Q.length-1:0,o=V-1,p=0;p<K.length;++p){var a=K[p];if(n<0||n>=Q.length)break;for(var r=0;r<a.p.length;++r)s.p[r]+=a.p[r]*Q[n],s.p[r]>o&&(o=s.p[r]);n+=z?-1:1}for(var f,l,u=0|Math.clamp(s.p[0],0,255),g=0|Math.clamp(s.p[1],0,255),w=0|Math.clamp(s.p[2],0,255),M=0|Math.clamp(s.p[3],0,255),d=255&h,c=h>>>8&255,x=h>>>16&255,y=M<<24|w<<16|g<<8|u,v=(null!=S&&j&&!z?(l=1/3,f=Math.max(2,T-H),T<=4&&.2<S[i]&&S[i]<.25?y=new BlueNoise({weightB:2*k/S[i]}).diffuse(h,O[F[i]],l,t,e):(T<=4||L(d,c,x,u,g,w)<2*f)&&(B=255&(y=new BlueNoise({weightB:.5*k/S[i]}).diffuse(h,O[F[i]],l,t,e)),m=y>>>8&255,b=y>>>16&255,T<=4&&U(d,c,x,B,m,b)>8*f&&(v=.65<S[i]?h:M<<24|w<<16|g<<8|u,B=255&(y=new BlueNoise({weightB:k*S[i]}).diffuse(v,O[F[i]],l,t,e)),m=y>>>8&255,b=y>>>16&255),B=255&(y=U(d,c,x,B,m,b)>H*f?new BlueNoise({weightB:k/S[i]}).diffuse(h,O[F[i]],l,t,e):y),m=y>>>8&255,b=y>>>16&255),B=255&y,m=y>>>8&255,b=y>>>16&255,T<3||6<H?4<T&&(L(d,c,x,B,m,b)>k*f||U(d,c,x,B,m,b)>2*f)&&(N=S[i]<.4?.4*k*S[i]:.4*k/S[i],v=S[i]<.6?h:M<<24|w<<16|g<<8|u,B=255&(y=new BlueNoise({weightB:N}).diffuse(v,O[F[i]],l,t,e)),m=y>>>8&255,b=y>>>16&255):4<T&&(L(d,c,x,B,m,b)>k*f||U(d,c,x,B,m,b)>f)&&(B=255&(y=k<.3&&(T<=32||S[i]<k)?new BlueNoise({weightB:.4*k*S[i]}).diffuse(y,O[F[i]],l,t,e):M<<24|w<<16|g<<8|u),m=y>>>8&255,b=y>>>16&255),V<16&&S[i]<.6&&L(d,c,x,B,m,b)>H-1&&(y=M<<24|w<<16|g<<8|u,B=u,m=g,b=w),N=I(M,B,m,b),0==G[N]&&(G[N]=A(O,y,i)+1),F[i]=G[N]-1):T<=32&&240<M?(N=I(M,u,g,w),0==G[N]&&(G[N]=A(O,y,i)+1),F[i]=G[N]-1,f=Math.max(2,T-H),null!=S&&(L(d,c,x,u,g,w)>f||U(d,c,x,u,g,w)>2*f)&&(l=1/3,y=new BlueNoise({weightB:1/S[i]}).diffuse(h,O[F[i]],l,t,e),F[i]=A(O,y,i))):F[i]=A(O,y,i),K.length>=V?K.shift():0<K.length&&W(K.length),255&(y=O[F[i]])),B=y>>>8&255,m=y>>>16&255,b=y>>>24&255,N=(s.p[0]=u-v,s.p[1]=g-B,s.p[2]=w-m,s.p[3]=M-b,2<O.length),P=TELL_BLUE_NOISE[4095&i]>J,D=(s.yDiff=z?L(d,c,x,v,B,m):1,!P&&TELL_BLUE_NOISE[4095&(4096*s.yDiff|0)]>J),E=N?s.p.length-1:0,r=0;r<E;++r)Math.abs(s.p[r])>=R&&(P?s.p[r]=Math.fround(Math.tanh(s.p[r]/o*20))*(R-1):D?s.p[r]=Math.fround(s.p[r]/o*s.yDiff)*(R-1):s.p[r]/=Math.fround(1+Math.sqrt(R)));K.push(s),z&&K.sort(function(t,e){return e.yDiff<t.yDiff?-1:t.yDiff<e.yDiff?1:0})}function v(t,e,i,h,s,n){var o=Math.abs(i+h),p=Math.abs(s+n),a=Math.sign(i),r=Math.sign(h),f=Math.sign(s),l=Math.sign(n);if(1==p)for(var u=0;u<o;++u)y(t,e),t+=a,e+=r;else if(1==o)for(u=0;u<p;++u)y(t,e),t+=f,e+=l;else{var g=i>>1,w=h>>1,M=s>>1,d=n>>1,c=Math.abs(g+w),x=Math.abs(M+d);3*p<2*o?(c%2!=0&&2<o&&(g+=a,w+=r),v(t,e,g,w,s,n),v(t+g,e+w,i-g,h-w,s,n)):(x%2!=0&&2<p&&(M+=f,d+=l),v(t,e,M,d,g,w),v(t+M,e+d,i,h,s-M,n-d),v(t+(i-a)+(M-f),e+(h-r)+(d-l),-M,-d,-(i-g),-(h-w)))}}function W(t){var e=Math.fround(Math.pow(o+1,1/(t-1))),i=1,h=0;Q=new Array(t);for(var s=0;s<t;++s)K.push(new q(0)),h+=Q[t-s-1]=i,i/=e;for(i=0,s=0;s<t;++s)Q[s]=Math.fround(Q[s]/h),i+=Q[s];Q[0]+=Math.fround(1-i)}t.prototype.dither=function(){K=[];var t=this.opts.weight<0,e=(this.opts.weight=Math.abs(this.opts.weight),H=this.opts.weight<.0025?12:this.opts.weight<.004?8:6,z=128<=this.opts.palette.length&&(!t||this.opts.weight<.18),V=this.opts.weight<.015?.0025<this.opts.weight?25:16:9,t?1:Math.exp(this.opts.weight)-.25),i=!t&&.002<this.opts.weight?-.25:1,i=(R=t||9<V?Math.pow(Math.sqrt(V)+e*i,2):V*Math.E,16<this.opts.palette.length?3200:1500);if((5e3<this.opts.palette.length/this.opts.weight&&(.045<this.opts.weight||.01<this.opts.weight&&this.opts.palette.length<64)||this.opts.weight<.03&&this.opts.palette.length/this.opts.weight<i&&16<=this.opts.palette.length&&this.opts.palette.length<128)&&(R=Math.pow(5+e,2)),R|=0,J=9<V?-112:-64,Q=[],G=new Uint32Array(65536),A=this.opts.ditherFn,I=this.opts.getColorIndex,_=this.opts.width,n=this.opts.height,C=this.opts.pixels,O=this.opts.palette,S=t?null:this.opts.saliencies,j=this.opts.dithering,T=O.length,k=4<T?.6-.00625*T:1,4<T?(i=.005-625e-7*T,k=Math.fround(this.opts.weight>i?.25:Math.min(1.5,k+T*this.opts.weight)),32<T&&T<256&&(k+=.1)):k*=.95,(64<T||4<T&&.02<this.opts.weight)&&(k*=.4),F=new(256<T?Uint16Array:Uint8Array)(C.length),z||W(V),n<=_?v(0,0,_,0,0,n):v(0,0,0,n,_,0),this.opts.indexedPixels=this.qPixels=F,this.opts.dithering){for(var h=new Uint32Array(F.length),s=0;s<F.length;++s)h[s]=O[F[s]];return h}return F},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var i=this;return new Promise(function(t,e){i.opts.dithering||i.opts.colors<=32?t({img8:i.dither(),indexedPixels:i.getIndexedPixels()}):t({indexedPixels:i.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);