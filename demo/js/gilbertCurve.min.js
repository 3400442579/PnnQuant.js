!function(){function t(t){this.opts=t,this.qPixels=[]}function p(t){t/=255;return t<.04045?t/12.92:Math.pow((.055+t)/1.055,2.4)}function N(t,e,i,h,s,n){function o(t,e,i){return.2126*p(t)+.7152*p(e)+.0722*p(i)}t=o(t,e,i),e=o(h,s,n);return 100*Math.abs(e-t)}function D(t,e,i,h,s,n){function o(t,e,i){return-.09991*t-.33609*e+.436*i}t=o(t,e,i),e=o(h,s,n);return Math.abs(e-t)}function E(t){var e=255&t,i=t>>>8&255,h=t>>>16&255,t=t>>>24&255;this.yDiff=0,this.p=[e,i,h,t]}Math.tanh||(Math.tanh=function(t){var e=Math.exp(+t),t=Math.exp(-t);return e==1/0?1:t==1/0?-1:(e-t)/(e+t)});var I,L,U,n,v,q,A,_,C,O,S,T,k,F,G,R,j,z=[],H=[],J=9,o=343;function K(t,e,i,h){var s,n,o=t+e*U,p=q[o],a=255&p,r=p>>>8&255,f=p>>>16&255,l=255&i,u=i>>>8&255,g=i>>>16&255,w=i>>>24&255,M=Math.max(2,C-R),d=(C<=4&&.2<_[o]&&_[o]<.25?i=new BlueNoise({weightB:2*h/_[o]}).diffuse(p,A[S[o]],1/3,t,e):(C<=4||N(a,r,f,l,u,g)<2*M)&&(d=255&(i=new BlueNoise({weightB:.5*h/_[o]}).diffuse(p,A[S[o]],1/3,t,e)),c=i>>>8&255,x=i>>>16&255,C<=4&&D(a,r,f,d,c,x)>8*M&&(n=.65<_[o]?p:w<<24|g<<16|u<<8|l,d=255&(i=new BlueNoise({weightB:h*_[o]}).diffuse(n,A[S[o]],1/3,t,e)),c=i>>>8&255,x=i>>>16&255),d=255&(i=D(a,r,f,d,c,x)>R*M?new BlueNoise({weightB:h/_[o]}).diffuse(p,A[S[o]],1/3,t,e):i),c=i>>>8&255,x=i>>>16&255),255&i),c=i>>>8&255,x=i>>>16&255,p=(C<3||6<R?(s=.0015<v&&v<.0025?h:Math.PI,4<C&&(N(a,r,f,d,c,x)>s*M||D(a,r,f,d,c,x)>R*M)&&(s=_[o]<.4?.4*h*_[o]:.4*h/_[o],n=_[o]<.6?p:w<<24|g<<16|u<<8|l,d=255&(i=new BlueNoise({weightB:s}).diffuse(n,A[S[o]],1/3,t,e)),c=i>>>8&255,x=i>>>16&255)):4<C&&(N(a,r,f,d,c,x)>h*M||D(a,r,f,d,c,x)>M)&&(d=255&(i=h<.3&&(C<=32||_[o]<h)?new BlueNoise({weightB:.4*h*_[o]}).diffuse(i,A[S[o]],1/3,t,e):w<<24|g<<16|u<<8|l),c=i>>>8&255,x=i>>>16&255),J<16&&_[o]<.6&&N(a,r,f,d,c,x)>R-1&&(i=w<<24|g<<16|u<<8|l,d=l,c=u,x=g),L(w,d,c,x));return 0==T[p]&&(T[p]=I(A,i,o)+1),T[p]-1}function y(t,e){for(var i=t+e*U,h=q[i],s=new E(h),n=G?H.length-1:0,o=J-1,p=0;p<z.length;++p){var a=z[p];if(n<0||n>=H.length)break;for(var r=0;r<a.p.length;++r)s.p[r]+=a.p[r]*H[n],s.p[r]>o&&(o=s.p[r]);n+=G?-1:1}for(var f=0|Math.clamp(s.p[0],0,255),l=0|Math.clamp(s.p[1],0,255),u=0|Math.clamp(s.p[2],0,255),g=0|Math.clamp(s.p[3],0,255),w=255&h,M=h>>>8&255,d=h>>>16&255,c=g<<24|u<<16|l<<8|f,x=(null!=_&&F&&!G?S[i]=K(t,e,c,O):C<=32&&240<g?(x=L(g,f,l,u),0==T[x]&&(T[x]=I(A,c,i)+1),S[i]=T[x]-1,x=Math.max(2,C-R),null!=_&&(N(w,M,d,f,l,u)>x||D(w,M,d,f,l,u)>2*x)&&(c=new BlueNoise({weightB:1/_[i]}).diffuse(h,A[S[i]],1/3,t,e),S[i]=I(A,c,i))):S[i]=I(A,c,i),z.length>=J?z.shift():0<z.length&&Q(z.length),255&(c=A[S[i]])),h=c>>>8&255,v=c>>>16&255,y=c>>>24&255,f=(s.p[0]=f-x,s.p[1]=l-h,s.p[2]=u-v,s.p[3]=g-y,2<A.length),B=TELL_BLUE_NOISE[4095&i]>j,m=(s.yDiff=G?N(w,M,d,x,h,v):1,!B&&TELL_BLUE_NOISE[4095&(4096*s.yDiff|0)]>j),b=!1,P=f?s.p.length-1:0,r=0;r<P;++r)Math.abs(s.p[r])>=k&&(G&&null!=_&&(b=!0),B?s.p[r]=Math.fround(Math.tanh(s.p[r]/o*20))*(k-1):m?s.p[r]=Math.fround(s.p[r]/o*s.yDiff)*(k-1):s.p[r]/=Math.fround(1+Math.sqrt(k)));b&&(S[i]=K(t,e,c,1.25)),z.push(s),G&&z.sort(function(t,e){return e.yDiff<t.yDiff?-1:t.yDiff<e.yDiff?1:0})}function B(t,e,i,h,s,n){var o=Math.abs(i+h),p=Math.abs(s+n),a=Math.sign(i),r=Math.sign(h),f=Math.sign(s),l=Math.sign(n);if(1==p)for(var u=0;u<o;++u)y(t,e),t+=a,e+=r;else if(1==o)for(u=0;u<p;++u)y(t,e),t+=f,e+=l;else{var g=i>>1,w=h>>1,M=s>>1,d=n>>1,c=Math.abs(g+w),x=Math.abs(M+d);3*p<2*o?(c%2!=0&&2<o&&(g+=a,w+=r),B(t,e,g,w,s,n),B(t+g,e+w,i-g,h-w,s,n)):(x%2!=0&&2<p&&(M+=f,d+=l),B(t,e,M,d,g,w),B(t+M,e+d,i,h,s-M,n-d),B(t+(i-a)+(M-f),e+(h-r)+(d-l),-M,-d,-(i-g),-(h-w)))}}function Q(t){var e=Math.fround(Math.pow(o+1,1/(t-1))),i=1,h=0;H=new Array(t);for(var s=0;s<t;++s)z.push(new E(0)),h+=H[t-s-1]=i,i/=e;for(i=0,s=0;s<t;++s)H[s]=Math.fround(H[s]/h),i+=H[s];H[0]+=Math.fround(1-i)}t.prototype.dither=function(){z=[];var t=this.opts.weight<0,e=(this.opts.weight=v=Math.abs(this.opts.weight),R=this.opts.weight<.0025?12:this.opts.weight<.004?8:6,G=128<=this.opts.palette.length&&(!t||this.opts.weight<.18),J=this.opts.weight<.015?.0025<this.opts.weight?25:16:9,t?1:Math.exp(this.opts.weight)-.25),i=!t&&.002<this.opts.weight?-.25:1,i=(k=t||9<J?Math.pow(Math.sqrt(J)+e*i,2):J*(null!=_?2:Math.E),16<this.opts.palette.length?3200:1500);if((5e3<this.opts.palette.length/this.opts.weight&&(.045<this.opts.weight||.01<this.opts.weight&&this.opts.palette.length<64)||this.opts.weight<.03&&this.opts.palette.length/this.opts.weight<i&&16<=this.opts.palette.length&&this.opts.palette.length<128)&&(k=Math.pow(5+e,2)),k|=0,j=9<J?-112:-64,H=[],T=new Uint32Array(65536),I=this.opts.ditherFn,L=this.opts.getColorIndex,U=this.opts.width,n=this.opts.height,q=this.opts.pixels,A=this.opts.palette,_=t?null:this.opts.saliencies,F=this.opts.dithering,C=A.length,O=4<C?.6-.00625*C:1,4<C?(i=.005-625e-7*C,O=Math.fround(this.opts.weight>i?.25:Math.min(1.5,O+C*this.opts.weight)),32<C&&C<256&&(O+=.1)):O*=.95,(64<C||4<C&&.02<this.opts.weight)&&(O*=.4),S=new(256<C?Uint16Array:Uint8Array)(q.length),G||Q(J),n<=U?B(0,0,U,0,0,n):B(0,0,0,n,U,0),this.opts.indexedPixels=this.qPixels=S,this.opts.dithering){for(var h=new Uint32Array(S.length),s=0;s<S.length;++s)h[s]=A[S[s]];return h}return S},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var i=this;return new Promise(function(t,e){i.opts.dithering||i.opts.colors<=32?t({img8:i.dither(),indexedPixels:i.getIndexedPixels()}):t({indexedPixels:i.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);