(function(){function t(t){this.opts=t||{},this.qPixels=[]}var e,r,i,n,o,h,s,a,p,f;function u(t){return t<0?-1:t>0?1:0}function l(t){var e=255&t,r=t>>>8&255,i=t>>>16&255,n=t>>>24&255;this.p=[e,r,i,n]}Math.clamp||(Math.clamp=function(t,e,r){return this.max(e,this.min(r,t))}),Math.fround||(Math.fround=(e=new Float32Array(1),function(t){return e[0]=+t,e[0]}));var d,c=[],v=[],M=9;function x(t,e){for(var h=t+e*o,u=s[h],x=new l(u),g=0;g<M;++g)for(var m=c[g],w=0;w<m.p.length;++w)x.p[w]+=m.p[w]*v[g];var y=0|Math.clamp(x.p[0],0,255),P=0|Math.clamp(x.p[1],0,255),b=0|Math.clamp(x.p[2],0,255),A=0|Math.clamp(x.p[3],0,255),U=A<<24|b<<16|P<<8|y;if(p<64){var q=i(A,y,P,b);0==d[q]&&(d[q]=u>>>24&!1?1:r(a,p,U)+1),f[h]=d[q]-1}else f[h]=r(a,p,U);c.shift();var I=255&(U=a[f[h]]),C=U>>>8&255,F=U>>>16&255,G=U>>>24&255;if(x.p[0]=y-I,x.p[1]=P-C,x.p[2]=b-F,x.p[3]=A-G,n<3||p>16)for(w=0;w<x.p.length;++w)Math.abs(x.p[w])<M||(x.p[w]=Math.fround(x.p[w]/n));c.push(x)}function g(t,e,r,i,n,o){var h=Math.abs(r+i),s=Math.abs(n+o),a=u(r),p=u(i),f=u(n),l=u(o);if(1!=s)if(1!=h){var d=r/2|0,c=i/2|0,v=n/2|0,M=o/2|0,m=Math.abs(d+c),w=Math.abs(v+M);if(2*h>3*s)return m%2!=0&&h>2&&(d+=a,c+=p),g(t,e,d,c,n,o),void g(t+d,e+c,r-d,i-c,n,o);w%2!=0&&s>2&&(v+=f,M+=l),g(t,e,v,M,d,c),g(t+v,e+M,r,i,n-v,o-M),g(t+(r-a)+(v-f),e+(i-p)+(M-l),-v,-M,-(r-d),-(i-c))}else for(y=0;y<s;++y)x(t,e),t+=f,e+=l;else for(var y=0;y<h;++y)x(t,e),t+=a,e+=p}t.prototype.dither=function(){c=[],v=new Array(M),d=new Uint32Array(65536);for(var t=Math.pow(344,1/(M-1)),e=1,u=0,x=0;x<M;++x){c.push(new l(0));var m=Math.fround(1/e);u+=v[M-x-1]=m,e*=t}e=0;for(x=0;x<M;++x)v[x]=Math.fround(v[x]/u),e+=v[x];return v[0]+=Math.fround(1-e),r=this.opts.ditherFn,i=this.opts.getColorIndex,o=this.opts.width,h=this.opts.height,s=this.opts.pixels,a=this.opts.palette,p=a.length,n=this.opts.divisor?this.opts.divisor:p>32?3:p>2?1.8:1.5,f=p>256?new Uint16Array(s.length):new Uint8Array(s.length),o>=h?g(0,0,o,0,0,h):g(0,0,0,h,o,0),this.qPixels=f,this.opts.dithering?function(){for(var t=new Uint32Array(f.length),e=0;e<f.length;++e)t[e]=a[f[e]];return t}():f},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var t=this;return new Promise(function(e,r){t.opts.dithering?e({img8:t.dither(),indexedPixels:t.getIndexedPixels()}):e({indexedPixels:t.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);