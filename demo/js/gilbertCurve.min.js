(function(){function t(t){this.opts=t||{},this.qPixels=[]}function e(t){return t<0?-1:t>0?1:0}function i(t){var e=255&t,i=t>>>8&255,n=t>>>16&255,r=t>>>24&255;this.p=[e,i,n,r]}var n,r,s,h,o,a,p,l,f;Math.clamp||(Math.clamp=function(t,e,i){return this.max(e,this.min(i,t))});var u,d=[],c=[],v=9;function x(t,e){for(var o=t+e*h,x=a[o],g=new i(x),m=0;m<v;++m)for(var M=d[m],w=0;w<M.p.length;++w)g.p[w]+=M.p[w]*c[m];var y=0|Math.clamp(g.p[0],0,255),P=0|Math.clamp(g.p[1],0,255),b=0|Math.clamp(g.p[2],0,255),A=0|Math.clamp(g.p[3],0,255),U=A<<24|b<<16|P<<8|y;if(l<64){var q=r(A,y,P,b);0==u[q]&&(u[q]=x>>>24&!1?1:n(p,l,U)+1),f[o]=u[q]-1}else f[o]=n(p,l,U);d.shift();var I=255&(U=p[f[o]]),C=U>>>8&255,F=U>>>16&255,G=U>>>24&255;if(g.p[0]=y-I,g.p[1]=P-C,g.p[2]=b-F,g.p[3]=A-G,s<3||l>16)for(w=0;w<g.p.length;++w)Math.abs(g.p[w])<v||(g.p[w]/=s);d.push(g)}function g(t,i,n,r,s,h){var o=Math.abs(n+r),a=Math.abs(s+h),p=e(n),l=e(r),f=e(s),u=e(h);if(1!=a)if(1!=o){var d=n/2|0,c=r/2|0,v=s/2|0,m=h/2|0,M=Math.abs(d+c),w=Math.abs(v+m);if(2*o>3*a)return M%2!=0&&o>2&&(d+=p,c+=l),g(t,i,d,c,s,h),void g(t+d,i+c,n-d,r-c,s,h);w%2!=0&&a>2&&(v+=f,m+=u),g(t,i,v,m,d,c),g(t+v,i+m,n,r,s-v,h-m),g(t+(n-p)+(v-f),i+(r-l)+(m-u),-v,-m,-(n-d),-(r-c))}else for(y=0;y<a;++y)x(t,i),t+=f,i+=u;else for(var y=0;y<o;++y)x(t,i),t+=p,i+=l}t.prototype.dither=function(){d=[],c=[],u=new Uint32Array(65536);for(var t=Math.pow(344,1/(v-1)),e=1,x=0,m=0;m<v;++m)d.push(new i(0)),x+=c[v-m-1]=1/e,e*=t;e=0;for(m=0;m<v;++m)e+=c[m]/=x;return c[0]+=1-e,n=this.opts.ditherFn,r=this.opts.getColorIndex,h=this.opts.width,o=this.opts.height,a=this.opts.pixels,p=this.opts.palette,l=p.length,s=l>32?3:l>2?1.8:1.5,f=l>256?new Uint16Array(a.length):new Uint8Array(a.length),h>=o?g(0,0,h,0,0,o):g(0,0,0,o,h,0),this.qPixels=f,this.opts.dithering?function(){for(var t=new Uint32Array(f.length),e=0;e<f.length;++e)t[e]=p[f[e]];return t}():f},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var t=this;return new Promise(function(e,i){t.opts.dithering?e({img8:t.dither(),indexedPixels:t.getIndexedPixels()}):e({indexedPixels:t.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);