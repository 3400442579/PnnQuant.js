(function(){function t(t){this.opts=t,this.qPixels=[]}function e(t){var e=t/255;return e<.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function i(t){var e=255&t,i=t>>>8&255,h=t>>>16&255,s=t>>>24&255;this.yDiff=1,this.p=[e,i,h,s]}var h,s,n,p,a,o,r,l,f,u,g,d,M,w=[],v=[],c=9;function x(t,p){for(var x=t+p*n,y=a[x],m=new i(y),P=c-1,b=d?v.length-1:0,D=0;D<c;++D){for(var E=w[D],L=0;L<E.p.length;++L)m.p[L]+=E.p[L]*v[b],m.p[L]>P&&(P=m.p[L]);b+=d?-1:1}var U=0|Math.clamp(m.p[0],0,255),q=0|Math.clamp(m.p[1],0,255),A=0|Math.clamp(m.p[2],0,255),I=0|Math.clamp(m.p[3],0,255),_=I<<24|A<<16|q<<8|U;if(l<=32&&I>240){var B=s(I,U,q,A);if(0==u[B]&&(u[B]=h(o,_,x)+1),f[x]=u[B]-1,null!=r&&r[x]>.65&&r[x]<.75){_=new BlueNoise({weight:1/r[x]}).diffuse(y,o[f[x]],1/3,t,p),f[x]=h(o,_,x)}}else f[x]=h(o,_,x);w.shift();var N=255&y,C=y>>>8&255,O=y>>>16&255,S=255&(_=o[f[x]]),T=_>>>8&255,F=_>>>16&255,G=_>>>24&255;m.p[0]=U-S,m.p[1]=q-T,m.p[2]=A-F,m.p[3]=I-G;var R=o.length>2,j=TELL_BLUE_NOISE[4095&x]>M;m.yDiff=d?function(t,i,h,s,n,p){function a(t,i,h){return.2126*e(t)+.7152*e(i)+.0722*e(h)}var o=a(t,i,h),r=a(s,n,p);return 100*Math.abs(r-o)}(N,C,O,U,q,A):1;var k=!j&&TELL_BLUE_NOISE[4095&(4096*m.yDiff|0)]>M,z=R?m.p.length-1:0;for(L=0;L<z;++L)Math.abs(m.p[L])>=g&&(j?m.p[L]=Math.fround(Math.tanh(m.p[L]/P*20))*(g-1):k?m.p[L]=Math.fround(m.p[L]/P*m.yDiff)*(g-1):m.p[L]/=Math.fround(1+Math.sqrt(g)));d&&m.yDiff>w[0].yDiff?w.unshift(m):w.push(m)}function y(t,e,i,h,s,n){var p=Math.abs(i+h),a=Math.abs(s+n),o=Math.sign(i),r=Math.sign(h),l=Math.sign(s),f=Math.sign(n);if(1!=a)if(1!=p){var u=i/2|0,g=h/2|0,d=s/2|0,M=n/2|0,w=Math.abs(u+g),v=Math.abs(d+M);if(2*p>3*a)return w%2!=0&&p>2&&(u+=o,g+=r),y(t,e,u,g,s,n),void y(t+u,e+g,i-u,h-g,s,n);v%2!=0&&a>2&&(d+=l,M+=f),y(t,e,d,M,u,g),y(t+d,e+M,i,h,s-d,n-M),y(t+(i-o)+(d-l),e+(h-r)+(M-f),-d,-M,-(i-u),-(h-g))}else for(c=0;c<a;++c)x(t,e),t+=l,e+=f;else for(var c=0;c<p;++c)x(t,e),t+=o,e+=r}t.prototype.dither=function(){w=[];var t=this.opts.weight<0;d=null!=this.opts.saliencies&&!t&&this.opts.palette.length>=128,this.opts.weight=Math.abs(this.opts.weight),c=this.opts.weight<.01?this.opts.weight>.0025?25:16:9;var e=t?1:Math.exp(this.opts.weight)-.25;g=t||c>9?Math.pow(Math.sqrt(c)+e,2):c,this.opts.palette.length/this.opts.weight>5e3&&(this.opts.weight>.045||this.opts.weight>.01&&this.opts.palette.length<=64)?g=Math.pow(5+e,2):this.opts.palette.length/this.opts.weight<3200&&this.opts.palette.length>16&&this.opts.palette.length<256&&(g=Math.pow(5+e,2)),M=c>9?-112:-64,v=new Array(c),u=new Uint32Array(65536);for(var x=Math.pow(344,1/(c-1)),m=1,P=0,b=0;b<c;++b){w.push(new i(0));var D=Math.fround(1/m);P+=v[c-b-1]=D,m*=x}m=0;for(b=0;b<c;++b)v[b]=Math.fround(v[b]/P),m+=v[b];return v[0]+=Math.fround(1-m),h=this.opts.ditherFn,s=this.opts.getColorIndex,n=this.opts.width,p=this.opts.height,a=this.opts.pixels,o=this.opts.palette,r=this.opts.saliencies,l=o.length,f=l>256?new Uint16Array(a.length):new Uint8Array(a.length),n>=p?y(0,0,n,0,0,p):y(0,0,0,p,n,0),this.opts.indexedPixels=this.qPixels=f,this.opts.dithering?function(){for(var t=new Uint32Array(f.length),e=0;e<f.length;++e)t[e]=o[f[e]];return t}():f},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var t=this;return new Promise(function(e,i){t.opts.dithering?e({img8:t.dither(),indexedPixels:t.getIndexedPixels()}):e({indexedPixels:t.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);
