(function(){function t(t){this.opts=t,this.qPixels=[]}function e(t){var e=t/255;return e<.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function i(t){this.yDiff=0,this.p=[255&t,t>>>8&255,t>>>16&255,t>>>24&255]}var $,s,n,f,h,p,r,o,l,a,g,_,u,x=[],d=[],w=9;function v(t,f){for(var v=t+f*n,c=h[v],b=new i(c),P=_?d.length-1:0,D=w-1,m=0;m<x.length;++m){var q=x[m];if(P<0||P>=d.length)break;for(var I=0;I<q.p.length;++I)b.p[I]+=q.p[I]*d[P],b.p[I]>D&&(D=b.p[I]);P+=_?-1:1}var C=0|Math.clamp(b.p[0],0,255),F=0|Math.clamp(b.p[1],0,255),k=0|Math.clamp(b.p[2],0,255),G=0|Math.clamp(b.p[3],0,255),R=G<<24|k<<16|F<<8|C;if(o<=32&&G>240){var j=s(G,C,F,k);0==a[j]&&(a[j]=$(p,R,v)+1),l[v]=a[j]-1,null!=r&&r[v]>.65&&r[v]<.75&&(R=new BlueNoise({weight:1/r[v]}).diffuse(c,p[l[v]],1/3,t,f),l[v]=$(p,R,v))}else l[v]=$(p,R,v);x.length>=w?x.shift():x.length>0&&y(x.length);var z=255&(R=p[l[v]]),A=R>>>8&255,B=R>>>16&255,E=R>>>24&255;b.p[0]=C-z,b.p[1]=F-A,b.p[2]=k-B,b.p[3]=G-E;var H=p.length>2,J=TELL_BLUE_NOISE[4095&v]>u;b.yDiff=_?function t(i,$,s,n,f,h){function p(t,i,$){var s=e(t),n=e(i),f=e($);return .2126*s+.7152*n+.0722*f}var r=p(i,$,s);return 100*Math.abs(p(n,f,h)-r)}(255&c,c>>>8&255,c>>>16&255,C,F,k):1;for(var K=!J&&TELL_BLUE_NOISE[(4096*b.yDiff|0)&4095]>u,L=H?b.p.length-1:0,I=0;I<L;++I)Math.abs(b.p[I])>=g&&(J?b.p[I]=Math.fround(Math.tanh(b.p[I]/D*20))*(g-1):K?b.p[I]=Math.fround(b.p[I]/D*b.yDiff)*(g-1):b.p[I]/=Math.fround(1+Math.sqrt(g)));x.push(b),_&&x.sort((t,e)=>e.yDiff-t.yDiff)}function c(t,e,i,$,s,n){var f=Math.abs(i+$),h=Math.abs(s+n),p=Math.sign(i),r=Math.sign($),o=Math.sign(s),l=Math.sign(n);if(1==h){for(var a=0;a<f;++a)v(t,e),t+=p,e+=r;return}if(1==f){for(var a=0;a<h;++a)v(t,e),t+=o,e+=l;return}var g=i/2|0,_=$/2|0,u=s/2|0,x=n/2|0,d=Math.abs(g+_),w=Math.abs(u+x);if(2*f>3*h){d%2!=0&&f>2&&(g+=p,_+=r),c(t,e,g,_,s,n),c(t+g,e+_,i-g,$-_,s,n);return}w%2!=0&&h>2&&(u+=o,x+=l),c(t,e,u,x,g,_),c(t+u,e+x,i,$,s-u,n-x),c(t+(i-p)+(u-o),e+($-r)+(x-l),-u,-x,-(i-g),-($-_))}function y(t){var e=Math.fround(Math.pow(344,1/(t-1))),$=1,s=0;d=Array(t);for(var n=0;n<t;++n)x.push(new i(0)),s+=d[t-n-1]=$,$/=e;$=0;for(var n=0;n<t;++n)d[n]=Math.fround(d[n]/s),$+=d[n];d[0]+=Math.fround(1-$)}t.prototype.dither=function(){x=[];var t=this.opts.weight<0;_=!t&&this.opts.palette.length>=256,this.opts.weight=Math.abs(this.opts.weight),w=this.opts.weight<.01?this.opts.weight>.0025?25:16:9;var e=t?1:Math.exp(this.opts.weight)-.25;return(g=t||w>9?Math.pow(Math.sqrt(w)+e,2):w,this.opts.palette.length/this.opts.weight>5e3&&(this.opts.weight>.045||this.opts.weight>.01&&this.opts.palette.length<=64)?g=Math.pow(5+e,2):this.opts.palette.length/this.opts.weight<3200&&this.opts.palette.length>16&&this.opts.palette.length<128&&(g=Math.pow(5+e,2)),u=w>9?-112:-64,d=[],a=new Uint32Array(65536),$=this.opts.ditherFn,s=this.opts.getColorIndex,n=this.opts.width,f=this.opts.height,h=this.opts.pixels,p=this.opts.palette,r=this.opts.saliencies,l=(o=p.length)>256?new Uint16Array(h.length):new Uint8Array(h.length),y(_?1:w),n>=f?c(0,0,n,0,0,f):c(0,0,0,f,n,0),this.opts.indexedPixels=this.qPixels=l,this.opts.dithering)?function t(){for(var e=new Uint32Array(l.length),i=0;i<l.length;++i)e[i]=p[l[i]];return e}():l},t.prototype.getIndexedPixels=function t(){return this.qPixels},t.prototype.getResult=function t(){var e=this;return new Promise(function(t,i){t(e.opts.dithering?{img8:e.dither(),indexedPixels:e.getIndexedPixels()}:{indexedPixels:e.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);
