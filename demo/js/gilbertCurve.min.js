(function(){function t(t){this.opts=t,this.qPixels=[]}function e(t){var e=t/255;return e<.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function i(t){var e=255&t,i=t>>>8&255,h=t>>>16&255,s=t>>>24&255;this.p=[e,i,h,s]}var h,s,n,r,a,o,p,l,u,f,g,d,M=[],w=[],v=9;function c(t,r){for(var c=t+r*n,x=a[c],m=new i(x),y=v-1,P=0;P<v;++P)for(var b=M[P],E=0;E<b.p.length;++E)m.p[E]+=b.p[E]*w[P],m.p[E]>y&&(y=m.p[E]);var L=0|Math.clamp(m.p[0],0,255),U=0|Math.clamp(m.p[1],0,255),q=0|Math.clamp(m.p[2],0,255),A=0|Math.clamp(m.p[3],0,255),I=A<<24|q<<16|U<<8|L;if(l<=32&&A>240){var _=s(A,L,U,q);if(0==f[_]&&(f[_]=h(o,I,c)+1),u[c]=f[_]-1,null!=p&&p[c]>.65&&p[c]<.75){I=new BlueNoise({weight:1/p[c]}).diffuse(x,o[u[c]],1/3,t,r),u[c]=h(o,I,c)}}else u[c]=h(o,I,c);M.shift();var B=255&x,N=x>>>8&255,C=x>>>16&255,O=255&(I=o[u[c]]),S=I>>>8&255,T=I>>>16&255,F=I>>>24&255;m.p[0]=L-O,m.p[1]=U-S,m.p[2]=q-T,m.p[3]=A-F;var G=o.length>2,R=TELL_BLUE_NOISE[4095&c]>d,j=R?1:function(t,i,h,s,n,r){function a(t,i,h){return.2126*e(t)+.7152*e(i)+.0722*e(h)}var o=a(t,i,h),p=a(s,n,r);return 100*Math.abs(p-o)}(B,N,C,L,U,q),k=(!R&&TELL_BLUE_NOISE[4095&(4096*j|0)],G?m.p.length-1:0);for(E=0;E<k;++E)Math.abs(m.p[E])>=g&&(R?m.p[E]=Math.fround(Math.tanh(m.p[E]/y*20))*(g-1):m.p[E]/=Math.fround(1+Math.sqrt(g)));M.push(m)}function x(t,e,i,h,s,n){var r=Math.abs(i+h),a=Math.abs(s+n),o=Math.sign(i),p=Math.sign(h),l=Math.sign(s),u=Math.sign(n);if(1!=a)if(1!=r){var f=i/2|0,g=h/2|0,d=s/2|0,M=n/2|0,w=Math.abs(f+g),v=Math.abs(d+M);if(2*r>3*a)return w%2!=0&&r>2&&(f+=o,g+=p),x(t,e,f,g,s,n),void x(t+f,e+g,i-f,h-g,s,n);v%2!=0&&a>2&&(d+=l,M+=u),x(t,e,d,M,f,g),x(t+d,e+M,i,h,s-d,n-M),x(t+(i-o)+(d-l),e+(h-p)+(M-u),-d,-M,-(i-f),-(h-g))}else for(m=0;m<a;++m)c(t,e),t+=l,e+=u;else for(var m=0;m<r;++m)c(t,e),t+=o,e+=p}t.prototype.dither=function(){M=[];var t=this.opts.weight<0;this.opts.weight=Math.abs(this.opts.weight),v=this.opts.weight<.01?this.opts.weight>.0025?25:16:9;var e=t?1:Math.exp(this.opts.weight)-.25;g=t||v>9?Math.pow(Math.sqrt(v)+e,2):v,this.opts.palette.length/this.opts.weight>5e3&&(this.opts.weight>.045||this.opts.weight>.01&&this.opts.palette.length<=64)&&(g=Math.pow(5+e,2)),this.opts.palette.length>16&&this.opts.palette.length<256&&(g=Math.max(g,this.opts.palette.length-v)),d=v>9?-112:-64,w=new Array(v),f=new Uint32Array(65536);for(var c=Math.pow(344,1/(v-1)),m=1,y=0,P=0;P<v;++P){M.push(new i(0));var b=Math.fround(1/m);y+=w[v-P-1]=b,m*=c}m=0;for(P=0;P<v;++P)w[P]=Math.fround(w[P]/y),m+=w[P];return w[0]+=Math.fround(1-m),h=this.opts.ditherFn,s=this.opts.getColorIndex,n=this.opts.width,r=this.opts.height,a=this.opts.pixels,o=this.opts.palette,p=this.opts.saliencies,l=o.length,u=l>256?new Uint16Array(a.length):new Uint8Array(a.length),n>=r?x(0,0,n,0,0,r):x(0,0,0,r,n,0),this.opts.indexedPixels=this.qPixels=u,this.opts.dithering?function(){for(var t=new Uint32Array(u.length),e=0;e<u.length;++e)t[e]=o[u[e]];return t}():u},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var t=this;return new Promise(function(e,i){t.opts.dithering?e({img8:t.dither(),indexedPixels:t.getIndexedPixels()}):e({indexedPixels:t.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);
