!function(){function t(t){this.opts=t,this.qPixels=[]}function p(t){t/=255;return t<.04045?t/12.92:Math.pow((.055+t)/1.055,2.4)}function U(t,e,i,h,s,n){function o(t,e,i){return.2126*p(t)+.7152*p(e)+.0722*p(i)}t=o(t,e,i),e=o(h,s,n);return 100*Math.abs(e-t)}function q(t,e,i,h,s,n){function o(t,e,i){return-.09991*t-.33609*e+.436*i}t=o(t,e,i),e=o(h,s,n);return Math.abs(e-t)}function A(t){var e=255&t,i=t>>>8&255,h=t>>>16&255,t=t>>>24&255;this.yDiff=0,this.p=[e,i,h,t]}var I,_,C,n,O,S,T,k,F,G,R,j,z,H,J,K=[],Q=[],V=9,o=343;function v(t,e){for(var i=t+e*C,h=O[i],s=new A(h),n=z?Q.length-1:0,o=V-1,p=0;p<K.length;++p){var a=K[p];if(n<0||n>=Q.length)break;for(var r=0;r<a.p.length;++r)s.p[r]+=a.p[r]*Q[n],s.p[r]>o&&(o=s.p[r]);n+=z?-1:1}for(var l,f,g,u,w=0|Math.clamp(s.p[0],0,255),d=0|Math.clamp(s.p[1],0,255),M=0|Math.clamp(s.p[2],0,255),c=0|Math.clamp(s.p[3],0,255),x=255&h,v=h>>>8&255,y=h>>>16&255,B=c<<24|M<<16|d<<8|w,m=(null==T||z?k<=32&&240<c?(u=_(c,w,d,M),0==R[u]&&(R[u]=I(S,B,i)+1),G[i]=R[u]-1,P=Math.max(2,k-H),null!=T&&(U(x,v,y,w,d,M)>P||q(x,v,y,w,d,M)>2*P)&&(N=1/3,B=new BlueNoise({weightB:1/T[i]}).diffuse(h,S[G[i]],N,t,e),G[i]=I(S,B,i))):G[i]=I(S,B,i):(N=1/3,P=Math.max(2,k-H),k<=8&&.2<T[i]&&T[i]<.25?B=new BlueNoise({weightB:F/T[i]}).diffuse(h,S[G[i]],N,t,e):(k<=8||U(x,v,y,w,d,M)<2*P)&&(B=new BlueNoise({weightB:.5*F/T[i]}).diffuse(h,S[G[i]],N,t,e)),l=255&B,f=B>>>8&255,g=B>>>16&255,k<3||6<H?8<k&&(U(x,v,y,l,f,g)>F*P||q(x,v,y,l,f,g)>2*P)&&(m=T[i]<.25?.4*F*T[i]:.4*F/T[i],b=c<<24|M<<16|d<<8|w,l=255&(B=new BlueNoise({weightB:m}).diffuse(b,S[G[i]],N,t,e)),f=B>>>8&255,g=B>>>16&255):8<k&&(U(x,v,y,l,f,g)>F*P||q(x,v,y,l,f,g)>P)&&(l=255&(B=F<.3?new BlueNoise({weightB:.4*F*T[i]}).diffuse(h,S[G[i]],N,t,e):c<<24|M<<16|d<<8|w),f=B>>>8&255,g=B>>>16&255),u=_(c,l,f,g),0==R[u]&&(R[u]=I(S,B,i)+1),G[i]=R[u]-1),K.length>=V?K.shift():0<K.length&&W(K.length),255&(B=S[G[i]])),b=B>>>8&255,P=B>>>16&255,h=B>>>24&255,N=(s.p[0]=w-m,s.p[1]=d-b,s.p[2]=M-P,s.p[3]=c-h,2<S.length),D=TELL_BLUE_NOISE[4095&i]>J,E=(s.yDiff=z?U(x,v,y,w,d,M):1,!D&&TELL_BLUE_NOISE[4095&(4096*s.yDiff|0)]>J),L=N?s.p.length-1:0,r=0;r<L;++r)Math.abs(s.p[r])>=j&&(D?s.p[r]=Math.fround(Math.tanh(s.p[r]/o*20))*(j-1):E?s.p[r]=Math.fround(s.p[r]/o*s.yDiff)*(j-1):s.p[r]/=Math.fround(1+Math.sqrt(j)));K.push(s),z&&K.sort(function(t,e){return Math.sign(t.yDiff-e.yDiff)})}function y(t,e,i,h,s,n){var o=Math.abs(i+h),p=Math.abs(s+n),a=Math.sign(i),r=Math.sign(h),l=Math.sign(s),f=Math.sign(n);if(1==p)for(var g=0;g<o;++g)v(t,e),t+=a,e+=r;else if(1==o)for(g=0;g<p;++g)v(t,e),t+=l,e+=f;else{var u=i/2|0,w=h/2|0,d=s/2|0,M=n/2|0,c=Math.abs(u+w),x=Math.abs(d+M);3*p<2*o?(c%2!=0&&2<o&&(u+=a,w+=r),y(t,e,u,w,s,n),y(t+u,e+w,i-u,h-w,s,n)):(x%2!=0&&2<p&&(d+=l,M+=f),y(t,e,d,M,u,w),y(t+d,e+M,i,h,s-d,n-M),y(t+(i-a)+(d-l),e+(h-r)+(M-f),-d,-M,-(i-u),-(h-w)))}}function W(t){var e=Math.fround(Math.pow(o+1,1/(t-1))),i=1,h=0;Q=new Array(t);for(var s=0;s<t;++s)K.push(new A(0)),h+=Q[t-s-1]=i,i/=e;for(i=0,s=0;s<t;++s)Q[s]=Math.fround(Q[s]/h),i+=Q[s];Q[0]+=Math.fround(1-i)}t.prototype.dither=function(){K=[];var t=this.opts.weight<0,e=(this.opts.weight=Math.abs(this.opts.weight),H=this.opts.weight<.0025?12:this.opts.weight<.004?8:6,z=128<=this.opts.palette.length&&(t?this.opts.weight<.18:.052<=this.opts.weight),V=this.opts.weight<.01?.0025<this.opts.weight?25:16:9,t?1:Math.exp(this.opts.weight)-.25),i=.002<this.opts.weight?-.25:1,t=(j=t||9<V?Math.pow(Math.sqrt(V)+e*i,2):V,16<this.opts.palette.length?3200:1500);if((5e3<this.opts.palette.length/this.opts.weight&&(.045<this.opts.weight||.01<this.opts.weight&&this.opts.palette.length<=64)||this.opts.weight<.03&&this.opts.palette.length/this.opts.weight<t&&16<=this.opts.palette.length&&this.opts.palette.length<128)&&(j=Math.pow(5+e,2)),J=9<V?-112:-64,Q=[],R=new Uint32Array(65536),I=this.opts.ditherFn,_=this.opts.getColorIndex,C=this.opts.width,n=this.opts.height,O=this.opts.pixels,S=this.opts.palette,T=this.opts.saliencies,k=S.length,F=8<k?24<k?.25:.7:1,.02<this.opts.weight&&(F*=.5),G=new(256<k?Uint16Array:Uint8Array)(O.length),z||W(V),n<=C?y(0,0,C,0,0,n):y(0,0,0,n,C,0),this.opts.indexedPixels=this.qPixels=G,this.opts.dithering){for(var h=new Uint32Array(G.length),s=0;s<G.length;++s)h[s]=S[G[s]];return h}return G},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var i=this;return new Promise(function(t,e){i.opts.dithering?t({img8:i.dither(),indexedPixels:i.getIndexedPixels()}):t({indexedPixels:i.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);
